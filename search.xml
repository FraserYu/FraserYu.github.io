<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>HttpMessageConverter转换原理解析</title>
      <link href="//p/spring-boot-messageconverter.html"/>
      <url>//p/spring-boot-messageconverter.html</url>
      
        <content type="html"><![CDATA[<p>Java Web 人员经常要设计 RESTful API（<a href="https://mp.weixin.qq.com/s?__biz=Mzg3NjIxMjA1Ng==&mid=2247483661&idx=1&sn=048af6543c7baf6cefa691f80587b4c3&chksm=cf34fb3af843722c839977948df95b881b9bc3a4124b36a091af8435451643470d7db0af51de&token=1506224503&lang=zh_CN#rd" target="_blank" rel="noopener">如何设计好的RESTful API</a>），通过 json 数据进行交互。那么前端传入的 json 数据如何被解析成 Java 对象作为 API入参，API 返回结果又如何将 Java 对象解析成 json 格式数据返回给前端，其实在整个数据流转过程中，<code>HttpMessageConverter</code> 起到了重要作用；另外在转换的过程我们可以加入哪些定制化内容？</p><h2 id="HttpMessageConverter-介绍"><a href="#HttpMessageConverter-介绍" class="headerlink" title="HttpMessageConverter 介绍"></a>HttpMessageConverter 介绍</h2><p><code>org.springframework.http.converter.HttpMessageConverter</code> 是一个策略接口，接口说明如下：</p><blockquote><p> Strategy interface that specifies a converter that can convert from and to HTTP requests and responses. 简单说就是 HTTP request (请求)和response (响应)的转换器。该接口有只有5个方法，简单来说就是获取支持的 MediaType（application/json之类），接收到请求时判断是否能读（canRead），能读则读（read）；返回结果时判断是否能写（canWrite），能写则写（write）。这几个方法先有个印象即可：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">canRead</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">canWrite</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span></span>;</span><br><span class="line"><span class="function">List&lt;MediaType&gt; <span class="title">getSupportedMediaTypes</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">T <span class="title">read</span><span class="params">(Class&lt;? extends T&gt; clazz, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotReadableException</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(T t, MediaType contentType, HttpOutputMessage outputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotWritableException</span>;</span><br></pre></td></tr></table></figure><h3 id="缺省配置"><a href="#缺省配置" class="headerlink" title="缺省配置"></a>缺省配置</h3><p>我们写 Demo 没有配置任何 MessageConverter，但是数据前后传递依旧好用，是因为 SpringMVC 启动时会自动配置一些HttpMessageConverter，在 <code>WebMvcConfigurationSupport</code> 类中添加了缺省 MessageConverter：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addDefaultHttpMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters)</span> </span>&#123;</span><br><span class="line">StringHttpMessageConverter stringConverter = <span class="keyword">new</span> StringHttpMessageConverter();</span><br><span class="line">stringConverter.setWriteAcceptCharset(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">messageConverters.add(<span class="keyword">new</span> ByteArrayHttpMessageConverter());</span><br><span class="line">messageConverters.add(stringConverter);</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> ResourceHttpMessageConverter());</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> AllEncompassingFormHttpMessageConverter());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (romePresent) &#123;</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> AtomFeedHttpMessageConverter());</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> RssChannelHttpMessageConverter());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (jackson2XmlPresent) &#123;</span><br><span class="line">ObjectMapper objectMapper = Jackson2ObjectMapperBuilder.xml().applicationContext(<span class="keyword">this</span>.applicationContext).build();</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> MappingJackson2XmlHttpMessageConverter(objectMapper));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (jaxb2Present) &#123;</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> Jaxb2RootElementHttpMessageConverter());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (jackson2Present) &#123;</span><br><span class="line">ObjectMapper objectMapper = Jackson2ObjectMapperBuilder.json().applicationContext(<span class="keyword">this</span>.applicationContext).build();</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> MappingJackson2HttpMessageConverter(objectMapper));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (gsonPresent) &#123;</span><br><span class="line">messageConverters.add(<span class="keyword">new</span> GsonHttpMessageConverter());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到很熟悉的 <code>MappingJackson2HttpMessageConverter</code> ，如果我们引入 jackson 相关包，Spring 就会为我们添加该 MessageConverter，但是我们通常在搭建框架的时候还是会手动添加配置 <code>MappingJackson2HttpMessageConverter</code>，为什么？ 先思考一下：</p><blockquote><p>当我们配置了自己的 MessageConverter， SpringMVC 启动过程就不会调用 <code>addDefaultHttpMessageConverters</code> 方法，且看下面代码 <code>if</code> 条件，这样做也是为了定制化我们自己的 MessageConverter</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; getMessageConverters() &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.messageConverters == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">this</span>.messageConverters = <span class="keyword">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;();</span><br><span class="line">configureMessageConverters(<span class="keyword">this</span>.messageConverters);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.messageConverters.isEmpty()) &#123;</span><br><span class="line">addDefaultHttpMessageConverters(<span class="keyword">this</span>.messageConverters);</span><br><span class="line">&#125;</span><br><span class="line">extendMessageConverters(<span class="keyword">this</span>.messageConverters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.messageConverters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="类关系图"><a href="#类关系图" class="headerlink" title="类关系图"></a>类关系图</h3><p>在此处仅列出 <code>MappingJackson2HttpMessageConverter</code> 和 <code>StringHttpMessageConverter</code> 两个转换器，我们发现， 前者实现了 <code>GenericHttpMessageConverter</code> 接口, 而后者却没有，留有这个<strong>关键</strong>印象，这是数据流转过程中关键逻辑判断<br><img src="https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-img2019-05-24-15-41-26.png" alt=""></p><h2 id="数据流转解析"><a href="#数据流转解析" class="headerlink" title="数据流转解析"></a>数据流转解析</h2><p>数据的请求和响应都要经过 <code>DispatcherServlet</code> 类的 <code>doDispatch(HttpServletRequest request, HttpServletResponse response)</code> 方法的处理</p><h3 id="请求过程解析"><a href="#请求过程解析" class="headerlink" title="请求过程解析"></a>请求过程解析</h3><p>看 doDispatch 方法中的关键代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里的 Adapter 实际上是 RequestMappingHandlerAdapter</span></span><br><span class="line">HandlerAdapter ha = <span class="keyword">this</span>.getHandlerAdapter(mappedHandler.getHandler()); </span><br><span class="line"><span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 实际处理的handler</span></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());            mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br></pre></td></tr></table></figure><p>从进入handle之后我先将调用栈粘贴在此处，希望小伙伴可以按照调用栈路线动手跟踪尝试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">readWithMessageConverters:<span class="number">192</span>, AbstractMessageConverterMethodArgumentResolver (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">readWithMessageConverters:<span class="number">150</span>, RequestResponseBodyMethodProcessor (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">resolveArgument:<span class="number">128</span>, RequestResponseBodyMethodProcessor (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">resolveArgument:<span class="number">121</span>, HandlerMethodArgumentResolverComposite (org.springframework.web.method.support)</span><br><span class="line">getMethodArgumentValues:<span class="number">158</span>, InvocableHandlerMethod (org.springframework.web.method.support)</span><br><span class="line">invokeForRequest:<span class="number">128</span>, InvocableHandlerMethod (org.springframework.web.method.support)</span><br><span class="line"> <span class="comment">// 下面的调用栈重点关注，处理请求和返回值的分叉口就在这里</span></span><br><span class="line">invokeAndHandle:<span class="number">97</span>, ServletInvocableHandlerMethod (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">invokeHandlerMethod:<span class="number">849</span>, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handleInternal:<span class="number">760</span>, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handle:<span class="number">85</span>, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method)</span><br><span class="line">doDispatch:<span class="number">967</span>, DispatcherServlet (org.springframework.web.servlet)</span><br></pre></td></tr></table></figure><p>这里重点说明调用栈最顶层 <code>readWithMessageConverters</code> 方法中内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历 messageConverters</span></span><br><span class="line"><span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="keyword">this</span>.messageConverters) &#123;</span><br><span class="line">    Class&lt;HttpMessageConverter&lt;?&gt;&gt; converterType = (Class&lt;HttpMessageConverter&lt;?&gt;&gt;) converter.getClass();</span><br><span class="line">        <span class="comment">// 上文类关系图处要重点记住的地方，主要判断 MappingJackson2HttpMessageConverter 是否是 GenericHttpMessageConverter 类型</span></span><br><span class="line">    <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class="line">        GenericHttpMessageConverter&lt;?&gt; genericConverter = (GenericHttpMessageConverter&lt;?&gt;) converter;</span><br><span class="line">        <span class="keyword">if</span> (genericConverter.canRead(targetType, contextClass, contentType)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Read ["</span> + targetType + <span class="string">"] as \""</span> + contentType + <span class="string">"\" with ["</span> + converter + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (inputMessage.getBody() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                inputMessage = getAdvice().beforeBodyRead(inputMessage, parameter, targetType, converterType);</span><br><span class="line">                body = genericConverter.read(targetType, contextClass, inputMessage);</span><br><span class="line">                body = getAdvice().afterBodyRead(body, inputMessage, parameter, targetType, converterType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                body = getAdvice().handleEmptyBody(<span class="keyword">null</span>, inputMessage, parameter, targetType, converterType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (targetClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (converter.canRead(targetClass, contentType)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Read ["</span> + targetType + <span class="string">"] as \""</span> + contentType + <span class="string">"\" with ["</span> + converter + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (inputMessage.getBody() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                inputMessage = getAdvice().beforeBodyRead(inputMessage, parameter, targetType, converterType);</span><br><span class="line">                body = ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, inputMessage);</span><br><span class="line">                body = getAdvice().afterBodyRead(body, inputMessage, parameter, targetType, converterType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                body = getAdvice().handleEmptyBody(<span class="keyword">null</span>, inputMessage, parameter, targetType, converterType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后就判断是否canRead，能读就read，最终走到下面代码处将输入的内容反序列化出来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">_readMapAndClose</span><span class="params">(JsonParser p0, JavaType valueType)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (JsonParser p = p0) &#123;</span><br><span class="line">            Object result;</span><br><span class="line">            JsonToken t = _initForReading(p);</span><br><span class="line">            <span class="keyword">if</span> (t == JsonToken.VALUE_NULL) &#123;</span><br><span class="line">                <span class="comment">// Ask JsonDeserializer what 'null value' to use:</span></span><br><span class="line">                DeserializationContext ctxt = createDeserializationContext(p,</span><br><span class="line">                        getDeserializationConfig());</span><br><span class="line">                result = _findRootDeserializer(ctxt, valueType).getNullValue(ctxt);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t == JsonToken.END_ARRAY || t == JsonToken.END_OBJECT) &#123;</span><br><span class="line">                result = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                DeserializationConfig cfg = getDeserializationConfig();</span><br><span class="line">                DeserializationContext ctxt = createDeserializationContext(p, cfg);</span><br><span class="line">                JsonDeserializer&lt;Object&gt; deser = _findRootDeserializer(ctxt, valueType);</span><br><span class="line">                <span class="keyword">if</span> (cfg.useRootWrapping()) &#123;</span><br><span class="line">                    result = _unwrapAndDeserialize(p, ctxt, cfg, valueType, deser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = deser.deserialize(p, ctxt);</span><br><span class="line">                &#125;</span><br><span class="line">                ctxt.checkUnresolvedObjectId();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Need to consume the token too</span></span><br><span class="line">            p.clearCurrentToken();</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>到这里从请求中解析参数过程就到此结束了，趁热打铁来看将响应结果返回给前端的过程</p><h3 id="返回过程解析"><a href="#返回过程解析" class="headerlink" title="返回过程解析"></a>返回过程解析</h3><p>在上面调用栈请求和返回结果分叉口处同样处理返回的内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">writeWithMessageConverters:<span class="number">224</span>, AbstractMessageConverterMethodProcessor (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handleReturnValue:<span class="number">174</span>, RequestResponseBodyMethodProcessor (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handleReturnValue:<span class="number">81</span>, HandlerMethodReturnValueHandlerComposite (org.springframework.web.method.support)</span><br><span class="line"><span class="comment">// 分叉口</span></span><br><span class="line">invokeAndHandle:<span class="number">113</span>, ServletInvocableHandlerMethod (org.springframework.web.servlet.mvc.method.annotation)</span><br></pre></td></tr></table></figure><p>重点关注调用栈顶层内容，是不是很熟悉的样子，完全一样的逻辑,  判断是否能写canWrite，能写则write：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; messageConverter : <span class="keyword">this</span>.messageConverters) &#123;</span><br><span class="line">    <span class="keyword">if</span> (messageConverter <span class="keyword">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((GenericHttpMessageConverter) messageConverter).canWrite(</span><br><span class="line">                declaredType, valueType, selectedMediaType)) &#123;</span><br><span class="line">            outputValue = (T) getAdvice().beforeBodyWrite(outputValue, returnType, selectedMediaType,</span><br><span class="line">                    (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line">                    inputMessage, outputMessage);</span><br><span class="line">            <span class="keyword">if</span> (outputValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line">                ((GenericHttpMessageConverter) messageConverter).write(</span><br><span class="line">                        outputValue, declaredType, selectedMediaType, outputMessage);</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Written ["</span> + outputValue + <span class="string">"] as \""</span> + selectedMediaType +</span><br><span class="line">                            <span class="string">"\" using ["</span> + messageConverter + <span class="string">"]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (messageConverter.canWrite(valueType, selectedMediaType)) &#123;</span><br><span class="line">        outputValue = (T) getAdvice().beforeBodyWrite(outputValue, returnType, selectedMediaType,</span><br><span class="line">                (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line">                inputMessage, outputMessage);</span><br><span class="line">        <span class="keyword">if</span> (outputValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line">            ((HttpMessageConverter) messageConverter).write(outputValue, selectedMediaType, outputMessage);</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Written ["</span> + outputValue + <span class="string">"] as \""</span> + selectedMediaType +</span><br><span class="line">                        <span class="string">"\" using ["</span> + messageConverter + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到有这样一行代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">outputValue = (T) getAdvice().beforeBodyWrite(outputValue, returnType, selectedMediaType,</span><br><span class="line">                    (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line">                    inputMessage, outputMessage);</span><br></pre></td></tr></table></figure><p>我们在设计 RESTful API 接口的时候通常会将返回的数据封装成统一格式，通常我们会实现 ResponseBodyAdvice<T> 接口来处理所有 API 的返回值，在真正 write 之前将数据进行统一的封装</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span>()</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResultResponseAdvice</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body, MethodParameter returnType, MediaType selectedContentType,</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType, ServerHttpRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (body <span class="keyword">instanceof</span> CommonResult) &#123;</span><br><span class="line"><span class="keyword">return</span> body;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;Object&gt;(body);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整个处理流程就是这样，整个实现过程细节还需小伙伴自行追踪发现，文章开头我们说过 添加自己的 MessageConverter 能更好的满足我们的定制化，都有哪些可以定制的呢？</p><h2 id="定制化"><a href="#定制化" class="headerlink" title="定制化"></a>定制化</h2><h3 id="空值处理"><a href="#空值处理" class="headerlink" title="空值处理"></a>空值处理</h3><p>请求和返回的数据有很多空值，这些值有时候并没有实际意义，我们可以过滤掉和不返回，或设置成默认值。比如通过重写 <code>getObjectMapper</code> 方法，将返回结果的空值不进行序列化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">converters.add(<span class="number">0</span>, <span class="keyword">new</span> MappingJackson2HttpMessageConverter()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectMapper <span class="title">getObjectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.getObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.getObjectMapper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="XSS-脚本攻击"><a href="#XSS-脚本攻击" class="headerlink" title="XSS 脚本攻击"></a>XSS 脚本攻击</h3><p>为了保证输入的数据更安全，防止 XSS 脚本攻击，我们可以添加自定义反序列化器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对应无法直接返回String类型</span></span><br><span class="line">converters.add(<span class="number">0</span>, <span class="keyword">new</span> MappingJackson2HttpMessageConverter()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectMapper <span class="title">getObjectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.getObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// XSS 脚本过滤</span></span><br><span class="line">        SimpleModule simpleModule = <span class="keyword">new</span> SimpleModule();</span><br><span class="line">        simpleModule.addDeserializer(String.class, <span class="keyword">new</span> StringXssDeserializer());</span><br><span class="line">        <span class="keyword">super</span>.getObjectMapper().registerModule(simpleModule);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getObjectMapper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="细节分析"><a href="#细节分析" class="headerlink" title="细节分析"></a>细节分析</h2><p>canRead 和 canWrite 的判断逻辑是什么呢？ 请看下图：</p><p><img src="https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-img2019-05-24-20-34-47.png" alt=""></p><p>客户端 Request Header 中设置好 Content-Type（传入的数据格式）和Accept（接收的数据格式），根据配置好的MessageConverter来判断是否 canRead 或 canWrite，然后决定 response.body 的 Content-Type 的第一要素是对应的request.headers.Accept 属性的值，又叫做 MediaType。如果服务端支持这个 Accept，那么应该按照这个 Accept 来确定返回response.body 对应的格式，同时把 response.headers.Content-Type 设置成自己支持的符合那个 Accept 的 MediaType</p><h2 id="总结与思考"><a href="#总结与思考" class="headerlink" title="总结与思考"></a>总结与思考</h2><p>站在上帝视角看，整个流程可以按照下图进行概括，请求报文先转换成 HttpInputMessage, 然后再通过 HttpMessageConverter 将其转换成 SpringMVC 的 java 对象，反之亦然。</p><p><img src="https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-img2019-05-26-10-25-17.png" alt=""></p><p>将各种常用 HttpMessageConverter 支持的MediaType 和 JavaType 以及对应关系总结在此处：</p><table><thead><tr><th align="left">类名</th><th align="left">支持的JavaType</th><th align="left">支持的MediaType</th></tr></thead><tbody><tr><td align="left">ByteArrayHttpMessageConverter</td><td align="left">byte[]</td><td align="left">application/octet-stream, */*</td></tr><tr><td align="left">StringHttpMessageConverter</td><td align="left">String</td><td align="left">text/plain, */*</td></tr><tr><td align="left">MappingJackson2HttpMessageConverter</td><td align="left">Object</td><td align="left">application/json, application/*+json</td></tr><tr><td align="left">AllEncompassingFormHttpMessageConverter</td><td align="left">Map&lt;K, List&lt;?&gt;&gt;</td><td align="left">application/x-www-form-urlencoded, multipart/form-data</td></tr><tr><td align="left">SourceHttpMessageConverter</td><td align="left">Source</td><td align="left">application/xml, text/xml, application/*+xml</td></tr></tbody></table><p>最后思考这样一个问题：为什么 HttpMessageConverter 在写的过程中，先判断 canWrite 后判断是否有 responseBodyAdvice 的数据封装呢？ 如果先进行 responseBodyAdvice 的数据封装后判断 canWrite 会怎样呢？ </p><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p>依旧介绍写该文章用到的一些好的工具</p><h3 id="processon"><a href="#processon" class="headerlink" title="processon"></a>processon</h3><p>ProcessOn是一个在线作图工具的聚合平台，它可以在线画流程图、思维导图、UI原型图、UML、网络拓扑图、组织结构图等等，<br>您无需担心下载和更新的问题，不管Mac还是Windows，一个浏览器就可以随时随地的发挥创意，规划工作，同时您可以把作品分享给团队成员或好友，无论何时何地大家都可以对作品进行编辑、阅读和评论</p><p><img src="https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-img2019-05-26-10-40-06.jpg" alt=""></p><h3 id="SequenceDiagram"><a href="#SequenceDiagram" class="headerlink" title="SequenceDiagram"></a>SequenceDiagram</h3><p><a href="https://plugins.jetbrains.com/plugin/8286-sequencediagram" target="_blank" rel="noopener">SequenceDiagram</a> 是 IntelliJ IDEA 的一个插件，有了这个插件，你可以</p><ol><li>生成简单序列图。</li><li>单击图形形状来导航代码。</li><li>从图中删除类。</li><li>将图表导出为图像。</li><li>通过“设置”&gt;“其他设置”&gt;“序列”从图表中排除类</li></ol><p>方便快速的定位方法和理解类的调用过程</p><p><img src="https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-img2019-05-26-10-43-55.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> HTTP </tag>
            
            <tag> MessageConverter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java12 Collectors.teeing 的使用详解</title>
      <link href="//p/jdk12-collectors-teeing-api-usage.html"/>
      <url>//p/jdk12-collectors-teeing-api-usage.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 Java 12 里面有个非常好用但在官方 JEP 没有公布的功能，因为它只是 Collector 中的一个小改动，它的作用是 merge 两个 collector 的结果，这句话显得很抽象，老规矩，我们先来看个图:<br><img src="https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-imgtee.jpg" alt=""></p><p>管道改造经常会用这个小东西，通常我们叫它「三通」，它的主要作用就是将 downstream1 和 downstream2 的流入合并，然后从 merger 流出</p><p>有了这个形象的说明我们就进入正题吧</p><h2 id="Collectors-teeing"><a href="#Collectors-teeing" class="headerlink" title="Collectors.teeing"></a>Collectors.teeing</h2><p>上面提到的小功能就是 Collectors.teeing API, 先来看一下 JDK 关于该 API 的说明，<strong>看着觉得难受的直接忽略，继续向下看例子就好了:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a &#123;<span class="doctag">@code</span> Collector&#125; that is a composite of two downstream collectors.</span></span><br><span class="line"><span class="comment"> * Every element passed to the resulting collector is processed by both downstream</span></span><br><span class="line"><span class="comment"> * collectors, then their results are merged using the specified merge function</span></span><br><span class="line"><span class="comment"> * into the final result.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The resulting collector functions do the following:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;supplier: creates a result container that contains result containers</span></span><br><span class="line"><span class="comment"> * obtained by calling each collector's supplier</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;accumulator: calls each collector's accumulator with its result container</span></span><br><span class="line"><span class="comment"> * and the input element</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;combiner: calls each collector's combiner with two result containers</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;finisher: calls each collector's finisher with its result container,</span></span><br><span class="line"><span class="comment"> * then calls the supplied merger and returns its result.</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The resulting collector is &#123;<span class="doctag">@link</span> Collector.Characteristics#UNORDERED&#125; if both downstream</span></span><br><span class="line"><span class="comment"> * collectors are unordered and &#123;<span class="doctag">@link</span> Collector.Characteristics#CONCURRENT&#125; if both downstream</span></span><br><span class="line"><span class="comment"> * collectors are concurrent.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;         the type of the input elements</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;R1&gt;        the result type of the first collector</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;R2&gt;        the result type of the second collector</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;R&gt;         the final result type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> downstream1 the first downstream collector</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> downstream2 the second downstream collector</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> merger      the function which merges two results into the single one</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> Collector&#125; which aggregates the results of two supplied collectors.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T, R1, R2, R&gt;</span><br><span class="line">Collector&lt;T, ?, R&gt; teeing(Collector&lt;? <span class="keyword">super</span> T, ?, R1&gt; downstream1,</span><br><span class="line">                          Collector&lt;? <span class="keyword">super</span> T, ?, R2&gt; downstream2,</span><br><span class="line">                          BiFunction&lt;? <span class="keyword">super</span> R1, ? <span class="keyword">super</span> R2, R&gt; merger) &#123;</span><br><span class="line">    <span class="keyword">return</span> teeing0(downstream1, downstream2, merger);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>API 描述重的一句话非常关键:</p><blockquote><p> <em>Every element passed to the resulting collector is processed by both downstream collectors</em><br> 结合「三通图」来说明就是，集合中每一个要被传入 merger 的元素都会经过 downstream1 和 downstream2 的加工处理</p></blockquote><p><strong>其中 merger 类型是 BiFunction，也就是说接收两个参数，并输出一个值，请看它的 apply 方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BiFunction</span>&lt;<span class="title">T</span>, <span class="title">U</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Applies this function to the given arguments.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the first function argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> u the second function argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the function result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">R <span class="title">apply</span><span class="params">(T t, U u)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至于可以如何处理，我们来看一些例子吧</p><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>为了更好的说明 teeing 的使用，列举了四个例子，看过这四个例子再回看上面的 API 说明，相信你会柳暗花明了</p><h3 id="计数和累加"><a href="#计数和累加" class="headerlink" title="计数和累加"></a>计数和累加</h3><p>先来看一个经典的问题，给定的数字集合，需要映射整数流中的元素数量和它们的和</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountSum</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Long count;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Integer sum;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountSum</span><span class="params">(Long count, Integer sum)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.count = count;</span><br><span class="line"><span class="keyword">this</span>.sum = sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"CountSum&#123;"</span> +</span><br><span class="line"><span class="string">"count="</span> + count +</span><br><span class="line"><span class="string">", sum="</span> + sum +</span><br><span class="line"><span class="string">'&#125;'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 Collectors.teeing 处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CountSum countsum = Stream.of(<span class="number">2</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">12</span>)</span><br><span class="line">        .collect(Collectors.teeing(</span><br><span class="line">                counting(),</span><br><span class="line">                summingInt(e -&gt; e),</span><br><span class="line">                CountSum::<span class="keyword">new</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(countsum.toString());</span><br></pre></td></tr></table></figure><ul><li>downstream1 通过 Collectors 的静态方法 counting 进行集合计数</li><li>downstream2 通过 Collectors 的静态方法 summingInt 进行集合元素值的累加</li><li>merger 通过 CountSum 构造器收集结果</li></ul><p>运行结果:</p><blockquote><p> CountSum{count=7, sum=46}</p></blockquote><p>我们通过 teeing 一次性得到我们想要的结果，继续向下看其他例子:</p><h3 id="最大值与最小值"><a href="#最大值与最小值" class="headerlink" title="最大值与最小值"></a>最大值与最小值</h3><p>通过给定的集合， 一次性计算出集合的最大值与最小值，同样新建一个类 MinMax，并创建构造器用于 merger 收集结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinMax</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Integer min;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Integer max;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MinMax</span><span class="params">(Integer min, Integer max)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.min = min;</span><br><span class="line"><span class="keyword">this</span>.max = max;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"MinMax&#123;"</span> +</span><br><span class="line"><span class="string">"min="</span> + min +</span><br><span class="line"><span class="string">", max="</span> + max +</span><br><span class="line"><span class="string">'&#125;'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 teeing API 计算结果:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MinMax minmax = Stream.of(<span class="number">2</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">12</span>)</span><br><span class="line">        .collect(Collectors.teeing(</span><br><span class="line">                minBy(Comparator.naturalOrder()),</span><br><span class="line">                maxBy(Comparator.naturalOrder()),</span><br><span class="line">                (Optional&lt;Integer&gt; a, Optional&lt;Integer&gt; b) -&gt; <span class="keyword">new</span> MinMax(a.orElse(Integer.MIN_VALUE), b.orElse(Integer.MAX_VALUE))));</span><br><span class="line"></span><br><span class="line">System.out.println(minmax.toString());</span><br></pre></td></tr></table></figure><ul><li>downstream1 通过 Collectors 的静态方法 minBy，通过 Comparator 比较器按照自然排序找到最小值</li><li>downstream2 通过 Collectors 的静态方法 maxBy，通过 Comparator 比较器按照自然排序找到最大值</li><li>merger 通过 MinMax 构造器收集结果，只不过为了应对 NPE，将 BiFunction 的两个入参经过 Optional 处理</li></ul><p>运行结果:</p><blockquote><p> MinMax{min=1, max=12}</p></blockquote><p>为了验证一下 Optional，我们将集合中添加一个 null 元素，并修改一下排序规则来看一下排序结果:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MinMax minmax = Stream.of(<span class="keyword">null</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">12</span>)</span><br><span class="line">.collect(Collectors.teeing(</span><br><span class="line">minBy(Comparator.nullsFirst(Comparator.naturalOrder())),</span><br><span class="line">maxBy(Comparator.nullsLast(Comparator.naturalOrder())),</span><br><span class="line">(Optional&lt;Integer&gt; a, Optional&lt;Integer&gt; b) -&gt; <span class="keyword">new</span> MinMax(a.orElse(Integer.MIN_VALUE), b.orElse(Integer.MAX_VALUE))));</span><br></pre></td></tr></table></figure><ul><li>downstream1 处理规则是将 null 放在排序的最前面</li><li>downstream2 处理规则是将 null 放在排序的最后面</li><li>merger 处理时，都会执行 optional.orElse 方法，分别输出最小值与最大值</li></ul><p>运行结果:</p><blockquote><p> MinMax{min=-2147483648, max=2147483647}</p></blockquote><h3 id="瓜的总重和单个重量"><a href="#瓜的总重和单个重量" class="headerlink" title="瓜的总重和单个重量"></a>瓜的总重和单个重量</h3><p>接下来举一个更贴合实际的操作对象的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义瓜的类型和重量</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Melon</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> weight;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Melon</span><span class="params">(String type, <span class="keyword">int</span> weight)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.type = type;</span><br><span class="line"><span class="keyword">this</span>.weight = weight;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> weight;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 总重和单个重量列表</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeightsAndTotal</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> totalWeight;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; weights;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WeightsAndTotal</span><span class="params">(<span class="keyword">int</span> totalWeight, List&lt;Integer&gt; weights)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.totalWeight = totalWeight;</span><br><span class="line"><span class="keyword">this</span>.weights = weights;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"WeightsAndTotal&#123;"</span> +</span><br><span class="line"><span class="string">"totalWeight="</span> + totalWeight +</span><br><span class="line"><span class="string">", weights="</span> + weights +</span><br><span class="line"><span class="string">'&#125;'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 teeing API 计算总重量和单个列表重量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Melon&gt; melons = Arrays.asList(<span class="keyword">new</span> Melon(<span class="string">"Crenshaw"</span>, <span class="number">1200</span>),</span><br><span class="line">    <span class="keyword">new</span> Melon(<span class="string">"Gac"</span>, <span class="number">3000</span>), <span class="keyword">new</span> Melon(<span class="string">"Hemi"</span>, <span class="number">2600</span>),</span><br><span class="line">    <span class="keyword">new</span> Melon(<span class="string">"Hemi"</span>, <span class="number">1600</span>), <span class="keyword">new</span> Melon(<span class="string">"Gac"</span>, <span class="number">1200</span>),</span><br><span class="line">    <span class="keyword">new</span> Melon(<span class="string">"Apollo"</span>, <span class="number">2600</span>), <span class="keyword">new</span> Melon(<span class="string">"Horned"</span>, <span class="number">1700</span>),</span><br><span class="line">    <span class="keyword">new</span> Melon(<span class="string">"Gac"</span>, <span class="number">3000</span>), <span class="keyword">new</span> Melon(<span class="string">"Hemi"</span>, <span class="number">2600</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WeightsAndTotal weightsAndTotal = melons.stream()</span><br><span class="line">    .collect(Collectors.teeing(</span><br><span class="line">            summingInt(Melon::getWeight),</span><br><span class="line">            mapping(m -&gt; m.getWeight(), toList()),</span><br><span class="line">            WeightsAndTotal::<span class="keyword">new</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(weightsAndTotal.toString());</span><br></pre></td></tr></table></figure><ul><li>downstream1 通过 Collectors 的静态方法 summingInt 做重量累加</li><li>downstream2 通过 Collectors 的静态方法 mapping 提取出瓜的重量，并通过流的终结操作 toList() 获取结果</li><li>merger 通过 WeightsAndTotal 构造器获取结果</li></ul><p>运行结果:</p><blockquote><p> WeightsAndTotal{totalWeight=19500, weights=[1200, 3000, 2600, 1600, 1200, 2600, 1700, 3000, 2600]}</p></blockquote><p>继续一个更贴合实际的例子吧:</p><h3 id="预约人员列表和预约人数"><a href="#预约人员列表和预约人数" class="headerlink" title="预约人员列表和预约人数"></a>预约人员列表和预约人数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Guest</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> participating;</span><br><span class="line"><span class="keyword">private</span> Integer participantsNumber;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Guest</span><span class="params">(String name, <span class="keyword">boolean</span> participating, Integer participantsNumber)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="keyword">this</span>.participating = participating;</span><br><span class="line"><span class="keyword">this</span>.participantsNumber = participantsNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isParticipating</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> participating;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">getParticipantsNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> participantsNumber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventParticipation</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; guestNameList;</span><br><span class="line"><span class="keyword">private</span> Integer totalNumberOfParticipants;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventParticipation</span><span class="params">(List&lt;String&gt; guestNameList, Integer totalNumberOfParticipants)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.guestNameList = guestNameList;</span><br><span class="line"><span class="keyword">this</span>.totalNumberOfParticipants = totalNumberOfParticipants;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"EventParticipation &#123; "</span> +</span><br><span class="line"><span class="string">"guests = "</span> + guestNameList +</span><br><span class="line"><span class="string">", total number of participants = "</span> + totalNumberOfParticipants +</span><br><span class="line"><span class="string">" &#125;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 teeing API 处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = Stream.of(</span><br><span class="line">                <span class="keyword">new</span> Guest(<span class="string">"Marco"</span>, <span class="keyword">true</span>, <span class="number">3</span>),</span><br><span class="line">                <span class="keyword">new</span> Guest(<span class="string">"David"</span>, <span class="keyword">false</span>, <span class="number">2</span>),</span><br><span class="line">                <span class="keyword">new</span> Guest(<span class="string">"Roger"</span>,<span class="keyword">true</span>, <span class="number">6</span>))</span><br><span class="line">                .collect(Collectors.teeing(</span><br><span class="line">                        Collectors.filtering(Guest::isParticipating, Collectors.mapping(Guest::getName, Collectors.toList())),</span><br><span class="line">                        Collectors.summingInt(Guest::getParticipantsNumber),</span><br><span class="line">                        EventParticipation::<span class="keyword">new</span></span><br><span class="line">                ));</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><ul><li>downstream1 通过 filtering 方法过滤出确定参加的人，并 mapping 出他们的姓名，最终放到 toList 集合中</li><li>downstream2 通过 summingInt 方法计数累加</li><li>merger 通过 EventParticipation 构造器收集结果</li></ul><p>其中我们定义了 var result 来收集结果，并没有指定类型，这个语法糖也加速了我们编程的效率</p><p>运行结果:</p><blockquote><p> EventParticipation { guests = [Marco, Roger], total number of participants = 11 }</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实 teeing API 就是灵活应用 Collectors 里面定义的静态方法，将集合元素通过 downstream1 和 downstream2 进行处理，最终通过 merger 收集起来，当项目中有同时获取两个收集结果时，是时候应用我们的 teeing API 了</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>Collectors 里面的静态方法你应用的熟练吗？</li><li>项目中你们在用 JDK 的版本是多少？</li><li>Lambda 的使用熟练吗？</li><li>你的灯还亮着吗？</li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JDK源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java并发死锁解决思路</title>
      <link href="//p/java-concurrency-dead-lock.html"/>
      <url>//p/java-concurrency-dead-lock.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>上一篇文章<a href="https://dayarch.top/p/33b9e35c.html">共享资源那么多，如何用一把锁保护多个资源？</a> 文章我们谈到了银行转账经典案例，其中有两个问题:</p><ol><li>单纯的用 synchronized 方法起不到保护作用(不能保护 target)</li><li>用 Account.class 锁方案，锁的粒度又过大，导致涉及到账户的所有操作(取款，转账，修改密码等)都会变成串行操作</li></ol><p>如何解决这两个问题呢？咱们先换好衣服穿越回到过去寻找一下钱庄，一起透过现象看本质，dengdeng deng…….</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/2019-10-17-16-08-25.png" alt=""></p><p>来到钱庄，告诉柜员你要给铁蛋儿转 100 铜钱，这时柜员转身在墙上寻找你和铁蛋儿的账本，此时柜员可能面临三种情况:</p><ol><li>理想状态: 你和铁蛋儿的账本都是空闲状态，一起拿回来，在你的账本上减 100 铜钱，在铁蛋儿账本上加 100 铜钱，柜员转身将账本挂回到墙上，完成你的业务</li><li>尴尬状态: 你的账本在，铁蛋儿的账本被其他柜员拿出去给别人转账，你要等待其他柜员把铁蛋儿的账本归还</li><li>抓狂状态: 你的账本不在，铁蛋儿的账本也不在，你只能等待两个账本都归还</li></ol><p>放慢柜员的取账本操作，他一定是先拿到你的账本，然后再去拿铁蛋儿的账本，两个账本都拿到(理想状态)之后才能完成转账，用程序模型来描述一下这个拿取账本的过程:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E6%AD%BB%E9%94%81%20%281%29.png" alt=""></p><p>我们继续用程序代码描述一下上面这个模型:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> balance;</span><br><span class="line">  <span class="comment">// 转账</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amt)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 锁定转出账户</span></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;              </span><br><span class="line">      <span class="comment">// 锁定转入账户</span></span><br><span class="line">      <span class="keyword">synchronized</span>(target) &#123;           </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.balance &gt; amt) &#123;</span><br><span class="line">          <span class="keyword">this</span>.balance -= amt;</span><br><span class="line">          target.balance += amt;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个解决方案看起来很完美，解决了文章开头说的两个问题，但真是这样吗？</p><hr><p>我们刚刚说过的理想状态是钱庄只有一个柜员(既单线程)。随着钱庄规模变大，墙上早已挂了非常多个账本，钱庄为了应对繁忙的业务，开通了多个窗口，此时有多个柜员(多线程)处理钱庄业务。</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/2019-10-17-18-42-42.png" alt=""></p><p>柜员 1 正在办理给铁蛋儿转账的业务，但只拿到了你的账本；柜员 2 正在办理铁蛋儿给你转账的业务，但只拿到了铁蛋儿的账本，此时双方出现了尴尬状态，两位柜员都在等待对方归还账本为当前客户办理转账业务。</p><p><img src="https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-imgbank.png" alt=""></p><p>现实中柜员会沟通，喊出一嗓子 <strong><em>老铁，铁蛋儿的账本先给我用一下，用完还给你</em></strong>，但程序却没这么智能，synchronized 内置锁非常执着，它会告诉你「死等」的道理，最终出现死锁</p><blockquote><p> Java 有了 synchronized 内置锁，还发明了显示锁 Lock，是不是就为了治一治 synchronized 「死等」的执着呢？😏</p></blockquote><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>如何解决上面的问题呢？正所谓知己知彼方能百战不殆，我们要先了解什么情况会发生死锁，才能知道如何避免死锁，很幸运我们可以站在巨人的肩膀上看待问题</p><p><code>Coffman</code> 总结出了四个条件说明可以发生死锁的情形:</p><h4 id="Coffman-条件"><a href="#Coffman-条件" class="headerlink" title="Coffman 条件"></a>Coffman 条件</h4><p><strong>互斥条件：</strong>指进程对所分配到的资源进行排它性使用，即在一段时间内某资源只由一个进程占用。如果此时还有其它进程请求资源，则请求者只能等待，直至占有资源的进程用毕释放。</p><p><strong>请求和保持条件：</strong>指进程已经保持至少一个资源，但又提出了新的资源请求，而该资源已被其它进程占有，此时请求进程阻塞，但又对自己已获得的其它资源保持不放。</p><p><strong>不可剥夺条件：</strong>指进程已获得的资源，在未使用完之前，不能被剥夺，只能在使用完时由自己释放。</p><p><strong>环路等待条件：</strong>指在发生死锁时，必然存在一个进程——资源的环形链，即进程集合{P1，P2，···，Pn}中的 P1 正在等待一个 P2 占用的资源；P2 正在等待 P3 占用的资源，……，Pn 正在等待已被 P0 占用的资源。</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E7%8E%AF%E5%BD%A2.png" alt=""></p><p>这几个条件很好理解，其中「互斥条件」是并发编程的根基，这个条件没办法改变。但其他三个条件都有改变的可能，也就是说破坏另外三个条件就不会出现上面说到的死锁问题</p><h4 id="破坏请求和保持条件"><a href="#破坏请求和保持条件" class="headerlink" title="破坏请求和保持条件"></a>破坏请求和保持条件</h4><p>每个柜员都可以取放账本，很容易出现互相等待的情况。要想破坏请求和保持条件，就要一次性拿到所有资源。</p><p>作为程序猿你一定听过这句话:</p><blockquote><p> 任何软件工程遇到的问题都可以通过增加一个中间层来解决</p></blockquote><p>我们不允许柜员都可以取放账本，账本要由单独的账本管理员来管理</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E8%B4%A6%E6%9C%AC%E7%AE%A1%E7%90%86%E5%91%98.png" alt=""></p><p>也就是说账本管理员拿取账本是临界区，如果只拿到其中之一的账本，那么不会给柜员，而是等待柜员下一次询问是否两个账本都在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//账本管理员</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountBookManager</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">getAllRequiredAccountBook</span><span class="params">( Object from, Object to)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(拿到所有账本)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 归还资源</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">releaseObtainedAccountBook</span><span class="params">(Object from, Object to)</span></span>&#123;</span><br><span class="line">归还获取到的账本</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line"><span class="comment">//单例的账本管理员</span></span><br><span class="line"><span class="keyword">private</span> AccountBookManager accountBookManager;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amt)</span></span>&#123;</span><br><span class="line"><span class="comment">// 一次性申请转出账户和转入账户，直到成功</span></span><br><span class="line"><span class="keyword">while</span>(!accountBookManager.getAllRequiredAccountBook(<span class="keyword">this</span>, target))&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">// 锁定转出账户</span></span><br><span class="line"><span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line"><span class="comment">// 锁定转入账户</span></span><br><span class="line"><span class="keyword">synchronized</span>(target)&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.balance &gt; amt)&#123;</span><br><span class="line"><span class="keyword">this</span>.balance -= amt;</span><br><span class="line">target.balance += amt;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">accountBookManager.releaseObtainedAccountBook(<span class="keyword">this</span>, target);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="破坏不可剥夺条件"><a href="#破坏不可剥夺条件" class="headerlink" title="破坏不可剥夺条件"></a>破坏不可剥夺条件</h4><p>上面已经给了你小小的提示，为了解决内置锁的执着，Java 显示锁支持通知(notify/notifyall)和等待(wait)，也就是说该功能可以实现喊一嗓子 <strong><em>老铁，铁蛋儿的账本先给我用一下，用完还给你</em></strong> 的功能，这个后续将到 Java SDK 相关内容时会做说明</p><h4 id="破坏环路等待条件"><a href="#破坏环路等待条件" class="headerlink" title="破坏环路等待条件"></a>破坏环路等待条件</h4><p>破坏环路等待条件也很简单，我们只需要将资源序号大小排序获取就会解决这个问题，将环路拆除</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E6%8E%92%E5%BA%8F.png" alt=""></p><p>继续用代码来说明:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> balance;</span><br><span class="line">  <span class="comment">// 转账</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amt)</span></span>&#123;</span><br><span class="line">    Account smaller = <span class="keyword">this</span>        </span><br><span class="line">    Account larger = target;    </span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.id &gt; target.id) &#123; </span><br><span class="line">      smaller = target;           </span><br><span class="line">      larger = <span class="keyword">this</span>;            </span><br><span class="line">    &#125;                          </span><br><span class="line">    <span class="comment">// 锁定序号小的账户</span></span><br><span class="line">    <span class="keyword">synchronized</span>(smaller)&#123;</span><br><span class="line">      <span class="comment">// 锁定序号大的账户</span></span><br><span class="line">      <span class="keyword">synchronized</span>(larger)&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.balance &gt; amt)&#123;</span><br><span class="line">          <span class="keyword">this</span>.balance -= amt;</span><br><span class="line">          target.balance += amt;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当 smaller 被占用时，其他线程就会被阻塞，也就不会存在死锁了. </p><h2 id="附加说明"><a href="#附加说明" class="headerlink" title="附加说明"></a>附加说明</h2><p>在实际业务中，关于 Account 都会是数据库对象，我们可以通过事务或数据库的乐观锁来解决的。另外分布式系统中，账本管理员这个角色的处理也可能会用 redis 分布式锁来解决. </p><p>在处理破坏请求和保持条件时，我们使用的是 while 循环方式来不断请求锁的时候，在实际业务中，我们会有 timeout 的设置，防止无休止的浪费 CPU 使用率</p><p>另外大家可以尝试使用阿里开源工具 Arthas 来查看 CPU 使用率，线程等相关问题，github 上有明确的说明</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>计算机的计算能力远远超过人类，但是他的智慧还需要有带提高，当看待并发问题时，我们往往认为人类的最基本沟通计算机也可以做到，其实不然，还是那句话，编写并发程序，要站在计算机的角度来看待问题</p><p>粗粒度锁我们不提倡，所以会使用细粒度锁，但使用细粒度锁的时候，我们要严格按照 Coffman 的四大条件来逐条判断，这样再应用我们这几个解决方案来解决就好了</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>破坏请求和保持条件时，处理能力的瓶颈在账本管理员那里，那你觉得这种处理方式会提高并发量吗？</li><li>破坏请求保持条件的方法和破坏环路等待的方法，你觉得那种方式更好</li><li>破坏请求和保持条件时，如果代码换成下面的样子会发生什么？</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amt)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 一次性申请转出账户和转入账户，直到成功</span></span><br><span class="line">    <span class="keyword">while</span>(accountBookManager.getAllRequiredAccountBook(<span class="keyword">this</span>, target))&#123;&#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 锁定转出账户</span></span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="comment">// 锁定转入账户</span></span><br><span class="line">                <span class="keyword">synchronized</span>(target)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.balance &gt; amt)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.balance -= amt;</span><br><span class="line">                        target.balance += amt;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            accountBookManager.releaseObtainedAccountBook(<span class="keyword">this</span>, target);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""> </p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ol><li><a href="https://dayarch.top/p/d7e125a1.html">这次走进并发的世界，请不要错过</a></li><li><a href="https://dayarch.top/p/86243a5b.html">学并发编程，透彻理解这三个核心是关键</a></li><li><a href="https://dayarch.top/p/6d12b8cf.html">并发Bug之源有三，请睁大眼睛看清它们</a></li><li><a href="https://dayarch.top/p/815d7647.html">可见性有序性，Happens-before来搞定</a></li><li><a href="https://dayarch.top/p/32b8e26a.html">解决原子性问题？你首先需要的是宏观理解</a></li><li><a href="https://dayarch.top/p/fb3c7eeb.html">面试并发volatile关键字时，我们应该具备哪些谈资？</a></li></ol><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享 </li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答 </li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 死锁 </tag>
            
            <tag> 锁粒度 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 自定义starter 全面教程</title>
      <link href="//p/spring-boot-starter-custom.html"/>
      <url>//p/spring-boot-starter-custom.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>我们每次构建一个 Spring 应用程序时，我们都不希望从头开始实现具有「横切关注点」的内容；相反，我们希望一次性实现这些功能，并根据需要将它们包含到任何我们要构建的应用程序中</p><blockquote><h4 id="横切关注点"><a href="#横切关注点" class="headerlink" title="横切关注点"></a>横切关注点</h4><p> 横切关注点: 指的是一些具有横越多个模块的行为 (来自维基百科的介绍)<br> <strong>说白了就是多个项目或模块都可以用到的内容，比如一个 SDK</strong></p></blockquote><p>在Spring Boot中，用于表示提供这种横切关注点的模块的术语是 <strong>starter</strong>，通过依赖 starter 可以轻松使用其包含的一些功能特性，<strong>无论你的工作中是否会构建自己的 starter，你都要具有构建 「starter」的思想</strong>，本文将结合 Spring Boot 官方标准构建一个简单的 starter</p><h2 id="自定义-starter"><a href="#自定义-starter" class="headerlink" title="自定义 starter"></a>自定义 starter</h2><p>在我们深入了解如何自定义 starter 之前，为了更好的理解我们每一步在干什么，以及 starter 是如何起作用的，我们先从宏观角度来看 starter 的结构组成到底是什么样的</p><p>通常一个完整的 starter 需要包含下面两个组件:</p><ol><li>Auto-Configure Module</li><li>Starter Module</li></ol><p>如果你看下面这两个组件的解释有些抽象，大概了解一下，阅读完该文章回看这里就会豁然开朗了</p><h3 id="Auto-Configure-Module"><a href="#Auto-Configure-Module" class="headerlink" title="Auto-Configure Module"></a>Auto-Configure Module</h3><p>Auto-Configure Module (自动配置模块) 是包含自动配置类的 Maven 或 Gradle 模块。通过这种方式，<strong>我们可以构建可以自动贡献于应用程序上下文的模块，以及添加某个特性或提供对某个外部库的访问</strong></p><h3 id="Starter-Module"><a href="#Starter-Module" class="headerlink" title="Starter Module"></a>Starter Module</h3><p>Spring Boot Starter 是一个 Maven 或 Gradle 模块，其唯一目的是提供 “启动” 某个特性所需的所有依赖项。可以包含一个或多个 Auto-Configure Module (自动配置模块)的依赖项，以及可能需要的任何其他依赖项。这样，在Spring 启动应用程序中，我们只需要添加这个 starter 依赖就可以使用其特性</p><blockquote><p> ⚠️: Spring 官方参考手册建议将自动配置分离，并将每个自动配置启动到一个独立的 Maven 或 Gradle 模块中，从而将自动配置和依赖项管理分离开来。如果你没有建立一个供成千上万用户使用的开源库，也可以将二者合并到一个 module 中<br> <em>You may combine the auto-configuration code and the dependency management in a single module if you do not need to separate those two concerns</em></p></blockquote><h3 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h3><p>来自 Spring 官方的 starter 都是 以 <code>spring-boot-starter</code> 开头，比如:</p><ul><li>spring-boot-starter-web</li><li>spring-boot-starter-aop</li></ul><p>如果我们自定义 starter 功能名称叫<code>acme</code>，那么我们的命名是这样的:</p><ul><li>acme-spring-boot-starter</li><li>acme-spring-boot-autoconfigure</li></ul><p>如果 starter 中用到了配置 keys，也要注意不要使用 Spring Boot 使用的命名空间，比如(server，management，spring)</p><h3 id="Parent-Module-创建"><a href="#Parent-Module-创建" class="headerlink" title="Parent Module 创建"></a>Parent Module 创建</h3><p>先来全局看一下项目结构:<br>一级目录结构:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── pom.xml</span><br><span class="line">├── rgyb-spring-boot-autoconfigure</span><br><span class="line">├── rgyb-spring-boot-sample</span><br><span class="line">└── rgyb-spring-boot-starter</span><br></pre></td></tr></table></figure><p>二级目录结构:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── pom.xml</span><br><span class="line">├── rgyb-spring-boot-autoconfigure</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src</span><br><span class="line">├── rgyb-spring-boot-sample</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src</span><br><span class="line">└── rgyb-spring-boot-starter</span><br><span class="line">    ├── pom.xml</span><br><span class="line">    └── src</span><br></pre></td></tr></table></figure><p>创建一个空的父亲 Maven Module，主要提供依赖管理，这样 SubModule 不用单独维护依赖版本号，来看 pom.xml 内容:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--  添加其他全局依赖管理到这里，submodule默认不引入这些依赖，需要显式的指定  --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Auto-Configure-Module-构建"><a href="#Auto-Configure-Module-构建" class="headerlink" title="Auto-Configure Module 构建"></a>Auto-Configure Module 构建</h3><p>新建类 <code>GreetingAutoConfiguration</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreetingAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GreetingService <span class="title">greetingService</span><span class="params">(GreetingProperties greetingProperties)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> GreetingService(greetingProperties.getMembers());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们用 <code>@Configuration</code> 注解标记类 GreetingAutoConfiguration，作为 starter 的入口点。这个配置包含了我们需要提供starter特性的所有 <code>@Bean</code> 定义，在本例中，为了简单阐述问题，我们只将 GreetingService Bean 添加到应用程序上下文</p><p>GreetingService 内容如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreetingService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; members = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">members.forEach(s -&gt; System.out.println(<span class="string">"hello "</span> + s));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 resources 目录下新建文件 <code>META-INF/spring.factories</code> (如果目录 <code>META-INF</code> 不存在需要手工创建)，向文件写入内容:</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"> <span class="attr">top.dayarch.autoconfigure.GreetingAutoConfiguration</span></span><br></pre></td></tr></table></figure><p>Spring 启动时会在其 classpath 中所有的 <code>spring.factoreis</code> 文件，并加载里面的声明配置，GreetingAutoConfiguration 类就绪后，我们的 Spring Boot Starter 就有了一个自动激活的入口点</p><p>到这里这个 “不完全的 starter” 已经可以使用了。但因为它是自动激活的，为了个让其灵活可用，我们需要让其按照我们的意愿来激活使用，所以我们需要条件注解来帮忙</p><h4 id="条件配置"><a href="#条件配置" class="headerlink" title="条件配置"></a>条件配置</h4><p>为类添加两个条件注解:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"rgyb.greeting.enable"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(DummyEmail.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreetingAutoConfiguration</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>通过使用 <code>@ConditionalOnProperty</code> 注解，我们告诉 Spring，只有属性 <code>rgyb.greeting.enable</code> 值被设置为 true 时，才将 GreetingAutoConfiguration (以及它声明的所有 bean ) 包含到应用程序上下文中</li><li>通过使用 <code>@ConditionalOnClass</code> 注解，我们告诉Spring 只有类 DummyEmail.class 存在于 classpath 时，才将 GreetingAutoConfiguration (以及它声明的所有 bean ) 包含到应用程序上下文中</li></ul><p>多个条件是 <code>and/与</code>的关系，既只有满足全部条件时，才会加载 GreetingAutoConfiguration</p><p>如果你对条件注解的使用还不是很明确，可以查看我之前的文章: <a href="https://dayarch.top/p/d66d57ce.html">@Conditional注解，灵活配置 Spring Boot</a></p><h4 id="配置属性管理"><a href="#配置属性管理" class="headerlink" title="配置属性管理"></a>配置属性管理</h4><p>上面使用了 <code>@ConditionalOnProperty</code> 注解，实际 starter 中可能有非常多的属性，所以我们需要将这些属性集中管理:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"rgyb.greeting"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreetingProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GreetingProperties 开关</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> enable = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要打招呼的成员列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;String&gt; members = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们知道这些属性是要在 application.yml 中使用的，当我们需要使用这些属性时，为了让 IDE 给出更友好的提示，我们需要在 pom.xml 中添加依赖:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样当我们 mvn compile 时，会在生成一个名为 <code>spring-configuration-metadata.json</code> JSON 文件，文件内容如下:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-14/2019-10-15-11-17-51.png" alt=""></p><p>生成的内容在接下来的内容中用到，且看</p><h4 id="提升启动时间"><a href="#提升启动时间" class="headerlink" title="提升启动时间"></a>提升启动时间</h4><p>对于类路径上的每个自动配置类，Spring Boot 必须计算 <code>@Conditional…</code> 条件值，用于决定是否加载自动配置及其所需的所有类，根据 Spring 启动应用程序中 starter 的大小和数量，这可能是一个非常昂贵的操作，并且会影响启动时间，为了提升启动时间，我们需要在 pom.xml 中添加另外一个依赖:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个注解会生成一个名为 <code>spring-autoconfigure-metadata.properties</code> Property 文件，其内容如下:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-14/2019-10-15-11-26-42.png" alt=""></p><p>这样，Spring Boot 在启动期间读取这些元数据，可以过滤出不满足条件的配置，而不必实际检查这些类，提升启动速度</p><p>到这里关于 Auto-Configure Module 就构建完了，我们需要继续完成 Starter Module 的构建</p><h3 id="Starter-Module-构建"><a href="#Starter-Module-构建" class="headerlink" title="Starter Module 构建"></a>Starter Module 构建</h3><p>Starter Module 的构建很简单了，你可以认为它就是一个空 module，除了依赖 Auto-Configure Module，其唯一作用就是为了使用 starter 功能特性提供所有必须依赖，所以我们为 starter module 的 pom.xml 文件添加如下内容:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.dayarch.learnings<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rgyb-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 在此处添加其他必要依赖，保证starter可用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>同样在 resources 目录下新建文件 <code>META-INF/spring.providers</code> , 其内容如下:</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">providers</span>: <span class="string">rgyb-spring-boot-autoconfigure</span></span><br></pre></td></tr></table></figure><p>该文件主要作用是说明 starter module 的依赖信息，多个依赖以逗号分隔就好，该文件不会影响 starter 的使用，可有可无</p><p>Starter Module 就可以这么简单，将两个 module 分别 mvn install 到本地 Maven Repository，接下来我们创建 sample module 引入这个 starter 依赖时就会从本地 Maven Repository 中拉取</p><h2 id="创建-Sample-Module"><a href="#创建-Sample-Module" class="headerlink" title="创建 Sample Module"></a>创建 Sample Module</h2><p>我们可以通过 Spring Initializr 正常初始化一个 Spring Boot 项目 (rgyb-spring-boot-sample)，引入我们刚刚创建的 starter 依赖，在 sample pom.xml 中添加依赖:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.dayarch.learnings<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rgyb-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接下来配置 application.yml 属性</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rgyb:</span></span><br><span class="line"><span class="attr">  greeting:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    members:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">李雷</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">韩梅梅</span></span><br></pre></td></tr></table></figure><p>在我们配置 YAML 的时候，会出现下图的提示，这样会更友好，当然为了规范，属性描述最好也用英文描述，这里为了说明问题用了中文描述:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-14/2019-10-15-11-43-14.png" alt=""></p><h2 id="编写测试类"><a href="#编写测试类" class="headerlink" title="编写测试类"></a>编写测试类</h2><p>我们编写测试用例:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">private</span> GreetingService greetingService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGreeting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    greetingService.sayHello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试结果如下:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello 李雷</span><br><span class="line">hello 韩梅梅</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里完整的 starter 开发就结束了，希望大家了解其构建过程，目录结构及命名等标准，这样有相应的业务需求时都可以开发自己的 starter 被其他人应用起来</p><p>starter 开发好了，别人可以手动添加依赖引入 starter 的相关功能，那我们如何像 Spring Initializr 一样，通过下来菜单选择我们的 starter 呢，这样直接初始化好整个项目，接下来的文章我们会模仿 Spring Initializr 自定义我们自的 Initializr</p><h2 id="知识点说明"><a href="#知识点说明" class="headerlink" title="知识点说明"></a>知识点说明</h2><h3 id="Dependency-optinal"><a href="#Dependency-optinal" class="headerlink" title="Dependency optinal"></a>Dependency optinal</h3><blockquote><p>为什么 Auto-Configure Module 的 dependency 都是 optional = true 呢？<br>这涉及到 Maven 传递性依赖的问题，详情请看 <a href="https://dayarch.top/p/b674819.html">Maven 依赖传递性透彻理解</a></p></blockquote><h3 id="spring-factories"><a href="#spring-factories" class="headerlink" title="spring.factories"></a>spring.factories</h3><blockquote><p> Spring Boot 是如何加载这个文件并找到我们的配置类的<br>下图是 Spring Boot 应用程序启动的调用栈的一部分，我添加了断点:</p></blockquote><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-14/2019-10-15-12-38-42.png" alt=""></p><p>打开 SpringFactoriesLoader 类，映入眼帘的就是这个内容:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-14/2019-10-15-12-39-32.png" alt=""></p><p>这两张图应该足够说明问题了，是 SPI 的一种加载方式，更细节的内容请大家自己去发现吧</p><h2 id="实际案例"><a href="#实际案例" class="headerlink" title="实际案例"></a>实际案例</h2><p>这里推荐查看 <a href="https://github.com/mybatis/spring-boot-starter" target="_blank" rel="noopener">mybatis-spring-boot-starter</a> 这个非 Spring 官方的案例，从中我们:</p><ul><li>模仿其目录结构</li><li>模仿其设计理念</li><li>模仿其编码规范</li></ul><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-14/2019-10-15-12-51-17.png" alt=""></p><p>另外，本文的案例我已上传，公众号回复「demo」，打开链接，查看 customstarter 目录下内容即可</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>在生成 spring-autoconfigure-metadata.properties 文件时，为什么 @ConditionalOnProperty 的内容没有被写进去</li><li>如果我们要将依赖上传至 remote central repository，你知道怎样搭建自己的 maven repository 吗？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""> </p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ol><li><a href="https://dayarch.top/p/d7e125a1.html">这次走进并发的世界，请不要错过</a></li><li><a href="https://dayarch.top/p/86243a5b.html">学并发编程，透彻理解这三个核心是关键</a></li><li><a href="https://dayarch.top/p/6d12b8cf.html">并发Bug之源有三，请睁大眼睛看清它们</a></li><li><a href="https://dayarch.top/p/815d7647.html">可见性有序性，Happens-before来搞定</a></li><li><a href="https://dayarch.top/p/32b8e26a.html">解决原子性问题？你首先需要的是宏观理解</a></li><li><a href="https://dayarch.top/p/fb3c7eeb.html">面试并发volatile关键字时，我们应该具备哪些谈资？</a></li></ol><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享 </li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答 </li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> Starter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Maven 依赖传递性透彻理解</title>
      <link href="//p/maven-dependency-optional-transitive.html"/>
      <url>//p/maven-dependency-optional-transitive.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>本来想写一篇「如何自定义Spring Boot Starter」，但是为了更好理解 Starter 的一些设计理念和其中的关键点，所以提前将一些细节内容单独提取出来讲解说明</p><p>在 Maven pom.xml 中，你经常会看到依赖项中有类似下面的代码:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>sample.ProjectA<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Project-A<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里的 <code>&lt;optional&gt;true&lt;/optional&gt;</code> 是什么意思呢？</p><h2 id="optional-关键字的奥秘"><a href="#optional-关键字的奥秘" class="headerlink" title="optional 关键字的奥秘"></a>optional 关键字的奥秘</h2><p>老规矩，画个图说明问题:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-11/maven%20optional%20%283%29.png" alt=""></p><p>由于 project C 使用到了两个来自 project A 的类 (OptionalFeatureAClass) 和 project B 的类 (OptionalFeatureBClass). 如果 project C 没有依赖 packageA 和 packageB，那么编译将会失败。</p><p>project D 依赖 project C，但是对于 project D 来说，类 (OptionalFeatureAClass) 和类 (OptionalFeatureBClass) <strong>是可选的特性</strong>，所以为了让最终的 war/ejb package 不包含不必要的依赖，使用<code>&lt;optional&gt;</code> 声明当前依赖是可选的, 默认情况下也不会被其他项目继承(好比 Java 中的 final 类，不能被其他类继承一样)</p><p>如果 project D 确实需要用到 project C 中的 OptionalFeatureAClass 怎么办呢？那我们就需要在 project D 的 pom.xml 中显式的添加声明 project A 依赖，继续看下图:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-11/maven%20optional%202.png" alt=""></p><p>Project D 需要用到 Project A 的 OptionalFeatureAClass，那么需要在 Project D 的 pom.xml 文件中显式的添加对 Project A 的依赖</p><p>到这也就很好理解为什么 Maven 为什么要设计 optional 关键字了，假设一个关于数据库持久化的项目(Project C), 为了适配更多类型的数据库持久化设计，比如 Mysql 持久化设计(Project A) 和 Oracle 持久化设计(Project B)，当我们的项目(Project D) 要用的 Project C 的持久化设计，不可能既引入 mysql 驱动又引入 oracle 驱动吧，所以我们要显式的指定一个，就是这个道理了</p><h2 id="实际案例"><a href="#实际案例" class="headerlink" title="实际案例"></a>实际案例</h2><p>在 <a href="https://repo1.maven.org/maven2/org/springframework/boot/spring-boot-actuator/1.3.3.RELEASE/spring-boot-actuator-1.3.3.RELEASE.pom" target="_blank" rel="noopener">spring-boot-actuator</a> pom.xml 文件中，有超过 20 个依赖是 optional</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-11/2019-10-11-20-34-58.png" alt=""></p><p>因为 Spring Boot 不可能将没必要的依赖也打包到你最终的 jar package 中，所以用到 spring boot actuator 的项目最终生成的 jar package 中不会包含这 20 多个依赖 jar，如果你要用到哪一个，显式的加入到你的项目就好了</p><p>在接下来的文章，自定义 Spring Boot Starter 也是这个策略，因为 starter 是包含特定功能为其他项目服务用的，类似本文的 Project C 的角色了，到这里你理解 optional 的奥秘了吗？</p><h2 id="反向应用"><a href="#反向应用" class="headerlink" title="反向应用"></a>反向应用</h2><p>如果 Project C 引入的依赖没有加 <code>&lt;optional&gt;true&lt;/optional&gt;</code>，Project D 又需要依赖 Project C，但只用到 Project A 的类怎么办呢？Maven 也是有解决办法的，使用 exclusion 关键字，不多说，上一段代码就懂了:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.dayarch.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Project-C<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.dayarch.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Project-B<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里，在你今后设计功能性依赖时，你应该明白怎样设计依赖关系了, 我这里推荐使用 optional 的形式，简单来说，你设计的依赖什么菜都有，想吃什么菜自己 “抱蔡明” 就好，接下来我们就模拟官方标准创建自定义的 starter……</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>有很多童鞋项目组用的构建工具时 Gradle，你知道 Gradle 中是怎样表示的吗？</li><li>自定义 starter，你知道官方标准 starter 的结构是什么样的吗？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""> </p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ol><li><a href="https://dayarch.top/p/d7e125a1.html">这次走进并发的世界，请不要错过</a></li><li><a href="https://dayarch.top/p/86243a5b.html">学并发编程，透彻理解这三个核心是关键</a></li><li><a href="https://dayarch.top/p/6d12b8cf.html">并发Bug之源有三，请睁大眼睛看清它们</a></li><li><a href="https://dayarch.top/p/815d7647.html">可见性有序性，Happens-before来搞定</a></li><li><a href="https://dayarch.top/p/32b8e26a.html">解决原子性问题？你首先需要的是宏观理解</a></li><li><a href="https://dayarch.top/p/fb3c7eeb.html">面试并发volatile关键字时，我们应该具备哪些谈资？</a></li></ol><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享 </li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答 </li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>锁保护资源，synchronized方法就够了吗</title>
      <link href="//p/java-concurrency-lock-resource.html"/>
      <url>//p/java-concurrency-lock-resource.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>上一篇文章<a href="https://dayarch.top/p/32b8e26a.html">原子性问题的宏观理解</a> 带领大家了解了锁和资源的模型，有了这篇文章的铺垫，相信理解这一篇文章就非常轻松了</p><p>当我们要保护单个资源并对其进行修改其实很简单，只需按照下图分三步走</p><ol><li>创建受保护资源 R 的锁</li><li>加锁进入临界区</li><li>解锁走出临界区</li></ol><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-09/%E5%8D%95%E4%B8%AA%E8%B5%84%E6%BA%90%E9%94%81%E6%A8%A1%E5%9E%8B.png" alt=""></p><p><strong>上图的关键是「R1 的锁保护 R1」的指向关系是否正确</strong></p><p>如果都是保护单个资源这样简单，程序猿的世界该有多美好，可惜并不是，通常我们需要保护多个资源</p><h2 id="保护多个资源"><a href="#保护多个资源" class="headerlink" title="保护多个资源"></a>保护多个资源</h2><h3 id="保护多个没有关系的资源"><a href="#保护多个没有关系的资源" class="headerlink" title="保护多个没有关系的资源"></a>保护多个没有关系的资源</h3><p>如果多个资源没有关系，那就是保护一个资源模型的复制，同样非常简单，且看下图:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-09/%E5%A4%9A%E4%B8%AA%E6%97%A0%E5%85%B3%E8%81%94%E8%B5%84%E6%BA%90%E9%94%81%E6%A8%A1%E5%9E%8B.png" alt=""></p><blockquote><p>比如现实中银行取款和修改密码操作。<br>银行取款操作对应的资源是「余额」, 修改密码操作对应的资源是「密码」，余额和密码两个资源完全没有关系，所以各自用自家的锁保护自家的资源就好了</p></blockquote><p>如果多个资源没有关系，程序猿的世界该有多美好，可惜并不是，我们保护的资源多数情况都有关联关系</p><h3 id="保护多个关系的资源"><a href="#保护多个关系的资源" class="headerlink" title="保护多个关系的资源"></a>保护多个关系的资源</h3><p>拿经典的银行转账案例来说明，账户 A 给账户 B 转账，账户 A 余额减少 100 元，账户 B 余额增加 100 元，这个操作要是原子性的，那么资源「A 余额」和资源「B 余额」就这样”有了关系”，先来看程序:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> balance;</span><br><span class="line">  <span class="comment">// 转账</span></span><br><span class="line">  <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Account target, <span class="keyword">int</span> amt)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.balance &gt; amt) &#123;</span><br><span class="line">      <span class="keyword">this</span>.balance -= amt;</span><br><span class="line">      target.balance += amt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用 synchronized 直接保护 transfer 方法，然后操作资源「A 余额」和资源「B 余额」就可以了</p><p>⚠️: 真的是这样吗？</p><p>先停止向下看，在你的笔记本上按照文章开头的三步走来画个图看一看，是否和下图一样呢？</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-09/%E5%A4%9A%E8%B5%84%E6%BA%90%E6%9C%89%E5%85%B3%E7%B3%BB.png" alt=""></p><p><strong>我们通常容易忽略锁和资源的指向关系</strong>，我们想当然的用锁 this 来保护 target 资源了，也就没有起到保护作用</p><blockquote><p> 假设 A，B，C 账户初始余额都是 200 原，A 向 B 转账 100，B 向 C 转账 100</p></blockquote><p><strong>我们期盼最终的结果是:</strong><br>账户 A 余额: 100 元<br>账户 B 余额: 200 元<br>账户 C 余额: 300 元</p><p>假线程 1「A 向 B 转账」与线程 2「B 向 C 转账」两个操作同时执行，根据 JMM 模型可知，线程 1 和线程 2 读取线程 B 当前的余额都是 200 元:</p><ul><li>线程 1 执行 transfer 方法锁定的是 A 的实例(A.this)，<strong>并没有锁定 B 的实例</strong></li><li>线程 2 执行 transfer 方法锁定的是 B 的实例(B.this)，并没有锁定 C 的实例</li></ul><p>所以线程 1 和线程 2 可以同时进入 transfer 临界区，上面你认为对的模型其实就会变成这个样子:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-09/%E9%93%B6%E8%A1%8C%E8%BD%AC%E8%B4%A61.png" alt=""></p><p>还记得 <a href="https://dayarch.top/p/815d7647.html">happens-before 规则</a> 这篇文章提到的<strong>监视器锁规则</strong>和<strong>传递性规则</strong>吗？</p><blockquote><p>####监视器锁规则<br> 对一个锁的解锁 happens-before 于随后对这个锁的加锁<br>####传递性规则<br>如果 A happens-before B, 且 B happens-before C, 那么 A happens-before C</p></blockquote><p><strong>资源 B.balance 存在于两个”临界区”中，所以这个”临界区”对 B.balance 来说形同虚设，也就不满足监视器锁规则，进而导致传递性规则也不生效，说白了，前序线程的更改结果对后一个线程不可见</strong></p><p>这样最终导致:</p><ul><li><p><strong>账户 B 的余额可能是 100: ** 线程 1 写 B.balance 100(balance = 300) **先于</strong> 线程 2 写 B.balance(balance = 100)，也就是说线程 1 的结果会被线程 2 覆盖，导致最终账户 B 的余额为 100</p></li><li><p><strong>账户 B 的余额可能是 300:</strong> 与上述情况相反，线程 1 写 B.balance 100(balance = 300) <strong>后于</strong> 线程 2 写 B.balance(balance = 100)，也就是说线程 2 的结果线程 1 覆盖，导致最终账户 B 的余额为 300</p></li></ul><p>就是不能得到我们理想结果 200，感觉生活无比的艰难，那怎么办呢？</p><h2 id="正确姿势"><a href="#正确姿势" class="headerlink" title="正确姿势"></a>正确姿势</h2><p>上面的问题就是为资源创建的锁不能保护所有关联的资源，那我们就想办法解决这个问题，来看下面代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> balance;</span><br><span class="line">  <span class="comment">// 转账</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amt)</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(Account.class) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.balance &gt; amt) &#123;</span><br><span class="line">        <span class="keyword">this</span>.balance -= amt;</span><br><span class="line">        target.balance += amt;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将 this 锁变为 Account.class 锁，Account.class 是虚拟机加载 Account 类时创建的，肯定是唯一的(<a href="https://dayarch.top/p/127ec041.html">双亲委派模型解释了为何该对象是唯一的</a>)， 所有 Account 对象都共享 Account.class, 也就是说，Account.class 锁能保护所有 Account 对象，我们将上面程序再用模型解释一下</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-09/%E9%93%B6%E8%A1%8C%E8%BD%AC%E8%B4%A62.png" alt=""></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里关于锁和资源的关系你应该了解的更加透彻了，单个资源和多个无关联资源的情形都很好处理，为各自资源创建相应的锁就好，如果多个资源有关联，为了让锁起到保护作用，我们需要将锁的粒度变大，比如将 this 锁变成了 Account.class 锁。</p><p>转账业务非常常见，并发量非常大，如果我们将锁的粒度都提升到 Account.class 这个级别(分久必合)，假设每次转账业务都很耗时，那么显然这个锁的性能是比较低的，<strong>所以接下来的文章，我们还会继续优化这个模型，选择合适的锁粒度，同时能保护多个有关联的资源</strong>，</p><p>我们的锁粒度虽然大，但是我们保障了账户的安全，所以并发编程可以先保证事情做对，遇到瓶颈了，慢慢优化改变相应的模型就好了，当然熟练理解这个模型以后，一步到位的并发编程模型当然是极好的……</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>还记得 happens-before 的几个原则吗？</li><li>偏向锁，轻量锁，重量锁是不是和我们这节内容有异曲同工之处呢？</li><li>提前想一下，我们如何来优化这个模型呢？ </li></ol><h2 id="附加说明"><a href="#附加说明" class="headerlink" title="附加说明"></a>附加说明</h2><p>如果你对这篇文章理解有些困难，可以按照下面的顺序回忆前序文章相关内容</p><ol><li><a href="https://dayarch.top/p/d7e125a1.html">这次走进并发的世界，请不要错过</a></li><li><a href="https://dayarch.top/p/86243a5b.html">学并发编程，透彻理解这三个核心是关键</a></li><li><a href="https://dayarch.top/p/6d12b8cf.html">并发Bug之源有三，请睁大眼睛看清它们</a></li><li><a href="https://dayarch.top/p/815d7647.html">可见性有序性，Happens-before来搞定</a></li><li><a href="https://dayarch.top/p/32b8e26a.html">解决原子性问题？你首先需要的是宏观理解</a></li><li><a href="https://dayarch.top/p/fb3c7eeb.html">面试并发volatile关键字时，我们应该具备哪些谈资？</a></li></ol><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://dayarch.top/p/af68cfb3.html">每天用SpringBoot，还不懂RESTful API返回统一数据格式是怎么实现的？ </a></li><li><a href="https://dayarch.top/p/127ec041.html">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://dayarch.top/p/61d8a472.html">EasyExcel 读取 excel 真的很easy</a></li><li><a href="https://dayarch.top/p/86cf6746.html">红黑树，超强动静图详解，简单易懂</a></li></ul><hr><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""> </p><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享 </li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答 </li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EasyExcel读取Excel实际应用</title>
      <link href="//p/easyexcel-read.html"/>
      <url>//p/easyexcel-read.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>Java 后端程序员应该会遇到读取 Excel 信息到 DB 等相关需求，脑海中可能突然间想起 Apache POI 这个技术解决方案，但是当 Excel 的数据量非常大的时候，你也许发现，POI 是将整个 Excel 的内容全部读出来放入到内存中，所以内存消耗非常严重，如果同时进行包含大数据量的 Excel 读操作，很容易造成内存溢出问题</p><p>但 EasyExcel 的出现很好的解决了 POI 相关问题，原本一个 3M 的 Excel 用 POI 需要100M左右内存, 而 EasyExcel 可以将其降低到几 M，同时再大的 Excel 都不会出现内存溢出的情况，因为是逐行读取 Excel 的内容 (老规矩，这里不用过分关心下图，脑海中有个印象即可，看完下面的用例再回看这个图，就很简单了)</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-17-09-51.jpg" alt=""></p><p>另外 EasyExcel 在上层做了模型转换的封装，不需要 cell 等相关操作，让使用者更加简单和方便，且看</p><h2 id="简单读"><a href="#简单读" class="headerlink" title="简单读"></a>简单读</h2><p>假设我们 excel 中有以下内容:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-09-09-50.png" alt=""></p><p>我们需要新建 User 实体，同时为其添加成员变量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 姓名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExcelProperty</span>(index = <span class="number">0</span>)</span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 年龄</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExcelProperty</span>(index = <span class="number">1</span>)</span><br><span class="line"><span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你也许关注到了 <code>@ExcelProperty</code> 注解，同时使用了 index 属性 (0 代表第一列，以此类推)，该注解同时支持以「列名」name 的方式匹配，比如:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExcelProperty</span>(<span class="string">"姓名"</span>)</span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure><p>按照 github 文档的说明:</p><blockquote><p> 不建议 index 和 name 同时用，要么一个对象只用index，要么一个对象只用name去匹配</p></blockquote><ol><li>如果读取的 Excel 模板信息列固定，这里建议以 index 的形式使用，因为如果用名字去匹配，名字重复，会导致只有一个字段读取到数据，所以 index 是更稳妥的方式</li><li>如果 Excel 模板的列 index 经常有变化，那还是选择 name 方式比较好，不用经常性修改实体的注解 index 数值</li></ol><p>所以大家可以根据自己的情况自行选择</p><p>编写测试用例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExcel</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String fileName = TestUtils.getPath() + <span class="string">"excel"</span> + File.separator + <span class="string">"users1.xlsx"</span>;</span><br><span class="line">    EasyExcel.read(fileName, User.class, <span class="keyword">new</span> UserExcelListener()).sheet().doRead();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EasyExcel 类中重载了很多个 read 方法，这里不一一列举说明，请大家自行查看；同时 sheet 方法也可以指定 sheetNo，默认是第一个 sheet 的信息</p><p>上面代码的 <code>new UserExcelListener()</code> 异常醒目，这也是 EasyExcel 逐行读取 Excel 内容的关键所在，自定义 <code>UserExcelListener</code> 继承 <code>AnalysisEventListener</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserExcelListener</span> <span class="keyword">extends</span> <span class="title">AnalysisEventListener</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批处理阈值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_COUNT = <span class="number">2</span>;</span><br><span class="line">List&lt;User&gt; list = <span class="keyword">new</span> ArrayList&lt;User&gt;(BATCH_COUNT);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(User user, AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"解析到一条数据:&#123;&#125;"</span>, JSON.toJSONString(user));</span><br><span class="line">list.add(user);</span><br><span class="line"><span class="keyword">if</span> (list.size() &gt;= BATCH_COUNT) &#123;</span><br><span class="line">saveData();</span><br><span class="line">list.clear();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line">saveData();</span><br><span class="line">log.info(<span class="string">"所有数据解析完成！"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveData</span><span class="params">()</span></span>&#123;</span><br><span class="line">log.info(<span class="string">"&#123;&#125;条数据，开始存储数据库！"</span>, list.size());</span><br><span class="line">log.info(<span class="string">"存储数据库成功！"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里请回看文章开头的 EasyExcel 原理图，invoke  方法逐行读取数据，对应的就是订阅者 1；doAfterAllAnalysed 方法对应的就是订阅者 2，这样你理解了吗？</p><p>打印结果:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-15-56-41.png" alt=""></p><p>从这里可以看出，虽然是逐行解析数据，但我们可以自定义阈值，完成数据的批处理操作，可见 EasyExcel 操作的灵活性</p><h2 id="自定义转换器"><a href="#自定义转换器" class="headerlink" title="自定义转换器"></a>自定义转换器</h2><p>这是最基本的数据读写，我们的业务数据通常不可能这么简单，有时甚至需要将其转换为程序可读的数据</p><h3 id="性别信息转换"><a href="#性别信息转换" class="headerlink" title="性别信息转换"></a>性别信息转换</h3><p>比如 Excel 中新增「性别」列，其性别为男/女，我们需要将 Excel 中的性别信息转换成程序信息: 「1: 男；2:女」</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-16-04-49.png" alt=""></p><p>首先在 User 实体中添加成员变量 gender:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExcelProperty</span>(index = <span class="number">2</span>)</span><br><span class="line"><span class="keyword">private</span> Integer gender;</span><br></pre></td></tr></table></figure><p>EasyExcel 支持我们自定义 converter，将 excel 的内容转换为我们程序需要的信息，这里新建 GenderConverter，用来转换性别信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenderConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MALE = <span class="string">"男"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FEMALE = <span class="string">"女"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">supportJavaTypeKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Integer.class;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CellDataTypeEnum <span class="title">supportExcelTypeKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> CellDataTypeEnum.STRING;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">convertToJavaData</span><span class="params">(CellData cellData, ExcelContentProperty excelContentProperty, GlobalConfiguration globalConfiguration)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">String stringValue = cellData.getStringValue();</span><br><span class="line"><span class="keyword">if</span> (MALE.equals(stringValue))&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CellData <span class="title">convertToExcelData</span><span class="params">(Integer integer, ExcelContentProperty excelContentProperty, GlobalConfiguration globalConfiguration)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p> 上面程序的 Converter 接口的泛型是指要转换的 Java 数据类型，与 supportJavaTypeKey 方法中的返回值类型一致</p></blockquote><p>打开注解 <code>@ExcelProperty</code> 查看，该注解是支持自定义 Converter 的，所以我们为 User 实体添加 <strong>gender</strong> 成员变量，并指定 converter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 性别 1：男；2：女</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExcelProperty</span>(index = <span class="number">2</span>, converter = GenderConverter.class)</span><br><span class="line"><span class="keyword">private</span> Integer gender;</span><br></pre></td></tr></table></figure><p>来看运行结果:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-16-09-14.png" alt=""></p><p>数据按照我们预期做出了转换，从这里也可以看出，Converter 可以一次定义到处是用的便利性</p><h3 id="日期信息转换"><a href="#日期信息转换" class="headerlink" title="日期信息转换"></a>日期信息转换</h3><p>日期信息也是我们常见的转换数据，比如 Excel 中新增「出生年月」列，我们要解析成 <strong>yyyy-MM-dd</strong> 格式，我们需要将其进行格式化，EasyExcel 通过 <code>@DateTimeFormat</code> 注解进行格式化</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-16-11-16.png" alt=""></p><p>在 User 实体中添加成员变量 <strong>birth</strong>，同时应用 <code>@DateTimeFormat</code> 注解，按照要求做格式化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 出生日期</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExcelProperty</span>(index = <span class="number">3</span>)</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span><br><span class="line"><span class="keyword">private</span> String birth;</span><br></pre></td></tr></table></figure><p>来看运行结果:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-16-13-08.png" alt=""></p><p>如果这里你指定 birth 的类型为 Date，试试看，你得到的结果是什么？</p><p>到这里都是以测试的方式来编写程序代码，作为 Java Web 开发人员，尤其在目前主流 Spring Boot 的架构下，所以如何实现 Web 方式读取 Excel 的信息呢？</p><h2 id="web-读"><a href="#web-读" class="headerlink" title="web 读"></a>web 读</h2><h3 id="简单-Web"><a href="#简单-Web" class="headerlink" title="简单 Web"></a>简单 Web</h3><p>很简单，只是将测试用例的关键代码移动到 Controller 中即可，我们新建一个 <code>UserController</code>，在其添加 <code>upload</code> 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/upload"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">EasyExcel.read(file.getInputStream(), User.class, <span class="keyword">new</span> UserExcelListener()).sheet().doRead();</span><br><span class="line"><span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实在写测试用例的时候你也许已经发现，listener 是以 new 的形式作为参数传入到 EasyExcel.read 方法中的，这是不符合 Spring IoC 的规则的，我们通常读取 Excel 数据之后都要针对读取的数据编写一些业务逻辑的，而业务逻辑通常又会写在 Service 层中，我们如何在 listener 中调用到我们的 service 代码呢？</p><p>*<em>先不要向下看，你脑海中有哪些方案呢？ *</em></p><h3 id="匿名内部类方式"><a href="#匿名内部类方式" class="headerlink" title="匿名内部类方式"></a>匿名内部类方式</h3><p>匿名内部类是最简单的方式，我们需要先新建 Service 层的信息:<br>新建 IUser 接口:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUser</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">saveData</span><span class="params">(List&lt;User&gt; users)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新建 IUser 接口实现类 UserServiceImpl:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUser</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">saveData</span><span class="params">(List&lt;User&gt; users)</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"UserService &#123;&#125;条数据，开始存储数据库！"</span>, users.size());</span><br><span class="line">log.info(JSON.toJSONString(users));</span><br><span class="line">log.info(<span class="string">"UserService 存储数据库成功！"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，在 Controller 中注入 IUser:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IUser iUser;</span><br></pre></td></tr></table></figure><p>修改 upload 方法，以匿名内部类重写 listener 方法的形式来实现:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/uploadWithAnonyInnerClass"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadWithAnonyInnerClass</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">EasyExcel.read(file.getInputStream(), User.class, <span class="keyword">new</span> AnalysisEventListener&lt;User&gt;()&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批处理阈值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_COUNT = <span class="number">2</span>;</span><br><span class="line">List&lt;User&gt; list = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(User user, AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"解析到一条数据:&#123;&#125;"</span>, JSON.toJSONString(user));</span><br><span class="line">list.add(user);</span><br><span class="line"><span class="keyword">if</span> (list.size() &gt;= BATCH_COUNT) &#123;</span><br><span class="line">saveData();</span><br><span class="line">list.clear();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line">saveData();</span><br><span class="line">log.info(<span class="string">"所有数据解析完成！"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveData</span><span class="params">()</span></span>&#123;</span><br><span class="line">iUser.saveData(list);</span><br><span class="line">&#125;</span><br><span class="line">&#125;).sheet().doRead();</span><br><span class="line"><span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看结果:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-10-06/2019-10-07-17-57-32.png" alt=""></p><p>这种实现方式，其实这只是将 listener 中的内容全部重写，并在 controller 中展现出来，当你看着这么臃肿的 controller 是不是非常难受？很显然这种方式不是我们的最佳编码实现</p><h3 id="构造器传参"><a href="#构造器传参" class="headerlink" title="构造器传参"></a>构造器传参</h3><p>在之前分析 SpringBoot 统一返回源码时，不知道你是否发现，Spring 底层源码多数以构造器的形式传参，所以我们可以将为 listener 添加有参构造器，将 Controller 中依赖注入的 IUser 以构造器的形式传入到 listener :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserExcelListener</span> <span class="keyword">extends</span> <span class="title">AnalysisEventListener</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> IUser iUser;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UserExcelListener</span><span class="params">(IUser iUser)</span></span>&#123;</span><br><span class="line"><span class="keyword">this</span>.iUser = iUser;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略相应代码...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveData</span><span class="params">()</span></span>&#123;</span><br><span class="line">iUser.saveData(list); <span class="comment">//调用 userService 中的 saveData 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改 Controller 方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/uploadWithConstructor"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadWithConstructor</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    EasyExcel.read(file.getInputStream(), User.class, <span class="keyword">new</span> UserExcelListener(iUser)).sheet().doRead();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果: 同上</p><p>这样更改后，controller 代码看着很清晰，但如果后续业务还有别的 Service 需要注入，我们难道要一直添加有参构造器吗？很明显，这种方式同样不是很灵活。</p><p>其实在使用匿名内部类的时候，你也许会想到，我们可以通过 Java8 lambda 的方式来解决这个问题</p><h3 id="Lambda-传参"><a href="#Lambda-传参" class="headerlink" title="Lambda 传参"></a>Lambda 传参</h3><p>为了解决构造器传参的痛点，同时我们又希望 listener 更具有通用性，没必要为每个 Excel 业务都新建一个 listener，因为 listener 都是逐行读取 Excel 数据，只需要将我们的业务逻辑代码传入给 listener 即可，所以我们需用到 <code>Consumer&lt;T&gt;</code> ，将其作为构造 listener 的参数。</p><p>新建一个工具类 ExcelDemoUtils，用来构造 listener:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelDemoUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 指定阈值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> threshold</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">AnalysisEventListener&lt;T&gt; <span class="title">getListener</span><span class="params">(Consumer&lt;List&lt;T&gt;&gt; consumer, <span class="keyword">int</span> threshold)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> AnalysisEventListener&lt;T&gt;() &#123;</span><br><span class="line"><span class="keyword">private</span> LinkedList&lt;T&gt; linkedList = <span class="keyword">new</span> LinkedList&lt;T&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(T t, AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line">linkedList.add(t);</span><br><span class="line"><span class="keyword">if</span> (linkedList.size() == threshold)&#123;</span><br><span class="line">consumer.accept(linkedList);</span><br><span class="line">linkedList.clear();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (linkedList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">consumer.accept(linkedList);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不指定阈值，阈值默认为10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">AnalysisEventListener&lt;T&gt; <span class="title">getListener</span><span class="params">(Consumer&lt;List&lt;T&gt;&gt; consumer)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> getListener(consumer, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到，getListener 方法接收一个 <code>Consumer&lt;List&lt;T&gt;&gt;</code> 的参数，这样下面代码被调用时，我们的业务逻辑也就会被相应的执行了:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumer.accept(linkedList);</span><br></pre></td></tr></table></figure><p>继续改造 Controller 方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/uploadWithLambda"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadWithLambda</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    AnalysisEventListener&lt;User&gt; userAnalysisEventListener = ExcelDemoUtils.getListener(<span class="keyword">this</span>.batchInsert(), <span class="number">2</span>);</span><br><span class="line">    EasyExcel.read(file.getInputStream(), User.class, userAnalysisEventListener).sheet().doRead();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Consumer&lt;List&lt;User&gt;&gt; batchInsert()&#123;</span><br><span class="line">    <span class="comment">//其他业务逻辑只需要添加到该方法中即可</span></span><br><span class="line">    <span class="keyword">return</span> users -&gt; iUser.saveData(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果: 同上</p><p>到这里，我们只需要将业务逻辑定制在 <code>batchInsert</code> 方法中:</p><ol><li>满足 Controller RESTful API 的简洁性</li><li>listener 更加通用和灵活，它更多是扮演了抽象类的角色，具体的逻辑交给抽象方法的实现来完成</li><li>业务逻辑可扩展性也更好，逻辑更加清晰</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里，关于如何使用 EasyExcel 读取 Excel 信息的基本使用方式已经介绍完了，还有很多细节内容没有讲，大家可以自行查阅 <a href="https://github.com/alibaba/easyexcel" target="_blank" rel="noopener">EasyExcel Github</a> 文档去发现更多内容</p><p>除了读取 Excel 的读取，还有 Excel 的写入，如果需要将其写入到指定位置，配合 HuTool 的工具类 FileWriter 的使用是非常方便的，针对 EasyExcel 的使用，如果大家有什么问题，也欢迎到博客下方探讨</p><p>完整代码请在公众号回复「demo」，点开链接，查看「easyexceldemo」文件夹的内容即可</p><h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>非常感谢 EasyExcel 的作者 🌹🌹，让 Excel 的读写更加方便 </p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>除了 Consumer，如果需要返回值的业务逻辑，需要用到哪个函数式接口呢？</li><li>当出现复杂表头的时候要如何处理呢？</li><li>将 DB 数据写入到 Excel 并下载，如何实现呢？</li><li>从 EasyExcel 的设计上，你学到了什么，欢迎博客下方留言讨论</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""> </p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ol><li><a href="https://dayarch.top/2019/08/25/bing-fa-bian-cheng-zhi-chu-tan/">这次走进并发的世界，请不要错过</a></li><li><a href="https://dayarch.top/2019/08/28/bing-fa-bian-cheng-san-da-he-xin/">学并发编程，透彻理解这三个核心是关键</a></li><li><a href="https://dayarch.top/2019/09/04/bing-fa-bian-cheng-san-da-wen-ti/">并发Bug之源有三，请睁大眼睛看清它们</a></li><li><a href="https://dayarch.top/2019/09/12/you-xu-xing-ke-jian-xing-happens-before-lai-gao-ding/">可见性有序性，Happens-before来搞定</a></li><li><a href="https://dayarch.top/2019/09/19/jie-jue-yuan-zi-xing-wen-ti-ni-shou-xian-xu-yao-de-shi-hong-guan-li-jie/">解决原子性问题？你首先需要的是宏观理解</a></li><li><a href="https://dayarch.top/2019/09/29/mian-shi-bing-fa-volatile-guan-jian-zi-shi-wo-men-ying-gai-ju-bei-na-xie-tan-zi/">面试并发volatile关键字时，我们应该具备哪些谈资？</a></li></ol><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享 </li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答 </li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EasyExcel </tag>
            
            <tag> POI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面试volatile关键字时，我们应该具备哪些谈资？</title>
      <link href="//p/java-concurrency-volatile.html"/>
      <url>//p/java-concurrency-volatile.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>在 <a href="https://dayarch.top/2019/09/12/you-xu-xing-ke-jian-xing-happens-before-lai-gao-ding/">可见性有序性，Happens-before来搞定</a> 文章中，happens-before 的原则之一: volatile变量规则</p><blockquote><p> 对一个 volatile 域的写, happens-before 于任意后续对这个 volatile 域的读</p></blockquote><p>按理说了解了这个规则，对 volatile 的使用就已经足够了，但是面试官可是喜欢刨根问到底的，为了更透彻的了解 volatile 的内存语义与读写语义，为了面试多一些谈资进而获得一些加分项，同时尽早填补前序文章留下的坑，于是乎这篇文章就这样尴尬的诞生了</p><h2 id="happens-before-之-volatile-变量规则"><a href="#happens-before-之-volatile-变量规则" class="headerlink" title="happens-before 之 volatile 变量规则"></a>happens-before 之 volatile 变量规则</h2><p>下面的表格你还记得吗？(是的，你记得😂)</p><table><thead><tr><th>能否重排序</th><th>第二个操作</th><th>第二个操作</th><th>第二个操作</th></tr></thead><tbody><tr><td>第一个操作</td><td>普通读/写</td><td>volatile 读</td><td>volatile 写</td></tr><tr><td>普通读/写</td><td>-</td><td>-</td><td>NO</td></tr><tr><td>volatile 读</td><td>NO</td><td>NO</td><td>NO</td></tr><tr><td>volatile 写</td><td>-</td><td>NO</td><td>NO</td></tr></tbody></table><p>上面的表格是 JMM 针对编译器定制的 volatile 重排序的规则，那 JMM 是怎样禁止重排序的呢？答案是<strong>内存屏障</strong></p><h2 id="内存屏障-Memory-Barriers-Fences"><a href="#内存屏障-Memory-Barriers-Fences" class="headerlink" title="内存屏障 (Memory Barriers / Fences)"></a>内存屏障 (Memory Barriers / Fences)</h2><p>无论你听过这个名词与否都没关系，很简单，且看</p><blockquote><p>为了实现 volatile 的内存语义，编译器在生成字节码时，会在指令序列中插入内存屏障来禁止特定类型的处理器重排序</p></blockquote><p>这句话有点抽象，试着想象内存屏障是一面高墙，如果两个变量之间有这个屏障，那么他们就不能互换位置(重排序)了，变量有读(Load)有写(Store)，操作有前有后，JMM 就将内存屏障插入策略分为 4 种:</p><ol><li>在每个 volatile 写操作的前面插入一个 StoreStore 屏障</li><li>在每个 volatile 写操作的后面插入一个 StoreLoad 屏障</li><li>在每个 volatile 读操作的后面插入一个 LoadLoad 屏障</li><li>在每个 volatile 读操作的后面插入一个 LoadStore 屏障</li></ol><p>1 和 2 用图形描述以及对应表格规则就是下面这个样子了:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-24/volatilepingzhang12.png" alt=""></p><p>3 和 4 用图形描述以及对应表格规则就是下面这个样子了:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-24/volatilepingzhang34.png" alt=""></p><blockquote><p>其实图形也是表格内容的体现，只不过告诉大家内存屏障是如何禁止指令重排序的，所以大家只要牢记表格内容即可</p></blockquote><p>一段程序的读写通常不会像上面两种情况这样简单，这些屏障组合起来如何使用呢？其实一点都不难，我们只需要将这些指令带入到文章开头的表格中，然后再按照程序顺序拼接指令就好了</p><p>来看一小段程序:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileBarrierExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> a;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> v1 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> v2 = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readAndWrite</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i = v1; <span class="comment">//第一个volatile读</span></span><br><span class="line"><span class="keyword">int</span> j = v2;<span class="comment">//第二个volatile读</span></span><br><span class="line">a = i + j;<span class="comment">//普通写</span></span><br><span class="line">v1 = i + <span class="number">1</span>;<span class="comment">//第一个volatile写</span></span><br><span class="line">v2 = j * <span class="number">2</span>;<span class="comment">//第二个volatile写</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将屏障指令带入到程序就是这个样子:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-24/volatile1234.png" alt=""></p><p>我们将上图分几个角度来看:</p><ol><li>彩色是将屏障指令带入到程序中生成的全部内容，也就是编译器生成的<strong>「最稳妥」</strong>的方案</li><li>显然有很多屏障是重复多余的，右侧虚线框指向的屏障是可以被<strong>「优化」</strong>删除掉的屏障</li></ol><p>到这里你应该了解了 volatile 是如何通过内存屏障保证程序不被”擅自”排序的，那 volatile 是如何保证可见性的呢？</p><h2 id="volatile-写-读的内存语义"><a href="#volatile-写-读的内存语义" class="headerlink" title="volatile 写-读的内存语义"></a>volatile 写-读的内存语义</h2><p>回顾一下之前文章内容中的程序，假定线程 A 先执行 writer 方法，随后线程 B 执行 reader 方法，:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReorderExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> y = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span>&#123;</span><br><span class="line">x = <span class="number">42</span>;<span class="comment">//1</span></span><br><span class="line">y = <span class="number">50</span>;<span class="comment">//2</span></span><br><span class="line">flag = <span class="keyword">true</span>;<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (flag)&#123;<span class="comment">//4</span></span><br><span class="line">System.out.println(<span class="string">"x:"</span> + x);<span class="comment">//5</span></span><br><span class="line">System.out.println(<span class="string">"y:"</span> + y);<span class="comment">//6</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里你是否还记得之前说过的 JMM，是的，你还记得😂，当线程 A 执行 writer 方法时，且看下图:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-24/volatile%E5%8F%AF%E8%A7%81%E6%80%A7.png" alt=""></p><p>线程 A 将本地内存更改的变量写回到主内存中</p><blockquote><h3 id="volatile-读的内存语义"><a href="#volatile-读的内存语义" class="headerlink" title="volatile 读的内存语义:"></a>volatile 读的内存语义:</h3><p>当读一个 volatile 变量时, JMM 会把该线程对应的本地内存置为无效。线程接下来将从主内存中读取共享变量。</p></blockquote><p>所以当线程 B 执行 reader 方法时，图形结构就变成了这个样子:</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-24/volatile%E5%8F%AF%E8%A7%81%E6%80%A7%E8%AF%BB.png" alt=""></p><p>线程 B 本地内存变量无效，从主内存中读取变量到本地内存中，也就得到了线程 A 更改后的结果，这就是 volatile 是如何保证可见性的</p><p>如果你看过前面的文章你就不难理解上面的两张图了，综合起来说:</p><ol><li>线程 A 写一个volatile变量, 实质上是线程 A 向接下来将要读这个 volatile 变量的某个线程发出了(其对共享变量所做修改的)消息</li><li>线程 B 读一个 volatile 变量,实质上是线程 B 接收了之前某个线程发出的(在写这个 volatile 变量之前对共享变量所做修改的)消息。</li><li>线程 A 写一个 volatile 变量, 随后线程 B 读这个 volatile 变量, 这个过程实质上是线程 A 通过主内存向线程B 发送消息。</li></ol><p>到这里，面试 volatile 时，你应该有一些谈资了，同时也对 volatile 的语义有了更深层次的了解</p><h2 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h2><p>之前的文章提到过这样一句话:</p><blockquote><p> 从内存语义的角度来说, volatile 的<code>写-读</code>与锁的<code>释放-获取</code>有相同的内存效果；volatile 写和锁的释放有相同的内存语义; volatile 读与锁的获取有相同的内存语义</p></blockquote><p>记住文中最后两张图， 当我们说到 synchronized 的时候，你就会猛的理解这句话的含义了, 感兴趣的可以自己先了解 synchronized 的写-读语义</p><p>接下来我们就聊一聊锁相关的内容了，敬请期待…</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>如果 volatile 写之后直接 return，那还会生成 StoreLoad 指令吗？</li><li>synchronized 是怎样逐步被优化的？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""> </p><h3 id="tool-lu"><a href="#tool-lu" class="headerlink" title="tool.lu"></a>tool.lu</h3><p><a href="https://tool.lu" target="_blank" rel="noopener">https://tool.lu</a> 是一款集成了非常多功能的在线工具，基本满足日常开发所需</p><p><img src="http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-24/2019-09-29-19-28-22.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/I53l5W_Wl-lMc-_FAeJ6WQ" target="_blank" rel="noopener">这次走进并发的世界，请不要错过 </a></li><li><a href="https://mp.weixin.qq.com/s/SrNsvp2NjhAEqYugx6c-3Q" target="_blank" rel="noopener">学并发编程，透彻理解这三个核心是关键</a></li><li><a href="https://mp.weixin.qq.com/s/fQcozKziqMxFMBkptpnuTw" target="_blank" rel="noopener">并发Bug之源有三，请睁大眼睛看清它们</a></li><li><a href="https://mp.weixin.qq.com/s/074jYZWZODJ5Z2qXyWy4gw" target="_blank" rel="noopener">可见性有序性，Happens-before来搞定</a></li><li><a href="https://mp.weixin.qq.com/s/SSfs_kz60MjfrvtwNhY7pg" target="_blank" rel="noopener">解决原子性问题？你首先需要的是宏观理解</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享 </li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答 </li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> volatile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决原子性问题？你首先需要的是宏观理解</title>
      <link href="//p/java-concurrency-atomic.html"/>
      <url>//p/java-concurrency-atomic.html</url>
      
        <content type="html"><![CDATA[<p>上一篇文章 <a href="https://mp.weixin.qq.com/s/074jYZWZODJ5Z2qXyWy4gw" target="_blank" rel="noopener">可见性有序性，Happens-before来搞定</a>，解决了并发三大问题中的两个，今天我们就聊聊如何解决原子性问题</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-17/prairie-679014.jpg" alt=""></p><p>原子性问题的源头就是 <strong>线程切换</strong>，但在多核 CPU 的大背景下，不允许线程切换是不可能的，正所谓「魔高一尺，道高一丈」，新规矩来了:</p><blockquote><p> 互斥: 同一时刻只有一个线程执行</p></blockquote><p>实际上，上面这句话的意思是: 对共享变量的修改是互斥的，也就是说线程 A 修改共享变量时其他线程不能修改，这就不存在操作被打断的问题了，那么如何实现互斥呢？</p><h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>对并发有所了解的小伙伴马上就能想到 <strong>锁</strong> 这个概念，并且你的第一反应很可能就是使用 synchronized，这里列出来你常见的 synchronized 的三种用法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreeSync</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object object = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">normalSyncMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//临界区</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">staticSyncMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//临界区</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncBlockMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (object)&#123;</span><br><span class="line"><span class="comment">//临界区</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>三种 synchronized 锁的内容有一些差别:</p><ul><li>对于普通同步方法，锁的是当前实例对象，通常指 this</li><li>对于静态同步方法，锁的是当前类的 Class 对象，如 ThreeSync.class</li><li>对于同步方法块，锁的是 synchronized 括号内的对象</li></ul><p>我特意在三种 synchronized 代码里面添加了「临界区」字样的注释，那什么是临界区呢？</p><blockquote><p> 临界区: 我们把需要互斥执行的代码看成为临界区</p></blockquote><p>说到这里，和大家串的知识都是表层认知，<strong>如何用锁保护有效的临界区才是关键</strong>，这直接关系到你是否会写出并发的 bug，了解过本章内容后，你会发现无论是隐式锁/内置锁 (synchronized) 还是显示锁 (Lock) 的使用都是在找寻这种关系，关系对了，一切就对了，且看</p><p>上面锁的三种方式都可以用下图来表达:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-17/%E7%AE%80%E6%98%93%E9%94%81%E6%A8%A1%E5%9E%8B.png" alt=""></p><p>线程进入临界区之前，尝试加锁 lock()， 加锁成功，则进入临界区(对共享变量进行修改)，持有锁的线程执行完临界区代码后，执行 unlock()，释放锁。针对这个模型，大家经常用抢占厕所坑位来形容:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-17/ABUIABADGAAg5Jf5yAUouJmMgAEw7gU4pAM.gif" alt=""></p><p>在学习 Java 早期我就是这样记忆与理解锁的，但落实到代码上，我们很容易忽略两点:</p><ol><li>我们锁的是什么？</li><li>我们保护的又是什么？</li></ol><p>将这两句话联合起来就是你的锁能否对临界区的资源起到保护的作用？所以我们要将上面的模型进一步细化</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-17/%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E6%9C%89%E6%95%88%E4%B8%B4%E7%95%8C%E5%8C%BA%20%281%29%20%281%29.png" alt=""></p><p>现实中，<strong>我们都知道自己的锁来锁自己需要保护的东西</strong> ，这句话翻译成你的行动语言之后你已经明确知道了:</p><ol><li>你锁的是什么</li><li>你保护的资源是什么</li></ol><p>CPU 可不像我们大脑这么智能，我们要明确说明我们锁的是什么，我们要保护的资源是什么，它才会用锁保护我们想要保护的资源(共享变量)</p><p>拿上图来说，资源 R (共享变量) 就是我们要保护的资源，所以我们就要创建资源 R 的锁来保护资源 R，细心的朋友可能发现上图几个问题:</p><blockquote><p> LR 和 R 之间有明确的指向关系<br>我们编写程序时，往往脑子中的模型是对的，但是忽略了这个指向关系，导致自己的锁不能起到保护资源 R 的作用(用别人家的锁保护自己家的东西或用自己家的锁保护别人家的东西)，最终引发并发 bug，<strong>所以在你勾画草图时，要明确找到这个关系</strong></p></blockquote><blockquote><p> 左图 LR 虚线指向了非共享变量<br>我们写程序的时候很容易这么做，不确定哪个是要保护的资源，直接大杂烩，用 LR 将要保护的资源 R 和没必要保护的非共享变量一起保护起来了，举两个例子来说你就明白这么做的坏处了</p></blockquote><ol><li>编写串行程序时，是不建议 try…catch 整个方法的，这样如果出现问是很难定位的，道理一样，我们要用锁精确的锁住我们要保护的资源就够了，其他无意义的资源是不要锁的</li><li>锁保护的东西越多，临界区就越大，一个线程从走入临界区到走出临界区的时间就越长，这就让其他线程等待的时间越久，这样并发的效率就有所下降，其实这是涉及到锁粒度的问题，后续也都会做相关说明</li></ol><p>作为程序猿还是简单拿代码说明一下心里比较踏实，且看:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object object = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">badSync</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//其他与共享变量count无关的业务逻辑</span></span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goodSync</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//其他与共享变量count无关的业务逻辑</span></span><br><span class="line"><span class="keyword">synchronized</span> (object)&#123;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>这里并不是说 synchronized 放在方法上不好，只是提醒大家用合适的锁的粒度才会更高效</em></p><p>在计数器程序例子中，我们会经常这么写:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeCounter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">counter</span><span class="params">()</span></span>&#123;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下图就是上面程序的模型展示:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-17/%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E4%B8%80%E9%94%81%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90%20%281%29.png" alt=""></p><p>这里我们锁的是 this，可以保护 this.count。但有些同学认为 getCount 方法没必要加 synchronized 关键字，因为是读的操作，不会对共享变量做修改，如果不加上 synchronized 关键字，就违背了我们上一篇文章 happens-before 规则中的监视器锁规则:</p><blockquote><p> 对一个锁的解锁 happens-before 于随后对这个锁的加锁<br>也就是说对 count 的写很可能对 count 的读不可见，也就导致脏读</p></blockquote><p>上面我们看到一个 this 锁是可以保护多个资源的，那用多个不同的锁保护一个资源可以吗？来看一段程序:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeCounter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">counter</span><span class="params">()</span></span>&#123;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">calc</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>睁大眼睛仔细看，一个锁的是 this，一个锁的是 UnsafeCounter.class, 他们都想保护共享变量 count，你觉得如何？下图就是行面程序的模型展示:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-17/%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E5%A4%9A%E9%94%81%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90-2.png" alt=""></p><p>两个临界区是用两个不同的锁来保护的，所以临界区没有互斥关系，也就不能保护 count，所以这样加锁是无意义的</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>解决原子性问题，就是要互斥，就是要保证中间状态对外不可见</li><li>锁是解决原子性问题的关键，明确知道我们锁的是什么，要保护的资源是什么，更重要的要知道你的锁能否保护这个受保护的资源(图中的箭头指向)</li><li>有效的临界区是一个入口和一个出口，多个临界区保护一个资源，也就是一个资源有多个并行的入口和多个出口，这就没有起到互斥的保护作用，临界区形同虚设</li><li>锁自己家门能保护资源就没必要锁整个小区，如果锁了整个小区，这严重影响其他业主的活动(锁粒度的问题)</li></ol><p>本文以 synchronized 锁举例来说明如何解决原子性问题，主要是帮助大家建立宏观的理念，用于解决原子性问题，这样后续你看到无论什么锁，只要脑海中回想起本节说明的模型，你会发现都是换汤不换药，学习起来就非常轻松了.</p><p>到这里并发的三大问题 有序性，可见性，原子性都有了解决方案，这是远看并发，让大家有了宏观的概念；但面试和实战都是讲求细节的，接下来我们由远及近，逐步看并发的细节，顺带说明那些面试官经常会问到的问题</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>多个锁锁一个资源一定会有问题吗？</li><li>什么时候需要锁小区，而不能锁某一户呢？</li><li>银行转账，两人互转和别人给自己转，用什么样的锁粒度合适呢？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/I53l5W_Wl-lMc-_FAeJ6WQ" target="_blank" rel="noopener">这次走进并发的世界，请不要错过 </a></li><li><a href="https://mp.weixin.qq.com/s/SrNsvp2NjhAEqYugx6c-3Q" target="_blank" rel="noopener">学并发编程，透彻理解这三个核心是关键</a></li><li><a href="https://mp.weixin.qq.com/s/fQcozKziqMxFMBkptpnuTw" target="_blank" rel="noopener">并发Bug之源有三，请睁大眼睛看清它们</a></li><li><a href="https://mp.weixin.qq.com/s/074jYZWZODJ5Z2qXyWy4gw" target="_blank" rel="noopener">可见性有序性，Happens-before来搞定</a></li><li><a href="https://mp.weixin.qq.com/s/VEWMz9XW95_syiHInUnI0w" target="_blank" rel="noopener">基础面试，为什么面试官总喜欢问String？</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>有序性可见性，Happens-before来搞定</title>
      <link href="//p/java-concurrency-happens-before-rule.html"/>
      <url>//p/java-concurrency-happens-before-rule.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>上一篇文章<a href="https://mp.weixin.qq.com/s/fQcozKziqMxFMBkptpnuTw" target="_blank" rel="noopener">并发 Bug 之源有三，请睁大眼睛看清它们</a> 谈到了<code>可见性/原子性/有序性</code>三个问题，这些问题通常违背我们的直觉和思考模式，也就导致了很多并发 Bug</p><ul><li>为了解决 CPU，内存，IO 的短板，增加了缓存，但这导致了可见性问题</li><li>编译器/处理器<code>擅自</code>优化 ( Java代码在编译后会变成 Java 字节码, 字节码被类加载器加载到 JVM 里,  JVM 执行字节码,  最终需要转化为汇编指令在 CPU 上执行) ，导致有序性问题</li></ul><p>初衷是好的，但引发了新问题，最有效的办法就禁止缓存和编译优化，问题虽然能解决，但「又回到最初的起点，呆呆地站在镜子前」是很尴尬的，我们程序的性能就堪忧了.</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>作为我们程序猿不想写出 bug 影响 KPI，所以希望内存模型易于理解、易于编程。这就需要基于一个<strong>强内存模型</strong>来编写代码</li><li>作为编译器和处理器不想让外人说它处理速度很慢，所以希望内存模型对他们束缚越少越好，可以由他们<strong>擅自优化</strong>，这就需要基于一个<strong>弱内存模型</strong></li></ol><blockquote><p>俗话说:「没有什么事是开会解决不了的，如果有，那就再开一次」😂</p></blockquote><p>JSR-133 的专家们就有了新想法，既然不能完全禁止缓存和编译优化，那就<strong>按需</strong>禁用缓存和编译优化，按需就是要加一些约束，约束中就包括了上一篇文章简单提到过的 <strong>volatile，synchronized，final</strong> 三个关键字，同时还有你可能听过的 <strong>Happens-Before</strong> 原则(包含可见性和有序性的约束)，Happens-before 规则也是本章的主要内容</p><p>为了满足二者的强烈需求，照顾到双方的情绪，于是乎: JMM 就对程序猿说了一个善意的谎言: 「会严格遵守 Happpen-Befores 规则，不会重排序」让程序猿放心，私下却有自己的策略:</p><ol><li>对于会改变程序执行结果的重排序,JMM要求编译器和处理器必须禁止这种重排序。</li><li>对于不会改变程序执行结果的重排序, JMM对编译器和处理器不做要求 (JMM允许这种重排序)。</li></ol><p>我们来用个图说明一下:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-05/JMM%E4%BF%9D%E8%AF%81%20%281%29.png" alt=""></p><blockquote><p>这就是那个善意的谎言，虽是谎言，但还是照顾到了程序猿的利益，所以我们只需要了解 happens-before 规则就能得到保证 (图画了好久，不知道是否说明了谎言的所在😅，欢迎留言)</p></blockquote><h2 id="Happens-before"><a href="#Happens-before" class="headerlink" title="Happens-before"></a>Happens-before</h2><p>Happens-before 规则主要用来约束两个操作，两个操作之间具有 happens-before 关系, 并不意味着前一个操作必须要在后一个操作之前执行，<strong>happens-before 仅仅要求前一个操作(执行的结果)对后一个操作可见</strong>,   (the first is <strong>visible</strong> to and ordered before the second)</p><p>说了这么多，先来看一小段代码带你逐步走进 Happen-Befores 原则，看看是怎样用该原则解决 <strong>可见性</strong> 和 <strong>有序性</strong> 的问题:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReorderExample</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x = <span class="number">42</span>;    <span class="comment">//1</span></span><br><span class="line">    flag = <span class="keyword">true</span>;    <span class="comment">//2</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123; <span class="comment">//3</span></span><br><span class="line">      System.out.println(x);    <span class="comment">//4</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>假设 A 线程执行 writer 方法，B 线程执行 reader 方法，打印出来的 x 可能会是 0，上一篇文章说明过: 因为代码 1 和 2 没有<strong>数据依赖</strong>关系，所以可能被重排序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag = <span class="keyword">true</span>;    <span class="comment">//2</span></span><br><span class="line">x = <span class="number">42</span>;    <span class="comment">//1</span></span><br></pre></td></tr></table></figure><p>所以，线程 A 将 <code>flag = true</code> 写入<strong>但没有为 x 重新赋值时</strong>，线程 B 可能就已经打印了 x 是 0</p><p>那么为 flag 加上 volatile 关键字试一下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure><p><em>即便加上了 volatile 关键字，这个问题在 java1.5 之前还是没有解决，但 java1.5 和其之后的版本对 volatile 语义做了增强</em>，问题得以解决，这就离不开 Happens-before 规则的约束了，总共有 6 个规则，且看</p><h3 id="程序顺序性规则"><a href="#程序顺序性规则" class="headerlink" title="程序顺序性规则"></a>程序顺序性规则</h3><blockquote><p> <strong>一个线程中</strong>的每个操作, happens-before 于该线程中的任意后续操作<br>第一感觉这个原则是一个在理想状态下的”废话”，并且和上面提到的会出现重排序的情况是矛盾的，注意这里是一个线程中的操作，其实隐含了「as-if-serial」语义: 说白了就是只要执行结果不被改变，无论怎么”排序”，都是对的</p></blockquote><p>这个规则是一个基础规则，happens-before 是多线程的规则，所以要和其他规则约束在一起才能体现出它的顺序性，别着急，继续向下看</p><h3 id="volatile变量规则"><a href="#volatile变量规则" class="headerlink" title="volatile变量规则"></a>volatile变量规则</h3><blockquote><p> 对一个 volatile 域的写, happens-before 于任意后续对这个 volatile 域的读</p></blockquote><p>我将上面的程序添加两行代码作说明:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReorderExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> y = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span>&#123;</span><br><span class="line">x = <span class="number">42</span>;<span class="comment">//1</span></span><br><span class="line">y = <span class="number">50</span>;<span class="comment">//2</span></span><br><span class="line">flag = <span class="keyword">true</span>;<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (flag)&#123;<span class="comment">//4</span></span><br><span class="line">System.out.println(<span class="string">"x:"</span> + x);<span class="comment">//5</span></span><br><span class="line">System.out.println(<span class="string">"y:"</span> + y);<span class="comment">//6</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里涉及到了 volatile 的内存增强语义，先来看个表格:</p><table><thead><tr><th>能否重排序</th><th>第二个操作</th><th>第二个操作</th><th>第二个操作</th></tr></thead><tbody><tr><td>第一个操作</td><td>普通读/写</td><td>volatile 读</td><td>volatile 写</td></tr><tr><td>普通读/写</td><td>-</td><td>-</td><td>NO</td></tr><tr><td>volatile 读</td><td>NO</td><td>NO</td><td>NO</td></tr><tr><td>volatile 写</td><td>-</td><td>NO</td><td>NO</td></tr></tbody></table><p>从这个表格 <strong>最后一列</strong> 可以看出:</p><blockquote><p> 如果第二个操作为 volatile 写，不管第一个操作是什么，都不能重排序，<strong>这就确保了 volatile 写之前的操作不会被重排序到 volatile 写之后</strong><br>拿上面的代码来说，代码 1 和 2 不会被重排序到代码 3 的后面，但代码 1 和 2 可能被重排序 (没有依赖也不会影响到执行结果)，说到这里和 <strong>程序顺序性规则</strong>是不是就已经关联起来了呢？</p></blockquote><p>从这个表格的 <strong>倒数第二行</strong> 可以看出:</p><blockquote><p> 如果第一个操作为 volatile 读，不管第二个操作是什么，都不能重排序，<strong>这确保了 volatile 读之后的操作不会被重排序到 volatile 读之前</strong><br>拿上面的代码来说，代码 4 是读取 volatile 变量，代码 5 和 6 不会被重排序到代码 4 之前</p></blockquote><p><em>volatile 内存语义的实现是应用到了 「内存屏障」，因为这完全够单独写一章的内容，这里为了不掩盖主角 Happens-before 的光环，保持理解 Happens-before 的连续性，先不做过多说明</em></p><p>到这里，看这个规则，貌似也没解决啥问题，因为它还要联合第三个规则才起作用</p><h3 id="传递性规则"><a href="#传递性规则" class="headerlink" title="传递性规则"></a>传递性规则</h3><blockquote><p> 如果 A happens-before B, 且 B happens-before C, 那么 A happens-before C<br>直接上图说明一下上面的例子</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-09-05/%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E5%9B%BE.png" alt=""></p><p>从上图可以看出</p><ul><li><code>x =42</code> 和 <code>y = 50</code> Happens-before <code>flag = true</code>, 这是<strong>规则 1</strong></li><li>写变量(代码 3) <code>flag=true</code> Happens-before 读变量(代码 4) <code>if(flag)</code>，这是<strong>规则 2</strong></li></ul><p>根据<strong>规则 3</strong>传递性规则，<code>x =42</code> Happens-before 读变量 <code>if(flag)</code></p><blockquote><p><strong>谜案要揭晓了</strong>: 如果线程 B 读到了 flag 是 true，那么 <code>x =42</code> 和 <code>y = 50</code> 对线程 B 就一定可见了，这就是 Java1.5 的增强 (之前版本是可以普通变量写和 volatile 变量写的重排序的)</p></blockquote><p>通常上面三个规则是一种联合约束，到这里你懂了吗？规则还没完，继续看</p><h3 id="监视器锁规则"><a href="#监视器锁规则" class="headerlink" title="监视器锁规则"></a>监视器锁规则</h3><blockquote><p> 对一个锁的解锁 happens-before 于随后对这个锁的加锁</p></blockquote><p>这个规则我觉得你应该最熟悉了，就是解释 synchronized 关键字的，来看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedExample</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">synBlock</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">// 1.加锁</span></span><br><span class="line"><span class="keyword">synchronized</span> (SynchronizedExample.class)&#123;</span><br><span class="line">x = <span class="number">1</span>; <span class="comment">// 对x赋值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 3.解锁</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.加锁</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">synMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">x = <span class="number">2</span>; <span class="comment">// 对x赋值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 3. 解锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先获取锁的线程，对 x 赋值之后释放锁，另外一个再获取锁，一定能看到对 x 赋值的改动，就是这么简单，请小伙伴用下面命令查看上面程序，看同步块和同步方法被转换成汇编指令有何不同？</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -c -v SynchronizedExample</span><br></pre></td></tr></table></figure><p>这和 synchronized 的语义相关，小伙伴可以先自行了解一下，锁的内容时会做详细说明</p><h3 id="start-规则"><a href="#start-规则" class="headerlink" title="start()规则"></a>start()规则</h3><blockquote><p> 如果线程 A 执行操作 ThreadB.start() (启动线程B),  那么 A 线程的 ThreadB.start() 操作 happens-before 于线程 B 中的任意操作，也就是说，主线程 A 启动子线程 B 后，子线程 B 能看到主线程在启动子线程 B 前的操作，看个程序就秒懂了</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartExample</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> y = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">StartExample startExample = <span class="keyword">new</span> StartExample();</span><br><span class="line"></span><br><span class="line">Thread thread1 = <span class="keyword">new</span> Thread(startExample::writer, <span class="string">"线程1"</span>);</span><br><span class="line">startExample.x = <span class="number">10</span>;</span><br><span class="line">startExample.y = <span class="number">20</span>;</span><br><span class="line">startExample.flag = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">thread1.start();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"主线程结束"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span>&#123;</span><br><span class="line">System.out.println(<span class="string">"x:"</span> + x );</span><br><span class="line">System.out.println(<span class="string">"y:"</span> + y );</span><br><span class="line">System.out.println(<span class="string">"flag:"</span> + flag );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主线程结束</span><br><span class="line">x:10</span><br><span class="line">y:20</span><br><span class="line">flag:true</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><p>线程 1 看到了主线程调用 thread1.start() 之前的所有赋值结果，这里没有打印「主线程结束」，你知道为什么吗？这个守护线程知识有关系</p><h3 id="join-规则"><a href="#join-规则" class="headerlink" title="join()规则"></a>join()规则</h3><blockquote><p>如果线程 A 执行操作 ThreadB.join() 并成功返回, 那么线程 B 中的任意操作 happens-before 于线程 A 从 ThreadB.join() 操作成功返回，<strong>和 start 规则刚好相反</strong>，主线程 A 等待子线程 B 完成，当子线程 B 完成后，主线程能够看到子线程 B 的赋值操作，将程序做个小改动，你也会秒懂的</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinExample</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> y = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">JoinExample joinExample = <span class="keyword">new</span> JoinExample();</span><br><span class="line"></span><br><span class="line">Thread thread1 = <span class="keyword">new</span> Thread(joinExample::writer, <span class="string">"线程1"</span>);</span><br><span class="line">thread1.start();</span><br><span class="line"></span><br><span class="line">thread1.join();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"x:"</span> + joinExample.x );</span><br><span class="line">System.out.println(<span class="string">"y:"</span> + joinExample.y );</span><br><span class="line">System.out.println(<span class="string">"flag:"</span> + joinExample.flag );</span><br><span class="line">System.out.println(<span class="string">"主线程结束"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">this</span>.x = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">this</span>.y = <span class="number">200</span>;</span><br><span class="line"><span class="keyword">this</span>.flag = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x:100</span><br><span class="line">y:200</span><br><span class="line">flag:true</span><br><span class="line">主线程结束</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><p>「主线程结束」这几个字打印出来喽，依旧和线程何时退出有关系</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li><strong>Happens-before 重点是解决前一个操作结果对后一个操作可见</strong>，相信到这里，你已经对 Happens-before 规则有所了解，这些规则解决了多线程编程的可见性与有序性问题，但还没有完全解决原子性问题(除了 synchronized)</li><li>start 和 join 规则也是解决主线程与子线程通信的方式之一</li><li>从内存语义的角度来说, volatile 的<code>写-读</code>与锁的<code>释放-获取</code>有相同的内存效果；volatile 写和锁的释放有相同的内存语义; volatile 读与锁的获取有相同的内存语义，⚠️⚠️⚠️(敲黑板了) volatile 解决的是可见性问题，synchronized 解决的是原子性问题，这绝对不是一回事，后续文章也会说明</li></ol><h2 id="附加说明"><a href="#附加说明" class="headerlink" title="附加说明"></a>附加说明</h2><ol><li>个人博客会首发原创文章，如文章有密码保护，通过查看文章的<strong>创建日期</strong>，如果是 1 月份，请公众号回复当前月份数值即可，如回复「1」</li><li>多线程系列文章整体会按照我的大纲节奏来写，但是如果大家有什么疑问，也欢迎到我单独建立的<a href="https://dayarch.top/2019/09/11/duo-xian-cheng-xi-lie-wen-ti-liu-yan-hui-zong/">多线程系列问题留言汇总</a> 文章中留言，我会统一回复，如果共通疑问很多，我会插入相关章节单独做说明</li><li>并发文章的相关代码，我也会同步上传到代码库，公众号回复「demo」，点击链接，找到concurrency 子项目即可</li><li>如果文章对你有帮助，烦请小伙伴转发分享给更多朋友，我们一起进步</li></ol><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>同步块和同步方法在编译成 CPU 指令后有什么不同？</li><li>线程有 Daemon(守护线程)和非 Daemon 线程，你知道线程的退出策略吗？</li><li>关于 Happens-before 你还有哪些疑惑呢？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><h3 id="MarkDown-表格生成器"><a href="#MarkDown-表格生成器" class="headerlink" title="MarkDown 表格生成器"></a>MarkDown 表格生成器</h3><p>本文的好多表格是从官网粘贴的，如何将其直接转换成 MD table 呢？那么 <a href="https://www.tablesgenerator.com/markdown_tables" target="_blank" rel="noopener">https://www.tablesgenerator.com/markdown_tables</a> 就可以帮到你了，无论是生成 MD table，还是粘贴内容生成 table 和内容都是极好的，当然了不止 MD table，自己发现吧，更多工具，公众号回复 「工具」获得</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-10-52-55.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/q5cyK14WGiMm-R6NIFBcTg" target="_blank" rel="noopener">每天用SpringBoot，还不懂RESTful API返回统一数据格式是怎么实现的？ </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/ilND8u_8HGSTSrJiMB4X8g" target="_blank" rel="noopener">红黑树，超强动静图详解，简单易懂</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Happens-before </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>并发编程三大问题</title>
      <link href="//p/java-concurrency-three-questions.html"/>
      <url>//p/java-concurrency-three-questions.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><blockquote><ul><li>生活中你一定听说过——能者多劳</li><li>作为 Java 程序员，你一定听过——这个功能请求慢，能加一层缓存或优化一下 SQL 吗？</li><li>看过中国古代神话故事的也一定听过——天上一天，地上一年</li></ul></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/scotland-540119_1920.jpg" alt=""></p><p>一切设计来源于生活，上一章 <a href="https://mp.weixin.qq.com/s/SrNsvp2NjhAEqYugx6c-3Q" target="_blank" rel="noopener">学并发编程，透彻理解这三个核心是关键</a>  中有讲过，作为”资本家”，你要尽可能的榨取 CPU，内存与 IO 的剩余价值，但三者完成任务的速度相差很大，CPU &gt; 内存 &gt; IO分，CPU 是天，那内存就是地，内存是天，那 IO 就是地，那怎样平衡三者，提升整体速度呢？</p><ol><li>CPU 增加缓存，还不止一层缓存，平衡内存的慢</li><li>CPU 能者多劳，通过分时复用，平衡 IO 的速度差异</li><li>优化编译指令</li></ol><p>上面的方式貌似解决了木桶短板问题，但同时这种解决方案也伴随着产生新的<strong>可见性，原子性，和有序性</strong>的问题，且看</p><h2 id="三大问题"><a href="#三大问题" class="headerlink" title="三大问题"></a>三大问题</h2><h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><p><strong>一个线程对共享变量的修改，另外一个线程能够立刻看到，我们称为可见性</strong></p><p>谈到可见性，要先引出 JMM (Java Memory Model) 概念, 即 Java 内存模型，Java 内存模型规定，将所有的变量都存放在 <strong>主内存</strong> 中，当线程使用变量时，会把主内存里面的变量 <strong>复制</strong> 到自己的工作空间或者叫作 <strong>私有内存</strong> ，线程读写变量时操作的是自己工作内存中的变量。</p><p>用 Git 的工作流程理解上面的描述就很简单了，<strong>Git 远程仓库就是主内存，Git 本地仓库就是自己的工作内存</strong></p><p>文字描述有些抽象，我们来图解说明:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/Untitled%20Diagram%20%281%29.png" alt=""></p><p>看这个场景:</p><blockquote><ol><li>主内存中有变量 x，初始值为 0</li><li>线程 A 要将 x 加 1，先将 x=0 拷贝到自己的私有内存中，然后更新 x 的值</li><li><strong>线程 A 将更新后的 x 值回刷到主内存的时间是不固定的</strong></li><li>刚好在线程 A 没有回刷 x 到主内存时，线程 B 同样从主内存中读取 x，此时为 0，和线程 A 一样的操作，最后期盼的 x=2 就会编程 x=1</li></ol></blockquote><p>这就是线程可见性的问题</p><p>JMM 是一个抽象的概念，在实际实现中，线程的工作内存是这样的:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/Untitled%20Diagram%20%282%29.png" alt=""></p><p>为了平衡内存/IO 短板，会在 CPU 上增加缓存，每个核都只有自己的一级缓存，甚至有一个所有 CPU 都共享的二级缓存，就是上图的样子了，都说这么设计是硬件同学留给软件同学的一个坑，但能否跳过去这个坑也是衡量软件同学是否走向 Java 进阶的关键指标吧……</p><blockquote><h4 id="小提示"><a href="#小提示" class="headerlink" title="小提示"></a>小提示</h4><p>从上图中你也可以看出，在 Java 中，所有的实例域，静态域和数组元素都存储在堆内存中，堆内存在线程之间共享，这些在后续文章中都称之为「共享变量」，局部变量，方法定义参数和异常处理器参数不会在线程之间共享，所以他们不会有内存可见性的问题，也就不受内存模型的影响</p></blockquote><p><strong>一句话，要想解决多线程可见性问题，所有线程都必须要刷取主内存中的变量</strong><br>怎么解决可见性问题呢？Java 关键字 <strong>volatile</strong> 帮你搞定，后续章节会分析……</p><h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><p>原子（atom）指化学反应不可再分的基本微粒，原子性操作你应该能感受到其含义:</p><blockquote><p> 所谓原子操作是指不会被线程调度机制打断的操作；这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch</p></blockquote><p>小品「钟点工」有一句非常经典的台词，要把大象装冰箱，总共分几步？</p><p>来看一小段程序:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/2019-09-04-15-47-39%402x.png" alt=""></p><p>多线程情况下能得到我们期盼的 <code>count = 20000</code> 的值吗？ 也许有同学会认为，线程调用的 counter 方法只有一个 count++ 操作，是单一操作，所以是原子性的，非也。在线程第一讲中说过我们不能用高级语言思维来理解 CPU 的处理方式，count++ 转换成 CPU 指令则需要三步，通过下面命令解析出汇编指令等信息:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -c UnsafeCounter</span><br></pre></td></tr></table></figure><p>截取 counter 方法的汇编指令来看:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/2019-09-04-15-48-42%402x.png" alt=""></p><p>解释一下上面的指令，<br>16 : 获取当前 count 值，并且放入栈顶<br>19 : 将常量 1 放入栈顶<br>20 : 将当前栈顶中两个值相加，并把结果放入栈顶<br>21 : 把栈顶的结果再赋值给 count</p><p>由此可见，简单的 count++ 不是一步操作，被转换为汇编后就不具备原子性了，就好比大象装冰箱，其实要分三步:</p><blockquote><p>第一步，把冰箱门打开；第二步，把大象放进去；第三步，把冰箱门带上</p></blockquote><p>结合 JMM 结构图理解，说明一下为什么很难得到 <code>count=20000</code> 的结果:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/Untitled%20Diagram%20%284%29.png" alt=""></p><p>多线程计数器，如何保证多个操作的原子性呢？最粗暴的方式是在方法上加 <strong>synchronized</strong> 关键字，比如这样:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/2019-09-04-15-49-53%402x.png" alt=""></p><p>问题是解决了，如果 synchronized 是万能良方，那么也许并发就没那么多事了，可以靠一个 synchronized 走天下了，事实并不是这样，synchronized 是独占锁 (同一时间只能有一个线程可以调用)，没有获取锁的线程会被阻塞；另外也会带来很多线程切换的上下文开销</p><p>所以 JDK 中就有了非阻塞 CAS (Compare and <strong>Swap</strong>) 算法实现的原子操作类 AtomicLong 等工具类，看过源码的同学也许会发现一个共同特点，所有原子类中都有下面这样一段代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br></pre></td></tr></table></figure><p>这个类是 JDK 的 rt.jar 包中的 Unsafe 类提供了 <strong>硬件级别</strong> 的原子性操作，类中的方法都是 native 修饰的，后面介绍原子类之前也会先说明这个类中的几个方法，这里先简单介绍有个印象即可。</p><p>有同学不理解我刚刚提到的线程上下文切换开销很大是什么意思，举 2个例子你就懂了:</p><blockquote><ul><li>你(CPU)在看两本书(两个线程)，看第一本书很短时间后要去看第二本书，看第二本书很短时间后又回看第一本书，并要精确的记得看到第几行，当初看到了什么(CPU 记住线程级别的信息)，当让你 <strong>“同时”</strong> 看 10 本甚至更多，切换的开销就很大了吧</li><li>综艺节目中有很多游戏，让你一边数钱，又要一边做其他的事，最终保证多样事情都做正确，大脑开销大不大，你试试就知道了😊</li></ul></blockquote><h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><p>生活中你问候他人「吃了吗你？」和「你吃了吗？」是一个意思，你写的是下面程序:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span>；</span><br><span class="line">b =  <span class="number">2</span>;</span><br><span class="line">System.out.println(a);</span><br><span class="line">System.out.println(b);</span><br></pre></td></tr></table></figure><p>编译器优化后可能就变成了这样:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b =  <span class="number">2</span>;</span><br><span class="line">a = <span class="number">1</span>；</span><br><span class="line">System.out.println(a);</span><br><span class="line">System.out.println(b);</span><br></pre></td></tr></table></figure><p>这个情况，编译器调整了语句顺序没什么影响，但编译器 <strong>擅自</strong> 优化顺序，就给我们埋下了雷，比如应用双重检查方式实现的单例</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/2019-09-04-15-50-34%402x.png" alt=""></p><p>一切又很完美是不是，非也，问题出现在 <code>instance = new Singleton();</code>，这 1 行代码转换成了 CPU 指令后又变成了 3 个，我们理解 new 对象应该是这样的:</p><ol><li>分配一块内存 M</li><li>在内存 M 上初始化 Singleton 对象</li><li>然后 M 的地址赋值给 instance 变量</li></ol><p>但编译器<strong>擅自</strong>优化后可能就变成了这样:</p><ol><li>分配一块内存 M</li><li>然后将 M 的地址赋值给 instance 变量</li><li>在内存 M 上初始化 Singleton 对象</li></ol><p>首先 new 对象分了三步，给 CPU 留下了切换线程的机会；另外，编译器优化后的顺序可能导致问题的发生，来看:</p><blockquote><ol><li>线程 A 先执行 getInstance 方法，当执行到指令 2 时，恰好发生了线程切换</li><li>线程 B 刚进入到 getInstance 方法，判断 if 语句 instance 是否为空</li><li>线程 A 已经将 M 的地址赋值给了 instance 变量，所以线程 B 认为 instance 不为空</li><li>线程 B 直接 return instance 变量</li><li>CPU 切换回线程 A，线程 A 完成后续初始化内容</li></ol></blockquote><p>我们还是画个图说明一下:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-28/%E5%8D%95%E4%BE%8B%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2.png" alt=""></p><p>如果线程 A 执行到第 2 步，线程切换，由于线程 A 没有把红色箭头执行完全，线程 B 就会得到一个未初始化完全的对象，访问 instance 成员变量的时候就可能发生 NPE，如果将变量 instance 用 volatile 或者 final 修饰(涉及到类的加载机制，可看我之前写的文章: <a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a>)，问题就解决了.</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>你所看到的程序并不一定是编译器优化/编译后的 CPU 指令，大象装冰箱是是个程序，但其隐含三个步骤，学习并发编程，你要按照 CPU 的思维考虑问题，所以你需要深刻理解 <strong>可见性/原子性/有序性</strong> ，这是产生并发 Bug 的源头</p><p>本节说明了三个问题，下面的文章也会逐个分析解决以上问题的办法，以及相对优的方案，请持续关注，另外关于并发的测试代码我都会按例上传到 github，公众号回复「demo」——&gt; concurrency 获取更多内容</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>为什么用 final 修饰的变量就是线程安全的了呢？</li><li>你会经常查看 CPU 汇编指令吗？</li><li>如果让你写单例，你通常会采用哪种实现？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><h3 id="Material-Theme-UI"><a href="#Material-Theme-UI" class="headerlink" title="Material Theme UI"></a>Material Theme UI</h3><p>这是一款 IDEA 的主题插件，安装后，选择 <code>Material Palenight</code> 主题，同时作出如下设置<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/2019-08-31-11-43-17.png" alt=""></p><p>设置完后，你的 IDEA 就是下面这样，引起极度舒适<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/2019-08-31-11-39-58.jpg" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/q5cyK14WGiMm-R6NIFBcTg" target="_blank" rel="noopener">每天用SpringBoot，还不懂RESTful API返回统一数据格式是怎么实现的？ </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/ilND8u_8HGSTSrJiMB4X8g" target="_blank" rel="noopener">红黑树，超强动静图详解，简单易懂</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 可见性 </tag>
            
            <tag> 原子性 </tag>
            
            <tag> 有序性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis拦截器实现数据加密与解密</title>
      <link href="//p/mybatis-interceptor-encrypt-decrypt.html"/>
      <url>//p/mybatis-interceptor-encrypt-decrypt.html</url>
      
        <content type="html"><![CDATA[<h2 id="拦截器介绍"><a href="#拦截器介绍" class="headerlink" title="拦截器介绍"></a>拦截器介绍</h2><p><code>Mybatis Interceptor</code>  在 Mybatis 中被当作 Plugin(插件)，不知道为什么，但确实是在 <code>org.apache.ibatis.plugin</code> 包下面</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/_image/2019-06-04/sunset-3689760.jpg" alt=""></p><p>既然是拦截器，可以拦截哪些内容呢？试想一下…… 当程序写到持久层时，Mybatis 会 <strong>执行</strong> 指定 <strong>SQL 语句</strong>，并处理 <strong>请求参数</strong> 和 <strong>返回值</strong>。没错，Mybatis 拦截器可以帮助我们处理上述内容，请看<a href="http://www.mybatis.org/mybatis-3/zh/configuration.html#plugins" target="_blank" rel="noopener">官网</a>的 Plugins 的片段, 内容不多</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行</span></span><br><span class="line">Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</span><br><span class="line"><span class="comment">// 请求参数处理</span></span><br><span class="line">ParameterHandler (getParameterObject, setParameters)</span><br><span class="line"><span class="comment">// 返回结果集处理</span></span><br><span class="line">ResultSetHandler (handleResultSets, handleOutputParameters)</span><br><span class="line"><span class="comment">// SQL语句构建</span></span><br><span class="line">StatementHandler (prepare, parameterize, batch, update, query)</span><br></pre></td></tr></table></figure><h2 id="拦截器的使用"><a href="#拦截器的使用" class="headerlink" title="拦截器的使用"></a>拦截器的使用</h2><p>如果需要实现自定义的拦截器，只需要实现 <code>org.apache.ibatis.plugin.Interceptor</code> 接口，该接口有三个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Object <span class="title">plugin</span><span class="params">(Object target)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span></span>;</span><br></pre></td></tr></table></figure><p>我们要实现数据加密，进入数据库的字段不能是真实的数据，但是返回来的数据要真实可用，所以我们需要针对 Parameter 和 ResultSet 两种类型处理，同时为了更灵活的使用，我们需要自定义注解</p><h3 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h3><p>类注解，将注解放在实体类上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要加解密的类注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Target</span>(&#123; ElementType.TYPE &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EncryptDecryptClass &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>字段注解，将注解放在实体字段上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加密字段注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Target</span>(&#123; ElementType.FIELD &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EncryptDecryptField &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有了这两个注解，我们可以在我们可以标记我们要处理的实体和实体中的字段</p><h3 id="自定义参数处理拦截器"><a href="#自定义参数处理拦截器" class="headerlink" title="自定义参数处理拦截器"></a>自定义参数处理拦截器</h3><p>参考官网，通过 <code>@Intercepts</code> 和 <code>@Signature</code> 的联合使用，指定 <code>ParameterHandler.class</code> 类型，同时通过 <code>@Component</code> 注解注入到容器中，即可在设置参数的时候进行拦截，通过自定义接口 <code>IEncryptDecrypt</code>, 根据 Field 的各种类型自定义加密解密算法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts</span>(&#123;</span><br><span class="line"><span class="meta">@Signature</span>(type = ParameterHandler.class, method = <span class="string">"setParameters"</span>, args = PreparedStatement.class),</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"domain.encrypt"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParammeterInterceptor</span>  <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IEncryptDecrypt encryptDecrypt;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"拦截器ParamInterceptor"</span>);</span><br><span class="line"><span class="comment">//拦截 ParameterHandler 的 setParameters 方法 动态设置参数</span></span><br><span class="line"><span class="keyword">if</span> (invocation.getTarget() <span class="keyword">instanceof</span> ParameterHandler) &#123;</span><br><span class="line">ParameterHandler parameterHandler = (ParameterHandler) invocation.getTarget();</span><br><span class="line">PreparedStatement ps = (PreparedStatement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反射获取 BoundSql 对象，此对象包含生成的sql和sql的参数map映射</span></span><br><span class="line"><span class="comment">/*Field boundSqlField = parameterHandler.getClass().getDeclaredField("boundSql");</span></span><br><span class="line"><span class="comment">boundSqlField.setAccessible(true);</span></span><br><span class="line"><span class="comment">BoundSql boundSql = (BoundSql) boundSqlField.get(parameterHandler);*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 反射获取 参数对像</span></span><br><span class="line">Field parameterField =</span><br><span class="line">parameterHandler.getClass().getDeclaredField(<span class="string">"parameterObject"</span>);</span><br><span class="line">parameterField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object parameterObject = parameterField.get(parameterHandler);</span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(parameterObject))&#123;</span><br><span class="line">Class&lt;?&gt; parameterObjectClass = parameterObject.getClass();</span><br><span class="line">EncryptDecryptClass encryptDecryptClass = AnnotationUtils.findAnnotation(parameterObjectClass, EncryptDecryptClass.class);</span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(encryptDecryptClass))&#123;</span><br><span class="line">Field[] declaredFields = parameterObjectClass.getDeclaredFields();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Object encrypt = encryptDecrypt.encrypt(declaredFields, parameterObject);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> invocation.proceed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Plugin.wrap(o, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样新建结果集拦截器</p><h3 id="结果集拦截器"><a href="#结果集拦截器" class="headerlink" title="结果集拦截器"></a>结果集拦截器</h3><p>与参数拦截器基本一样, 只不过类型指定为 <code>ResultSetHandler.class</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts</span>(&#123;</span><br><span class="line"><span class="meta">@Signature</span>(type = ResultSetHandler.class, method = <span class="string">"handleResultSets"</span>, args=&#123;Statement.class&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"domain.decrypt"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IEncryptDecrypt encryptDecrypt;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">Object result = invocation.proceed();</span><br><span class="line"><span class="keyword">if</span> (Objects.isNull(result))&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result <span class="keyword">instanceof</span> ArrayList) &#123;</span><br><span class="line">ArrayList resultList = (ArrayList) result;</span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.isNotEmpty(resultList) &amp;&amp; needToDecrypt(resultList.get(<span class="number">0</span>)))&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; resultList.size(); i++) &#123;</span><br><span class="line">encryptDecrypt.decrypt(resultList.get(i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (needToDecrypt(result))&#123;</span><br><span class="line">encryptDecrypt.decrypt(result);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">needToDecrypt</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line">Class&lt;?&gt; objectClass = object.getClass();</span><br><span class="line">EncryptDecryptClass encryptDecryptClass = AnnotationUtils.findAnnotation(objectClass, EncryptDecryptClass.class);</span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(encryptDecryptClass))&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="加密解密"><a href="#加密解密" class="headerlink" title="加密解密"></a>加密解密</h3><p><code>IEncryptDecrypt</code> 接口定义了 加密和解密两个方法，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IEncryptDecrypt</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加密方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> declaredFields 反射bean成员变量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parameterObject Mybatis入参</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">encrypt</span><span class="params">(Field[] declaredFields, T parameterObject)</span> <span class="keyword">throws</span> IllegalAccessException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解密方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> result Mybatis 返回值，需要判断是否是ArrayList类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">decrypt</span><span class="params">(T result)</span> <span class="keyword">throws</span> IllegalAccessException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两个拦截器通过在 YAML 中配置属性，按条件注入，外加自定义加密解密算法，完成全局灵活的配置。<br>核心代码已上传至 <a href="https://github.com/FraserYu/learnings/tree/master/mybatis-interceptor/interceptor" target="_blank" rel="noopener">Github Demo</a></p><h2 id="问题彩蛋"><a href="#问题彩蛋" class="headerlink" title="问题彩蛋"></a>问题彩蛋</h2><p>也许应对当前的业务，看了该文章满足了当下需求，我们目前只看到了什么是 Mybatis 拦截器，怎样简单使用，拦截器的其他用法以及其他很多为什么都没有解决，关注公众号，回复“人迹罕至” 读完文章 「程序猿为什么要看源码」后 ，我不会满足眼前的这些基本应用，我会有诸多疑问，</p><ol><li>我们日常写 CRUD 的业务，为什么 Executor 中只有 R(query) 和 U(update), 那么C(insert) 和 D(delete) 怎样处理的？</li><li>自定义拦截器是以什么方式被执行的，执行顺序是什么？</li><li>分页也是 Mybatis 拦截器的一种，带有分页的框架是怎样使用拦截器的呢？如 <code>Mybatis Plus</code>, <code>PageHelper</code></li><li>虽然重写了 Inteceptor 接口的 <code>public void setProperties(Properties properties)</code> 方法，但是并没有写什么业务逻辑，这个方法能怎样使用？</li><li>……<br>后续文章也会通过读源码的方式逐步解析这些问题，当然你有相关问题也可以留言交流讨论</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p>依旧推荐在写文章时用到的高效工具，后续相关工具也会在文章中陆续更新，请持续关注</p><h3 id="MyBatis-Log-Plugin"><a href="#MyBatis-Log-Plugin" class="headerlink" title="MyBatis Log Plugin"></a>MyBatis Log Plugin</h3><p>MyBatis Log Plugin 是 Intelligj IDEA 的一个插件，用来从 Mybatis 输出的 log 中提取出当前调用的 SQL 语句，并将参数封装在 SQL 语句中组成完整的 SQL，这样，当我们调试的时候更加清晰方便，可以轻松定位是否 SQL 又问题</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/_image/2019-06-04/MyBatisLogPlugin.gif" alt=""></p><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/q5cyK14WGiMm-R6NIFBcTg" target="_blank" rel="noopener">每天用SpringBoot，还不懂RESTful API返回统一数据格式是怎么实现的？ </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/ilND8u_8HGSTSrJiMB4X8g" target="_blank" rel="noopener">红黑树，超强动静图详解，简单易懂</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java String基础面试</title>
      <link href="//p/java-string-interview.html"/>
      <url>//p/java-string-interview.html</url>
      
        <content type="html"><![CDATA[<p>关于 Java String，这是面试的基础，但是还有很多童鞋不能说清楚，所以本文将简单而又透彻的说明一下那个让你迷惑的 String</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/mountain-landscape-2031539_1920.jpg" alt=""></p><p>在 Java 中，我们有两种方式创建一个字符串</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"abc"</span>;</span><br><span class="line">String y = <span class="keyword">new</span> String(<span class="string">"abc"</span>);</span><br></pre></td></tr></table></figure><p>你常见也常写第一种，很少见第二种，但面试还总问这类问题，双引号和构造器两种形式创建字符串到底有什么差别呢？</p><p>先来看例子</p><h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子 1"></a>例子 1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String a = <span class="string">"abcd"</span>;</span><br><span class="line">String b = <span class="string">"abcd"</span>;</span><br><span class="line">System.out.println(a == b);  <span class="comment">// True</span></span><br><span class="line">System.out.println(a.equals(b)); <span class="comment">// True</span></span><br></pre></td></tr></table></figure><p><code>a == b</code> 结果为 true，是因为 a 和 b 都指向 <strong>方法区(method area)</strong> 同一个字符串文字，内存引用是同一个</p><p>当多次创建相同的字符串文字时，只存储每个不同字符串值的一个副本。这个叫做<strong>字符串留驻/留用</strong>，Java 中所有编译期字符串常量都会被自动留驻</p><h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子 2"></a>例子 2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String c = <span class="keyword">new</span> String(<span class="string">"abcd"</span>);</span><br><span class="line">String d = <span class="keyword">new</span> String(<span class="string">"abcd"</span>);</span><br><span class="line">System.out.println(c == d);  <span class="comment">// False</span></span><br><span class="line">System.out.println(c.equals(d)); <span class="comment">// True</span></span><br></pre></td></tr></table></figure><p><code>c==d</code> 结果为 false，因为 c 和 d 的引用指向<strong>堆</strong>中不同的对象，<code>不同的对象肯定有不同的内存引用</code></p><p>举了两个例子，文字描述有点懵？我们来试图通过图形来理解上述两种情况:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/2019-08-30-18-44-15.jpg" alt=""></p><p>也许你已经看看出来了，一个是在<code>方法区</code>，一个是在<code>堆</code>中，在 JVM 模型中这是两个不同的区域，也许你面试时也经常被问到吧，来看下图:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/2019-08-30-18-47-02.jpg" alt=""></p><p>再次提醒一下，所有 new 的对象都会在 Heap 中，这样以后你就好区分了</p><h2 id="运行期字符串留驻"><a href="#运行期字符串留驻" class="headerlink" title="运行期字符串留驻"></a>运行期字符串留驻</h2><p>上面说的字符串留驻是在编译期，那么运行期可以吗？答案是肯定的，我们需要一个函数来帮忙</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String c = <span class="keyword">new</span> String(<span class="string">"abcd"</span>).intern();</span><br><span class="line">String d = <span class="keyword">new</span> String(<span class="string">"abcd"</span>).intern();</span><br><span class="line">System.out.println(c == d);  <span class="comment">// Now true</span></span><br><span class="line">System.out.println(c.equals(d)); <span class="comment">// True</span></span><br></pre></td></tr></table></figure><p>看到 <code>c == d</code> 结果为 true，你应该理解 intern (英文有拘留，软禁的意思)的作用了，通过调用 intern()方法，就好比把创建的字符串拘留在方法区一样了</p><p>在面试时甚至还会问你下面代码创建了几个对象:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String d = <span class="keyword">new</span> String(<span class="string">"abcd"</span>)</span><br></pre></td></tr></table></figure><ol><li>如果方法区已存在”abcd”, 那么只创建一个 new String 的对象</li><li>如果方法区没有”abcd”, 那么要创建两个对象，一个在方法区，一个在堆中</li></ol><p>所以，<strong>正常情况</strong>下我们没必要使用构造器创建对象，因为这很可能会产生一个额外的没用的对象，但是有例外哦，我们下面说</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"abcd"</span>;</span><br><span class="line">s = s.concat(<span class="string">"ef"</span>);</span><br></pre></td></tr></table></figure><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/2019-08-30-20-38-21.jpg" alt=""></p><p>当我们想在字符串 s 后面拼接字符”ef”时，会在堆中创建一个新的对象，并将 s 的引用指向新创建的对象，由于 String 创建的是不可变对象，所以 <strong>String 类中的所有方法都不会改变它自身，而是返回一个新的字符串(快打开你的 IDE，看看是否每个操作String 的方法最后都是返回有 return new String 字样)</strong>，到这里你也应该理解了一个道理:</p><blockquote><p> 如果我们需要一个字符串被修改，我们最好使用 StringBuffer 或者 StringBuilder，否则，由于每次操作字符串都会创建一个新的对象，而旧的对象不会有引用指向它，这样我们会浪费很多垃圾回收的时间</p></blockquote><p>到这里还没完，你有没有想过为什么 String 会被设置/制造成 final？</p><h2 id="为什么-String-类被-final-修饰"><a href="#为什么-String-类被-final-修饰" class="headerlink" title="为什么 String 类被 final 修饰"></a>为什么 String 类被 final 修饰</h2><p>谈及这个问题我们需要一些倒推的或者相互约束思维来思考</p><h3 id="字符串池的需求"><a href="#字符串池的需求" class="headerlink" title="字符串池的需求"></a>字符串池的需求</h3><p>字符串池(String intern pool)是方法区域中的一个特殊存储区域。当创建一个字符串时，如果该字符串已经存在于池中，那么返回现有字符串的引用，而不是创建一个新对象。所以说，如果一个字符串是可变的，那么改变一个引用的值，将导致原本指向该值的引用获取到错误的值</p><h3 id="缓存-hashcode"><a href="#缓存-hashcode" class="headerlink" title="缓存 hashcode"></a>缓存 hashcode</h3><p>字符串的hashcode在Java中经常使用。例如，在HashMap或HashSet中。不可变保证hashcode始终是相同的，这样就可以在不担心更改的情况下兑现它。这意味着，不需要每次使用hashcode时都计算它。这样更有效率。所以你会在 String 类中看到下面的成员变量的定义:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Cache the hash code for the string */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> hash; <span class="comment">// Default to 0</span></span><br></pre></td></tr></table></figure><h3 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h3><p>String被广泛用作许多java类的参数，例如网络连接、打开文件等。如果字符串不是不可变的，连接或文件将被更改，这可能导致严重的安全威胁。该方法认为它连接到一台机器上，但实际上并没有。<strong>可变字符串也可能导致反射中的安全问题，因为参数是字符串</strong>。</p><h3 id="不可变对象天生是线程安全的"><a href="#不可变对象天生是线程安全的" class="headerlink" title="不可变对象天生是线程安全的"></a>不可变对象天生是线程安全的</h3><p>由于不可变对象不能被更改，所以它们可以在多个线程之间自由共享。这消除了同步的需求。</p><p>总之，出于效率和安全性的考虑，String 被设计为不可变的。这也是为什么在一般情况下，不可变类是首选的原因。</p><h2 id="附加说明"><a href="#附加说明" class="headerlink" title="附加说明"></a>附加说明</h2><p>关于不可变对象和不可变引用总是有同学搞不清楚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> User user = <span class="keyword">new</span> User();</span><br></pre></td></tr></table></figure><p>上面的代码指的是 user 引用不能被更改指向内存的其他地址，但是由于 User 是可变对象，我们可以调用 user 的 setter 方法修改其属性</p><p>在String类中包含很多学问，包括你对JVM模型的理解，这也就是为什么面试官为什么喜欢问String，主要考察你的基本功</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>String 和基本类型的包装类如 Integer 和 Long 都被 final 修饰，但为什么不建议作为 synchronized 同步块的参数适用呢？</li><li>基本类型自动装箱你知道发生了什么吗？和上一个问题有关系</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><h3 id="Material-Theme-UI"><a href="#Material-Theme-UI" class="headerlink" title="Material Theme UI"></a>Material Theme UI</h3><p>这是一款 IDEA 的主题插件，安装后，选择 <code>Material Palenight</code> 主题，同时作出如下设置<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/2019-08-31-11-43-17.png" alt=""></p><p>设置完后，你的 IDEA 就是下面这样，引起极度舒适<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-08-30/2019-08-31-11-39-58.jpg" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/q5cyK14WGiMm-R6NIFBcTg" target="_blank" rel="noopener">每天用SpringBoot，还不懂RESTful API返回统一数据格式是怎么实现的？ </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/ilND8u_8HGSTSrJiMB4X8g" target="_blank" rel="noopener">红黑树，超强动静图详解，简单易懂</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>并发编程三大核心</title>
      <link href="//p/java-concurrency-core.html"/>
      <url>//p/java-concurrency-core.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>上一篇文章<a href="https://mp.weixin.qq.com/s/I53l5W_Wl-lMc-_FAeJ6WQ" target="_blank" rel="noopener">这次走进并发的世界，请不要错过</a> 给大家带了并发编程的开胃菜，接下来我们逐步上正餐，在吃正餐之前，我还要引用那首诗词: 「横看成岭侧成峰，远近高低各不同」，远看看轮廓，近看看细节，不断切换思维或视角来学习</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-27/team-3393037.jpg" alt=""></p><p>远看并发，<strong>并发编程可以抽象成三个核心问题: 分工、同步/协作、互斥</strong></p><p>如果你已经工作了，那么你一定听说过或者正在应用敏捷开发模式来交付日常的工作任务，我们就用你熟悉的流程来解释这三个核心问题</p><h2 id="分工"><a href="#分工" class="headerlink" title="分工"></a>分工</h2><blockquote><p>将当前 Sprint 的 Story 拆分成「合适」大小的 Task，并且安排给「合适」的 Team Member 去完成</p></blockquote><p>这里面用了两个「合适」，将 Story 拆分成大小适中，可完成的 Task 是非常重要的。拆分的粒度太粗，导致这个任务完成难度变高，耗时长，不易与其他人配合；拆分的粒度太细，又导致任务太多，不好管理与追踪，浪费精力和资源。(<strong>合适的线程才能更好的完成整块工作，当然一个线程可以轻松搞定的就没必要多线程</strong>)；安排给合适的人员去完成同样重要，UX-UE 问题交给后端人员处理，很显然是有问题的 (<strong>主线程应该做的事交给子线程显然是解决不了问题的，每个线程做正确的事才能发挥作用</strong>)</p><p>关于分工，常见的 Executor，生产者-消费者模式，Fork/Join 等，这都是分工思想的体现</p><h2 id="同步-协作"><a href="#同步-协作" class="headerlink" title="同步/协作"></a>同步/协作</h2><p>任务拆分完毕，我要等张三的任务，张三要等李四的任务，也就是说任务之间存在依赖关系，前面的任务执行完毕，后面的任务才可以执行，人高级在可以通过沟通反复确认，确保自己的任务可以开始执行。<strong>但面对程序，我们需要了解程序的沟通方式，一个线程执行完任务，如何通知后续线程执行</strong></p><p>所有的同步/协作关系我们都可以用你最熟悉的 If-then-else 来表示:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(前序任务完成)&#123;</span><br><span class="line">    execute();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    wait();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码就是说:<strong>当某个条件不满足时，线程需要等待；当某个条件满足时，线程需要被唤醒执行</strong>，线程之间的协作可能是主线程与子线程的协作，可能是子线程与子线程的合作， Java SDK 中 CountDownLatch 和 CyclicBarrier 就是用来解决线程协作问题的</p><h2 id="互斥"><a href="#互斥" class="headerlink" title="互斥"></a>互斥</h2><p><strong>分工和同步强调的是性能，但是互斥是强调正确性</strong>，就是我们常常提到的「线程安全」，当多个线程<strong>同时</strong>访问一个共享变量/成员变量时，就可能发生不确定性，造成不确定性主要是有<code>可见性</code>、<code>原子性</code>、<code>有序性</code>这三大问题，而解决这些问题的核心就是互斥</p><blockquote><h3 id="互斥-1"><a href="#互斥-1" class="headerlink" title="互斥"></a>互斥</h3><p> 同一时刻，只允许一个线程访问共享变量</p></blockquote><p>来看下图，主干路就是共享变量，进入主干路一次只能有一辆车，这样你是否理解了呢？「<strong>天下大事，分久必合</strong>」</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-27/42f62cfa83224f5b8735bc03df7deb39.gif" alt=""></p><p>同样 Java SDK 也有很多互斥的解决方案，比如你马上就能想到 synchronized 关键字，Lock，ThreadLocal 等就是互斥的解决方案</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>资本家疯狂榨取劳动工人的剩余价值，获得最大收益。当你面对 CPU，内存，IO 这些劳动工人时，你就是那个资本家，你要思考如何<code>充分榨取</code>它们的价值</p><blockquote><p> 当一个工人能干的活，绝不让两个人来干(单线程能满足就没必要为了多线程)<br>当多个工人干活时，就要让他们分工明确，合作顺畅，没矛盾</p></blockquote><p>当任务很大时，由于 IO 干活慢，CPU 干活快，就没必要让 CPU 死等当前的 IO，转而去执行其他指令，这就是<code>榨取剩余价值</code>，如何最大限度的榨取其价值，这就涉及到后续的调优问题，比如多少线程合适等</p><p><strong>分工是设计，同步和互斥是实现</strong>，没有好的设计也就没有好的实现，所以在分工阶段，强烈建议大家勾划草图，了解瓶颈所在，这样才会有更好的实现，后续章节的内容，我也会带领大家画草图，分析问题，逐步养成这个习惯</p><p>本章内容可以用下面的图来简单概括，叶子结点的内容我们会逐步点亮，现阶段不用过分关注(如果你上来就啃 JDK 源码，也许你会痛苦的迷失，并最终放弃你的进阶之路的)</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-27/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83.png" alt=""></p><p><strong>理解三大核心问题，你要充分结合生活中的实际，程序中的并发问题，基本上都能在实际生活中找得到原型</strong></p><p>下一篇文章的内容，我们就要聊聊，引起线程安全的三个问题:「可见性，原子性，有序性」，这涉及到 JMM 的一点内容，可以提前了解一下的，这样我们才能更好的碰撞</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>工作中多线程编程的场景多吗？</li><li>想到多线程，只会想到 synchronized 吗？</li><li>Java 并发包各个类，你有了解底层实现和设计理念吗？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/q5cyK14WGiMm-R6NIFBcTg" target="_blank" rel="noopener">每天用SpringBoot，还不懂RESTful API返回统一数据格式是怎么实现的？ </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/ilND8u_8HGSTSrJiMB4X8g" target="_blank" rel="noopener">红黑树，超强动静图详解，简单易懂</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分工 </tag>
            
            <tag> 同步 </tag>
            
            <tag> 互斥 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>并发编程之初探</title>
      <link href="//p/java-concurrency-metaphor.html"/>
      <url>//p/java-concurrency-metaphor.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p><code>Java 有进阶，其名为并发，并发知识之大，一口吃不下</code>。那好，请您多吃几口，又没说一顿吃完，细嚼慢咽才有味.  所有 Java 书籍都将并发编程放在其高级/进阶篇章中，其重要性不言而喻，学好并发也是自身走入高级行列的必备素质之一</p><p><code>并发/并行</code>，<code>进程/线程</code> 这些概念总是显得过于抽象，因为这是与操作系统沟通用到的词汇，就像我们习惯了使用十进制算法，二进制和 16 进制就需要思维的切换；生活中，我们彼此总是不能互相理解，平静之后，我们知道要换位思考；程序的世界也一样，为了更好的理解问题，你也要站在操作系统的角度来思考问题，但当你尝试理解对方时，是违背自己认知习惯的，所以有些困难在所难免</p><p>生活中你一定说过「杀鸡焉用牛刀？」这句话，并发编程中的各种锁(内置锁/显示锁/偏向锁/轻量锁/重量锁/乐观锁/悲观锁)，看到眼花缭乱，有时候很小的问题却用了很重的锁，这是没有必要的；但是这些锁，没有最好的那个，只有最合适和更高效的那个</p><p>JUC (java.util.concurrent) 包随着 JDK 的版本升级内容也变的越来越多，面对琳琅满目的并发类，又有些无从下手，其实他们都有一定的联系，我们需要找到升级的主线，让其变得有迹可循.</p><p>谈及并发编程，我还是带有一丝惶恐:</p><ul><li>如何将这些抽象的概念变得具象？</li><li>如何将编程问题联系到生活实际?</li><li>如何在抽象和具象之间切换思维?</li></ul><p>个人觉得这些都是学好并发编程的关键。所以关于并发编程的系列文章，我打算从以上几点出发，将技术问题以幽默风趣具象的方式落地</p><h2 id="如何学并发"><a href="#如何学并发" class="headerlink" title="如何学并发"></a>如何学并发</h2><p>「横看成岭侧成峰，远近高低各不同」，在之前的文章中多次引用了这段诗词，我们学习技术也要这样，远观看轮廓，近观看细节，从不同的角度看待问题，在后续的文章中，也希望大家不要将思维局限，尝试跳入/跳出，抽象/具象</p><blockquote><p>郑重声明，接下来不是广告<br>我希望和大家共同完成并发编程系列有更多的思想碰撞，希望大家在读这个系列的同时也阅读以下书籍逐步形成自己的知识体系，这里附上个人认为的最佳阅读顺序:</p></blockquote><blockquote><h4 id="1-「Java并发编程实战」"><a href="#1-「Java并发编程实战」" class="headerlink" title="1.「Java并发编程实战」"></a>1.「Java并发编程实战」</h4><p> 该书籍是值得返回看的，第一遍不需要精度，主要是为了建立一个并发的思想，和关键术语的大致记忆，先阅读第 16 章也是极好的，理解 JMM 是实践并发编程的基础</p><h4 id="2-「码出高效」"><a href="#2-「码出高效」" class="headerlink" title="2. 「码出高效」"></a>2. 「码出高效」</h4><p>可直接阅读第七章「并发与多线程」，这个章节更好的将技术问题联系到了生活实际，有了「并发编程实战」的铺底，相信，看这个章节会更有感觉</p><h4 id="3-「Java并发编程之美」"><a href="#3-「Java并发编程之美」" class="headerlink" title="3. 「Java并发编程之美」"></a>3. 「Java并发编程之美」</h4><p> 这本书从第 5 章开始，就会有源码分析，有前辈带领读源码，轻松多了，这回让你更加了解本质，同时也会找到 JUC 升级的主线</p><h4 id="4-「Java-并发编程的艺术」"><a href="#4-「Java-并发编程的艺术」" class="headerlink" title="4. 「Java 并发编程的艺术」"></a>4. 「Java 并发编程的艺术」</h4><p>这本书会满足你从各个角度看待并发编程问题</p></blockquote><p>慎重，如果你是买书如山倒，读书如抽丝的童鞋，请忽略这点内容，停止你的买书行动，请安心跟踪公众号的内容即可</p><h2 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h2><p>如无特殊异常，会按照 1 周 1 篇的节奏来分享，会控制篇幅大小，给大家留有思考空间，期待大家带着疑问等待下一篇文章的到来，我会从大家更多了解的内容出发，逐步走入并发的世界</p><h2 id="并发开胃菜"><a href="#并发开胃菜" class="headerlink" title="并发开胃菜"></a>并发开胃菜</h2><p>不再多废话，拿出之前收藏的一篇文章作为并发编程的开胃小菜，通过这个形象比喻，希望大家能对并发有个初步的了解:</p><blockquote><p>摘自: <a href="https://www.cnblogs.com/CoolRandy/p/3169938.html" target="_blank" rel="noopener">https://www.cnblogs.com/CoolRandy/p/3169938.html</a></p></blockquote><p>觉得图解的很到位，将并发编程的几个核心要素都以具象的形式表达出来了，接下来看看何为 <strong>进程</strong>（<strong>process</strong>）和 <strong>线程</strong>（<strong>thread</strong>）</p><p>1.计算机的核心是CPU，它承担了所有的计算任务。它就像一座工厂，时刻在运行。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-23-20.jpg" alt=""></p><p>2.假定工厂的电力有限，一次只能供给一个车间使用。也就是说，一个车间开工的时候，其他车间都必须停工。背后的含义就是，单个 CPU 一次只能运行一个任务。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-24-05.jpg" alt=""></p><p>3.<strong>进程</strong>就好比工厂的车间，它代表 CPU 所能处理的单个任务。任一时刻，CPU 总是运行一个 <strong>进程</strong>，其他 <strong>进程</strong> 处于非运行状态。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-24-41.jpg" alt=""></p><p>4.一个车间里，可以有很多工人。他们协同完成一个任务。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-25-08.jpg" alt=""></p><p>5.<strong>线程</strong> 就好比车间里的工人。一个 <strong>进程</strong> 可以包括多个 <strong>线程</strong>。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-25-36.jpg" alt=""></p><p>6.车间的空间是工人们共享的，比如许多房间是每个工人都可以进出的。这象征一个 <strong>进程</strong> 的内存空间是共享的，每个 <strong>线程</strong> 都可以使用这些共享内存。</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-26-04.jpg" alt=""></p><p>7.可是，每间房间的大小不同，有些房间最多只能容纳一个人，比如厕所。里面有人的时候，其他人就不能进去了。这代表一个 <strong>线程</strong> 使用某些共享内存时，其他 <strong>线程</strong> 必须等它结束，才能使用这一块内存。</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-26-34.jpg" alt=""></p><p>8.一个防止他人进入的简单方法，就是门口加一把锁。先到的人锁上门，后到的人看到上锁，就在门口排队，等锁打开再进去。这就叫 “互斥锁”（Mutual exclusion，缩写 Mutex），防止多个 <strong>线程</strong> 同时读写某一块内存区域。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-27-08.jpg" alt=""></p><p>9.还有些房间，可以同时容纳 n 个人，比如厨房。也就是说，如果人数大于n，多出来的人只能在外面等着。这好比某些内存区域，只能供给固定数目的 <strong>线程</strong> 使用。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-27-37.jpg" alt=""></p><p>10.这时的解决方法，就是在门口挂 n 把钥匙。进去的人就取一把钥匙，出来时再把钥匙挂回原处。后到的人发现钥匙架空了，就知道必须在门口排队等着了。这种做法叫做 “信号量”（Semaphore），用来保证多个 <strong>线程</strong> 不会互相冲突。</p><p>不难看出，Mutex (互斥锁) 是 Semaphore (信号量)的一种特殊情况（n=1时）。也就是说，完全可以用后者替代前者。但是，因为 mutex 较为简单，且效率高，所以在必须保证资源独占的情况下，还是采用这种设计。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-28-09.jpg" alt=""></p><p>11.操作系统的设计，因此可以归结为三点：<br>（1）以多 <strong>进程</strong> 形式，允许多个任务同时运行；<br>（2）以多 <strong>线程</strong> 形式，允许单个任务分成不同的部分运行；<br>（3）提供协调机制，一方面防止 <strong>进程</strong> 之间和 <strong>线程</strong> 之间产生冲突，另一方面允许 <strong>进程</strong> 之间和 <strong>线程</strong> 之间共享资源。</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-07-25/2019-08-25-20-28-40.jpg" alt=""></p><p>相信看过这之后就了解了并发编程大概要关注的一些内容了，在后续的文章中，希望大家牢记，你是一个工厂只能有一个车间运行的负责人，如何让工人高效的干活且不出差错，也不起冲突，你就是合格的负责人……</p><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""> [center]</p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/6dg3u2PkcTSQHu_3T_QYnA" target="_blank" rel="noopener">只会用 git pull ？有时候你可以尝试更优雅的处理方式 </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/V7h8O6pVFQ-nr_iA2SNqtw" target="_blank" rel="noopener">程序猿为什么要看源码？</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java-Concurrency </category>
          
      </categories>
      
      
        <tags>
            
            <tag> thread </tag>
            
            <tag> 并发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot统一异常处理</title>
      <link href="//p/spring-boot-global-exception.html"/>
      <url>//p/spring-boot-global-exception.html</url>
      
        <content type="html"><![CDATA[<h2 id="话说异常"><a href="#话说异常" class="headerlink" title="话说异常"></a>话说异常</h2><p><code>「欲渡黄河冰塞川，将登太行雪满天」</code>，无论生活还是计算机世界难免发生异常，上一篇文章<a href="https://fraseryu.github.io/2019/08/08/mei-tian-yong-springboot-huan-bu-dong-tong-yi-fan-hui-shu-ju-ge-shi-shi-zen-me-shi-xian-de/#toc-heading-2" target="_blank" rel="noopener">RESTful API 返回统一JSON数据格式</a> 说明了统一返回的处理，这是请求一切正常的情形；<strong>这篇文章将说明如何统一处理异常，以及其背后的实现原理</strong>，老套路，先实现，后说明原理，有了上一篇文章的铺底，相信，理解这篇文章就驾轻就熟了</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-09/sunset-3325080_1920.jpg" alt=""></p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="新建业务异常"><a href="#新建业务异常" class="headerlink" title="新建业务异常"></a>新建业务异常</h3><p>新建 BusinessException.class 类表示业务异常，<strong>注意这是一个 Runtime 异常</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errorCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errorMsg;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加统一异常处理静态方法"><a href="#添加统一异常处理静态方法" class="headerlink" title="添加统一异常处理静态方法"></a>添加统一异常处理静态方法</h3><p>在 CommonResult 类中添加静态方法 errorResult 用于接收异常码和异常消息:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResult&lt;T&gt; <span class="title">errorResult</span><span class="params">(String errorCode, String errorMsg)</span></span>&#123;</span><br><span class="line">    CommonResult&lt;T&gt; commonResult = <span class="keyword">new</span> CommonResult&lt;&gt;();</span><br><span class="line">    commonResult.errorCode = errorCode;</span><br><span class="line">    commonResult.errorMsg = errorMsg;</span><br><span class="line">    commonResult.status = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> commonResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>同样要用到 <code>@RestControllerAdvice</code> 注解，将统一异常添加到配置中:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span>(<span class="string">"com.example.unifiedreturn.api"</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnifiedExceptionHandler</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BusinessException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Void&gt; <span class="title">handleBusinessException</span><span class="params">(BusinessException be)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CommonResult.errorResult(be.getErrorCode(), be.getErrorMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>三部搞定，到这里无论是 Controller 还是 Service 中，只要抛出 BusinessException, 我们都会返回给前端一个统一数据格式</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>将 UserController 中的方法进行改造，直接抛出异常:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> UserVo <span class="title">getUserById</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">"1001"</span>, <span class="string">"根据ID查询用户异常"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>浏览器中输入:  <em><a href="http://localhost:8080/users/1" target="_blank" rel="noopener">http://localhost:8080/users/1</a></em></p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-09/2019-08-09-14-29-07.png" alt=""></p><p>在 Service 中抛出异常:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户ID查询用户</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserVo <span class="title">getUserById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">"1001"</span>, <span class="string">"根据ID查询用户异常"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行是得到同样的结果，所以我们尽可能的抛出异常吧 (作为一个程序猿这种心理很可拍)</p><h2 id="解剖实现过程"><a href="#解剖实现过程" class="headerlink" title="解剖实现过程"></a>解剖实现过程</h2><p>解剖这个过程是相当纠结的，为了更好的说(yin)明(wei)问(wo)题(lan)，我要说重中之重了，真心希望看该文章的童鞋自己去案发现场发现线索<br>还是在 WebMvcConfigurationSupport 类中实例化了 HandlerExceptionResolver Bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HandlerExceptionResolver <span class="title">handlerExceptionResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;HandlerExceptionResolver&gt; exceptionResolvers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    configureHandlerExceptionResolvers(exceptionResolvers);</span><br><span class="line">    <span class="keyword">if</span> (exceptionResolvers.isEmpty()) &#123;</span><br><span class="line">        addDefaultHandlerExceptionResolvers(exceptionResolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    extendHandlerExceptionResolvers(exceptionResolvers);</span><br><span class="line">    HandlerExceptionResolverComposite composite = <span class="keyword">new</span> HandlerExceptionResolverComposite();</span><br><span class="line">    composite.setOrder(<span class="number">0</span>);</span><br><span class="line">    composite.setExceptionResolvers(exceptionResolvers);</span><br><span class="line">    <span class="keyword">return</span> composite;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和上一篇文章一毛一样的套路，ExceptionHandlerExceptionResolver 实现了 InitializingBean 接口，重写了 afterPropertiesSet 方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Do this first, it may add ResponseBodyAdvice beans</span></span><br><span class="line">    initExceptionHandlerAdviceCache();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initExceptionHandlerAdviceCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getApplicationContext() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;ControllerAdviceBean&gt; adviceBeans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</span><br><span class="line">    AnnotationAwareOrderComparator.sort(adviceBeans);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ControllerAdviceBean adviceBean : adviceBeans) &#123;</span><br><span class="line">        Class&lt;?&gt; beanType = adviceBean.getBeanType();</span><br><span class="line">        <span class="keyword">if</span> (beanType == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unresolvable type for ControllerAdviceBean: "</span> + adviceBean);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重点看这个构造方法</span></span><br><span class="line">        ExceptionHandlerMethodResolver resolver = <span class="keyword">new</span> ExceptionHandlerMethodResolver(beanType);</span><br><span class="line">        <span class="keyword">if</span> (resolver.hasExceptionMappings()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.exceptionHandlerAdviceCache.put(adviceBean, resolver);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ResponseBodyAdvice.class.isAssignableFrom(beanType)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.responseBodyAdvice.add(adviceBean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重点看上面我用注释标记的构造方法，代码很好懂，仔细看看吧，其实就是筛选出我们用 @ExceptionHandler 注解标记的方法并放到集合当中，用于后续全局异常捕获的匹配</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A constructor that finds &#123;<span class="doctag">@link</span> ExceptionHandler&#125; methods in the given type.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> handlerType the type to introspect</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExceptionHandlerMethodResolver</span><span class="params">(Class&lt;?&gt; handlerType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Method method : MethodIntrospector.selectMethods(handlerType, EXCEPTION_HANDLER_METHODS)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends Throwable&gt; exceptionType : detectExceptionMappings(method)) &#123;</span><br><span class="line">            addExceptionMapping(exceptionType, method);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extract exception mappings from the &#123;<span class="doctag">@code</span> <span class="doctag">@ExceptionHandler</span>&#125; annotation first,</span></span><br><span class="line"><span class="comment"> * and then as a fallback from the method signature itself.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="keyword">private</span> List&lt;Class&lt;? extends Throwable&gt;&gt; detectExceptionMappings(Method method) &#123;</span><br><span class="line">    List&lt;Class&lt;? extends Throwable&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    detectAnnotationExceptionMappings(method, result);</span><br><span class="line">    <span class="keyword">if</span> (result.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; paramType : method.getParameterTypes()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Throwable.class.isAssignableFrom(paramType)) &#123;</span><br><span class="line">                result.add((Class&lt;? extends Throwable&gt;) paramType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No exception types mapped to "</span> + method);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">detectAnnotationExceptionMappings</span><span class="params">(Method method, List&lt;Class&lt;? extends Throwable&gt;&gt; result)</span> </span>&#123;</span><br><span class="line">    ExceptionHandler ann = AnnotatedElementUtils.findMergedAnnotation(method, ExceptionHandler.class);</span><br><span class="line">    Assert.state(ann != <span class="keyword">null</span>, <span class="string">"No ExceptionHandler annotation"</span>);</span><br><span class="line">    result.addAll(Arrays.asList(ann.value()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里，我们用 <code>@RestControllerAdvice</code> 和 <code>@ExceptionHandler</code> 注解就会被 Spring 扫描到上下文，供我们使用</p><p>让我们回到你最熟悉的调用的入口 DispatcherServlet 类的  doDispatch 方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ModelAndView mv = <span class="keyword">null</span>;</span><br><span class="line">        Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 当请求发生异常，该方法会通过 catch 捕获异常</span></span><br><span class="line">            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            dispatchException = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">            <span class="comment">// As of 4.3, we're processing Errors thrown from handler methods as well,</span></span><br><span class="line">            <span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">            dispatchException = <span class="keyword">new</span> NestedServletException(<span class="string">"Handler dispatch failed"</span>, err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用该方法分析捕获的异常</span></span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，我们来看 processDispatchResult 方法，这里只要展示调用栈你就会眼前一亮了，又是为了返回统一格式数据:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-09/2019-08-09-15-01-27.png" alt=""></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上一篇文章的返回统一数据格式是基础，当异常情况发生时，只不过需要将异常信息提取出来。本文主要为了说明问题，剖析原理，好多地方设计方式是不可取，比如我们最好将异常封装在一个 Enum 类，通过 enum 对象抛出异常等，如果你用到这些，去完善你的设计方案吧</p><p>回复 「demo」，打开链接，查看文件夹 「unifiedreturn」下内容，获取完整代码</p><h2 id="附加说明"><a href="#附加说明" class="headerlink" title="附加说明"></a>附加说明</h2><p>之前看到的一本书对异常的分类让我印象深刻，在此摘录一小段分享给大家:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-09/Untitled%20Diagram.png" alt=""></p><p>结合出国旅行的例子说明异常分类:</p><blockquote><ul><li>机场地震，属于不可抗力，对应异常分类中的 <code>Error</code>，在制订出行计划时，根本不需要把这个部分的异常考虑进去</li><li>堵车属于 <code>checked</code> 异常，应对这种异常，我们可以提前出发，或者改签机票。而飞机延误异常,虽然也需要 check，但我们无能为力，只能持续关注航班动态</li><li>没有带护照，明显属于可<code>提前预测的异常</code>，只要出发前检查即可避免；去机场路上车子抛锚，这个异常是突发的，虽然难以预料，但是必须处理，属于<code>需要捕捉的异常</code>，可以通过更换交通工具；应对检票机器故障属于 <code>可透出异常</code>，交由航空公司处理,我们无须关心</li></ul></blockquote><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>这两篇文章，你学到了哪些设计模式？</li><li>你能熟练的使用反射吗？当看源码是会看到很多反射的应用</li><li>你了解 Spring CGLIB 吗？它的工作原理是什么？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><h3 id="JSON-Viewer"><a href="#JSON-Viewer" class="headerlink" title="JSON-Viewer"></a>JSON-Viewer</h3><p>JSON-Viewer  是 Chrome 浏览器的插件，用于快速解析及格式化 json 内容，在 Chrome omnibox（多功能输入框）输入<code>json-viewer + TAB</code> ，将 json 内容拷贝进去，然后输入回车键，将看到结构清晰的 json 数据，同时可以自定义主题</p><p><img src="http://ww1.sinaimg.cn/large/8dc363e6ly1g39u1u0er6j21v80tyadz.jpg" alt=""></p><h2 id="另外，前端人员打开开发者工具，双击请求链接，会自动将-response-中的-json-数据解析出来，非常方便"><a href="#另外，前端人员打开开发者工具，双击请求链接，会自动将-response-中的-json-数据解析出来，非常方便" class="headerlink" title="另外，前端人员打开开发者工具，双击请求链接，会自动将 response 中的 json 数据解析出来，非常方便"></a>另外，前端人员打开开发者工具，双击请求链接，会自动将 response 中的 json 数据解析出来，非常方便</h2><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/6dg3u2PkcTSQHu_3T_QYnA" target="_blank" rel="noopener">只会用 git pull ？有时候你可以尝试更优雅的处理方式 </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/V7h8O6pVFQ-nr_iA2SNqtw" target="_blank" rel="noopener">程序猿为什么要看源码？</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Exception </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Springboot返回统一JSON数据格式是怎么实现的？</title>
      <link href="//p/spring-boot-global-return.html"/>
      <url>//p/spring-boot-global-return.html</url>
      
        <content type="html"><![CDATA[<p>关于 Spring 的全局处理，我有两方面要说:</p><ol><li>统一数据返回格式</li><li>统一异常处理<br>为了将两个问题说明清楚，将分两个章节分别说明，本章主要说第一点</li></ol><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-07-25/landscape-615429_1920.jpg" alt=""></p><p>有童鞋说，我们项目都做了这种处理，就是在每个 API 都单独工具类将返回值进行封装，但这种不够优雅；我想写最少的代码完成这件事，也许有童鞋说，加几个注解就解决问题了，说的没错，<strong>但这篇文章主要是为了说明为什么加了几个注解就解决问题了，目的是希望大家知其所以然</strong>。</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-08/comic-4388763_1920.png" alt=""></p><p>为了更好的说明问题，本文先说明如何实现，然后再详细剖析实现原理(这很关键)</p><h2 id="为什么要做统一数据返回格式"><a href="#为什么要做统一数据返回格式" class="headerlink" title="为什么要做统一数据返回格式"></a>为什么要做统一数据返回格式</h2><p>前后端分离是当今服务形式的主流，<a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计一个好的 RESTful API</a> ，以及如何让前端小伙伴可以处理标准的 response JSON 数据结构都至关重要，为了让前端有更好的逻辑展示与页面交互处理，每一次 RESTful 请求都应该包含以下几个信息:</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>status</td><td>状态码，标识请求成功与否，如 [1:成功；-1:失败]</td></tr><tr><td>errorCode</td><td>错误码，给出明确错误码，更好的应对业务异常；请求成功该值可为空</td></tr><tr><td>errorMsg</td><td>错误消息，与错误码相对应，更具体的描述异常信息</td></tr><tr><td>resultBody</td><td>返回结果，通常是 Bean 对象对应的 JSON 数据, 通常为了应对不同返回值类型，将其声明为泛型类型</td></tr></tbody></table><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="通用返回值类定义"><a href="#通用返回值类定义" class="headerlink" title="通用返回值类定义"></a>通用返回值类定义</h3><p>根据上面的描述，用 Java Bean 来体现这个结构就是这样:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> status = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errorCode = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errorMsg = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> T resultBody;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommonResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommonResult</span><span class="params">(T resultBody)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.resultBody = resultBody;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>没错，我们需要借助几个关键注解来完成一下相关配置:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnifiedReturnConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestControllerAdvice</span>(<span class="string">"com.example.unifiedreturn.api"</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResultResponseAdvice</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">Object</span>&gt;</span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter methodParameter, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body, MethodParameter methodParameter, MediaType mediaType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass, ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (body <span class="keyword">instanceof</span> CommonResult)&#123;</span><br><span class="line"><span class="keyword">return</span> body;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;Object&gt;(body);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里就结束了，我们就可以纵情的写任何 RESTful API 了，所有的返回值都会有统一的 JSON 结构</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>新建 UserController，添加相应的 RESTful API，测试用例写的比较简单，只为了说明返回值的处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">""</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;UserVo&gt; <span class="title">getUserList</span><span class="params">()</span></span>&#123;</span><br><span class="line">List&lt;UserVo&gt; userVoList = Lists.newArrayListWithCapacity(<span class="number">2</span>);</span><br><span class="line">userVoList.add(UserVo.builder().id(<span class="number">1L</span>).name(<span class="string">"日拱一兵"</span>).age(<span class="number">18</span>).build());</span><br><span class="line">userVoList.add(UserVo.builder().id(<span class="number">2L</span>).name(<span class="string">"tan"</span>).age(<span class="number">19</span>).build());</span><br><span class="line"><span class="keyword">return</span> userVoList;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打开浏览器输入地址测试:  <em><a href="http://localhost:8080/users/" target="_blank" rel="noopener">http://localhost:8080/users/</a></em> ，我们可以看到返回了 List JSON 数据</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-08/2019-08-08-20-16-04.png" alt=""></p><p>继续添加 RESTful API，根据用户 ID 查询用户信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> UserVo <span class="title">getUserByName</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UserVo.builder().id(<span class="number">1L</span>).name(<span class="string">"日拱一兵"</span>).age(<span class="number">18</span>).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打开浏览器输入地址测试:  <em><a href="http://localhost:8080/users/1" target="_blank" rel="noopener">http://localhost:8080/users/1</a></em> ，我们可以看到返回了单个 User JSON 数据</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-08/2019-08-08-20-16-32.png" alt=""></p><p>添加一个返回值类型为 ResponseEntity 的 API</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/testResponseEntity"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">getUserByAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity(UserVo.builder().id(<span class="number">1L</span>).name(<span class="string">"日拱一兵"</span>).age(<span class="number">18</span>).build(), HttpStatus.OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打开浏览器输入地址测试:  <em><a href="http://localhost:8080/users/testResponseEntity" target="_blank" rel="noopener">http://localhost:8080/users/testResponseEntity</a></em> ，我们可以看到同样返回了单个 User JSON 数据</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-08/2019-08-08-20-17-07.png" alt=""></p><h2 id="解剖实现过程"><a href="#解剖实现过程" class="headerlink" title="解剖实现过程"></a>解剖实现过程</h2><p>我会将关键部分一一说明清楚，断案还需小伙伴自己去案发现场(打开自己的 IDE 查看)</p><p>故事要从 <code>@EnableWebMvc</code> 这个注解说起，打开该注解看:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(DelegatingWebMvcConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableWebMvc &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>@Import</code> 注解引入了 <code>DelegatingWebMvcConfiguration.class</code>，那来看这个类吧:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelegatingWebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有 <code>@Configuration</code> 注解，你应该很熟悉了，该类的父类 <code>WebMvcConfigurationSupport</code> 中却隐藏着一段关键代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestMappingHandlerAdapter <span class="title">requestMappingHandlerAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestMappingHandlerAdapter adapter = createRequestMappingHandlerAdapter();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> adapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RequestMappingHandlerAdapter 是每一次请求处理的关键，来看该类的定义:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMappingHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMethodAdapter</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">BeanFactoryAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该类实现了 InitializingBean 接口，我在 <a href="https://mp.weixin.qq.com/s/I7zgbOoCgAUnRFy4avipiQ" target="_blank" rel="noopener">Spring Bean 生命周期之“我从哪里来”？</a> 这篇文章中明确说明了 Spring Bean 初始化的几个关键，其中 InitializingBean 接口的<br><code>afterPropertiesSet</code> 方法就是关键之一，在 RequestMappingHandlerAdapter 类中同样重写了该方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Do this first, it may add ResponseBody advice beans</span></span><br><span class="line">    initControllerAdviceCache();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">        <span class="keyword">this</span>.argumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.initBinderArgumentResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers();</span><br><span class="line">        <span class="keyword">this</span>.initBinderArgumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.returnValueHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">        <span class="keyword">this</span>.returnValueHandlers = <span class="keyword">new</span> HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法内容都非常关键，但我们先来看 <code>initControllerAdviceCache</code> 方法，其他内容后续再单独说明:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initControllerAdviceCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">"Looking for @ControllerAdvice: "</span> + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;ControllerAdviceBean&gt; beans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</span><br><span class="line">    AnnotationAwareOrderComparator.sort(beans);</span><br><span class="line"></span><br><span class="line">    List&lt;Object&gt; requestResponseBodyAdviceBeans = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ControllerAdviceBean bean : beans) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (ResponseBodyAdvice.class.isAssignableFrom(bean.getBeanType())) &#123;</span><br><span class="line">            requestResponseBodyAdviceBeans.add(bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 ControllerAdviceBean 静态方法扫描 <code>ControllerAdvice</code> 注解，可是我们在实现上使用的是 <code>@RestControllerAdvice</code> 注解，打开看该注解:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RestControllerAdvice &#123;</span><br></pre></td></tr></table></figure><blockquote><p>该注解由 <code>@ControllerAdvice</code> 和 <code>@ResponseBody</code> 标记，就好比你熟悉的 <code>@RestController</code> 注解由 <code>@Controller</code> 和 <code>@ResponseBody</code>  标记是一样的</p></blockquote><p>到这里你已经知道我们用 <code>@RestControllerAdvice</code> 标记的 Bean 是如何被加载到 Spring 上下文的，接下来就要知道是 Spring 是如何使用我们的 bean 以及对返回 body 做处理的</p><p>其实在 <a href="https://mp.weixin.qq.com/s/wWj8M46EmxRRgBWdch2Big" target="_blank" rel="noopener">HttpMessageConverter是如何转换数据的？</a> 这篇文章中已经说明了一部分，希望小伙伴先看这篇文章，下面的部分就会秒懂了，我们在这里做进一步的说明</p><p>在 AbstractMessageConverterMethodProcessor 的 <code>writeWithMessageConverters</code> 方法中，有一段核心代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (messageConverter <span class="keyword">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class="line">    <span class="keyword">if</span> (((GenericHttpMessageConverter) messageConverter).canWrite(</span><br><span class="line">            declaredType, valueType, selectedMediaType)) &#123;</span><br><span class="line">        outputValue = (T) getAdvice().beforeBodyWrite(outputValue, returnType, selectedMediaType,</span><br><span class="line">                (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line">                inputMessage, outputMessage);</span><br><span class="line">            ...</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到通过 getAdvice() 调用了 <code>beforeBodyWrite</code> 方法，我们已经接近真相了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> RequestResponseBodyAdviceChain <span class="title">getAdvice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.advice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RequestResponseBodyAdviceChain，看名字带有 Chain，很明显用到了「责任链设计模式」，这些内容在 <a href="https://mp.weixin.qq.com/s/SqIkX01JwR6QXKTa6Kqp4Q" target="_blank" rel="noopener">不得不知的责任链设计模式</a> 文章中明确说明过，只不过它传递责任链以循环的方式完成:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestResponseBodyAdviceChain</span> <span class="keyword">implements</span> <span class="title">RequestBodyAdvice</span>, <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body, MethodParameter returnType, MediaType contentType,</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType,</span></span></span><br><span class="line"><span class="function"><span class="params">ServerHttpRequest request, ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> processBody(body, returnType, contentType, converterType, request, response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Object <span class="title">processBody</span><span class="params">(Object body, MethodParameter returnType, MediaType contentType,</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType,</span></span></span><br><span class="line"><span class="function"><span class="params">ServerHttpRequest request, ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (ResponseBodyAdvice&lt;?&gt; advice : getMatchingAdvice(returnType, ResponseBodyAdvice.class)) &#123;</span><br><span class="line"><span class="keyword">if</span> (advice.supports(returnType, converterType)) &#123;</span><br><span class="line">body = ((ResponseBodyAdvice&lt;T&gt;) advice).beforeBodyWrite((T) body, returnType,</span><br><span class="line">contentType, converterType, request, response);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> body;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们重写的 <code>beforeBodyWrite</code> 方法终究会被调用到，真相就是这样了!!!</p><p>其实还没完，你有没有想过，如果我们的 API 方法返回值是 <code>org.springframework.http.ResponseEntity&lt;T&gt;</code> 类型，我们可以指定 HTTP 返回状态码，但是这个返回值会直接放到我们的 beforeBodyWrite 方法的 body 参数中吗？如果这样做很明显是错误的，因为 ResponseEntity 包含很多我们非业务数据在里面，那 Spring 是怎么帮我们处理的呢？</p><p>在我们方法取得返回值并且在调用 <code>beforeBodyWrite</code> 方法之前，还要选择 HandlerMethodReturnValueHandler 用于处理不同的 Handler 来处理返回值</p><p>在类 HandlerMethodReturnValueHandlerComposite 中的 handleReturnValue 方法中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown return value type: "</span> + returnType.getParameterType().getName());</span><br><span class="line">    &#125;</span><br><span class="line">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过调用 selectHandler 方法来选择合适的 handler，Spring 内置了很多个 Handler，我们来看类图:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-08/2019-08-08-16-36-31.png" alt=""></p><p>HttpEntityMethodProcessor 就是其中之一，它重写了 supportsParameter 方法，支持 HttpEntity 类型，即支持 ResponseEntity 类型:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (HttpEntity.class == parameter.getParameterType() ||</span><br><span class="line">            RequestEntity.class == parameter.getParameterType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以当我们返回的类型为 ResponseEntity 时，就要通过 HttpEntityMethodProcessor 的 handleReturnValue 方法来处理我们的结果:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (responseEntity <span class="keyword">instanceof</span> ResponseEntity) &#123;</span><br><span class="line">        <span class="keyword">int</span> returnStatus = ((ResponseEntity&lt;?&gt;) responseEntity).getStatusCodeValue();</span><br><span class="line">        outputMessage.getServletResponse().setStatus(returnStatus);</span><br><span class="line">        <span class="keyword">if</span> (returnStatus == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SAFE_METHODS.contains(inputMessage.getMethod())</span><br><span class="line">                    &amp;&amp; isResourceNotModified(inputMessage, outputMessage)) &#123;</span><br><span class="line">                <span class="comment">// Ensure headers are flushed, no body should be written.</span></span><br><span class="line">                outputMessage.flush();</span><br><span class="line">                <span class="comment">// Skip call to converters, as they may update the body.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try even with null body. ResponseBodyAdvice could get involved.</span></span><br><span class="line">    writeWithMessageConverters(responseEntity.getBody(), returnType, inputMessage, outputMessage);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ensure headers are flushed even if no body was written.</span></span><br><span class="line">    outputMessage.flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法提取出 responseEntity.getBody()，并传递个 MessageConverter，然后再继续调用 <code>beforeBodyWrite</code> 方法，这才是真相!!!</p><p><strong>这是 RESTful API 正常返回内容的情况，下一篇文章，让我们来侦查一下统一异常情况的处理以及实现原理</strong></p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>返回值是非 ResponseEntity 类型时，用的是什么 handler？它支持的返回值类型是什么？看过你也许就知道为什么要用 <code>@ResponseBody</code> 注解了</li><li>你有追踪过 DispatchServlet 的整个请求过程吗？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/6dg3u2PkcTSQHu_3T_QYnA" target="_blank" rel="noopener">只会用 git pull ？有时候你可以尝试更优雅的处理方式 </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/V7h8O6pVFQ-nr_iA2SNqtw" target="_blank" rel="noopener">程序猿为什么要看源码？</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总 | 回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 | 回复「资料」</li></ul></blockquote><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shiro—小而美的安全框架</title>
      <link href="//p/shiro-in-practice.html"/>
      <url>//p/shiro-in-practice.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>在一款应用的整个生命周期，我们都会谈及该应用的数据安全问题。用户的合法性与数据的可见性是数据安全中非常重要的一部分。但是，一方面，不同的应用对于数据的合法性和可见性要求的维度与粒度都有所区别；另一方面，以当前微服务、多服务的架构方式，如何共享Session，如何缓存认证和授权数据应对高并发访问都迫切需要我们解决。Shiro的出现让我们可以快速和简单的应对我们应用的数据安全问题</p><h2 id="Shiro介绍"><a href="#Shiro介绍" class="headerlink" title="Shiro介绍"></a>Shiro介绍</h2><h3 id="Shiro简介"><a href="#Shiro简介" class="headerlink" title="Shiro简介"></a>Shiro简介</h3><p>这个官网解释不抽象，所以直接用官网解释：Apache Shiro™是一个强大且易用的 Java 安全框架，可以执行身份验证、授权、加密和会话管理等。基于 Shiro 的易于理解的API，您可以快速、轻松地使任何应用程序变得安全（从最小的移动应用到最大的网络和企业应用）。</p><p>谈及安全，多数 Java 开发人员都离不开 Spring 框架的支持，自然也就会先想到 Spring Security，那我们先来看二者的差别</p><table><thead><tr><th>Shiro</th><th>Spring Security</th></tr></thead><tbody><tr><td>简单、灵活</td><td>复杂、笨重</td></tr><tr><td>可脱离Spring</td><td>不可脱离Spring</td></tr><tr><td>粒度较粗</td><td>粒度较细</td></tr></tbody></table><p>虽然 Spring Security 属于名震中外 Spring 家族的一部分，但是了解 Shiro 之后，你不会想 “嫁入豪门”，而是选择追求「诗和远方」冲动。</p><p>横看成岭侧成峰，远近高低各不同 (依旧是先了解概念就好)</p><h3 id="远看-Shiro-看轮廓"><a href="#远看-Shiro-看轮廓" class="headerlink" title="远看 Shiro 看轮廓"></a>远看 Shiro 看轮廓</h3><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/image001.png" alt=""></p><h4 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h4><p>它是一个主体，代表了当前“用户”，这个用户不一定是一个具体的人，与当前应用交互的任何东西都是Subject，如网络爬虫，机器人等；即一个抽象概念；所有 Subject 都绑定到 SecurityManager，与 Subject 的所有交互都会委托给SecurityManager；可以把 Subject 认为是一个门面；SecurityManager 才是实际的执行者</p><h4 id="SecurityManager"><a href="#SecurityManager" class="headerlink" title="SecurityManager"></a>SecurityManager</h4><p>安全管理器；即所有与安全有关的操作都会与 SecurityManager 交互；且它管理着所有 Subject；可以看出它是 Shiro 的核心，它负责与后边介绍的其他组件进行交互，如果学习过 SpringMVC，你可以把它看成 DispatcherServlet前端控制器</p><h4 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h4><p>域，Shiro 从 Realm 获取安全数据（如用户、角色、权限），就是说 SecurityManager 要验证用户身份，那么它需要从 Realm 获取相应的用户进行比较以确定用户身份是否合法；也需要从 Realm 得到用户相应的角色/权限进行验证用户是否能进行操作；可以把 Realm 看成 DataSource，即安全数据源。</p><h3 id="近看-Shiro-看细节"><a href="#近看-Shiro-看细节" class="headerlink" title="近看 Shiro 看细节"></a>近看 Shiro 看细节</h3><p>看图瞬间懵逼？别慌，会为你拆解来看，结合着图看下面的解释，这不是啥大问题，且看:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/image002.png" alt=""></p><h4 id="Subject-1"><a href="#Subject-1" class="headerlink" title="Subject"></a>Subject</h4><p>主体，可以看到主体可以是任何可以与应用交互的 “用户”</p><h4 id="SecurityManager-1"><a href="#SecurityManager-1" class="headerlink" title="SecurityManager"></a>SecurityManager</h4><p>相当于 SpringMVC 中的 DispatcherServlet；是 Shiro 的心脏；所有具体的交互都通过 SecurityManager 进行控制；它管理着所有 Subject、且负责进行认证和授权、及会话、缓存的管理</p><h4 id="Authenticator"><a href="#Authenticator" class="headerlink" title="Authenticator"></a>Authenticator</h4><p>认证器，负责主体认证的，这是一个扩展点，如果用户觉得 Shiro 默认的不好，可以自定义实现；需要自定义认证策略（Authentication Strategy），即什么情况下算用户认证通过了</p><h4 id="Authrizer"><a href="#Authrizer" class="headerlink" title="Authrizer"></a>Authrizer</h4><p>授权器，或者访问控制器，用来决定主体是否有权限进行相应的操作；即控制着用户能访问应用中的哪些功能</p><h4 id="Realm-1"><a href="#Realm-1" class="headerlink" title="Realm"></a>Realm</h4><p>可以有 1 个或多个 Realm，可以认为是安全实体数据源，即用于获取安全实体的；可以是JDBC实现，也可以是LDAP实现，或者内存实现等等；由用户提供；注意：Shiro 不知道你的用户/权限存储在哪及以何种格式存储；所以我们一般在应用中都需要实现自己的Realm</p><h4 id="SessionManager"><a href="#SessionManager" class="headerlink" title="SessionManager"></a>SessionManager</h4><p>如果写过 Servlet 就应该知道 Session 的概念，Session 需要有人去管理它的生命周期，这个组件就是 SessionManager；而Shiro 并不仅仅可以用在 Web 环境，也可以用在如普通的 JavaSE 环境、EJB等环境；所以，Shiro 就抽象了一个自己的Session 来管理主体与应用之间交互的数据；这样的话，比如我们在 Web 环境用，刚开始是一台Web服务器；接着又上了台EJB 服务器；这时又想把两台服务器的会话数据放到一个地方，我们就可以实现自己的分布式会话（如把数据放到Memcached 服务器）</p><h4 id="SessionDAO"><a href="#SessionDAO" class="headerlink" title="SessionDAO"></a>SessionDAO</h4><p>DAO大家都用过，数据访问对象，用于会话的 CRUD，比如我们想把 Session 保存到数据库，那么可以实现自己的SessionDAO，通过如JDBC写到数据库；比如想把 Session 放到 Memcached 中，可以实现自己的 Memcached SessionDAO；另外 SessionDAO 中可以使用 Cache 进行缓存，以提高性能；</p><h4 id="CacheManager"><a href="#CacheManager" class="headerlink" title="CacheManager"></a>CacheManager</h4><p>缓存控制器，来管理如用户、角色、权限等的缓存的；因为这些数据基本上很少去改变，放到缓存中后可以提高访问的性能</p><h4 id="Cryptography"><a href="#Cryptography" class="headerlink" title="Cryptography"></a>Cryptography</h4><p>密码模块，Shiro提高了一些常见的加密组件用于如密码「加密/解密」的</p><p><strong>注意上图的结构，我们会根据这张图来逐步拆分讲解，记住这张图也更有助于我们理解 Shiro 的工作原理</strong>，所以依旧是打开两个网页一起看就好喽</p><h2 id="搭建概览"><a href="#搭建概览" class="headerlink" title="搭建概览"></a>搭建概览</h2><p>多数小伙伴都在使用 Spring Boot， Shiro 也很应景的定义了 starter，做了更好的封装，对于我们来说使用起来也就更加方便，来看选型概览</p><table><thead><tr><th>序号</th><th>名称</th><th>版本</th></tr></thead><tbody><tr><td>1</td><td>Springboot</td><td>2.0.4</td></tr><tr><td>2</td><td>JPA</td><td>2.0.4</td></tr><tr><td>3</td><td>Mysql</td><td>8.0.12</td></tr><tr><td>4</td><td>Redis</td><td>2.0.4</td></tr><tr><td>5</td><td>Lombok</td><td>1.16.22</td></tr><tr><td>6</td><td>Guava</td><td>26.0-jre</td></tr><tr><td>7</td><td>Shiro</td><td>1.4.0</td></tr></tbody></table><p>使用 Spring Boot，大多都是通过添加 starter 依赖，会自动解决依赖包版本，所以自己尝试的时候用最新版本不会有什么问题，比如 Shiro 现在的版本是 1.5.0 了，整体问题不大，大家自行尝试就好</p><h3 id="添加-Gradle-依赖管理"><a href="#添加-Gradle-依赖管理" class="headerlink" title="添加 Gradle 依赖管理"></a>添加 Gradle 依赖管理</h3><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-11-06-41%402x.png" alt=""></p><h3 id="大体目录结构"><a href="#大体目录结构" class="headerlink" title="大体目录结构"></a>大体目录结构</h3><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-09-29-54.png" alt=""></p><h3 id="application-yml-配置"><a href="#application-yml-配置" class="headerlink" title="application.yml 配置"></a>application.yml 配置</h3><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-11-07-29%402x.png" alt=""></p><h3 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h3><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-11-08-17%402x.png" alt=""></p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/6af89bc8gw1f8su5fhsizg208c08ct9n.gif" alt=""></p><p>你就让我看这？这只是一个概览，先做到心中有数，我们来看具体配置，逐步完成搭建</p><p>其中 shiroFilter bean 部分指定了拦截路径和相应的过滤器，”/user/login”, ”/user”, ”/user/loginout” 可以匿名访问，其他路径都需要授权访问，shiro 提供和多个默认的过滤器，我们可以用这些过滤器来配置控制指定url的权限(先了解个大概即可)：</p><table><thead><tr><th>配置缩写</th><th>对应的过滤器</th><th>功能</th></tr></thead><tbody><tr><td>anon</td><td>AnonymousFilter</td><td>指定url可以匿名访问</td></tr><tr><td>authc</td><td>FormAuthenticationFilter</td><td>指定url需要form表单登录，默认会从请求中获取username、password,rememberMe等参数并尝试登录，如果登录不了就会跳转到loginUrl配置的路径。我们也可以用这个过滤器做默认的登录逻辑，但是一般都是我们自己在控制器写登录逻辑的，自己写的话出错返回的信息都可以定制嘛。</td></tr><tr><td>authcBasic</td><td>BasicHttpAuthenticationFilter</td><td>指定url需要basic登录</td></tr><tr><td>Logout</td><td>LogoutFilter</td><td>登出过滤器，配置指定url就可以实现退出功能，非常方便</td></tr><tr><td>noSessionCreation</td><td>NoSessionCreationFilter</td><td>禁止创建会话</td></tr><tr><td>perms</td><td>PermissionsAuthorizationFilter</td><td>需要指定权限才能访问</td></tr><tr><td>port</td><td>PortFilter</td><td>需要指定端口才能访问</td></tr><tr><td>rest</td><td>HttpMethodPermissionFilter</td><td>将http请求方法转化成相应的动词来构造一个权限字符串，这个感觉意义不大，有兴趣自己看源码的注释</td></tr><tr><td>roles</td><td>RolesAuthorizationFilter</td><td>需要指定角色才能访问</td></tr><tr><td>ssl</td><td>SslFilter</td><td>需要https请求才能访问</td></tr><tr><td>user</td><td>UserFilter</td><td>需要已登录或“记住我”的用户才能访问</td></tr></tbody></table><h3 id="数据库表设计"><a href="#数据库表设计" class="headerlink" title="数据库表设计"></a>数据库表设计</h3><p>数据库表设计请参考 entity package下的 bean，通过@Entity 注解与 JPA 的设置自动生成表结构 (你需要简单的了解一下 JPA 的功能)。</p><p>我们要说重点啦～～～</p><h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><p>身份认证是一个证明 “李雷是李雷，韩梅梅是韩梅梅” 的过程，回看上图，Realm 模块就是用来做这件事的，Shiro 提供了 IniRealm，JdbcReaml，LDAPReam等认证方式，但自定义的 Realm 通常是最适合我们业务需要的，认证通常是校验登录用户是否合法。</p><h3 id="新建用户-User"><a href="#新建用户-User" class="headerlink" title="新建用户 User"></a>新建用户 User</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy=GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(unique =<span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="定义-Repository"><a href="#定义-Repository" class="headerlink" title="定义 Repository"></a>定义 Repository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserByUsername</span><span class="params">(String username)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编写UserController："><a href="#编写UserController：" class="headerlink" title="编写UserController："></a>编写UserController：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">    UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username, password);</span><br><span class="line">    token.setRememberMe(<span class="keyword">true</span>);</span><br><span class="line">    Subject currentUser = SecurityUtils.getSubject();</span><br><span class="line">    currentUser.login(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义-Realm"><a href="#自定义-Realm" class="headerlink" title="自定义 Realm"></a>自定义 Realm</h3><p>自定义 Realm，主要是为了重写 doGetAuthenticationInfo(…)方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    UsernamePasswordToken token = (UsernamePasswordToken) authenticationToken;</span><br><span class="line">    String username = token.getUsername();</span><br><span class="line">    User user = userRepository.findUserByUsername(username);</span><br><span class="line">    SimpleAuthenticationInfo simpleAuthenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(user, user.getPassword(), getName());</span><br><span class="line">    simpleAuthenticationInfo.setCredentialsSalt(ByteSource.Util.bytes(user.getSalt()));</span><br><span class="line">    <span class="keyword">return</span> simpleAuthenticationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这些代码我需要做一个说明，你可能也满肚子疑惑:</p><ol><li>这段代码怎么应用了 shiro？</li><li>controller 是怎么调用到 custom realm 的？</li><li>重写的  doGetAuthenticationInfo(…) 方法目的是什么？</li></ol><h3 id="认证流程说明"><a href="#认证流程说明" class="headerlink" title="认证流程说明"></a>认证流程说明</h3><p>用户访问<code>/user/login</code> 路径，生成 UsernamePasswordToken,  通过SecurityUtils.getSubject()获取Subject（currentUser），调用 login 方法进行验证，让我们跟踪一下代码，瞧一瞧就知道自定义的CustomRealm怎样起作用的，一起来看源码：</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/image013.png" alt=""></p><p>到这里我们要停一停了，请回看 Shiro 近景图，将源码追踪路径与其对比，是完全一致的</p><h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>身份认证是验证你是谁的问题，而授权是你能干什么的问题，</p><blockquote><p>产品经理：申购模块只能科室看<br>程序员：好的<br>产品经理：科长权限大一些，他也能看申购模块<br>程序员：好的(黑脸)<br>产品经理：科长不但能看，还能修改数据<br>程序员：关公提大刀，拿命来<br>…</p></blockquote><p>作为程序员，我们的宗旨是：「能动手就不吵吵」; 硝烟怒火拔地起，耳边响起驼铃声（Shiro）：「放下屠刀，立地成佛」授权没有那么麻烦，大家好商量…</p><p>整个过程和身份认证基本是一毛一样，你对比看看</p><h3 id="角色实体创建"><a href="#角色实体创建" class="headerlink" title="角色实体创建"></a>角色实体创建</h3><p>涉及到授权，自然要和角色相关，所以我们创建 Role 实体:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy=GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(unique =<span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> String roleCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="新建-Role-Repository"><a href="#新建-Role-Repository" class="headerlink" title="新建 Role Repository"></a>新建 Role Repository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Role</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query</span>(value = <span class="string">"select roleId from UserRoleRel ur where ur.userId = ?1"</span>)</span><br><span class="line">    <span class="function">List&lt;Long&gt; <span class="title">findUserRole</span><span class="params">(Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findByIdIn</span><span class="params">(List&lt;Long&gt; ids)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="定义权限实体-Permission"><a href="#定义权限实体-Permission" class="headerlink" title="定义权限实体 Permission"></a>定义权限实体 Permission</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Permission</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy=GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(unique =<span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> String permCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String permName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="定义-Permission-Repository"><a href="#定义-Permission-Repository" class="headerlink" title="定义 Permission Repository"></a>定义 Permission Repository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PermissionRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Permission</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query</span>(value = <span class="string">"select permId from RolePermRel pr where pr.roleId in ?1"</span>)</span><br><span class="line">    <span class="function">List&lt;Long&gt; <span class="title">findRolePerm</span><span class="params">(List&lt;Long&gt; roleIds)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Permission&gt; <span class="title">findByIdIn</span><span class="params">(List&lt;Long&gt; ids)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="建立用户与角色关系"><a href="#建立用户与角色关系" class="headerlink" title="建立用户与角色关系"></a>建立用户与角色关系</h3><p>其实可以通过 JPA 注解来制定关系的，这里为了说明问题，以单独外键形式说明</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRoleRel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy=GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long roleId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="建立角色与权限关系"><a href="#建立角色与权限关系" class="headerlink" title="建立角色与权限关系"></a>建立角色与权限关系</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RolePermRel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy=GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long permId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long roleId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编写-UserController"><a href="#编写-UserController" class="headerlink" title="编写 UserController"></a>编写 UserController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresPermissions</span>(<span class="string">"user:list:view"</span>)</span><br><span class="line"><span class="meta">@GetMapping</span>()</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAllUsers</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;User&gt; users = userRepository.findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@RequiresPermissions(&quot;user:list:view&quot;)</code> 注解说明具有用户：列表：查看权限的才可以访问），官网明确给出权限定义格式，包括通配符等，我希望你自行去查看</p><p>自定义 CustomRealm (主要重写 doGetAuthorizationInfo) 方法:</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-11-10-16%402x.png" alt=""></p><p>与认证流程如出一辙，只不过多了用户，角色，权限的关系罢了</p><h3 id="授权流程说明"><a href="#授权流程说明" class="headerlink" title="授权流程说明"></a>授权流程说明</h3><p>这里通过过滤器（见Shiro配置）和注解二者结合的方式来进行授权，和认证流程一样，最终会走到我们自定义的 CustomRealm 中，同样 Shiro 默认提供了许多注解用来处理不同的授权情况</p><table><thead><tr><th>注解</th><th>功能</th></tr></thead><tbody><tr><td>@RequiresGuest</td><td>只有游客可以访问</td></tr><tr><td>@RequiresAuthentication</td><td>需要登录才能访问</td></tr><tr><td>@RequiresUser</td><td>已登录的用户或“记住我”的用户能访问</td></tr><tr><td>@RequiresRoles</td><td>已登录的用户需具有指定的角色才能访问</td></tr><tr><td>@RequiresPermissions</td><td>已登录的用户需具有指定的权限才能访问（如果不想和产品经理华山论剑，推荐用这个注解）</td></tr></tbody></table><p>授权官网给出明确的授权策略与案例，请查看：<a href="http://shiro.apache.org/permissions.html" target="_blank" rel="noopener">http://shiro.apache.org/permissions.html</a></p><p>上面的例子我们通过一直在通过访问 Mysql 获取用户认证和授权信息，这中方式明显不符合生产环境的需求</p><h2 id="Session会话管理"><a href="#Session会话管理" class="headerlink" title="Session会话管理"></a>Session会话管理</h2><p>做过 Web 开发的同学都知道 Session 的概念，最常用的是 Session 过期时间，数据在 Session 的 CRUD，同样看上图，我们需要关注 SessionManager 和 SessionDAO 模块，Shiro starter 已经提供了基本的 Session配置信息，我们按需在YAML中配置就好（官网<a href="https://shiro.apache.org/spring-boot.html" target="_blank" rel="noopener">https://shiro.apache.org/spring-boot.html</a> 已经明确给出Session的配置信息）</p><table><thead><tr><th>Key</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td>shiro.enabled</td><td>true</td><td>Enables Shiro’s Spring module</td></tr><tr><td>shiro.web.enabled</td><td>true</td><td>Enables Shiro’s Spring web module</td></tr><tr><td>shiro.annotations.enabled</td><td>true</td><td>Enables Spring support for Shiro’s annotations</td></tr><tr><td>shiro.sessionManager.deleteInvalidSessions</td><td>true</td><td>Remove invalid session from session storage</td></tr><tr><td>shiro.sessionManager.sessionIdCookieEnabled</td><td>true</td><td>Enable session ID to cookie, for session tracking</td></tr><tr><td>shiro.sessionManager.sessionIdUrlRewritingEnabled</td><td>true</td><td>Enable session URL rewriting support</td></tr><tr><td>shiro.userNativeSessionManager</td><td>false</td><td>If enabled Shiro will manage the HTTP sessions instead of the container</td></tr><tr><td>shiro.sessionManager.cookie.name</td><td>JSESSIONID</td><td>Session cookie name</td></tr><tr><td>shiro.sessionManager.cookie.maxAge</td><td>-1</td><td>Session cookie max age</td></tr><tr><td>shiro.sessionManager.cookie.domain</td><td>null</td><td>Session cookie domain</td></tr><tr><td>shiro.sessionManager.cookie.path</td><td>null</td><td>Session cookie path</td></tr><tr><td>shiro.sessionManager.cookie.secure</td><td>false</td><td>Session cookie secure flag</td></tr><tr><td>shiro.rememberMeManager.cookie.name</td><td>rememberMe</td><td>RememberMe cookie name</td></tr><tr><td>shiro.rememberMeManager.cookie.maxAge</td><td>one year</td><td>RememberMe cookie max age</td></tr><tr><td>shiro.rememberMeManager.cookie.domain</td><td>null</td><td>RememberMe cookie domain</td></tr><tr><td>shiro.rememberMeManager.cookie.path</td><td>null</td><td>RememberMe cookie path</td></tr><tr><td>shiro.rememberMeManager.cookie.secure</td><td>false</td><td>RememberMe cookie secure flag</td></tr><tr><td>shiro.loginUrl</td><td>/login.jsp</td><td>Login URL used when unauthenticated users are redirected to login page</td></tr><tr><td>shiro.successUrl</td><td>/</td><td>Default landing page after a user logs in (if alternative cannot be found in the current session)</td></tr><tr><td>shiro.unauthorizedUrl</td><td>null</td><td>Page to redirect user to if they are unauthorized (403 page)</td></tr></tbody></table><p>分布式服务中，我们通常需要将Session信息放入Redis中来管理，来应对高并发的访问需求，这时只需重写SessionDAO即可完成自定义的Session管理</p><h3 id="整合Redis"><a href="#整合Redis" class="headerlink" title="整合Redis"></a>整合Redis</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">stringObjectRedisTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        template.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        template.setValueSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer());</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重写SessionDao"><a href="#重写SessionDao" class="headerlink" title="重写SessionDao"></a>重写SessionDao</h3><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-11-10-59%402x.png" alt=""></p><p>查看源码，可以看到调用默认SessionManager的retriveSession方法，我们重写该方法，将Session放入HttpRequest中，进一步提高session访问效率</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-11-11-37%402x.png" alt=""></p><h3 id="向ShiroConfig中添加配置"><a href="#向ShiroConfig中添加配置" class="headerlink" title="向ShiroConfig中添加配置"></a>向ShiroConfig中添加配置</h3><p> 其实在概览模块已经给出代码展示，这里单独列出来做说明:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义RedisSessionDao用来管理Session在Redis中的CRUD</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"redisSessionDao"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisSessionDao <span class="title">redisSessionDao</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RedisSessionDao();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义SessionManager,应用自定义SessionDao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"customerSessionManager"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CustomerWebSessionManager <span class="title">customerWebSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">    CustomerWebSessionManager customerWebSessionManager = <span class="keyword">new</span> CustomerWebSessionManager();</span><br><span class="line">    customerWebSessionManager.setSessionDAO(redisSessionDao());</span><br><span class="line">    <span class="keyword">return</span> customerWebSessionManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义Security manager</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customRealm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"securityManager"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">defaultWebSecurityManager</span><span class="params">(CustomRealm customRealm)</span> </span>&#123;</span><br><span class="line">    DefaultWebSecurityManager  securityManager = <span class="keyword">new</span> DefaultWebSecurityManager ();</span><br><span class="line">    securityManager.setRealm(customRealm);</span><br><span class="line">    securityManager.setSessionManager(customerWebSessionManager()); <span class="comment">// 可不指定，Shiro会用默认Session manager</span></span><br><span class="line">    securityManager.setCacheManager(redisCacheManagers());  <span class="comment">//可不指定，Shiro会用默认CacheManager</span></span><br><span class="line"><span class="comment">//        securityManager.setSessionManager(defaultWebSessionManager());</span></span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义session管理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"sessionManager"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> DefaultWebSessionManager <span class="title">defaultWebSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">    DefaultWebSessionManager defaultWebSessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">    defaultWebSessionManager.setSessionDAO(redisSessionDao());</span><br><span class="line">    <span class="keyword">return</span> defaultWebSessionManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，将 session 信息由 redis 管理功能就这样完成了</p><h2 id="缓存管理"><a href="#缓存管理" class="headerlink" title="缓存管理"></a>缓存管理</h2><p>应对分布式服务，对于高并发访问数据库权限内容是非常低效的方式，同样我们可以利用Redis来解决这一问题，将授权数据缓存到Redis中</p><h3 id="新建-RedisCache"><a href="#新建-RedisCache" class="headerlink" title="新建 RedisCache"></a>新建 RedisCache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCache</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Cache</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHIRO_PREFIX = <span class="string">"shiro-cache:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; stringObjectRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getKey</span><span class="params">(K key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">instanceof</span> String)&#123;</span><br><span class="line">            <span class="keyword">return</span> (SHIRO_PREFIX + key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K k)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"read from redis..."</span>);</span><br><span class="line">        V v = (V) stringObjectRedisTemplate.opsForValue().get(getKey(k));</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K k, V v)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        stringObjectRedisTemplate.opsForValue().set(getKey(k), v);</span><br><span class="line">        stringObjectRedisTemplate.expire(getKey(k), <span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(K k)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        V v = (V) stringObjectRedisTemplate.opsForValue().get(getKey(k));</span><br><span class="line">        stringObjectRedisTemplate.delete((String) get(k));</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        <span class="comment">//不要重写，如果只保存shiro数据无所谓</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;K&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="新建-RedisCacheManager"><a href="#新建-RedisCacheManager" class="headerlink" title="新建 RedisCacheManager"></a>新建 RedisCacheManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;K, V&gt; <span class="function">Cache&lt;K, V&gt; <span class="title">getCache</span><span class="params">(String s)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisCache;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，我们不用每次访问 Mysql DB 来获取认证和授权信息，而是通过 Redis 来缓存这些信息，大大提升了效率，也满足分布式系统的设计需求</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>回复公众号 「demo」获取 demo 代码。这里只是梳理了Springboot整合Shiro的流程，以及应用Redis最大化利用Shiro，Shiro的使用细节还很多，官网说的也很明确，带着上面的架构图来理解Shiro会事半功倍，感觉这里面的代码挺多挺头大的？那是你没有自己动手去尝试，结合官网与 demo 相信你会对 Shiro 有更好的理解，另外你可以理解 Shiro 是 mini 版本的 Spring Security，我希望以小见大，当需要更细粒度的认证授权时，也会对理解 Spring Security 有很大帮助，点击文末「阅读原文」，效果更好</p><p>落霞与孤鹜齐飞 秋水共长天一色，产品经理和程序员一片祥和…  </p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>都说 Redis 是单线程，但是很快，你知道为什么吗？</li><li>你们项目中是怎样控制认证授权的呢？当授权有变化，对于程序员来说，这个修改是灾难吗？</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><h3 id="MarkDown-表格生成器"><a href="#MarkDown-表格生成器" class="headerlink" title="MarkDown 表格生成器"></a>MarkDown 表格生成器</h3><p>本文的好多表格是从官网粘贴的，如何将其直接转换成 MD table 呢？那么 <a href="https://www.tablesgenerator.com/markdown_tables" target="_blank" rel="noopener">https://www.tablesgenerator.com/markdown_tables</a> 就可以帮到你了，无论是生成 MD table，还是粘贴内容生成 table 和内容都是极好的，当然了不止 MD table，自己发现吧，更多工具，公众号回复 「工具」获得</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-08-05/2019-08-05-10-52-55.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/6dg3u2PkcTSQHu_3T_QYnA" target="_blank" rel="noopener">只会用 git pull ？有时候你可以尝试更优雅的处理方式 </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/V7h8O6pVFQ-nr_iA2SNqtw" target="_blank" rel="noopener">程序猿为什么要看源码？</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总  回复「工具」</li><li>面试问题分析与解答</li><li>技术资料领取 回复「资料」</li></ul></blockquote><p>后续会推出「多线程」与「ElasticSearch」等连载内容</p><blockquote><p>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shiro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>@Conditional注解，Spring Boot 的灵活配置</title>
      <link href="//p/spring-boot-condition-annotation.html"/>
      <url>//p/spring-boot-condition-annotation.html</url>
      
        <content type="html"><![CDATA[<p>上一篇文章 <a href="https://mp.weixin.qq.com/s/fvgL73R_4ANp4wsSiEhUGA" target="_blank" rel="noopener">你应该知道的 @ConfigurationProperties 注解的使用姿势，这一篇就够了</a> 介绍了如何通过 <code>@ConfigurationProperties</code> 注解灵活读取配置属性，这篇文章将介绍如何灵活配置 Spring Bean</p><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>当我们构建一个 Spring 应用的时候，有时我们想在满足指定条件的时候才将某个 bean 加载到应用上下文中， 在Spring 4.0 时代，我们可以通过 <code>@Conditional</code> 注解来实现这类操作<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-14-13-28%402x.png" alt=""></p><p>我们看到  <code>@Conditional</code>  注解接收的参数是 extends Condition 接口的泛型类，也就是说，我们要使用 <code>@Conditional</code> 注解，只需要实现 Condition 接口并重写其方法即可:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-14-14-40%402x.png" alt=""></p><p>看到接口的 matches 方法返回的是 boolean 类型，是不是和我们自定义 validation annotation 有些类似，都是用来判断是否满足指定条件。另外注意看，以上注解和接口都在  <code>org.springframework.context.annotation</code>  package 中</p><p>终于到了 Spring Boot 时代，在这个全新的时代，Spring Boot 在  <code>@Conditional</code>  注解的基础上进行了细化，无需出示复杂的介绍信 (实现 Condition 接口)，只需要手持预定义好的 <code>@ConditionalOnXxxx</code> 注解印章的门票，如果验证通过，就会走进 Application Context 大厅</p><h2 id="注解详解"><a href="#注解详解" class="headerlink" title="注解详解"></a>注解详解</h2><p>Spring Boot 对 <code>@Conditional</code> 注解为我们做了细化，这些注解都定义在 <code>org.springframework.boot.autoconfigure.condition</code> package 下<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-11-07-51.png" alt=""></p><p>逐个打开这 13 个注解，我们发现这些注解上有相同的元注解:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-45-29%402x.png" alt=""></p><p>从这些标记上我们可以了解如下内容:</p><ul><li><p>都可以应用在 TYPE 上，也就是说，Spring 自动扫描的一切类 (@Configuration, @Component, @Service, @Repository, or @Controller) 都可以通过添加相应的 <code>@ConditionalOnXxxx</code> 来判断是否加载</p></li><li><p>都可以应用在 METHOD 上，所以有 @Bean 标记的方法也可以应用这些注解</p></li><li><p>都是用了 <code>@Conditional</code> 注解来标记，OnBeanCondition 等自定义 Condition 还是实现了 Condition 接口的，换汤不换药，没什么神秘的，只不过做了更具象的封装罢了，来看类依赖图:</p></li></ul><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-13-40-16.png" alt=""></p><p>其实看这些注解字面意思已经能理解这些注解的含义，但是我们还是要说明具体的使用以及一些注意事项，我按照个人使用频次由高到低讲解:</p><h3 id="ConditionalOnProperty"><a href="#ConditionalOnProperty" class="headerlink" title="@ConditionalOnProperty"></a>@ConditionalOnProperty</h3><p>毫无疑问这个注解是榜首<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-49-03%402x.png" alt=""></p><p>这个条件解释是:  application.properties 或 application.yml 文件中 mybean.enable 为 true 才会加载 MyCondition 这个 Bean，如果没有匹配上也会加载，因为 matchIfMissing = true，默认值是 false。<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-49-57%402x.png" alt=""></p><h3 id="ConditionalOnBean-和-ConditionalOnMissingBean"><a href="#ConditionalOnBean-和-ConditionalOnMissingBean" class="headerlink" title="@ConditionalOnBean 和 ConditionalOnMissingBean"></a>@ConditionalOnBean 和 ConditionalOnMissingBean</h3><p>有时候我们需要某个 Bean 已经存在应用上下文时才会加载，那么我们会用到 <code>@ConditionalOnBean</code> 注解:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-51-16%402x.png" alt=""></p><p>与之相反，有时候我们需要某个 Bean 不存在于应用上下文时才会加载，那么我们会用到 <code>@ConditionalOnMissingBean</code> 注解</p><h3 id="ConditionalOnClass-和-ConditionalOnMissingClass"><a href="#ConditionalOnClass-和-ConditionalOnMissingClass" class="headerlink" title="@ConditionalOnClass 和 @ConditionalOnMissingClass"></a>@ConditionalOnClass 和 @ConditionalOnMissingClass</h3><p>不要嫌我废话，和上面的一样，只不过判断某个类是否存在于 classpath 中，这就不做过多说明了</p><h3 id="ConditionalOnExpression"><a href="#ConditionalOnExpression" class="headerlink" title="@ConditionalOnExpression"></a>@ConditionalOnExpression</h3><p>如果我们有更复杂的多个配置属性一起判断，那么我们就可以用这个表达式了:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-54-28%402x.png" alt=""></p><p>只有当两个属性都为 true 的时候才加载 MyModule，到这里要顺便揭晓上一篇文章 <a href="https://mp.weixin.qq.com/s/fvgL73R_4ANp4wsSiEhUGA" target="_blank" rel="noopener">你应该知道的 @ConfigurationProperties 注解的使用姿势，这一篇就够了</a> 灵魂追问 3，其中 <code>:true</code> 就是: 如果没有为该属性设置值，则为该属性设置默认值true, 其实这就是<code>@Vaue</code> 注解的规范，一切 SpEL 都可以应用在这里.</p><p>写到这，我常用的已经用完了，还要硬着头皮介绍其他几个内容 😄，开个玩笑，咱们继续:</p><h3 id="ConditionalOnSingleCandidate"><a href="#ConditionalOnSingleCandidate" class="headerlink" title="@ConditionalOnSingleCandidate"></a>@ConditionalOnSingleCandidate</h3><p>这个注解和 @ConditionalOnBean 类似，为了更好的说明该注解的使用 (其实是 <code>才疏学浅</code> ) ，我只能翻译一下类的注释了<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-56-07%402x.png" alt=""></p><blockquote><p> 只有指定类已存在于 BeanFactory 中，并且可以确定单个候选项才会匹配成功</p><p>BeanFactory 存在多个 bean 实例，但是有一个 primary 候选项被指定(通常在类上使用 <code>@Primary</code> 注解)，也会匹配成功。实质上，如果自动连接具有定义类型的 bean 匹配就会成功</p><p>目前，条件只是匹配已经被应用上下文处理的 bean 定义，本身来讲，强烈建议仅仅在 auto-configuration 类中使用这个条件，如果候选 bean 被另外一个 auto-configuration 创建，确保使用该条件的要在其后面运行</p></blockquote><h3 id="ConditionalOnResource"><a href="#ConditionalOnResource" class="headerlink" title="@ConditionalOnResource"></a>@ConditionalOnResource</h3><p>如果我们要加载的 bean 依赖指定资源是否存在于 classpath 中，那么我们就可以使用这个注解<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-57-04%402x.png" alt=""></p><p>看到这个 logback.xml 是不是很亲切，在我们引入第三方工具类如 <a href="https://mp.weixin.qq.com/s/rE_cX0Z7nccY5D6z3O7mUQ" target="_blank" rel="noopener">Dozer</a> 等都可以添加类似的开关</p><p>接下来的是真冷门，大家有个印象，如果有需要，至少能想到用这些注解实现灵活配置就好了</p><h3 id="ConditionalOnJndi"><a href="#ConditionalOnJndi" class="headerlink" title="@ConditionalOnJndi"></a>@ConditionalOnJndi</h3><p>只有指定的资源通过 JNDI 加载后才加载 bean<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-58-52%402x.png" alt=""></p><h3 id="ConditionalOnJava"><a href="#ConditionalOnJava" class="headerlink" title="@ConditionalOnJava"></a>@ConditionalOnJava</h3><p>只有运行指定版本的 Java 才会加载 Bean<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-16-59-48%402x.png" alt=""></p><h3 id="ConditionalOnWebApplication-和-ConditionalOnNotWebApplication"><a href="#ConditionalOnWebApplication-和-ConditionalOnNotWebApplication" class="headerlink" title="@ConditionalOnWebApplication 和 @ConditionalOnNotWebApplication"></a>@ConditionalOnWebApplication 和 @ConditionalOnNotWebApplication</h3><p>只有运行在 web 应用里才会加载这个 bean<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-17-00-34%402x.png" alt=""></p><p>与之相反，在非 web 环境才加载 bean<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-17-01-29%402x.png" alt=""></p><h3 id="ConditionalOnCloudPlatform"><a href="#ConditionalOnCloudPlatform" class="headerlink" title="@ConditionalOnCloudPlatform"></a>@ConditionalOnCloudPlatform</h3><p>这个注解冷的我呼吸都要停止了，只有运行在指定的云平台上才加载指定的 bean，CloudPlatform 是 <code>org.springframework.boot.cloud</code> 下一个 enum 类型的类，大家可以打开自行看看:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-17-02-42%402x.png" alt=""></p><p>到此，Spring Boot 为我们提供的这 13 个注解就介绍完了，但是没有结束，下面的一些冷门知识，你需要知道:</p><h2 id="组合条件"><a href="#组合条件" class="headerlink" title="组合条件"></a>组合条件</h2><h3 id="组合条件-AND"><a href="#组合条件-AND" class="headerlink" title="组合条件 AND"></a>组合条件 AND</h3><p>如果我们想多个条件一起应用，并且条件的关系是 <code>and</code>，我们只需要在类上使用多个<code>@ConditionalOnXxxx</code> 就可以了 (你这也叫冷门？) ，当然也可以继承 <code>AllNestedConditions</code>类封装我们多个条件<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-17-05-03%402x.png" alt=""></p><p>这样就有了组合 and 条件，只有内部所有条件都满足，才加载指定 bean</p><h3 id="组合条件-OR"><a href="#组合条件-OR" class="headerlink" title="组合条件 OR"></a>组合条件 OR</h3><p>如果我们希望组合的条件是 <code>or</code> 的关系，我们该怎么办呢？ 我们可以通过继承 <code>AnyNestedCondition</code> 来完成这一要求，示例代码和上面一样，大家自行打开 <code>AnyNestedCondition</code> 类，查看类说明即可</p><h3 id="条件组合-NONE"><a href="#条件组合-NONE" class="headerlink" title="条件组合 NONE"></a>条件组合 NONE</h3><p>有 and 和 or 就肯定有 non(非)，我们可以通过继承 <code>NoneNestedConditions</code> 完成这一要求，大家自行查看即可</p><h2 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h2><p>通过组合方式实现了多条件逻辑应用，我们需要应用这些组合条件也就要自定义注解，其实文章开头已经讲过了，模仿内置的 13 个注解写就好了:<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-17-05-50%402x.png" alt=""></p><p>只需要通过<code>@Conditional</code>注解指定我们自定义的 condition 类就好了，然后应用到你想用的地方就好了<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/Spring/_image/2019-07-30/2019-07-30-17-06-30%402x.png" alt=""></p><p>还是推荐大家看 RabbitMq 的 <code>RabbitAutoConfiguration</code> 类，这个类里面主流的注解都是用了 (只看这一个类就好了)，大家看框架理解学习这些注解是更好的方式:</p><blockquote><p> <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/amqp/RabbitAutoConfiguration.java" target="_blank" rel="noopener">https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/amqp/RabbitAutoConfiguration.java</a></p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里，你已经了解了如何灵活配置 bean，结合之前的文章，相信的定义会更加灵活，希望大家打开 IDE，自行查看这些注解，了解更多具体内容</p><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>SpringBoot 添加了 web starter，有哪些方法将其更改为非 web 应用？</li><li>Java8 Stream 也有 findAny，findAll 这类的操作，这都是匹配，你有使用过吗？</li><li>看下面这段代码，如果 classpath 中没有 MyBean class，编译会报错，那这个注解什么用呢？<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>    </span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(MyBean.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfiguration</span></span>&#123;</span><br><span class="line">    <span class="comment">// omitted       </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/ilND8u_8HGSTSrJiMB4X8g" target="_blank" rel="noopener">红黑树，超强动静图详解，简单易懂</a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/V7h8O6pVFQ-nr_iA2SNqtw" target="_blank" rel="noopener">程序猿为什么要看源码？</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享</li><li>高效工具汇总</li><li>面试问题分析与解答</li><li>技术资料领取</li></ul><p><strong>后续会推出 「多线程」以及「ElasticSearch」等连载内容</strong><br>以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 注解 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>红黑树，史上最强动静图详解</title>
      <link href="//p/redblack-tree.html"/>
      <url>//p/redblack-tree.html</url>
      
        <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>红黑树，对很多童鞋来说，是既熟悉又陌生。学校中学过，只了解大概；工作中不怎么使用，但面试又是重点。每次需要查看红黑树内容时都很难以更生动形象的方式来理解其内容。没错，本文内容就是要解决这个问题，用简单的语言，搭配静图和动图(利用大脑图形记忆方式)，让你对红黑树有更深入的了解和更清晰的记忆，希望小伙伴们再次遇到红黑树的问题不至于头大，<strong>建议读该文章姿势: 打开两个页面，一个页面看图片和内容，一个页面看公式，像玩魔方一样，多玩几次就明白了</strong></p><blockquote><p>通过工具 (公众号回复「工具」—&gt;那些可以提高效率的工具—&gt;红黑树) 动态感受红黑树的转换过程</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/Jul-19-2019%2016-46-36.gif" alt=""></p><blockquote><h4 id="俺家司令买完东西后，我俩经常会发生这样的一段对话"><a href="#俺家司令买完东西后，我俩经常会发生这样的一段对话" class="headerlink" title="俺家司令买完东西后，我俩经常会发生这样的一段对话:"></a>俺家司令买完东西后，我俩经常会发生这样的一段对话:</h4><p>司令:你猜我买的这个多少钱？<br><em>我: 1000</em><br>司令: 高了<br><em>我: 500</em><br>司令: 低了:<br><em>我: 750</em><br>…… 直到最后猜中</p></blockquote><p>这样说大家应该已经猜到了是「二分查找法」，通过这个例子我想要引出的是 <strong>树</strong>，来看图片</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/tree-838667.jpg" alt=""><br>程序中的树其实是我们日常看到的树的倒影，或者发挥一下想象，倒影也可以是树根</p><h2 id="二叉查找树"><a href="#二叉查找树" class="headerlink" title="二叉查找树"></a>二叉查找树</h2><p>二叉查找树，Binary Search Tree 「BST」，要想了解二叉查找树，我们首先看下二叉查找树有哪些特性呢？</p><ol><li>某节点的左子树节点值仅包含小于该节点值</li><li>某节点的右子树节点值仅包含大于该节点值</li><li>左右子树每个也必须是二叉查找树<br>看个图就轻松理解上面三句话的意思了:</li></ol><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/2019-07-19-10-33-23.jpg" alt=""></p><p>上图，结合二叉查找树的三条约束来看，非常好，没有什么问题。再来看一个图，依旧符合上面三条约束，感觉有问题吗？</p><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/2019-07-19-10-42-07.jpg" alt=""></p><ol><li>这是一个走路一米六，一米八的树</li><li>这是一个畸形的树，大风一挂很可能被折断的树<br>从程序的角度来说这个树不够平衡，查找次数或时间复杂度 O(h)可能会随着一条腿长无限增长</li></ol><p>理科生在高中学习生物时学过一个关键字「去除顶端优势」，通过去除植物顶端优势，侧芽会迅速生长，慢慢变得强壮和平衡， <strong>红黑树其实就是去除二叉查找树顶端优势的解决方案</strong>，从而达到树的平衡</p><h2 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h2><p>红黑树，Red-Black Tree 「RBT」是一个自平衡(不是绝对的平衡)的二叉查找树(BST)，树上的每个节点都遵循下面的规则:</p><ol><li>每个节点都有红色或黑色</li><li>树的根始终是黑色的 (黑土地孕育黑树根，😄)</li><li>没有两个相邻的红色节点（红色节点不能有红色父节点或红色子节点，<strong>并没有说不能出现连续的黑色节点</strong>）</li><li>从节点（包括根）到其任何后代NULL节点(叶子结点下方挂的两个空节点，并且认为他们是黑色的)的每条路径都具有相同数量的黑色节点</li></ol><p>瞬间懵逼？<strong>了解一下印象就行</strong>，开始玩魔方都是要照着魔方公式一点点玩的，多玩几次就熟悉了。红黑树也一样，红黑树有两大操作:</p><ol><li>recolor (重新标记黑色或红色)</li><li>rotation (旋转，这是树达到平衡的关键)<br>我们会先尝试 recolor，如果 recolor 不能达到红黑树的 4 点要求，然后我们尝试 rotation，其实红黑树的关键玩法就是弄清楚 recolor 和 rotation 的规则，接下来看看详细的算法公式吧 <strong>千万别着急记忆公式，有图示会逐步说明，就像魔方一样，多玩几次就懂了</strong>:<br>假设我们插入的新节点为 X</li></ol><ul><li><ol><li>将新插入的节点标记为红色</li></ol></li><li><ol start="2"><li>如果 X 是根结点(root)，则标记为黑色</li></ol></li><li><ol start="3"><li>如果 X 的 parent 不是黑色，同时 X 也不是 root:<ul><li>3.1 如果 X 的 uncle (叔叔) 是红色<ul><li>3.1.1 将 parent 和 uncle 标记为黑色</li><li>3.1.2 将 grand parent (祖父) 标记为红色</li><li>3.1.3 让 X 节点的颜色与 X 祖父的颜色相同，然后重复步骤 2、3</li></ul></li></ul></li></ol></li></ul><p>话不多说，看下图<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/2019-07-19-15-21-51.jpg" alt=""></p><p>跟着上面的公式走:</p><ol><li>将新插入的 X 节点标记为红色</li><li>发现 X 的 parent (P) 同样为红色，这违反了红黑树的第三条规则「不能有两个连续相邻的红色节点」</li><li>发现 X 的 uncle (U) 同样为红色</li><li>将 P 和 U 标记为黑色</li><li>将 X 和 X 的 grand parent (G) 标记为相同的颜色，即红色，继续重复公式 2、3</li><li>发现 G 是根结点，标记为黑色</li><li>结束</li></ol><p>刚刚说了 X 的 uncle 是红色的情况，接下来要说是黑色的情况</p><ul><li><ol start="3"><li>如果 X 的 parent 不是黑色，同时 X 也不是 root:<ul><li>3.2 如果 X 的 uncle (叔叔) 是黑色，我们要分四种情况处理<ul><li>3.2.1 左左 (P 是 G 的左孩子，并且 X 是 P 的左孩子)</li><li>3.2.2 左右 (P 是 G 的左孩子，并且 X 是 P 的右孩子)</li><li>3.2.3 右右 (和 3.2.1 镜像过来，恰好相反)</li><li>3.2.4 右左 (和 3.2.2 镜像过来，恰好相反)<br>当出现 uncle 是黑色的时候我们第一步要考虑的是 <strong>旋转</strong> ，这里先请小伙伴<strong>不要关注红黑树的第 4 条规则</strong>，主要是为了演示如何旋转的，来一点点看，不要看图就慌，有解释的😜:<h3 id="左左情况"><a href="#左左情况" class="headerlink" title="左左情况"></a>左左情况</h3>这种情况很简单，想象这是一根绳子，手提起 P 节点，然后变色即可</li></ul></li></ul></li></ol></li></ul><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/2019-07-19-15-38-39.jpg" alt=""></p><h3 id="左右"><a href="#左右" class="headerlink" title="左右"></a>左右</h3><p>左旋: 使 X 的父节点 P 被 X 取代，同时父节点 P 成为 X 的左孩子，然后再应用 <strong>左左情况</strong><br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/2019-07-19-15-39-07.jpg" alt=""></p><h3 id="右右"><a href="#右右" class="headerlink" title="右右"></a>右右</h3><p>与左左情况一样，想象成一根绳子<br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/2019-07-19-15-39-32.jpg" alt=""></p><h3 id="右左"><a href="#右左" class="headerlink" title="右左"></a>右左</h3><p>右旋: 使 X 的父节点 P 被 X 取代，同时父节点 P 成为 X 的右孩子，然后再应用 <strong>右右情况</strong><br><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/2019-07-19-15-39-44.jpg" alt=""></p><p>你说的动图在哪里，你个大骗子，别着急，现在就为小伙伴们奉上动图演示，来说明公式的使用:</p><h3 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h3><blockquote><p>插入 10，20，30，15 到一个空树中</p></blockquote><ol><li>向空树中第一次插入数字 10，肯定是 root 节点</li><li>root 节点标记成黑色</li></ol><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/Jul-19-2019%2016-08-11.gif" alt=""></p><ol><li>向树中插入新节点 20，标记为红色</li><li>20 &gt; 10，并发现 10 没有叶子节点，将新节点 20 作为 10 的右孩子</li></ol><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/Jul-19-2019%2016-12-00.gif" alt=""></p><ol><li>向树中插入新节点 30，标记为红色</li><li>30 &gt; 10，查找 10 的右子树，找到 20</li><li>30 &gt; 20，继续查找 20 的右子树，发现 20 没有叶子节点，将值插在此处</li><li>30 和 20 节点都为红色，30 为右孩子，20 也为右孩子，触发了 <strong>右右情况</strong></li><li>通过一次旋转，提起 20 节点</li><li>20 节点是根结点，标记为黑色</li></ol><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/Jul-19-2019%2016-17-51.gif" alt=""></p><ol><li>向树中插入新节点 15，标记为红色</li><li>通过比对大小和判断是否有叶子节点，最终插值为 10 节点的右孩子</li><li>15 和 10 节点都为红色，15 的 uncle 节点 30 也为红色</li><li>按照公式，将 15 的 parent 10 和 uncle 30 更改为黑色</li><li>让 15 节点 grand parent 20 的颜色与 15 节点的颜色一样，变为红色</li><li>20 为根结点，将其改为黑色</li></ol><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%BA%94%E7%94%A8%E7%B1%BB%E6%96%87%E7%AB%A0/_image/2019-07-19/Jul-19-2019%2016-30-42.gif" alt=""></p><blockquote><p>继续插入其他节点只不过反复应用上面的公式，上面应用到的红黑树工具，可以暂停动画效果，一帧一帧的看红黑树的转换过程，这样通过练习，查看公式，观察变化三管齐下，红黑树的入门理解应该完全不再是问题了</p></blockquote><h2 id="灵魂追问"><a href="#灵魂追问" class="headerlink" title="灵魂追问"></a>灵魂追问</h2><ol><li>jdk 1.8 HashMap 中有使用到红黑树，你知道触发条件是什么吗？有读过源码是如何 put 和 remove 的吗？</li><li>这里讲的是红黑树的 insert，delete 又是什么规则呢？</li><li>哪些场景可以应用红黑树？</li><li>你了解各种树的时间复杂度吗？</li><li>留个小作业，应用工具将 [10 70 32 34 13 56 32 56 21 3 62 4 ] 逐个插入到树中，理解红黑树 recolor 和 rotation 的转换规则</li></ol><h2 id="提高效率工具"><a href="#提高效率工具" class="headerlink" title="提高效率工具"></a>提高效率工具</h2><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png" alt=""></p><hr><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://mp.weixin.qq.com/s/6dg3u2PkcTSQHu_3T_QYnA" target="_blank" rel="noopener">只会用 git pull ？有时候你可以尝试更优雅的处理方式 </a></li><li><a href="https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA" target="_blank" rel="noopener">双亲委派模型：大厂高频面试题，轻松搞定</a></li><li><a href="https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew" target="_blank" rel="noopener">面试还不知道BeanFactory和ApplicationContext的区别？</a></li><li><a href="https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ" target="_blank" rel="noopener">如何设计好的RESTful API</a></li><li><a href="https://mp.weixin.qq.com/s/V7h8O6pVFQ-nr_iA2SNqtw" target="_blank" rel="noopener">程序猿为什么要看源码？</a></li></ul><hr><blockquote><h3 id="欢迎持续关注公众号：「日拱一兵」"><a href="#欢迎持续关注公众号：「日拱一兵」" class="headerlink" title="欢迎持续关注公众号：「日拱一兵」"></a>欢迎持续关注公众号：「日拱一兵」</h3><ul><li>前沿 Java 技术干货分享 [orange]</li><li>高效工具汇总 [green]</li><li>面试问题分析与解答 [pink]</li><li>技术资料领取 [red]</li></ul><p><strong>后续文章会为你讲解各种时间空间复杂度，以及多线程，ElasticSearch 等问题</strong><br> 以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注……</p></blockquote><p><img src="https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 红黑树 </tag>
            
            <tag> 二叉查找树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何设计好的Restful API</title>
      <link href="//p/restful-api-design.html"/>
      <url>//p/restful-api-design.html</url>
      
        <content type="html"><![CDATA[<h2 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h2><p>现阶段的开发模式多以前后端分离形式存在，前后端开发人员需要通过大量 API 来进行数据交互，如果在交互过程中前后端人员经常遭遇如下问题：</p><ul><li>前端人员不能快速理解接口字段含义及接口字段变化</li><li>后端人员想复用某些接口，但是不能快速从接口 URL 的定义中明确该接口的含义，需要进一步读代码确认</li><li>URL中的英文单词使用五花八门，搜索某个接口不知道具体的关键字</li><li>请求方法动词如 POST GET 随意使用</li><li>完成当前业务接口对接，前端人员经常会询问下一步业务流程的接口定义在哪里，对接形式是什么样的</li></ul><p>以上只是前后端人员通过接口交互的一小部分问题，这些问题就好比”牙痛”，不致命，但是在整个软件开发的生命周期内，天天”牙痛”是很要命的, 需要解决上述的问题，需要前后端人员都能认识与了解接口设计规范的重要性。</p><h2 id="什么是REST"><a href="#什么是REST" class="headerlink" title="什么是REST"></a>什么是REST</h2><p>在 2000 年，Roy Fielding 提出 <a href="https://zjcqoo.github.io/-----https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank" rel="noopener">Representational State Transfer (REST)</a> 的概念，中文翻译过来”表述性状态传递”，感兴趣的朋友可以去维基百科看看原始概念，乍一看是一个挺抽象的概念，但其实，这个概念就像交通灯规则一样简单，就看如何看待相关规范. 当我们谈及 RESTful 设计规范，多数人能了解设计的大原则，但是不了解小细节，而对这些细节的了解与否，是能否治好”牙痛病”的关键</p><h2 id="REST术语介绍"><a href="#REST术语介绍" class="headerlink" title="REST术语介绍"></a>REST术语介绍</h2><p>现实世界交通灯有红绿黄，REST相关的概念也是三个：资源，集合，URL</p><h3 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h3><p>资源是某种东西的对象或表示，它具有一些与之相关的数据，并且可以有一组方法对其进行操作。 例如, 动物，学校和员工是资源;  删除，添加，更新是对这些资源执行的相关操作</p><h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>集合是资源集合，例如，公司是公司资源的集合</p><h3 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h3><p>URL（统一资源定位符）是可以通过其定位资源的路径，并且可以对其执行某些操作</p><p>了解到以上内容， 那REST 世界的”交通灯”规则是什么样的？我们来了解一下</p><h2 id="如何设计和开发一个高可用的-REST-APIs"><a href="#如何设计和开发一个高可用的-REST-APIs" class="headerlink" title="如何设计和开发一个高可用的 REST APIs"></a>如何设计和开发一个高可用的 REST APIs</h2><blockquote><p>网上一直有关于”最好的Restful API的设计”争论，何为最好，至今没有一个官方的指导。本文总结 RESTful 的设计细节，介绍如何设计出易于理解和使用的 API。在 Restful API 设计标准之上，我们可以为我们的设计增加一些弹性（团队都认可的方式），每个项目的情况不同，最重要的是项目组成员达成一致的Restful API 设计规则，达到高可用即可</p></blockquote><h3 id="URL-设计"><a href="#URL-设计" class="headerlink" title="URL 设计"></a>URL 设计</h3><p><em>学英语，名词（car/animal/teacher）都很好记忆，但是如何用动词和这些名词组合来准确的表达特定的含义却很困难，庆幸的是在 REST 的世界，动词寥寥无几，并且含义单一</em> ，RESTful 的核心思想也是通过这些<strong>动词 + 名词</strong>完成对资源的操作与访问，但我们经常看到这样的动词与名词的 URL 组合：</p><ul><li>/getAllUsers</li><li>/createNewCompany</li><li>/updateUserInfo</li><li>/deleteUser?name=zhangsan</li></ul><p>这些 URL 的设计会导致文章开头所说的很多问题，我们进一步来了解如何应用所谓的<strong>动词 + 名词</strong></p><h4 id="动词"><a href="#动词" class="headerlink" title="动词"></a>动词</h4><p>动词通常就是 5 种 HTTP 方法，对应我们常见的 CRUD 操作：</p><ul><li>POST：新建（Create）</li><li>GET：读取（Read）</li><li>PUT：更新（Update）</li><li>PATCH：更新（Update），通常不分更新，也很少用到</li><li>DELETE：删除（Delete）</li></ul><p>根据 HTTP 规范，动词一律大写，另外根据RESTful 幂等性（多次调用是否会对资源产生影响）原则，我们不能乱用动词，GET/PUT/DELETE 是幂等的，POST/PATCH 不是幂等的</p><p>有些客户端只能使用<code>GET</code>和<code>POST</code>这两种方法。服务器必须接受<code>POST</code>模拟其他三个方法（<code>PUT</code>、<code>PATCH</code>、<code>DELETE</code>）。</p><p>这时，客户端发出的 HTTP 请求，要加上<code>X-HTTP-Method-Override</code>属性，告诉服务器应该使用哪一个动词，覆盖<code>POST</code>方法。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/users/12</span> HTTP/1.1</span><br><span class="line"><span class="attribute">X-HTTP-Method-Override</span>: PUT</span><br></pre></td></tr></table></figure><p>上面代码中，<code>X-HTTP-Method-Override</code>指定本次请求的方法是<code>PUT</code>，而不是<code>POST</code></p><h4 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h4><p>名词就是表示一个资源或者服务，如 /users，/teachers，这里看到我用名词复数的形式描述某一资源，至于用单数还是复数每个人都有自己的见解，我在这里推荐使用复数，因为在现实世界中，资源多数是以集合的形式存在的</p><h4 id="动词-名词"><a href="#动词-名词" class="headerlink" title="动词 + 名词"></a>动词 + 名词</h4><table><thead><tr><th>资源</th><th>POST（Create）</th><th>GET（Read）</th><th>PUT（Update）</th><th>DELETE （Delete）</th></tr></thead><tbody><tr><td>/users</td><td>创建新用户</td><td>查询所有用户</td><td>批量更新用户</td><td>删除所有用户</td></tr><tr><td>/users/12</td><td>方法不被允许（405）</td><td>查询指定用户</td><td>更新指定用户</td><td>删除指定用户</td></tr></tbody></table><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /users</span><br><span class="line">GET /users</span><br><span class="line">PUT /users</span><br><span class="line">DELETE /users</span><br><span class="line">GET /users/12</span><br><span class="line">PUT /users/12</span><br><span class="line">DELETE /users/12</span><br></pre></td></tr></table></figure><p>上述<strong>动词 + 名词</strong>的组合是不是清晰多了，没有杂乱的动词在 URL 中，大家的理解含义相同</p><h4 id="URL-层级"><a href="#URL-层级" class="headerlink" title="URL 层级"></a>URL 层级</h4><p>现实中哪有这么简单的 CRUD，资源的相互关联与嵌套很常见，<em>查找 id 是 12 的用户的所有帖子</em>， 如何设计这个 URL，下面两种设计也会有争论：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /users/12/posts</span><br><span class="line">GET /posts?userId=12</span><br></pre></td></tr></table></figure><p>第一种出现两个名词主题（users/posts），会让人有几秒钟的猜想，这到底请求的是用户资源还是帖子资源，当存在更深浅套的时候也不容易扩展，所以我推荐第二种方式，主体名词 posts 资源明显，其他过滤条件也更容易扩展，比如 /posts?userName=zhangsan，我们可以复用同样的接口</p><h4 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h4><p>我们看到过很多如下 URL 设计，用来区分 API 版本：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /v2/users</span><br><span class="line">GET /V1/users/12</span><br></pre></td></tr></table></figure><p>我们都指向同样的资源 users，URL 中为什么要加版本号呢？ 针对这个问题，答案依旧没有统一标准，如果多个版本的API版本返回数据结果结构一样，那没必要区分版本，如果结构已经发生变化，而且要向下兼容，那版本号是很好的区分方式，而且通过 URL 加版本的方式可以更好的发现资源</p><h4 id="过滤-分页-排序"><a href="#过滤-分页-排序" class="headerlink" title="过滤/分页/排序"></a>过滤/分页/排序</h4><p>实际的业务场景中会经常对请求资源做条件筛选，分页显示，以及排序，我们不要为这些业务要求创建不同步的 API，我们应该尽量保持 URL 的信息简单，只需添加查询条件参数来实现上述功能，同时符合”望 URL 知意”的原则</p><h5 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /users/12/posts?state=published</span><br><span class="line">GET /users/12/posts?published=true</span><br></pre></td></tr></table></figure><p>上述两种方式都可以实现资源的过滤</p><h5 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /users?pageNo=1&amp;pageSize=20</span><br></pre></td></tr></table></figure><p>以分页方式查询用户列表，显示第 2 页内容，每页显示 20 条信息</p><h5 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /users?sort=score_desc</span><br></pre></td></tr></table></figure><p>按照学生分数降序进行排序</p><p>上述所有的方式我们都可以做到”望 URL 知意”，这就是好的设计</p><h3 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h3><p>RESTful API 的返回结果也是设计环节中重要的一环</p><h4 id="响应数据格式"><a href="#响应数据格式" class="headerlink" title="响应数据格式"></a>响应数据格式</h4><p>API 返回的数据格式，不应该是纯文本，而应该是一个 JSON 对象，因为这样才能返回标准的结构化数据。所以，服务器回应的 HTTP 头的<code>Content-Type</code>属性要设为<code>application/json</code>。同时客户端也应作出相应的配合，客户端请求时，也要明确告诉服务器，可以接受 JSON 格式，即请求的 HTTP 头的<code>ACCEPT</code>属性也要设成<code>application/json</code>，多渠道调用可能会存在相同资源需要有不同的 producer 类型的情况存在</p><h4 id="响应状态码"><a href="#响应状态码" class="headerlink" title="响应状态码"></a>响应状态码</h4><p>很多后端开发人员可能受开发框架所限，或者返回数据封装形式不够好，经常会给前端人员不是很友好的 HTTP 状态码，比如 response 有 error，却给出 <code>200 HTTP.OK</code> 的状态码 (明明吃了三碗粉，却给两碗粉的钱)</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"-1"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"error"</span>: <span class="string">"分数应小于150"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有人说，我已经标记返回内容 status 是 -1（表示failure）, 用 200 作为状态码也无妨吧？这是一个很错误的观念，RESTful 的设计理念之一是简单直观，试想一下，前端开发人员打开开发者工具，所有请求都是200的状态码，但是页面数据就是没有显示出来，难道前端开发人员还要每个接口调用点开看一看，是哪个 status 是 -1 导致的吗？ 很显然我们不希望这样的情况发生，正确的做法应该类似这样的：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 400 Bad Request</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"-1"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"error"</span>: <span class="string">"分数应小于150"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面页列举出来常用的状态码以及表示的含义：</p><h5 id="2xx-状态码"><a href="#2xx-状态码" class="headerlink" title="2xx 状态码"></a>2xx 状态码</h5><p>   200表示成功，同时我们可以表示的更加精确</p><blockquote><ul><li><code>GET: 200 OK</code> 请求成功</li><li><code>POST: 201 Created</code> 创建成功</li><li><code>PUT: 200 OK</code> 更新成功</li><li><code>DELETE: 204 No Content</code> 找不到要删除的内容</li></ul></blockquote><p>   使用状态码 202 有时候会比 使用状态啊吗 201 是更好的选择，状态码 202 的意思是：服务端已接收到了请求，但是还没有创建任何资源，但结果一切正常。 比如：</p><blockquote><ul><li>异步操作：服务器已接收到请求，但是还未处理，但是会在未来处理</li><li>资源已经存在，没有创建新的资源 （有些业务可能会返回错误信息”您创建的数据已存在”，所以这种情景没有明确的规定，符合自己的业务需求即可）</li></ul></blockquote><h5 id="4xx-状态码"><a href="#4xx-状态码" class="headerlink" title="4xx 状态码"></a>4xx 状态码</h5><p>   4xx 状态码表示客户端的错误，主要有以下几种：</p><blockquote><ul><li><code>400 Bad Request</code>：服务器不理解客户端的请求，未做任何处理</li><li><code>401 Unauthorized</code>：用户未提供身份验证凭据，或者没有通过身份验证</li><li><code>403 Forbidden</code>：用户通过了身份验证，但是不具有访问资源所需的权限</li><li><code>404 Not Found</code>：所请求的资源不存在，或不可用</li><li><code>415 Unsupported Media Type</code>：客户端要求的返回格式不支持。比如，API 只能返回 JSON 格式，但是客户端要求返回 XML 格式</li></ul></blockquote><p>   这里要注意状态码 401 和 403 的区别</p><h5 id="5xx-状态码"><a href="#5xx-状态码" class="headerlink" title="5xx 状态码"></a>5xx 状态码</h5><p>   5xx 状态码表示服务端错误，通常只会用到两个：</p><blockquote><ul><li><code>500 Internal Server Error</code>：客户端请求有效，服务器处理时发生了意外</li><li><code>503 Service Unavailable</code>：服务器无法处理请求，一般用于网站维护状态</li></ul></blockquote><h4 id="无状态"><a href="#无状态" class="headerlink" title="无状态"></a>无状态</h4><p>过去开发人员通常会将活动的用户信息存储在服务端的 session 中， 这种形式很显然不适用于现在分布式微服务架构的模式，我们可以使用 JWT (JSON Web Token) 如 OAuth2 来实现，这样每次在 Httpheader 中添加 token 来做验证即可</p><h4 id="API-文档"><a href="#API-文档" class="headerlink" title="API 文档"></a>API 文档</h4><p>Swagger是一种广泛使用的工具来用来记录与呈现 REST API，它提供了一种探索特定 API 使用的方法，因此允许开发人员理解底层的语义行为。 这是一种使用注释添加文档的声明性方法，它进一步生成描述 API 及其用法的 JSON，可以实时应对 API 的更新，具体请参考 <a href="https://swagger.io/" target="_blank" rel="noopener">Swagger 官网</a> , 同时使用 Spring Boot 的小伙伴也可以很轻松的集成 Swagger，只需引入<a href="https://github.com/SpringForAll/spring-boot-starter-swagger" target="_blank" rel="noopener">Swagger Starter</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spring4all<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="HATEOAS"><a href="#HATEOAS" class="headerlink" title="HATEOAS"></a>HATEOAS</h4><p>HATEOAS (Hypermedia As Transfer Engine Of Application State), API 的使用者未必知道，URL 是怎么设计的。一个解决方法就是，在回应中，给出相关链接，便于下一步操作。这样的话，用户只要记住一个 URL，就可以发现其他的 URL。这种方法叫做 HATEOAS , 举个例子，列表页数据通常会有查看操作，这样我们在返回列表页的数据的时候同样返回如何操作查看具体数据详情的 API 接口：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"-1"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: [&#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"zhangsan"</span>,</span><br><span class="line">      <span class="attr">"links"</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"href"</span>: <span class="string">"http://localhost:8080/user/&#123;id&#125;"</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Spring 框架的小伙伴可以快速的体验一下这种方式，Spring 官网项目 <a href="https://spring.io/projects/spring-hateoas" target="_blank" rel="noopener">Spring HATEOAS</a> , 会快速的将参数都做替换, 将查看 API URL 中的 id 直接替换成 1。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"-1"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: [&#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"zhangsan"</span>,</span><br><span class="line">      <span class="attr">"links"</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"href"</span>: <span class="string">"http://localhost:8080/user/1"</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="提升效率工具"><a href="#提升效率工具" class="headerlink" title="提升效率工具"></a>提升效率工具</h2><h3 id="RestfulToolkit"><a href="#RestfulToolkit" class="headerlink" title="RestfulToolkit"></a>RestfulToolkit</h3><p>后端开发人员可以安装 IntellJ idea 插件 <a href="https://plugins.jetbrains.com/plugin/10292-restfultoolkit" target="_blank" rel="noopener">RestfulToolkit</a>, Mac 环境使用快捷键 <code>CMD + \</code> 输入关键字快速定位到 API 位置</p><p><img src="https://plugins.jetbrains.com/files/10292/screenshot_17681.png" alt="官网截图"></p><p>同时在右侧工具栏打开 API，会自动生成 demoData 请求参数，实现快速调用测试：</p><p><img src="https://plugins.jetbrains.com/files/10292/screenshot_17679.png" alt="参数"></p><h3 id="JSON-Viewer"><a href="#JSON-Viewer" class="headerlink" title="JSON-Viewer"></a>JSON-Viewer</h3><p>JSON-Viewer  是 Chrome 浏览器的插件，用于快速解析及格式化 json 内容，在 Chrome omnibox（多功能输入框）输入<code>json-viewer + TAB</code> ，将 json 内容拷贝进去，然后输入回车键，将看到结构清晰的 json 数据，同时可以自定义主题</p><p><img src="http://ww1.sinaimg.cn/large/8dc363e6ly1g39u1u0er6j21v80tyadz.jpg" alt=""></p><p>另外，前端人员打开开发者工具，双击请求链接，会自动将 response 中的 json 数据解析出来，非常方便</p><h3 id="Postman"><a href="#Postman" class="headerlink" title="Postman"></a>Postman</h3><p>Postman 功能十分强大， 搜索 <code>Postman 自定义环境变量</code>，会打开新世界的大门</p><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>如何设计出最好的 RESTful API 永远不会有结论，设计出高可用，团队认可，简单清晰明了的 RESTful API 就是好的。</p><p>欢迎交流你们在团队中是如何设计 RESTful API 的，遇到了哪些问题，是如何解决和规范的</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> 安全-协议-规范 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RESTful </tag>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Excel的公式使用</title>
      <link href="//p/excel-formula.html"/>
      <url>//p/excel-formula.html</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近在做基础数据的整理，数据存放在 Word 表格中，要将大量的数据整理好并导入到数据库中着实需要费些力气，于是需要笨方法和巧方法一起用</p><h3 id="整理过程"><a href="#整理过程" class="headerlink" title="整理过程"></a>整理过程</h3><p>首先应用笨方法，将 Word 中的数据表格拷贝到 Excel 中，貌似这是必须的，由于拷贝过来的表格有合并单元格的情况，所以我们要将 Excel 中的表格标准化</p><h3 id="Excel通过公式拼接字符串换行"><a href="#Excel通过公式拼接字符串换行" class="headerlink" title="Excel通过公式拼接字符串换行"></a>Excel通过公式拼接字符串换行</h3><p>我们通常都会通过Excel公式<strong>=CONCATENATE(Text1,[Text2])</strong>来拼接字符串，当我们需要拼接的字符串中需要换行时我们可以使用<strong>CHAR(10)</strong>来完成拼接换行符，请看如下例子</p><pre><code>=CONCATENATE(&quot;hello&quot;,CHAR(10),&quot;world&quot;)</code></pre><p>输出结果如下：</p><pre><code>helloworld</code></pre><p><strong>NOTE:</strong> 使用拼接字符串公式的单元格请设置为<strong>常规</strong>，不要是自动换行.</p><ol><li><p>取消合并单元格</p><p>将 Excel 全部选中，然后点击取消单元格</p><img itemprop="url image" src="/uploads/May-16-2019 11-17-29.gif" /></li><li><p>将空单元格进行字段的填充</p><p>我们看到拆分后的单元格好多都是空的，我们需要将空的单元格填充为它上面一行的数据</p><ul><li>选中待处理的单元格</li><li>按F5</li><li>在弹出框的位置选择空值选项</li><li>键盘输入等于号”=”，然后敲击向上方向键</li><li>Ctrl + Enter 组合完成</li></ul><img itemprop="url image" src="/uploads/May-16-2019 11-20-29.gif" /></li><li><p>修改 Excel 的默认语言</p><p>我用的Mac 英文版，打开 Excel 没有类似 LENB() 这样的函数，所以我需要将语言就改为中文</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改 Excel 语言</span></span><br><span class="line">defaults write com.microsoft.Excel AppleLanguages '("zh-tw")'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 Word 语言</span></span><br><span class="line">defaults write com.microsoft.Word AppleLanguages '("zh-tw")'</span><br></pre></td></tr></table></figure></li><li><p>数字与汉字的拆分</p><p>拷贝过来的数据，需要做K-V 的映射，将一段文字中的数字提取出来作为 key， 将文本中的汉字提取出来作为 Value，所以需要用到两组公式：</p><ul><li><p>LEFT(单元格, length) / RIGHT(单元格, length)</p><blockquote><p>LEFT: 从单元格内容开始位置截取指定长度内容；</p><p>RIGHT: 从单元格内容末尾位置截取指定长度内容；</p></blockquote></li><li><p>LEN(单元格) / LENB(单元格)</p><blockquote><p>LEN是返回字符串的<strong>字符</strong>数;</p><p>LENB是返回字符串的<strong>字节</strong>数;</p><p><em>数字、字母、英文、标点符号（半角状态）都是按1计算的，汉字、全角状态下的标点符号，每个字符按2计算</em></p></blockquote></li></ul><img itemprop="url image" src="/uploads/May-16-2019 11-27-17.gif" /></li><li><p>阿拉伯数字转罗马数字</p><p>只需要应用公式：<strong>= ROMAN(A16)</strong></p><img itemprop="url image" src="/uploads/May-16-2019 11-48-53.gif" /></li><li><p>罗马数字转阿拉伯数字</p><p>同样应用公式：<strong>=MATCH(B16,INDEX(ROMAN(ROW(INDIRECT(“1:4000”))),0),0)</strong></p><img itemprop="url image" src="/uploads/May-16-2019 11-52-57.gif" /></li></ol><p>以上就是这次数据提取用到的一些公式</p><h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p>在此处附上 office 的各种语言字典码<br><img itemprop="url image" src="/uploads/Xnip2019-05-13_16-19-16.jpg" /></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Excel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>双亲委派模型</title>
      <link href="//p/java-parents-delegation-model.html"/>
      <url>//p/java-parents-delegation-model.html</url>
      
        <content type="html"><![CDATA[<h2 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h2><p>在介绍这个Java技术点之前，先试着思考以下几个问题：</p><ol><li><p>为什么我们不能定义同名的 <strong>String</strong> 的 java 文件？</p></li><li><p>多线程的情况下，类的加载为什么不会出现重复加载的情况？</p></li><li><p>下面代码，虚拟机是怎样初始化注册 Mysql 连接驱动(Driver)的？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection conn= DriverManager.getConnection(&quot;jdbc:mysql://localhost:3306/mydb?characterEncoding=GBK&quot;, &quot;root&quot;, &quot;000000&quot;);</span><br></pre></td></tr></table></figure></li><li><p>热部署的原理是什么？</p></li></ol><p>想理解以上几个问题的前提是了解类加载时机与过程, 这篇文章将会以非常详细的解读方式来回答以上几个问题</p><a id="more"></a><h3 id="类加载时机与过程"><a href="#类加载时机与过程" class="headerlink" title="类加载时机与过程"></a>类加载时机与过程</h3><p>类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载（Loading）、验证（Verification）、准备(Preparation)、解析(Resolution)、初始化(Initialization)、使用(Using)和卸载(Unloading)7个阶段。其中准备、验证、解析3个部分统称为连接（Linking）。如图所示</p><p><img src="http://ww1.sinaimg.cn/large/8dc363e6ly1g2fwal0c83j20hf06774b.jpg" alt=""></p><p>加载、验证、准备、初始化和卸载这5个阶段的顺序是确定的，类的加载过程必须按照这种顺序按部就班地开始，而解析阶段则不一定：它在某些情况下可以在初始化阶段之后再开始，这是为了支持Java语言的运行时绑定（也称为动态绑定或晚期绑定）</p><h4 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h4><p>在加载阶段（可以参考java.lang.ClassLoader的loadClass()方法），虚拟机需要完成以下3件事情：</p><ol><li>通过一个类的全限定名来获取定义此类的二进制字节流（并没有指明要从一个Class文件中获取，可以从其他渠道，譬如：网络、动态生成、数据库等）；</li><li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构；</li><li>在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口；</li></ol><p>加载阶段和连接阶段（Linking）的部分内容（如一部分字节码文件格式验证动作）是交叉进行的，加载阶段尚未完成，连接阶段可能已经开始，但这些夹在加载阶段之中进行的动作，仍然属于连接阶段的内容，这两个阶段的开始时间仍然保持着固定的先后顺序。</p><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。<br>验证阶段大致会完成4个阶段的检验动作：</p><ol><li>文件格式验证：验证字节流是否符合Class文件格式的规范；例如：是否以魔术0xCAFEBABE开头（当class文件以二进制形式打开，会看到这个文件头，cafebabe）、主次版本号是否在当前虚拟机的处理范围之内、常量池中的常量是否有不被支持的类型。</li><li>元数据验证：对字节码描述的信息进行语义分析（注意：对比javac编译阶段的语义分析），以保证其描述的信息符合Java语言规范的要求；例如：这个类是否有父类，除了java.lang.Object之外。</li><li>字节码验证：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。</li><li>符号引用验证：确保解析动作能正确执行。</li></ol><p>验证阶段是非常重要的，但不是必须的，它对程序运行期没有影响，如果所引用的类经过反复验证，那么可以考虑采用-Xverifynone参数来关闭大部分的类验证措施，以缩短虚拟机类加载的时间。</p><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在方法区中进行分配。这时候进行内存分配的仅包括类变量（被static修饰的变量），而不包括实例变量，实例变量将会在对象实例化时随着对象一起分配在堆中。其次，这里所说的初始值<strong>通常情况</strong>下是数据类型的零值，假设一个类变量的定义为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量value在准备阶段过后的初始值为0而不是123.因为这时候尚未开始执行任何java方法，而把value赋值为123的putstatic指令是程序被编译后，存放于类构造器()方法之中，所以把value赋值为123的动作将在初始化阶段才会执行</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value=<span class="number">123</span>;</span><br></pre></td></tr></table></figure><p>有<strong>通常情况</strong>就有<strong>特殊情况</strong>，这里的特殊是指：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当类字段的字段属性是ConstantValue时，会在准备阶段初始化为指定的值，所以标注为final之后，value的值在准备阶段初始化为123而非0</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> value=<span class="number">123</span>;</span><br></pre></td></tr></table></figure><h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><p>解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行。</p><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>在介绍初始化时，要先介绍两个方法：<code>&lt;clinit&gt;</code> 和 <code>&lt;init&gt;</code> :</p><blockquote><p>在编译生成class文件时，会自动产生两个方法，一个是类的初始化方法<clinit>, 另一个是实例的初始化方法<init></p><ul><li><p><code>clinit&gt;</code>：在jvm第一次加载class文件时调用，包括静态变量初始化语句和静态块的执行</p></li><li><p><code>&lt;init&gt;</code>: 在实例创建出来的时候调用，包括调用new操作符；调用 Class 或 Java.lang.reflect.Constructor 对象的newInstance()方法；调用任何现有对象的clone()方法；通过 java.io.ObjectInputStream 类的getObject() 方法反序列化。</p></li></ul></blockquote><p>类初始化阶段是类加载过程的最后一步，到了初始化阶段，才真正开始执行类中定义的java程序代码。在准备极端，变量已经付过一次系统要求的初始值，而在初始化阶段，则根据程序猿通过程序制定的主管计划去初始化类变量和其他资源，或者说：初始化阶段是执行类构造器<code>&lt;clinit&gt;()</code>方法的过程.</p><p><code>&lt;clinit&gt;()</code>方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块 static{} 中的语句合并产生的，编译器收集的顺序是由语句在源文件中出现的顺序所决定的，静态语句块只能访问到定义在静态语句块之前的变量，定义在它之后的变量，在前面的静态语句块可以赋值，但是不能访问。如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i=<span class="number">0</span>;</span><br><span class="line">        System.out.println(i); <span class="comment">//这句编译器会报错：Illegal forward reference (不合法的向前引用)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么去掉报错的那句，改成下面：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i=<span class="number">0</span>;</span><br><span class="line">        <span class="comment">// System.out.println(i); //这句编译器会报错：Illegal forward reference (不合法的向前引用)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果：1</p><p>为什么输出结果是1，在准备阶段我们知道 i=0，然后类初始化阶段按照顺序执行，首先执行 static 块中的 i=0,接着执行 static赋值操作i=1, 最后在 main 方法中获取 i 的值为1</p><blockquote><ul><li><p><code>&lt;clinit&gt;</code>()方法与实例构造器<code>&lt;init&gt;()</code>方法不同，它不需要显示地调用父类构造器，虚拟机会保证在子类<code>&lt;init&gt;()</code>方法执行之前，父类的<code>&lt;clinit&gt;()</code>方法方法已经执行完毕</p></li><li><p>由于父类的<code>&lt;clinit&gt;()</code>方法先执行，也就意味着父类中定义的静态语句块要优先于子类的变量赋值操作。</p></li><li><p><code>&lt;clinit&gt;()</code>方法对于类或者接口来说并不是必需的，如果一个类中没有静态语句块，也没有对变量的赋值操作，那么编译器可以不为这个类生产<code>&lt;clinit&gt;()</code>方法。</p></li><li><p>接口中不能使用静态语句块，但仍然有变量初始化的赋值操作，因此接口与类一样都会生成<code>&lt;clinit&gt;()</code>方法。但接口与类不同的是，执行接口的<code>&lt;clinit&gt;()</code>方法不需要先执行父接口的<code>&lt;clinit&gt;()</code>方法。只有当父接口中定义的变量使用时，父接口才会初始化。另外，接口的实现类在初始化时也一样不会执行接口的<code>&lt;clinit&gt;()</code>方法。</p></li><li><p>虚拟机会保证一个类的<code>&lt;clinit&gt;()</code>方法在多线程环境中被正确的加锁、同步，如果多个线程同时去初始化一个类，那么只会有一个线程去执行这个类的<code>&lt;clinit&gt;()</code>方法，其他线程都需要阻塞等待，直到活动线程执行<code>&lt;clinit&gt;()</code>方法完毕。如果在一个类的<code>&lt;clinit&gt;()</code>方法中有耗时很长的操作，就可能造成多个线程阻塞，在实际应用中这种阻塞往往是隐藏的。</p></li></ul></blockquote><p>让我们来验证上面的加载规则</p><ol><li><p>虚拟机会保证在子类<code>&lt;init&gt;()</code>方法执行之前，父类的<code>&lt;clinit&gt;()</code>方法方法已经执行完毕</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"SSClass"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperClass</span> <span class="keyword">extends</span> <span class="title">SSClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"SuperClass init!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SuperClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"init SuperClass"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"SubClass init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> a;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"init SubClass"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(SubClass.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SSClass</span><br><span class="line">SuperClass init!</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure></li><li><p>通过数组定义来引用类，不会触发此类的初始化(我的理解是数组的父类是Object)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SuperClass[] sca = <span class="keyword">new</span> SuperClass[<span class="number">10</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果：无</p></li><li><p>常量在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"ConstClass init!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">final</span> String HELLOWORLD = <span class="string">"hello world"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(ConstClass.HELLOWORLD);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello world</span><br></pre></td></tr></table></figure></li></ol><p><code>验证小结</code></p><p>虚拟机规范严格规定了有且只有5中情况（jdk1.7）必须对类进行“初始化”（而加载、验证、准备自然需要在此之前开始）：</p><ol><li>遇到 new, getstatic, putstatic, invokestatic 这些字节码指令时，如果类没有进行过初始化，则需要先触发其初始化。生成这4条指令的最常见的Java代码场景是：使用new关键字实例化对象的时候、读取或设置一个类的静态字段（被final修饰、已在编译器把结果放入常量池的静态字段除外）的时候，以及调用一个类的静态方法的时候。</li><li>使用 java.lang.reflect 包的方法对类进行反射调用的时候，如果类没有进行过初始化，则需要先触发其初始化。</li><li>当初始化一个类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化。</li><li>当虚拟机启动时，用户需要指定一个要执行的主类（包含main()方法的那个类），虚拟机会先初始化这个主类。</li><li>当使用jdk1.7动态语言支持时，如果一个 java.lang.invoke.MethodHandle 实例最后的解析结果REF_getstatic, REF_putstatic, REF_invokeStatic 的方法句柄，并且这个方法句柄所对应的类没有进行初始化，则需要先出触发其初始化。</li></ol><p>有了这个加载规则的印象，双亲委派模型就很好理解了，别着急，继续向下看, 你会发现你的理解层面提高了</p><h3 id="双亲委派模型-1"><a href="#双亲委派模型-1" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h3><p>刚看到这个词汇的时候我是完全懵懂的状态，其实就是定义了 JVM 启动的时候类的加载规则, 大家要按规矩办事，好办事，来看下图：</p><p><img src="http://ww1.sinaimg.cn/large/8dc363e6ly1g2fwftq83rj20jg0dz3z6.jpg" alt=""></p><p>所谓双亲委派是指每次收到类加载请求时，先将请求委派给父类加载器完成（所有加载请求最终会委派到顶层的Bootstrap ClassLoader加载器中），如果父类加载器无法完成这个加载（该加载器的<strong>搜索范围</strong>中没有找到对应的类），子类尝试自己加载， 如果都没加载到，则会抛出 ClassNotFoundException 异常， 看到这里其实就解释了文章开头提出的第一个问题，父加载器已经加载了JDK 中的 String.class 文件，所以我们不能定义同名的 String java 文件。</p><p><em>为什么会有这样的规矩设定？</em></p><blockquote><p>因为这样可以避免重复加载，当父亲已经加载了该类的时候，就没有必要 ClassLoader 再加载一次。考虑到安全因素，我们试想一下，如果不使用这种委托模式，那我们就可以随时使用自定义的String来动态替代java核心api中定义的类型，这样会存在非常大的安全隐患，而双亲委托的方式，就可以避免这种情况，因为String 已经在启动时就被引导类加载器（Bootstrcp ClassLoader）加载，所以用户自定义的ClassLoader永远也无法加载一个自己写的String，除非你改变 JDK 中 ClassLoader 搜索类的默认算法。</p></blockquote><p>我们发现除了启动类加载器（BootStrap ClassLoader），每个类都有其”父类”加载器</p><blockquote><p>⚠️ 其实这里的父子关系是组合模式，不是继承关系来实现</p></blockquote><p><img src="http://ww1.sinaimg.cn/large/8dc363e6ly1g2fys9eto8j20cc087wft.jpg" alt=""></p><p>从图中可以看到类 <strong>AppClassLoader</strong> 和 <strong>ExtClassLoader</strong> 都继承 <strong>URLClassLoader</strong>， 而 <strong>URLClassLoader</strong> 又继承</p><p><strong>ClassLoader</strong>， 在 <strong>ClassLoader</strong> 中有一个属性</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// The parent class loader for delegation</span><br><span class="line">// Note: VM hardcoded the offset of this field, thus all new fields</span><br><span class="line">// must be added *after* it.</span><br><span class="line">private final ClassLoader parent;</span><br></pre></td></tr></table></figure><p>在通过构造函数实例化  <strong>AppClassLoader</strong> 和 <strong>ExtClassLoader</strong> 的时候都要传入一个 classloader 作为当前 classloader 的 parent</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AppClassLoader(URL[] var1, ClassLoader var2) &#123;</span><br><span class="line">// 通过层层调用 super，最后指定到 ClassLoader.java 中的 parent 属性</span><br><span class="line">super(var1, var2, Launcher.factory);</span><br><span class="line">this.ucp.initLookupCache(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>顶层ClassLoader有几个函数很关键，先有个印象</p><ol><li><p>指定保护域（protectionDomain），把ByteBuffer的内容转换成 Java 类，这个方法被声明为final的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defineClass(String name, java.nio.ByteBuffer b,ProtectionDomain protectionDomain)</span><br></pre></td></tr></table></figure></li><li><p>把字节数组 b中的内容转换成 Java 类，其开始偏移为off,这个方法被声明为final的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defineClass(String name, <span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span><br></pre></td></tr></table></figure></li><li><p>查找指定名称的类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findClass(String name)</span><br></pre></td></tr></table></figure></li><li><p>链接指定的类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolveClass(Class&lt;?&gt;)</span><br></pre></td></tr></table></figure></li></ol><h4 id="类加载器责任范围"><a href="#类加载器责任范围" class="headerlink" title="类加载器责任范围"></a>类加载器责任范围</h4><p>上面我们提到每个加载器都有对应的加载搜索范围</p><ol><li><strong>Bootstrap ClassLoader</strong>:这个加载器不是一个Java类，而是由底层的c++实现，负责在虚拟机启动时加载Jdk核心类库（如：rt.jar、resources.jar、charsets.jar等）以及加载后两个类加载器。这个ClassLoader完全是JVM自己控制的，需要加载哪个类，怎么加载都是由JVM自己控制，别人也访问不到这个类</li><li><strong>Extension ClassLoader</strong>:是一个普通的Java类，继承自ClassLoader类，负责加载{JAVA_HOME}/jre/lib/ext/目录下的所有jar包。</li><li><strong>App ClassLoader</strong>：是Extension ClassLoader的子对象，负责加载应用程序classpath目录下的所有jar和class文件。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试类加载器加载目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassLoaderPath</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line">      <span class="comment">// BootStrap ClassLoader加载的文件</span></span><br><span class="line">        System.out.println(System.getProperty(<span class="string">"sun.boot.class.path"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ExtClassLoader加载的文件</span></span><br><span class="line">      System.out.println(System.getProperty(<span class="string">"java.ext.dirs"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// AppClassLoader加载的文件</span></span><br><span class="line">      System.getProperty(<span class="string">"java.class.path"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大家自行运行这个文件，就可以看到每个类加载器加载的文件了</p><h4 id="两种类的加载方式"><a href="#两种类的加载方式" class="headerlink" title="两种类的加载方式"></a>两种类的加载方式</h4><p>通常用这两种方式来动态加载一个 java 类，<strong>Class.forName()</strong> 与 <strong>ClassLoader.loadClass()</strong> 但是两个方法之间也是有一些细微的差别</p><h5 id="Class-forName-方式"><a href="#Class-forName-方式" class="headerlink" title="Class.forName() 方式"></a>Class.forName() 方式</h5><p>查看Class类的具体实现可知，实质上这个方法是调用原生的方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static native Class&lt;?&gt; forName0(String name, boolean initialize,ClassLoader loader);</span><br></pre></td></tr></table></figure><p>形式上类似于Class.forName(name,true,currentLoader)。 综上所述，Class.forName 如果调用成功会：</p><ul><li>保证一个Java类被有效得加载到内存中；</li><li>类默认会被初始化，即执行内部的静态块代码以及保证静态属性被初始化；</li><li>默认会使用<strong>当前的类加载器</strong>来加载<strong>对应的类</strong>。</li></ul><h5 id="ClassLoader-loadClass方式"><a href="#ClassLoader-loadClass方式" class="headerlink" title="ClassLoader.loadClass方式"></a>ClassLoader.loadClass方式</h5><p>如果采用这种方式的类加载策略，由于双亲托管模型的存在，最终都会将类的加载任务交付给Bootstrap ClassLoader进行加载。跟踪源代码，最终会调用原生方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private native Class&lt;?&gt; findBootstrapClass(String name);</span><br></pre></td></tr></table></figure><p>与此同时，与上一种方式的最本质的不同是，类不会被初始化，只有显式调用才会进行初始化。综上所述，ClassLoader.loadClass 如果调用成功会：</p><ul><li>类会被加载到内存中；</li><li>类不会被初始化，只有在之后被第一次调用时类才会被初始化；</li><li>之所以采用这种方式的类加载，是提供一种灵活度，可以根据自身的需求继承ClassLoader类实现一个自定义的类加载器实现类的加载。（很多开源Web项目中都有这种情况，比如tomcat，struct2，jboss。原因是根据Java Servlet规范的要求，既要Web应用自己的类的优先级要高于Web容器提供的类，但同时又要保证Java的核心类不被任意覆盖，此时重写一个类加载器就很必要了）</li></ul><h2 id="双亲委派模型源码分析"><a href="#双亲委派模型源码分析" class="headerlink" title="双亲委派模型源码分析"></a>双亲委派模型源码分析</h2><h3 id="Launcher"><a href="#Launcher" class="headerlink" title="Launcher"></a>Launcher</h3><p>分析类加载器源码要从 <strong>sun.misc.Launcher.class</strong> 文件看起, 关键代码已添加注释，同时可以在此类中看到 ExtClassLoader 和 AppClassLoader 的定义，也验证了我们上文提到的他们不是继承关系，而是通过指定 parent 属性来形成的组合模型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Launcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Launcher.ExtClassLoader var1;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取扩展类加载器</span></span><br><span class="line">            var1 = Launcher.ExtClassLoader.getExtClassLoader();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var10) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"Could not create extension class loader"</span>, var10);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取应用程序类加载器，同时指定 parent 是var1（扩展类加载器）</span></span><br><span class="line">            <span class="keyword">this</span>.loader = Launcher.AppClassLoader.getAppClassLoader(var1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"Could not create application class loader"</span>, var9);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置AppClassLoader为线程上下文类加载器（很关键），破坏双亲委派模型都要用到这个机制</span></span><br><span class="line">        Thread.currentThread().setContextClassLoader(<span class="keyword">this</span>.loader);</span><br><span class="line">        String var2 = System.getProperty(<span class="string">"java.security.manager"</span>);</span><br><span class="line">        <span class="keyword">if</span> (var2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SecurityManager var3 = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">""</span>.equals(var2) &amp;&amp; !<span class="string">"default"</span>.equals(var2)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 调用loadClass函数，这里的loader是AppClassLoader</span></span><br><span class="line">                    var3 = (SecurityManager)<span class="keyword">this</span>.loader.loadClass(var2).newInstance();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InstantiationException var6) &#123;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var7) &#123;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassCastException var8) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                var3 = <span class="keyword">new</span> SecurityManager();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (var3 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"Could not create SecurityManager: "</span> + var2);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.setSecurityManager(var3);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态内部类ExtClassLoader</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtClassLoader</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">net</span>.<span class="title">URLClassLoader</span></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 静态内部类AppClassLoader</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AppClassLoader</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">net</span>.<span class="title">URLClassLoader</span></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入上面第25行的 <em>loadClass</em> 方法中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// parent为空，交给BootStrapClassLoader</span></span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                    <span class="comment">//URLClassLoader重写了ClassLoader的findClass方法，会调用defineClass方法形成一个Java类</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到方法有同步块（synchronized）, 这也就解释了文章开头第2个问题，多线程情况不会出现重复加载的情况。同时会询问parent classloader是否有加载，如果没有，自己尝试加载。</p><p>URLClassLoader中的 findClass方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(<span class="keyword">final</span> String name)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> PrivilegedExceptionAction&lt;Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">                    <span class="keyword">public</span> Class&lt;?&gt; run() <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">".class"</span>);</span><br><span class="line">                        Resource res = ucp.getResource(path, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (res != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// 定义Class</span></span><br><span class="line">                                <span class="keyword">return</span> defineClass(name, res);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException pae) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (ClassNotFoundException) pae.getException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>借用网友的一个加载时序图来解释整个过程更加清晰：</p><p><img src="http://ww1.sinaimg.cn/large/8dc363e6ly1g2i4z0q3w9j20k70dtwfj.jpg" alt="加载时序图"></p><h2 id="双亲委派模型的破坏"><a href="#双亲委派模型的破坏" class="headerlink" title="双亲委派模型的破坏"></a>双亲委派模型的破坏</h2><p>Java本身有一套资源管理服务JNDI，是放置在rt.jar中，由启动类加载器加载的。以对数据库管理JDBC为例，java给数据库操作提供了一个Driver接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.sql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Driver</span> </span>&#123;</span><br><span class="line">    <span class="function">Connection <span class="title">connect</span><span class="params">(String url, java.util.Properties info)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">acceptsURL</span><span class="params">(String url)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    DriverPropertyInfo[] getPropertyInfo(String url, java.util.Properties info) <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMajorVersion</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMinorVersion</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">jdbcCompliant</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后提供了一个DriverManager来管理这些Driver的具体实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">registerDriver</span><span class="params">(java.sql.Driver driver,</span></span></span><br><span class="line"><span class="function"><span class="params">           DriverAction da)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/* Register the driver if it has not already been added to our list */</span></span><br><span class="line">       <span class="keyword">if</span>(driver != <span class="keyword">null</span>) &#123;</span><br><span class="line">           registeredDrivers.addIfAbsent(<span class="keyword">new</span> DriverInfo(driver, da));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// This is for compatibility with the original DriverManager</span></span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       println(<span class="string">"registerDriver: "</span> + driver);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>这里省略了大部分代码，可以看到我们使用数据库驱动前必须先要在DriverManager中使用registerDriver()注册，然后我们才能正常使用。</p><h3 id="不破坏双亲委派模型的情况（不使用JNDI服务）"><a href="#不破坏双亲委派模型的情况（不使用JNDI服务）" class="headerlink" title="不破坏双亲委派模型的情况（不使用JNDI服务）"></a>不破坏双亲委派模型的情况（不使用JNDI服务）</h3><p>我们看下mysql的驱动是如何被加载的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.加载数据访问驱动，以Class.forName的方式加载，会初始化</span></span><br><span class="line">Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line"><span class="comment">//2.连接到数据"库"上去</span></span><br><span class="line">Connection conn= DriverManager.getConnection(<span class="string">"jdbc:mysql://localhost:3306/mydb?characterEncoding=GBK"</span>, <span class="string">"root"</span>, <span class="string">""</span>);</span><br></pre></td></tr></table></figure><p>核心就是这句Class.forName()触发了mysql驱动的加载，我们看下mysql对Driver接口的实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> <span class="keyword">extends</span> <span class="title">NonRegisteringDriver</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">sql</span>.<span class="title">Driver</span> </span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Register ourselves with the DriverManager</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.sql.DriverManager.registerDriver(<span class="keyword">new</span> Driver());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException E) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't register driver!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Construct a new driver and register it with DriverManager</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     *             if a database error occurs.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Driver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">// Required for Class.forName().newInstance()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，Class.forName()其实触发了静态代码块，然后向DriverManager中注册了一个mysql的Driver实现。这个时候，我们通过DriverManager去获取connection的时候只要遍历当前所有Driver实现，然后选择一个建立连接就可以了。</p><h4 id="破坏双亲委派模型的情况"><a href="#破坏双亲委派模型的情况" class="headerlink" title="破坏双亲委派模型的情况"></a>破坏双亲委派模型的情况</h4><p>在JDBC4.0以后，开始支持使用spi的方式来注册这个Driver，具体做法就是在mysql的jar包中的META-INF/services/java.sql.Driver 文件中指明当前使用的Driver是哪个，然后使用的时候就直接这样就可以了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection conn= DriverManager.getConnection(<span class="string">"jdbc:mysql://localhost:3306/mydb?characterEncoding=GBK"</span>, <span class="string">"root"</span>, <span class="string">""</span>);</span><br></pre></td></tr></table></figure><p>可以看到这里直接获取连接，省去了上面的Class.forName()注册过程。<br> 现在，我们分析下看使用了这种spi服务的模式原本的过程是怎样的:</p><ul><li>第一，从META-INF/services/java.sql.Driver文件中获取具体的实现类名“com.mysql.jdbc.Driver”</li><li>第二，加载这个类，这里肯定只能用class.forName(“com.mysql.jdbc.Driver”)来加载</li></ul><p>好了，问题来了，Class.forName()加载用的是调用者的Classloader，这个调用者DriverManager是在rt.jar中的，ClassLoader是启动类加载器，而com.mysql.jdbc.Driver肯定不在<JAVA_HOME>/lib下，所以肯定是无法加载mysql中的这个类的。这就是双亲委派模型的局限性了，父级加载器无法加载子级类加载器路径中的类。</p><p>那么，这个问题如何解决呢？按照目前情况来分析，这个mysql的drvier只有应用类加载器能加载，那么我们只要在启动类加载器中有方法获取应用程序类加载器，然后通过它去加载就可以了。这就是所谓的线程上下文加载器。</p><blockquote><p>文章前半段提到线程上下文类加载器可以通过 <strong>Thread.setContextClassLoaser()</strong> 方法设置，如果不特殊设置会从父类继承，一般默认使用的是应用程序类加载器</p></blockquote><p><strong>很明显，线程上下文类加载器让父级类加载器能通过调用子级类加载器来加载类，这打破了双亲委派模型的原则</strong></p><p>现在我们看下DriverManager是如何使用线程上下文类加载器去加载第三方jar包中的Driver类的，先来看源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DriverManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        loadInitialDrivers();</span><br><span class="line">        println(<span class="string">"JDBC DriverManager initialized"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadInitialDrivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String drivers;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            drivers = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;String&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> System.getProperty(<span class="string">"jdbc.drivers"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            drivers = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If the driver is packaged as a Service Provider, load it.</span></span><br><span class="line">        <span class="comment">// Get all the drivers through the classloader</span></span><br><span class="line">        <span class="comment">// exposed as a java.sql.Driver.class service.</span></span><br><span class="line">        <span class="comment">// ServiceLoader.load() replaces the sun.misc.Providers()</span></span><br><span class="line"></span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServiceLoader 是 implements Iterable&lt;S&gt;的一个类，并重写了 iterator 方法（很关键）</span></span><br><span class="line">                ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</span><br><span class="line">                Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Load these drivers, so that they can be instantiated.</span></span><br><span class="line"><span class="comment">                 * It may be the case that the driver class may not be there</span></span><br><span class="line"><span class="comment">                 * i.e. there may be a packaged driver with the service class</span></span><br><span class="line"><span class="comment">                 * as implementation of java.sql.Driver but the actual class</span></span><br><span class="line"><span class="comment">                 * may be missing. In that case a java.util.ServiceConfigurationError</span></span><br><span class="line"><span class="comment">                 * will be thrown at runtime by the VM trying to locate</span></span><br><span class="line"><span class="comment">                 * and load the service.</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * Adding a try catch block to catch those runtime errors</span></span><br><span class="line"><span class="comment">                 * if driver not available in classpath but it's</span></span><br><span class="line"><span class="comment">                 * packaged as service and that service is there in classpath.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span>(driversIterator.hasNext()) &#123;</span><br><span class="line">                        driversIterator.next();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span>(Throwable t) &#123;</span><br><span class="line">                <span class="comment">// Do nothing</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        println(<span class="string">"DriverManager.initialize: jdbc.drivers = "</span> + drivers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (drivers == <span class="keyword">null</span> || drivers.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] driversList = drivers.split(<span class="string">":"</span>);</span><br><span class="line">        println(<span class="string">"number of Drivers:"</span> + driversList.length);</span><br><span class="line">        <span class="keyword">for</span> (String aDriver : driversList) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                println(<span class="string">"DriverManager.Initialize: loading "</span> + aDriver);</span><br><span class="line">                Class.forName(aDriver, <span class="keyword">true</span>,</span><br><span class="line">                        ClassLoader.getSystemClassLoader());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                println(<span class="string">"DriverManager.Initialize: load failed: "</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用时，我们直接调用DriverManager.getConnection() 方法自然会触发静态代码块的执行，开始加载驱动然后我们看下ServiceLoader.load()的具体实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 上文介绍类加载源码时，注释说明过设置AppClassLoader为上下文加载器</span></span><br><span class="line">    ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service, ClassLoader loader)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServiceLoader&lt;&gt;(service, loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续向下看构造函数实例化 ServiceLoader 做了哪些事情：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ServiceLoader</span><span class="params">(Class&lt;S&gt; svc, ClassLoader cl)</span> </span>&#123;</span><br><span class="line">    service = Objects.requireNonNull(svc, <span class="string">"Service interface cannot be null"</span>);</span><br><span class="line">    loader = (cl == <span class="keyword">null</span>) ? ClassLoader.getSystemClassLoader() : cl;</span><br><span class="line">    acc = (System.getSecurityManager() != <span class="keyword">null</span>) ? AccessController.getContext() : <span class="keyword">null</span>;</span><br><span class="line">    reload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看 reload() 函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  providers.clear();</span><br><span class="line">  lookupIterator = <span class="keyword">new</span> LazyIterator(service, loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续查看LazyIterator构造器，该类同样实现了Iterator接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">LazyIterator</span><span class="params">(Class&lt;S&gt; service, ClassLoader loader)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.service = service;</span><br><span class="line">  <span class="keyword">this</span>.loader = loader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实例化到这里我们也将上下文得到的类加载器实例化到这里，来回看ServiceLoader 重写的 iterator() 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;S&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;S&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders</span><br><span class="line">      = providers.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (knownProviders.hasNext())</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">return</span> lookupIterator.hasNext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DriverManager 类中 driversIterator 调用的next() 方法实际是这个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> S <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (knownProviders.hasNext())</span><br><span class="line">        <span class="keyword">return</span> knownProviders.next().getValue();</span><br><span class="line">      <span class="keyword">return</span> lookupIterator.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面next() 方法调用了lookupIterator.next()，这个lookupIterator 就是刚刚实例化的 LazyIterator(); 来看next方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> S <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (acc == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> nextService();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PrivilegedAction&lt;S&gt; action = <span class="keyword">new</span> PrivilegedAction&lt;S&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> S <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextService(); &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> AccessController.doPrivileged(action, acc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续查看nextService 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> S <span class="title">nextService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!hasNextService())</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">    String cn = nextName;</span><br><span class="line">    nextName = <span class="keyword">null</span>;</span><br><span class="line">    Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    c = Class.forName(cn, <span class="keyword">false</span>, loader);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ClassNotFoundException x) &#123;</span><br><span class="line">    fail(service, <span class="string">"Provider "</span> + cn + <span class="string">" not found"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!service.isAssignableFrom(c)) &#123;</span><br><span class="line">    fail(service,  <span class="string">"Provider "</span> + cn  + <span class="string">" not a subtype"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    S p = service.cast(c.newInstance());</span><br><span class="line">    providers.put(cn, p);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">    fail(service, <span class="string">"Provider "</span> + cn + <span class="string">" could not be instantiated"</span>, x);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> Error();          <span class="comment">// This cannot happen</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>终于到这里了，在上面 nextService函数中第8行调用了c = Class.forName(cn, false, loader) 方法，我们成功的做到了通过线程上下文类加载器拿到了应用程序类加载器（或者自定义的然后塞到线程上下文中的），同时我们也查找到了厂商在子级的jar包中注册的驱动具体实现类名，这样我们就可以成功的在rt.jar包中的DriverManager中成功的加载了放在第三方应用程序包中的类了同时在第16行完成Driver的实例化，等同于new Driver();  文章开头的问题在理解到这里也迎刃而解了</p><h2 id="JAVA热部署实现"><a href="#JAVA热部署实现" class="headerlink" title="JAVA热部署实现"></a>JAVA热部署实现</h2><p>首先谈一下何为热部署（hotswap），热部署是在不重启 Java 虚拟机的前提下，能自动侦测到 class 文件的变化，更新运行时 class 的行为。Java 类是通过 Java 虚拟机加载的，某个类的 class 文件在被 classloader 加载后，会生成对应的 Class 对象，之后就可以创建该类的实例。默认的虚拟机行为只会在启动时加载类，如果后期有一个类需要更新的话，单纯替换编译的 class 文件，Java 虚拟机是不会更新正在运行的 class。如果要实现热部署，最根本的方式是修改虚拟机的源代码，改变 classloader 的加载行为，使虚拟机能监听 class 文件的更新，重新加载 class 文件，这样的行为破坏性很大，为后续的 JVM 升级埋下了一个大坑。</p><p>另一种友好的方法是创建自己的 classloader 来加载需要监听的 class，这样就能控制类加载的时机，从而实现热部署。</p><p>热部署步骤：</p><ol><li><p>销毁自定义classloader(被该加载器加载的class也会自动卸载)；</p></li><li><p>更新class</p></li><li><p>使用新的ClassLoader去加载class</p></li></ol><p>JVM中的Class只有满足以下三个条件，才能被GC回收，也就是该Class被卸载（unload）：</p><ul><li>该类所有的实例都已经被GC，也就是JVM中不存在该Class的任何实例。</li><li>加载该类的ClassLoader已经被GC。</li><li>该类的java.lang.Class 对象没有在任何地方被引用，如不能在任何地方通过反射访问该类的方法</li></ul><h2 id="自定义类加载器"><a href="#自定义类加载器" class="headerlink" title="自定义类加载器"></a>自定义类加载器</h2><p>要创建用户自己的类加载器，只需要继承java.lang.ClassLoader类，然后覆盖它的findClass(String name)方法即可，即指明如何获取类的字节码流。</p><p><strong>如果要符合双亲委派规范，则重写findClass方法（用户自定义类加载逻辑）；要破坏的话，重写loadClass方法(双亲委派的具体逻辑实现)</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClassLoad</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"类加载成功。"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String classPath;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String classPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classPath = classPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] classData = getData(name);</span><br><span class="line">        <span class="keyword">if</span> (classData == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, classData, <span class="number">0</span>, classData.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getData(String className) &#123;</span><br><span class="line">        String path = classPath + File.separatorChar</span><br><span class="line">                + className.replace(<span class="string">'.'</span>, File.separatorChar) + <span class="string">".class"</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream is = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">            ByteArrayOutputStream stream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((num = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                stream.write(buffer, <span class="number">0</span>, num);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> stream.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> ClassNotFoundException,</span></span><br><span class="line"><span class="function">            InstantiationException, IllegalAccessException </span>&#123;</span><br><span class="line">        ClassLoader pcl = <span class="keyword">new</span> PathClassLoader(<span class="string">"D:\\ProgramFiles\\eclipseNew\\workspace\\cp-lib\\bin"</span>);</span><br><span class="line">        Class c = pcl.loadClass(<span class="string">"classloader.TestClassLoad"</span>);<span class="comment">//注意要包括包名</span></span><br><span class="line">        System.out.println(c.newInstance());<span class="comment">//打印类加载成功.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="感谢与参考"><a href="#感谢与参考" class="headerlink" title="感谢与参考"></a>感谢与参考</h2><p>非常感谢以下博文的作者，通过反复拜读来了解双亲委派模型的原理</p><ol><li><a href="https://blog.csdn.net/u014634338/article/details/81434327" target="_blank" rel="noopener">https://blog.csdn.net/u014634338/article/details/81434327</a></li><li><a href="https://www.cnblogs.com/aspirant/p/7200523.html" target="_blank" rel="noopener">https://www.cnblogs.com/aspirant/p/7200523.html</a></li><li><a href="https://www.cnblogs.com/gdpuzxs/p/7044963.html" target="_blank" rel="noopener">https://www.cnblogs.com/gdpuzxs/p/7044963.html</a></li><li><a href="https://www.jianshu.com/p/09f73af48a98" target="_blank" rel="noopener">https://www.jianshu.com/p/09f73af48a98</a></li><li><a href="https://www.cnblogs.com/yahokuma/p/3668138.html" target="_blank" rel="noopener">https://www.cnblogs.com/yahokuma/p/3668138.html</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ClassLoader </tag>
            
            <tag> 热部署 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PKIX证书导入</title>
      <link href="//p/pkix-certificate-import.html"/>
      <url>//p/pkix-certificate-import.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">通过理解SSL握手过程解决客户端证书问题</blockquote><p>最近做项目，调用远程服务器突然出现如下错误：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</span><br></pre></td></tr></table></figure><p>很明显，客户端找不到服务器端返回的public certificate，所以我们需要拿到服务器给客户端的证书，并且存放到Keystore中，这就涉及到SSL握手（handshake）获取信任的过程。</p><h3 id="图解SSL（Secure-Socket-Layer）协议"><a href="#图解SSL（Secure-Socket-Layer）协议" class="headerlink" title="图解SSL（Secure Socket Layer）协议"></a>图解SSL（Secure Socket Layer）协议</h3><p>开始加密通信之前，客户端和服务器首先必须建立连接和交换参数，这个过程叫做握手（handshake）</p><a id="more"></a><img itemprop="url image" src="/uploads/SSL.png"/><ol><li>客户端给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法</li><li>服务端确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）</li><li>客户端确认数字证书有效，然后生成一个新的随机数（Premaster secret），并使用数字证书中的公钥，加密这个随机数，发给服务端</li><li>服务端使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）</li><li>客户端和服务器根据约定的加密方法，使用前面的三个随机数，生成”对话密钥”（session key），用来加密接下来的整个对话过程</li></ol><p>以上就是握手的整个过程，其中握手阶段有三点需要注意</p><ol><li>生成对话密钥一共需要三个随机数。</li><li>握手之后的对话使用”对话密钥”加密（对称加密），服务器的公钥和私钥只用于加密和解密”对话密钥”（非对称加密RSA），无其他作用。</li><li>服务器公钥放在服务器的数字证书之中。</li></ol><h3 id="SSL具体握手过程"><a href="#SSL具体握手过程" class="headerlink" title="SSL具体握手过程"></a>SSL具体握手过程</h3><p>用-Djavax.net.debug=all来开启调试信息的输出，SSL的握手过程一目了然：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span>-<span class="number">02</span>-<span class="number">01</span> <span class="number">17</span>:<span class="number">05</span>:<span class="number">24</span> --INFO-- ***Helper : https:<span class="comment">//xxx.xxx.com:8443/***/ws/***Service</span></span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unsupported cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256</span><br><span class="line">Ignoring unsupported cipher suite: TLS_RSA_WITH_AES_128_CBC_SHA256</span><br><span class="line">Allow unsafe renegotiation: <span class="keyword">false</span></span><br><span class="line">Allow legacy hello messages: <span class="keyword">true</span></span><br><span class="line">Is initial handshake: <span class="keyword">true</span></span><br><span class="line">Is secure renegotiation: <span class="keyword">false</span></span><br><span class="line">%% Client cached [Session-<span class="number">5</span>, TLS_RSA_WITH_AES_256_CBC_SHA]</span><br><span class="line">%% Try resuming [Session-<span class="number">5</span>, TLS_RSA_WITH_AES_256_CBC_SHA] from port <span class="number">12371</span></span><br><span class="line">##客户端跟服务器第一次打招呼##</span><br><span class="line">*** ClientHello, TLSv1</span><br><span class="line">RandomCookie:  GMT: <span class="number">1517410388</span> bytes = &#123; <span class="number">95</span>, <span class="number">120</span>, <span class="number">132</span>, <span class="number">216</span>, <span class="number">69</span>, <span class="number">34</span>, <span class="number">205</span>, <span class="number">73</span>, <span class="number">133</span>, <span class="number">30</span>, <span class="number">240</span>, <span class="number">178</span>, <span class="number">37</span>, <span class="number">187</span>, <span class="number">228</span>, <span class="number">127</span>, <span class="number">73</span>, <span class="number">149</span>, <span class="number">1</span>, <span class="number">216</span>, <span class="number">19</span>, <span class="number">3</span>, <span class="number">35</span>, <span class="number">236</span>, <span class="number">29</span>, <span class="number">111</span>, <span class="number">125</span>, <span class="number">132</span> &#125;</span><br><span class="line">Session ID:  &#123;<span class="number">248</span>, <span class="number">40</span>, <span class="number">73</span>, <span class="number">62</span>, <span class="number">46</span>, <span class="number">20</span>, <span class="number">43</span>, <span class="number">249</span>, <span class="number">49</span>, <span class="number">73</span>, <span class="number">148</span>, <span class="number">196</span>, <span class="number">222</span>, <span class="number">200</span>, <span class="number">202</span>, <span class="number">68</span>, <span class="number">221</span>, <span class="number">241</span>, <span class="number">33</span>, <span class="number">57</span>, <span class="number">128</span>, <span class="number">93</span>, <span class="number">149</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">112</span>, <span class="number">248</span>, <span class="number">66</span>, <span class="number">173</span>, <span class="number">203</span>, <span class="number">187</span>, <span class="number">1</span>&#125;</span><br><span class="line">##支持的加密算法##</span><br><span class="line">Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_DSS_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]</span><br><span class="line">Compression Methods:  &#123; <span class="number">0</span> &#125;</span><br><span class="line">Extension elliptic_curves, curve names: &#123;secp256r1, sect163k1, sect163r2, secp192r1, secp224r1, sect233k1, sect233r1, sect283k1, sect283r1, secp384r1, sect409k1, sect409r1, secp521r1, sect571k1, sect571r1, secp160k1, secp160r1, secp160r2, sect163r1, secp192k1, sect193r1, sect193r2, secp224k1, sect239k1, secp256k1&#125;</span><br><span class="line">Extension ec_point_formats, formats: [uncompressed]</span><br><span class="line">Extension server_name, server_name: [host_name: idmtest.dcpc.com]</span><br><span class="line">***</span><br><span class="line">[write] MD5 and SHA1 hashes:  len = <span class="number">220</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> D8 <span class="number">03</span> <span class="number">01</span> <span class="number">5</span>A <span class="number">72</span>   D8 <span class="number">54</span> <span class="number">5F</span> <span class="number">78</span> <span class="number">84</span> D8 <span class="number">45</span> <span class="number">22</span>  ......Zr.T_x..E<span class="string">"</span></span><br><span class="line"><span class="string">0010: CD 49 85 1E F0 B2 25 BB   E4 7F 49 95 01 D8 13 03  .I....%...I.....</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DefaultQuartzScheduler_Worker-3, WRITE: TLSv1 Handshake, length = 220</span></span><br><span class="line"><span class="string">[Raw write]: length = 225</span></span><br><span class="line"><span class="string">0000: 16 03 01 00 DC 01 00 00   D8 03 01 5A 72 D8 54 5F  ...........Zr.T_</span></span><br><span class="line"><span class="string">0010: 78 84 D8 45 22 CD 49 85   1E F0 B2 25 BB E4 7F 49  x..E"</span>.I....%...I</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[Raw read]: length = <span class="number">5</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">16</span> <span class="number">03</span> <span class="number">01</span> <span class="number">06</span> <span class="number">22</span>                                     ....<span class="string">"</span></span><br><span class="line"><span class="string">[Raw read]: length = 1570</span></span><br><span class="line"><span class="string">0000: 02 00 00 46 03 01 5A 72   63 4E F2 CF 4B 0F CE 58  ...F..ZrcN..K..X</span></span><br><span class="line"><span class="string">0010: 0E EF 36 D4 F3 3E C0 85   AD 6D 4B 8D DB CA FB 77  ..6..&gt;...mK....w</span></span><br><span class="line"><span class="string">0020: 80 B3 A1 D2 A7 90 20 D5   A6 FD 6E A7 FF 5A D4 DF  ...... ...n..Z..</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DefaultQuartzScheduler_Worker-3, READ: TLSv1 Handshake, length = 1570</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">##服务器响应</span></span><br><span class="line"><span class="string">*** ServerHello, TLSv1</span></span><br><span class="line"><span class="string">RandomCookie:  GMT: 1517445966 bytes = &#123; 242, 207, 75, 15, 206, 88, 14, 239, 54, 212, 243, 62, 192, 133, 173, 109, 75, 141, 219, 202, 251, 119, 128, 179, 161, 210, 167, 144 &#125;</span></span><br><span class="line"><span class="string">Session ID:  &#123;213, 166, 253, 110, 167, 255, 90, 212, 223, 9, 221, 44, 82, 61, 249, 50, 79, 110, 177, 174, 106, 198, 101, 47, 213, 191, 119, 128, 106, 200, 188, 1&#125;</span></span><br><span class="line"><span class="string">##服务器选定的加密算法</span></span><br><span class="line"><span class="string">Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line"><span class="string">Compression Method: 0</span></span><br><span class="line"><span class="string">***</span></span><br><span class="line"><span class="string">Warning: No renegotiation indication extension in ServerHello</span></span><br><span class="line"><span class="string">%% Initialized:  [Session-8, TLS_RSA_WITH_AES_256_CBC_SHA]</span></span><br><span class="line"><span class="string">** TLS_RSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line"><span class="string">[read] MD5 and SHA1 hashes:  len = 74</span></span><br><span class="line"><span class="string">0000: 02 00 00 46 03 01 5A 72   63 4E F2 CF 4B 0F CE 58  ...F..ZrcN..K..X</span></span><br><span class="line"><span class="string">0010: 0E EF 36 D4 F3 3E C0 85   AD 6D 4B 8D DB CA FB 77  ..6..&gt;...mK....w</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">##服务器返回给客户端的证书链,证明“我是我”</span></span><br><span class="line"><span class="string">*** Certificate chain</span></span><br><span class="line"><span class="string">chain [0] = [</span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">  Version: V3</span></span><br><span class="line"><span class="string">  Subject: CN=*.****.com, ST=北京市, L=北京市, O=***公司, C=CN</span></span><br><span class="line"><span class="string">  Signature Algorithm: SHA256withRSA, OID = 1.2.840.113549.1.1.11</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Key:  Sun RSA public key, 2048 bits</span></span><br><span class="line"><span class="string">  modulus: 256891288892062675553247103925...</span></span><br><span class="line"><span class="string">  public exponent: 65537</span></span><br><span class="line"><span class="string">  Validity: [From: Wed May 17 16:15:30 CST 2017,</span></span><br><span class="line"><span class="string">               To: Fri May 15 16:15:30 CST 2020]</span></span><br><span class="line"><span class="string">  Issuer: CN=WoSign OV SSL CA, O=WoSign CA Limited, C=CN</span></span><br><span class="line"><span class="string">  SerialNumber: [    363fa17d 5c46082c dc707c24 6a8d81b2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Certificate Extensions: 9</span></span><br><span class="line"><span class="string">[1]: ObjectId: 1.3.6.1.5.5.7.1.1 Criticality=false</span></span><br><span class="line"><span class="string">AuthorityInfoAccess [[</span></span><br><span class="line"><span class="string">   accessMethod: ocsp</span></span><br><span class="line"><span class="string">   accessLocation: URIName: http://wosign-ovca.ocsp-certum.com,</span></span><br><span class="line"><span class="string">   accessMethod: caIssuers</span></span><br><span class="line"><span class="string">   accessLocation: URIName: http://repository.certum.pl/wosign-ovca.cer]]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[2]: ObjectId: 2.5.29.35 Criticality=false</span></span><br><span class="line"><span class="string">AuthorityKeyIdentifier [</span></span><br><span class="line"><span class="string">KeyIdentifier [</span></span><br><span class="line"><span class="string">0000: A1 13 54 DC 56 73 2C 27   82 CA C8 84 EF EE BF 00  ..T.Vs,'........</span></span><br><span class="line"><span class="string">0010: FD 5F AB 56                                        ._.V</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[3]: ObjectId: 2.5.29.19 Criticality=true</span></span><br><span class="line"><span class="string">BasicConstraints:[</span></span><br><span class="line"><span class="string">  CA:false</span></span><br><span class="line"><span class="string">  PathLen: undefined</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[4]: ObjectId: 2.5.29.31 Criticality=false</span></span><br><span class="line"><span class="string">CRLDistributionPoints [</span></span><br><span class="line"><span class="string">  [DistributionPoint:</span></span><br><span class="line"><span class="string">     [URIName: http://wosign.crl.certum.pl/wosign-ovca.crl]</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[5]: ObjectId: 2.5.29.32 Criticality=false</span></span><br><span class="line"><span class="string">CertificatePolicies [</span></span><br><span class="line"><span class="string">  [CertificatePolicyId: [2.23.140.1.2.2]</span></span><br><span class="line"><span class="string">[]  ]</span></span><br><span class="line"><span class="string">  [CertificatePolicyId: [1.2.616.1.113527.2.5.1.12.2]</span></span><br><span class="line"><span class="string">[PolicyQualifierInfo: [</span></span><br><span class="line"><span class="string">  qualifierID: 1.3.6.1.5.5.7.2.2</span></span><br><span class="line"><span class="string">  qualifier:</span></span><br><span class="line"><span class="string">0000: 30 81 E4 30 1F 16 18 41   73 73 65 63 6F 20 44 61  0..0...Asseco Da</span></span><br><span class="line"><span class="string">0010: 74 61 20 53 79 73 74 65   6D 73 20 53 2E 41 2E 30  ta Systems S.A.0</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">]]  ]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[6]: ObjectId: 2.5.29.37 Criticality=false</span></span><br><span class="line"><span class="string">ExtendedKeyUsages [</span></span><br><span class="line"><span class="string">  serverAuth</span></span><br><span class="line"><span class="string">  clientAuth</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[7]: ObjectId: 2.5.29.15 Criticality=true</span></span><br><span class="line"><span class="string">KeyUsage [</span></span><br><span class="line"><span class="string">  DigitalSignature</span></span><br><span class="line"><span class="string">  Key_Encipherment</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[8]: ObjectId: 2.5.29.17 Criticality=false</span></span><br><span class="line"><span class="string">SubjectAlternativeName [</span></span><br><span class="line"><span class="string">  DNSName: *.dcpc.com</span></span><br><span class="line"><span class="string">  DNSName: dcpc.com</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[9]: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class="line"><span class="string">SubjectKeyIdentifier [</span></span><br><span class="line"><span class="string">KeyIdentifier [</span></span><br><span class="line"><span class="string">0000: B3 A6 53 AD 96 D8 B7 51   09 D5 E1 07 E5 B2 BC E6  ..S....Q........</span></span><br><span class="line"><span class="string">0010: B5 F2 82 2B                                        ...+</span></span><br><span class="line"><span class="string">]]]</span></span><br><span class="line"><span class="string">  Algorithm: [SHA256withRSA]</span></span><br><span class="line"><span class="string">  Signature:</span></span><br><span class="line"><span class="string">0000: 9A 38 A4 8F B2 A8 CE 9A   B6 98 2F 8F 18 AA 45 79  .8......../...Ey</span></span><br><span class="line"><span class="string">0010: DE D6 31 22 99 6E D7 14   45 5E C1 1F 06 EC 7F C9  ..1"</span>.n..E^......</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line">***</span><br><span class="line">==客户端从本地找到的信赖证书(如果找不到会直接报certificate_unknow)==</span><br><span class="line">Found trusted certificate:</span><br><span class="line">[</span><br><span class="line">[</span><br><span class="line">  Version: V3</span><br><span class="line">  Subject: CN=*.****.com, ST=北京市, L=北京市, O=****公司, C=CN</span><br><span class="line">  Signature Algorithm: SHA256withRSA, OID = <span class="number">1.2</span>.840.113549.1.1.11</span><br><span class="line"></span><br><span class="line">  Key:  Sun RSA <span class="keyword">public</span> key, <span class="number">2048</span> bits</span><br><span class="line">  modulus: <span class="number">2568912888920626755532471039254124</span>....</span><br><span class="line">  <span class="keyword">public</span> exponent: <span class="number">65537</span></span><br><span class="line">  Validity: [From: Wed May <span class="number">17</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">30</span> CST <span class="number">2017</span>,</span><br><span class="line">               To: Fri May <span class="number">15</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">30</span> CST <span class="number">2020</span>]</span><br><span class="line">  Issuer: CN=WoSign OV SSL CA, O=WoSign CA Limited, C=CN</span><br><span class="line">  SerialNumber: [    <span class="number">363f</span>a17d <span class="number">5</span>c46082c dc707c24 <span class="number">6</span>a8d81b2]</span><br><span class="line"></span><br><span class="line">Certificate Extensions: <span class="number">9</span></span><br><span class="line">[<span class="number">1</span>]: ObjectId: <span class="number">1.3</span>.6.1.5.5.7.1.1 Criticality=<span class="keyword">false</span></span><br><span class="line">AuthorityInfoAccess [</span><br><span class="line">  [</span><br><span class="line">   accessMethod: ocsp</span><br><span class="line">   accessLocation: URIName: http:<span class="comment">//wosign-ovca.ocsp-certum.com</span></span><br><span class="line">,</span><br><span class="line">   accessMethod: caIssuers</span><br><span class="line">   accessLocation: URIName: http:<span class="comment">//repository.certum.pl/wosign-ovca.cer</span></span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">[<span class="number">2</span>]: ObjectId: <span class="number">2.5</span>.29.35 Criticality=<span class="keyword">false</span></span><br><span class="line">AuthorityKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line"><span class="number">0000</span>: A1 <span class="number">13</span> <span class="number">54</span> DC <span class="number">56</span> <span class="number">73</span> <span class="number">2</span>C <span class="number">27</span>   <span class="number">82</span> CA C8 <span class="number">84</span> EF EE BF <span class="number">00</span>  ..T.Vs,<span class="string">'........</span></span><br><span class="line"><span class="string">0010: FD 5F AB 56                                        ._.V</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[3]: ObjectId: 2.5.29.19 Criticality=true</span></span><br><span class="line"><span class="string">BasicConstraints:[</span></span><br><span class="line"><span class="string">  CA:false</span></span><br><span class="line"><span class="string">  PathLen: undefined</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[4]: ObjectId: 2.5.29.31 Criticality=false</span></span><br><span class="line"><span class="string">CRLDistributionPoints [</span></span><br><span class="line"><span class="string">  [DistributionPoint:</span></span><br><span class="line"><span class="string">     [URIName: http://wosign.crl.certum.pl/wosign-ovca.crl]</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[5]: ObjectId: 2.5.29.32 Criticality=false</span></span><br><span class="line"><span class="string">CertificatePolicies [</span></span><br><span class="line"><span class="string">  [CertificatePolicyId: [2.23.140.1.2.2]</span></span><br><span class="line"><span class="string">[]  ]</span></span><br><span class="line"><span class="string">  [CertificatePolicyId: [1.2.616.1.113527.2.5.1.12.2]</span></span><br><span class="line"><span class="string">[PolicyQualifierInfo: [</span></span><br><span class="line"><span class="string">  qualifierID: 1.3.6.1.5.5.7.2.2</span></span><br><span class="line"><span class="string">  qualifier:</span></span><br><span class="line"><span class="string">0000: 30 81 E4 30 1F 16 18 41   73 73 65 63 6F 20 44 61  0..0...Asseco Da</span></span><br><span class="line"><span class="string">0010: 74 61 20 53 79 73 74 65   6D 73 20 53 2E 41 2E 30  ta Systems S.A.0</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">]]  ]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[6]: ObjectId: 2.5.29.37 Criticality=false</span></span><br><span class="line"><span class="string">ExtendedKeyUsages [</span></span><br><span class="line"><span class="string">  serverAuth</span></span><br><span class="line"><span class="string">  clientAuth</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[7]: ObjectId: 2.5.29.15 Criticality=true</span></span><br><span class="line"><span class="string">KeyUsage [</span></span><br><span class="line"><span class="string">  DigitalSignature</span></span><br><span class="line"><span class="string">  Key_Encipherment</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[8]: ObjectId: 2.5.29.17 Criticality=false</span></span><br><span class="line"><span class="string">SubjectAlternativeName [</span></span><br><span class="line"><span class="string">  DNSName: *.dcpc.com</span></span><br><span class="line"><span class="string">  DNSName: dcpc.com</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[9]: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class="line"><span class="string">SubjectKeyIdentifier [</span></span><br><span class="line"><span class="string">KeyIdentifier [</span></span><br><span class="line"><span class="string">0000: B3 A6 53 AD 96 D8 B7 51   09 D5 E1 07 E5 B2 BC E6  ..S....Q........</span></span><br><span class="line"><span class="string">0010: B5 F2 82 2B                                        ...+</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">  Algorithm: [SHA256withRSA]</span></span><br><span class="line"><span class="string">  Signature:</span></span><br><span class="line"><span class="string">0000: 9A 38 A4 8F B2 A8 CE 9A   B6 98 2F 8F 18 AA 45 79  .8......../...Ey</span></span><br><span class="line"><span class="string">0010: DE D6 31 22 99 6E D7 14   45 5E C1 1F 06 EC 7F C9  ..1".n..E^......</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">[read] MD5 and SHA1 hashes:  len = 1492</span></span><br><span class="line"><span class="string">0000: 0B 00 05 D0 00 05 CD 00   05 CA 30 82 05 C6 30 82  ..........0...0.</span></span><br><span class="line"><span class="string">0010: 04 AE A0 03 02 01 02 02   10 36 3F A1 7D 5C 46 08  .........6?..\F.</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">*** ServerHelloDone</span></span><br><span class="line"><span class="string">[read] MD5 and SHA1 hashes:  len = 4</span></span><br><span class="line"><span class="string">0000: 0E 00 00 00                                        ....</span></span><br><span class="line"><span class="string">*** ClientKeyExchange, RSA PreMasterSecret, TLSv1</span></span><br><span class="line"><span class="string">[write] MD5 and SHA1 hashes:  len = 262</span></span><br><span class="line"><span class="string">0000: 10 00 01 02 01 00 85 BD   72 17 92 EA 05 0F 0A BD  ........r.......</span></span><br><span class="line"><span class="string">0010: 90 92 72 51 08 0F 6E 29   C4 A2 F0 D2 BA 78 0B A0  ..rQ..n).....x..</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DefaultQuartzScheduler_Worker-3, WRITE: TLSv1 Handshake, length = 262</span></span><br><span class="line"><span class="string">[Raw write]: length = 267</span></span><br><span class="line"><span class="string">0000: 16 03 01 01 06 10 00 01   02 01 00 85 BD 72 17 92  .............r..</span></span><br><span class="line"><span class="string">0010: EA 05 0F 0A BD 90 92 72   51 08 0F 6E 29 C4 A2 F0  .......rQ..n)...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">SESSION KEYGEN:</span></span><br><span class="line"><span class="string">PreMaster Secret:</span></span><br><span class="line"><span class="string">0000: 03 01 80 92 4B 03 FA 1D   39 CE F4 82 3D 4A 96 A7  ....K...9...=J..</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">CONNECTION KEYGEN:</span></span><br><span class="line"><span class="string">Client Nonce:</span></span><br><span class="line"><span class="string">0000: 5A 72 D8 54 5F 78 84 D8   45 22 CD 49 85 1E F0 B2  Zr.T_x..E".I....</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">Server Nonce:</span></span><br><span class="line"><span class="string">0000: 5A 72 63 4E F2 CF 4B 0F   CE 58 0E EF 36 D4 F3 3E  ZrcN..K..X..6..&gt;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">Master Secret:</span></span><br><span class="line"><span class="string">0000: 93 05 C4 97 B7 FB 23 5F   11 15 8A 8E 2C C1 C7 72  ......#_....,..r</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">Client MAC write Secret:</span></span><br><span class="line"><span class="string">0000: 22 84 BA CD 61 27 D9 62   5F 84 FA 7A DF 05 DE 0A  "...a'</span>.b_..z....</span><br><span class="line">...</span><br><span class="line">Server MAC write Secret:</span><br><span class="line"><span class="number">0000</span>: D2 AC <span class="number">73</span> AC CE F2 D2 <span class="number">00</span>   <span class="number">31</span> E6 <span class="number">4F</span> <span class="number">8</span>A DE E3 <span class="number">97</span> <span class="number">8</span>D  ..s.....<span class="number">1</span>.O.....</span><br><span class="line"><span class="number">0010</span>: <span class="number">73</span> <span class="number">52</span> BA D2                                        sR..</span><br><span class="line">Client write key:</span><br><span class="line"><span class="number">0000</span>: CA FB B2 <span class="number">02</span> E7 <span class="number">3F</span> <span class="number">79</span> <span class="number">93</span>   <span class="number">55</span> <span class="number">61</span> CB AB FF EF <span class="number">1</span>E <span class="number">76</span>  .....?y.Ua.....v</span><br><span class="line"><span class="number">0010</span>: <span class="number">10</span> <span class="number">4</span>C DD DE <span class="number">83</span> <span class="number">55</span> <span class="number">99</span> <span class="number">6F</span>   <span class="number">28</span> <span class="number">8</span>E <span class="number">19</span> <span class="number">5</span>D <span class="number">18</span> <span class="number">25</span> <span class="number">33</span> A2  .L...U.o(..].%<span class="number">3</span>.</span><br><span class="line">Server write key:</span><br><span class="line"><span class="number">0000</span>: <span class="number">1</span>A <span class="number">25</span> <span class="number">31</span> <span class="number">69</span> D2 <span class="number">3</span>B <span class="number">45</span> D7   <span class="number">70</span> <span class="number">09</span> <span class="number">5F</span> <span class="number">9</span>A FF D5 B3 <span class="number">71</span>  .%<span class="number">1</span>i.;E.p._....q</span><br><span class="line"><span class="number">0010</span>: <span class="number">73</span> <span class="number">9</span>D D6 <span class="number">52</span> F0 <span class="number">10</span> <span class="number">21</span> <span class="number">8</span>B   <span class="number">8</span>E <span class="number">13</span> <span class="number">97</span> BE B1 <span class="number">02</span> <span class="number">75</span> <span class="number">46</span>  s..R..!.......uF</span><br><span class="line">Client write IV:</span><br><span class="line"><span class="number">0000</span>: <span class="number">68</span> <span class="number">49</span> <span class="number">14</span> C3 A2 <span class="number">97</span> <span class="number">75</span> A0   F3 AC <span class="number">89</span> DA <span class="number">31</span> <span class="number">84</span> C3 EF  hI....u.....<span class="number">1</span>...</span><br><span class="line">Server write IV:</span><br><span class="line"><span class="number">0000</span>: <span class="number">2</span>C <span class="number">03</span> <span class="number">9</span>D <span class="number">28</span> <span class="number">6F</span> C2 <span class="number">7</span>D BD   <span class="number">37</span> B1 AA E5 <span class="number">30</span> <span class="number">6</span>E <span class="number">09</span> EA  ,..(o...<span class="number">7</span>...<span class="number">0</span>n..</span><br><span class="line">DefaultQuartzScheduler_Worker-<span class="number">3</span>, WRITE: TLSv1 Change Cipher Spec, length = <span class="number">1</span></span><br><span class="line">[Raw write]: length = <span class="number">6</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">14</span> <span class="number">03</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">01</span>                                  ......</span><br><span class="line">*** Finished</span><br><span class="line">verify_data:  &#123; <span class="number">56</span>, <span class="number">169</span>, <span class="number">160</span>, <span class="number">43</span>, <span class="number">198</span>, <span class="number">100</span>, <span class="number">229</span>, <span class="number">140</span>, <span class="number">160</span>, <span class="number">251</span>, <span class="number">76</span>, <span class="number">146</span> &#125;</span><br><span class="line">***</span><br><span class="line">[write] MD5 and SHA1 hashes:  len = <span class="number">16</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>C <span class="number">38</span> A9 A0 <span class="number">2</span>B   C6 <span class="number">64</span> E5 <span class="number">8</span>C A0 FB <span class="number">4</span>C <span class="number">92</span>  ....<span class="number">8</span>..+.d....L.</span><br><span class="line">Padded plaintext before ENCRYPTION:  len = <span class="number">48</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>C <span class="number">38</span> A9 A0 <span class="number">2</span>B   C6 <span class="number">64</span> E5 <span class="number">8</span>C A0 FB <span class="number">4</span>C <span class="number">92</span>  ....<span class="number">8</span>..+.d....L.</span><br><span class="line"><span class="number">0010</span>: F5 B1 BB DE F4 <span class="number">25</span> ED A2   <span class="number">3</span>A <span class="number">18</span> <span class="number">9</span>D C8 <span class="number">8</span>E EE <span class="number">2</span>B A6  .....%..:.....+.</span><br><span class="line"><span class="number">0020</span>: <span class="number">4</span>A <span class="number">1</span>E <span class="number">3</span>A C7 <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B   <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B <span class="number">0</span>B  J.:.............</span><br><span class="line">DefaultQuartzScheduler_Worker-<span class="number">3</span>, WRITE: TLSv1 Handshake, length = <span class="number">48</span></span><br><span class="line">[Raw write]: length = <span class="number">53</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">16</span> <span class="number">03</span> <span class="number">01</span> <span class="number">00</span> <span class="number">30</span> <span class="number">4</span>E <span class="number">92</span> <span class="number">1F</span>   <span class="number">3</span>A <span class="number">1F</span> <span class="number">91</span> C8 <span class="number">1</span>B <span class="number">9F</span> <span class="number">6</span>B <span class="number">3</span>A  ....<span class="number">0</span>N..:.....k:</span><br><span class="line"><span class="number">0010</span>: CC <span class="number">2</span>C <span class="number">67</span> <span class="number">2</span>C <span class="number">9</span>D CA <span class="number">58</span> DA   <span class="number">4F</span> <span class="number">91</span> <span class="number">21</span> <span class="number">01</span> <span class="number">8</span>E D8 <span class="number">5</span>A <span class="number">37</span>  .,g,..X.O.!...Z7</span><br><span class="line"><span class="number">0020</span>: <span class="number">67</span> B8 BD A9 E4 F3 <span class="number">79</span> E9   <span class="number">9</span>C E6 E1 <span class="number">52</span> BB <span class="number">8</span>D <span class="number">39</span> <span class="number">0</span>E  g.....y....R..<span class="number">9</span>.</span><br><span class="line"><span class="number">0030</span>: <span class="number">45</span> <span class="number">5F</span> F5 <span class="number">7</span>E <span class="number">7</span>A                                     E_..z</span><br><span class="line">[Raw read]: length = <span class="number">5</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">14</span> <span class="number">03</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span>                                     .....</span><br><span class="line">[Raw read]: length = <span class="number">1</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">01</span>                                                 .</span><br><span class="line">DefaultQuartzScheduler_Worker-<span class="number">3</span>, READ: TLSv1 Change Cipher Spec, length = <span class="number">1</span></span><br><span class="line">[Raw read]: length = <span class="number">5</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">16</span> <span class="number">03</span> <span class="number">01</span> <span class="number">00</span> <span class="number">30</span>                                     ....<span class="number">0</span></span><br><span class="line">[Raw read]: length = <span class="number">48</span></span><br><span class="line"><span class="number">0000</span>: A9 B4 AB <span class="number">6</span>C <span class="number">68</span> BA <span class="number">47</span> DB   CF <span class="number">6</span>E EF <span class="number">8</span>A F2 <span class="number">6F</span> BD <span class="number">73</span>  ...lh.G..n...o.s</span><br><span class="line"><span class="number">0010</span>: E4 <span class="number">44</span> <span class="number">55</span> C8 <span class="number">93</span> <span class="number">1</span>B <span class="number">4</span>B C6   D9 A3 DB <span class="number">4</span>D <span class="number">03</span> <span class="number">3</span>B E0 <span class="number">8</span>D  .DU...K....M.;..</span><br><span class="line"><span class="number">0020</span>: <span class="number">67</span> ED E8 <span class="number">35</span> CA <span class="number">63</span> D8 F8   C8 <span class="number">11</span> <span class="number">40</span> <span class="number">1</span>B <span class="number">54</span> DD <span class="number">6F</span> F2  g..<span class="number">5</span>.c....@.T.o.</span><br><span class="line">DefaultQuartzScheduler_Worker-<span class="number">3</span>, READ: TLSv1 Handshake, length = <span class="number">48</span></span><br><span class="line">Padded plaintext after DECRYPTION:  len = <span class="number">48</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>C <span class="number">58</span> <span class="number">5</span>A F4 F0   FA C9 BE <span class="number">1</span>D <span class="number">27</span> <span class="number">6</span>A A5 <span class="number">3</span>A  ....XZ......<span class="string">'j.:</span></span><br><span class="line"><span class="string">0010: DC 90 D1 52 C8 53 16 DD   CB 04 E9 F0 F7 46 E2 9F  ...R.S.......F..</span></span><br><span class="line"><span class="string">0020: 9E A6 EF 63 0B 0B 0B 0B   0B 0B 0B 0B 0B 0B 0B 0B  ...c............</span></span><br><span class="line"><span class="string">*** Finished</span></span><br><span class="line"><span class="string">verify_data:  &#123; 88, 90, 244, 240, 250, 201, 190, 29, 39, 106, 165, 58 &#125;</span></span><br><span class="line"><span class="string">***</span></span><br><span class="line"><span class="string">%% Cached client session: [Session-8, TLS_RSA_WITH_AES_256_CBC_SHA]</span></span><br><span class="line"><span class="string">[read] MD5 and SHA1 hashes:  len = 16</span></span><br><span class="line"><span class="string">0000: 14 00 00 0C 58 5A F4 F0   FA C9 BE 1D 27 6A A5 3A  ....XZ......'</span>j.:</span><br><span class="line">DefaultQuartzScheduler_Worker-<span class="number">3</span>, setSoTimeout(<span class="number">9000000</span>) called</span><br><span class="line">Padded plaintext before ENCRYPTION:  len = <span class="number">960</span></span><br><span class="line">##发送数据</span><br><span class="line"><span class="number">0000</span>: <span class="number">50</span> <span class="number">4F</span> <span class="number">53</span> <span class="number">54</span> <span class="number">20</span> <span class="number">2F</span> <span class="number">69</span> <span class="number">64</span>   <span class="number">6</span>D <span class="number">2F</span> <span class="number">77</span> <span class="number">73</span> <span class="number">2F</span> <span class="number">55</span> <span class="number">6</span>E <span class="number">69</span>  POST /idm/ws/Uni</span><br><span class="line"><span class="number">0010</span>: <span class="number">74</span> <span class="number">53</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">69</span> <span class="number">63</span> <span class="number">65</span>   <span class="number">20</span> <span class="number">48</span> <span class="number">54</span> <span class="number">54</span> <span class="number">50</span> <span class="number">2F</span> <span class="number">31</span> <span class="number">2</span>E  tService HTTP/<span class="number">1</span>.</span><br><span class="line"><span class="number">0020</span>: <span class="number">30</span> <span class="number">0</span>D <span class="number">0</span>A <span class="number">43</span> <span class="number">6F</span> <span class="number">6</span>E <span class="number">74</span> <span class="number">65</span>   <span class="number">6</span>E <span class="number">74</span> <span class="number">2</span>D <span class="number">54</span> <span class="number">79</span> <span class="number">70</span> <span class="number">65</span> <span class="number">3</span>A  <span class="number">0</span>..Content-Type:</span><br><span class="line"><span class="number">0030</span>: <span class="number">20</span> <span class="number">74</span> <span class="number">65</span> <span class="number">78</span> <span class="number">74</span> <span class="number">2F</span> <span class="number">78</span> <span class="number">6</span>D   <span class="number">6</span>C <span class="number">3</span>B <span class="number">20</span> <span class="number">63</span> <span class="number">68</span> <span class="number">61</span> <span class="number">72</span> <span class="number">73</span>   text/xml; chars</span><br><span class="line"><span class="number">0040</span>: <span class="number">65</span> <span class="number">74</span> <span class="number">3</span>D <span class="number">75</span> <span class="number">74</span> <span class="number">66</span> <span class="number">2</span>D <span class="number">38</span>   <span class="number">0</span>D <span class="number">0</span>A <span class="number">41</span> <span class="number">63</span> <span class="number">63</span> <span class="number">65</span> <span class="number">70</span> <span class="number">74</span>  et=utf-<span class="number">8</span>..Accept</span><br><span class="line"><span class="number">0050</span>: <span class="number">3</span>A <span class="number">20</span> <span class="number">61</span> <span class="number">70</span> <span class="number">70</span> <span class="number">6</span>C <span class="number">69</span> <span class="number">63</span>   <span class="number">61</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6F</span> <span class="number">6</span>E <span class="number">2F</span> <span class="number">73</span> <span class="number">6F</span>  : application/so</span><br><span class="line"><span class="number">0060</span>: <span class="number">61</span> <span class="number">70</span> <span class="number">2</span>B <span class="number">78</span> <span class="number">6</span>D <span class="number">6</span>C <span class="number">2</span>C <span class="number">20</span>   <span class="number">61</span> <span class="number">70</span> <span class="number">70</span> <span class="number">6</span>C <span class="number">69</span> <span class="number">63</span> <span class="number">61</span> <span class="number">74</span>  ap+xml, applicat</span><br><span class="line"><span class="number">0070</span>: <span class="number">69</span> <span class="number">6F</span> <span class="number">6</span>E <span class="number">2F</span> <span class="number">64</span> <span class="number">69</span> <span class="number">6</span>D <span class="number">65</span>   <span class="number">2</span>C <span class="number">20</span> <span class="number">6</span>D <span class="number">75</span> <span class="number">6</span>C <span class="number">74</span> <span class="number">69</span> <span class="number">70</span>  ion/dime, multip</span><br><span class="line"><span class="number">0080</span>: <span class="number">61</span> <span class="number">72</span> <span class="number">74</span> <span class="number">2F</span> <span class="number">72</span> <span class="number">65</span> <span class="number">6</span>C <span class="number">61</span>   <span class="number">74</span> <span class="number">65</span> <span class="number">64</span> <span class="number">2</span>C <span class="number">20</span> <span class="number">74</span> <span class="number">65</span> <span class="number">78</span>  art/related, tex</span><br><span class="line"><span class="number">0090</span>: <span class="number">74</span> <span class="number">2F</span> <span class="number">2</span>A <span class="number">0</span>D <span class="number">0</span>A <span class="number">55</span> <span class="number">73</span> <span class="number">65</span>   <span class="number">72</span> <span class="number">2</span>D <span class="number">41</span> <span class="number">67</span> <span class="number">65</span> <span class="number">6</span>E <span class="number">74</span> <span class="number">3</span>A  t<span class="comment">/*..User-Agent:</span></span><br><span class="line"><span class="comment">00A0: 20 41 78 69 73 2F 31 2E   34 0D 0A 48 6F 73 74 3A   Axis/1.4..Host:</span></span><br><span class="line"><span class="comment">00B0: 20 69 64 6D 74 65 73 74   2E 64 63 70 63 2E 63 6F   ***.***.co</span></span><br><span class="line"><span class="comment">00C0: 6D 3A 38 34 34 33 0D 0A   43 61 63 68 65 2D 43 6F  m:8443..Cache-Co</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, WRITE: TLSv1 Application Data, length = 960</span></span><br><span class="line"><span class="comment">[Raw write]: length = 965</span></span><br><span class="line"><span class="comment">0000: 17 03 01 03 C0 76 73 C9   5C 37 18 B3 8D 85 B6 4A  .....vs.\7.....J</span></span><br><span class="line"><span class="comment">0010: A5 FF 06 E0 81 74 E2 46   22 C7 32 12 51 A6 C4 10  .....t.F".2.Q...</span></span><br><span class="line"><span class="comment">0020: 7E 1D 14 C6 1E 1B 44 95   57 6E AC 83 AA 8D A7 92  ......D.Wn......</span></span><br><span class="line"><span class="comment">0030: 4C 34 01 5D E9 A1 1E 8C   BB 03 55 D9 7A 09 0F 1E  L4.]......U.z...</span></span><br><span class="line"><span class="comment">0040: 5D C4 71 46 CA 29 72 0D   C1 CC F8 CE 6E F9 51 3A  ].qF.)r.....n.Q:</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[Raw read]: length = 5</span></span><br><span class="line"><span class="comment">0000: 17 03 01 01 60                                     ....`</span></span><br><span class="line"><span class="comment">[Raw read]: length = 352</span></span><br><span class="line"><span class="comment">0000: CD C2 06 A2 9F EA 9F 00   C7 27 5E F0 B3 C4 3D 78  .........'^...=x</span></span><br><span class="line"><span class="comment">0010: 2E 9B F4 52 08 FF D7 05   2E A8 1B 42 3F 9A 3D 73  ...R.......B?.=s</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, READ: TLSv1 Application Data, length = 352</span></span><br><span class="line"><span class="comment">##接收数据</span></span><br><span class="line"><span class="comment">Padded plaintext after DECRYPTION:  len = 352</span></span><br><span class="line"><span class="comment">0000: 48 54 54 50 2F 31 2E 31   20 32 30 30 20 0D 0A 43  HTTP/1.1 200 ..C</span></span><br><span class="line"><span class="comment">0010: 6F 6E 74 65 6E 74 2D 54   79 70 65 3A 20 74 65 78  ontent-Type: tex</span></span><br><span class="line"><span class="comment">0020: 74 2F 78 6D 6C 3B 63 68   61 72 73 65 74 3D 55 54  t/xml;charset=UT</span></span><br><span class="line"><span class="comment">0030: 46 2D 38 0D 0A 44 61 74   65 3A 20 54 68 75 2C 20  F-8..Date: Thu,</span></span><br><span class="line"><span class="comment">0040: 30 31 20 46 65 62 20 32   30 31 38 20 30 39 3A 30  01 Feb 2018 09:0</span></span><br><span class="line"><span class="comment">0050: 35 3A 32 35 20 47 4D 54   0D 0A 43 6F 6E 6E 65 63  5:25 GMT..Connec</span></span><br><span class="line"><span class="comment">0060: 74 69 6F 6E 3A 20 63 6C   6F 73 65 0D 0A 0D 0A 3C  tion: close....&lt;</span></span><br><span class="line"><span class="comment">0070: 73 6F 61 70 3A 45 6E 76   65 6C 6F 70 65 20 78 6D  soap:Envelope xm</span></span><br><span class="line"><span class="comment">0080: 6C 6E 73 3A 73 6F 61 70   3D 22 68 74 74 70 3A 2F  lns:soap="http:/</span></span><br><span class="line"><span class="comment">0090: 2F 73 63 68 65 6D 61 73   2E 78 6D 6C 73 6F 61 70  /schemas.xmlsoap</span></span><br><span class="line"><span class="comment">00A0: 2E 6F 72 67 2F 73 6F 61   70 2F 65 6E 76 65 6C 6F  .org/soap/envelo</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">[Raw read]: length = 5</span></span><br><span class="line"><span class="comment">0000: 15 03 01 00 20                                     ....</span></span><br><span class="line"><span class="comment">[Raw read]: length = 32</span></span><br><span class="line"><span class="comment">0000: 10 E4 3E EF D9 D6 A2 0F   F3 11 85 6F 8F 68 48 C8  ..&gt;........o.hH.</span></span><br><span class="line"><span class="comment">0010: 26 73 2E C8 FA 9D 00 03   AB 3B 79 46 DE ED CC 40  &amp;s.......;yF...@</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, READ: TLSv1 Alert, length = 32</span></span><br><span class="line"><span class="comment">Padded plaintext after DECRYPTION:  len = 32</span></span><br><span class="line"><span class="comment">0000: 01 00 C2 40 0A 51 E1 F1   28 06 65 73 E4 84 81 01  ...@.Q..(.es....</span></span><br><span class="line"><span class="comment">0010: 8F A9 A1 FD A9 6E 09 09   09 09 09 09 09 09 09 09  .....n..........</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, RECV TLSv1 ALERT:  warning, close_notify</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, called closeInternal(false)</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, SEND TLSv1 ALERT:  warning, description = close_notify</span></span><br><span class="line"><span class="comment">Padded plaintext before ENCRYPTION:  len = 32</span></span><br><span class="line"><span class="comment">0000: 01 00 4F BB 75 8C 9C 8A   12 64 D7 62 F6 AF 81 90  ..O.u....d.b....</span></span><br><span class="line"><span class="comment">0010: 92 0E 91 25 6F 9B 09 09   09 09 09 09 09 09 09 09  ...%o...........</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, WRITE: TLSv1 Alert, length = 32</span></span><br><span class="line"><span class="comment">[Raw write]: length = 37</span></span><br><span class="line"><span class="comment">0000: 15 03 01 00 20 C1 60 66   8A 2A 1D A5 6C 82 C3 59  .... .`f.*..l..Y</span></span><br><span class="line"><span class="comment">0010: A8 D5 E9 28 70 1D 93 F1   DD 34 00 14 1F 56 12 46  ...(p....4...V.F</span></span><br><span class="line"><span class="comment">0020: 33 0C 4C 3F 51                                     3.L?Q</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, called closeSocket(selfInitiated)</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, called close()</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, called closeInternal(true)</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, called close()</span></span><br><span class="line"><span class="comment">DefaultQuartzScheduler_Worker-3, called closeInternal(true)</span></span><br></pre></td></tr></table></figure><h3 id="证书识别"><a href="#证书识别" class="headerlink" title="证书识别"></a>证书识别</h3><p>Java程序对受信证书的查找顺序是：</p><ol><li><p>javax.net.ssl.trustStore</p><p>就是System.setProperty(“javax.net.ssl.trustStore”,”D:\cacert.keystore”);或者通过JVM参数指定：-Djavax.net.ssl.trustStore=D:\cacert.keystore。</p></li><li><p>JAVA_HOME\jre\lib\security\jssecacerts 【推荐】</p><p>默认没有jssecacerts，一般把cacerts复制成jssecacerts，然后再使用keytool来修改它。jsse的全称是Java Secure Socket Extension。</p></li><li><p>JAVA_HOME\jre\lib\security\cacerts</p><p>通常情况下不就建议通过-Djavax.net.ssl.trustStore=D:\cacert.keystore来直接修改keystore文件的位置，因为这样会造成系统中其他模块可能找不到自己对应的证书了。推荐使用jssecacerts。我们需要什么证书直接往这个位置导就行了。程序不需要做调整。</p></li></ol><h3 id="Springboot-程序实现"><a href="#Springboot-程序实现" class="headerlink" title="Springboot 程序实现"></a>Springboot 程序实现</h3><p>我们希望在Springboot应用每次启动后都向服务器请求证书，并将证书更新到Keystore中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">@ConditionalOnProperty(value = &quot;cert.installation&quot;, havingValue = &quot;true&quot;)</span><br><span class="line">@ConfigurationProperties(&quot;cert&quot;)</span><br><span class="line">@Configuration</span><br><span class="line">public class InstallCert implements CommandLineRunner &#123;</span><br><span class="line"></span><br><span class="line">private static Logger logger = LoggerFactory.getLogger(InstallCert.class);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 生成的证书需要存放的security路径，即： %JAVA_HOME%\jre\lib\security</span><br><span class="line"> */</span><br><span class="line">private String path;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 需要SSL认证的域名</span><br><span class="line"> */</span><br><span class="line">private List&lt;String&gt; domains = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private String password = &quot;changeit&quot;;</span><br><span class="line"></span><br><span class="line">public String getPath() &#123;</span><br><span class="line">return path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void setPath(String path) &#123;</span><br><span class="line">this.path = path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public List&lt;String&gt; getDomains() &#123;</span><br><span class="line">return domains;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void setDomains(List&lt;String&gt; domains) &#123;</span><br><span class="line">this.domains = domains;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public String getPassword() &#123;</span><br><span class="line">return password;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void setPassword(String password) &#123;</span><br><span class="line">this.password = password;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void run(String... strings) throws Exception &#123;</span><br><span class="line">logger.info(&quot;ready to install valid certs&quot;);</span><br><span class="line">if (!Collections.isEmpty(domains))&#123;</span><br><span class="line">logger.info(&quot;domains is &#123;&#125;&quot;, domains.toString());</span><br><span class="line">String[] arrayStr = new String[domains.size()];</span><br><span class="line">installValidCerts(domains.toArray(arrayStr));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private void installValidCerts(String[] args) throws Exception &#123;</span><br><span class="line">logger.info(&quot;Usage: java InstallCert &lt;host&gt;[:port] [passphrase]&quot;);</span><br><span class="line"></span><br><span class="line">char[] passphrase = password.toCharArray();</span><br><span class="line"></span><br><span class="line">String certPath = path;</span><br><span class="line">if (Strings.isNullOrEmpty(path))&#123;</span><br><span class="line">char separator = File.separatorChar;</span><br><span class="line">certPath = System.getProperty(&quot;java.home&quot;) + separator + &quot;lib&quot; + separator + &quot;security&quot;;</span><br><span class="line">&#125;</span><br><span class="line">File dir = new File(certPath);</span><br><span class="line"></span><br><span class="line">//File file = new File(&quot;jssecacerts&quot;);</span><br><span class="line">//if (file.isFile() == false) &#123;</span><br><span class="line">//char SEP = File.separatorChar;</span><br><span class="line">//File dir = new File(System.getProperty(&quot;java.home&quot;) + SEP + &quot;lib&quot; + SEP + &quot;security&quot;);</span><br><span class="line">//file = new File(dir, &quot;jssecacerts&quot;);</span><br><span class="line">//if (file.isFile() == false) &#123;</span><br><span class="line">//file = new File(dir, &quot;cacerts&quot;);</span><br><span class="line">//&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KeyStore ks = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class="line">InputStream in = null;</span><br><span class="line">logger.info(&quot;jre security dir path: &#123;&#125;&quot;, dir.getCanonicalPath());</span><br><span class="line">File file = new File(dir, &quot;jssecacerts&quot;);</span><br><span class="line">if (!file.exists() &amp;&amp; !file.isFile())&#123;</span><br><span class="line">file.createNewFile();</span><br><span class="line">File file1 = new File(dir, &quot;cacerts&quot;);</span><br><span class="line">if (!file1.isFile())&#123;</span><br><span class="line">logger.info(&quot;no certs will be registered, casue no cacerts file was found&quot;);</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">in = new FileInputStream(file1);</span><br><span class="line">ks.load(in, passphrase);</span><br><span class="line">logger.info(&quot;file jssecacerts is created successfully&quot;);</span><br><span class="line">&#125;else &#123;</span><br><span class="line">in = new FileInputStream(file);</span><br><span class="line">ks.load(in, passphrase);</span><br><span class="line">logger.info(&quot;file jssecacerts is existing, will not create again&quot;);</span><br><span class="line">&#125;</span><br><span class="line">IOUtils.closeQuietly(in);</span><br><span class="line"></span><br><span class="line">logger.info(&quot;Loading KeyStore &quot; + file + &quot;...&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SSLContext context = SSLContext.getInstance(&quot;TLS&quot;);</span><br><span class="line">TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">tmf.init(ks);</span><br><span class="line">X509TrustManager defaultTrustManager = (X509TrustManager) tmf.getTrustManagers()[0];</span><br><span class="line">SavingTrustManager tm = new SavingTrustManager(defaultTrustManager);</span><br><span class="line">context.init(null, new TrustManager[] &#123; tm &#125;, null);</span><br><span class="line">SSLSocketFactory factory = context.getSocketFactory();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OutputStream out = new FileOutputStream(file);</span><br><span class="line">for (String domain: args)&#123;</span><br><span class="line">logger.info(&quot;domain is &#123;&#125;&quot;, domain);</span><br><span class="line">String[] c = args[0].split(&quot;:&quot;);</span><br><span class="line">String host = c[0];</span><br><span class="line">int port = (c.length == 1) ? 443 : Integer.parseInt(c[1]);</span><br><span class="line">logger.info(&quot;Opening connection to &quot; + host + &quot;:&quot; + port + &quot;...&quot;);</span><br><span class="line">SSLSocket socket = (SSLSocket) factory.createSocket(host, port);</span><br><span class="line">socket.setSoTimeout(10000);</span><br><span class="line">try &#123;</span><br><span class="line">logger.info(&quot;Starting SSL handshake...&quot;);</span><br><span class="line">socket.startHandshake();</span><br><span class="line">socket.close();</span><br><span class="line">logger.info(&quot;No errors, certificate is already trusted&quot;);</span><br><span class="line">&#125; catch (SSLException e) &#123;</span><br><span class="line">e.printStackTrace(System.out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">X509Certificate[] chain = tm.chain;</span><br><span class="line">if (chain == null) &#123;</span><br><span class="line">logger.info(&quot;Could not obtain server certificate chain, continue next one&quot;);</span><br><span class="line">continue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logger.info(&quot;Server sent &quot; + chain.length + &quot; certificate(s):&quot;);</span><br><span class="line">MessageDigest sha1 = MessageDigest.getInstance(&quot;SHA1&quot;);</span><br><span class="line">MessageDigest md5 = MessageDigest.getInstance(&quot;MD5&quot;);</span><br><span class="line">for (int i = 0; i &lt; chain.length; i++) &#123;</span><br><span class="line">X509Certificate cert = chain[i];</span><br><span class="line">logger.info(&quot; &quot; + (i + 1) + &quot; Subject &quot; + cert.getSubjectDN());</span><br><span class="line">logger.info(&quot;   Issuer  &quot; + cert.getIssuerDN());</span><br><span class="line">sha1.update(cert.getEncoded());</span><br><span class="line">logger.info(&quot;   sha1    &quot; + toHexString(sha1.digest()));</span><br><span class="line">md5.update(cert.getEncoded());</span><br><span class="line">logger.info(&quot;   md5     &quot; + toHexString(md5.digest()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int k=0;</span><br><span class="line"></span><br><span class="line">X509Certificate cert = chain[k];</span><br><span class="line">String alias = host + &quot;-&quot; + (k + 1);</span><br><span class="line">ks.setCertificateEntry(alias, cert);</span><br><span class="line">ks.store(out, passphrase);</span><br><span class="line"></span><br><span class="line">logger.info(cert.toString());</span><br><span class="line">logger.info(&quot;Added &#123;&#125; certificate to keystore &apos;jssecacerts&apos; using alias &#123;&#125;&quot;, domain, alias);</span><br><span class="line">&#125;</span><br><span class="line">IOUtils.closeQuietly(out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static final char[] HEXDIGITS = &quot;0123456789abcdef&quot;.toCharArray();</span><br><span class="line"></span><br><span class="line">private static String toHexString(byte[] bytes) &#123;</span><br><span class="line">StringBuilder sb = new StringBuilder(bytes.length * 3);</span><br><span class="line">for (int b : bytes) &#123;</span><br><span class="line">b &amp;= 0xff;</span><br><span class="line">sb.append(HEXDIGITS[b &gt;&gt; 4]);</span><br><span class="line">sb.append(HEXDIGITS[b &amp; 15]);</span><br><span class="line">sb.append(&apos; &apos;);</span><br><span class="line">&#125;</span><br><span class="line">return sb.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private static class SavingTrustManager implements X509TrustManager &#123;</span><br><span class="line"></span><br><span class="line">private final X509TrustManager tm;</span><br><span class="line">private X509Certificate[] chain;</span><br><span class="line"></span><br><span class="line">SavingTrustManager(X509TrustManager tm) &#123;</span><br><span class="line">this.tm = tm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">throw new UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void checkClientTrusted(X509Certificate[] chain, String authType) throws CertificateException &#123;</span><br><span class="line">throw new UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void checkServerTrusted(X509Certificate[] chain, String authType) throws CertificateException &#123;</span><br><span class="line">this.chain = chain;</span><br><span class="line">tm.checkServerTrusted(chain, authType);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来我们只需要在YAML（applicaton.yml）中配置要申请握手的服务器就好</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cert:</span></span><br><span class="line"><span class="attr">  installation:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  domains:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">bidxxxxxxx.xxxxxxxxxxxxxx.com</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">suppxxxxxx.xxxxx.com</span></span><br></pre></td></tr></table></figure><p>至此，就不会出现证书找不到的问题了</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol><li><a href="https://www.cnblogs.com/huqiaoblog/p/8398009.html" target="_blank" rel="noopener">https://www.cnblogs.com/huqiaoblog/p/8398009.html</a></li><li><a href="http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html</a></li><li><a href="https://blog.csdn.net/catoop/article/details/80819638" target="_blank" rel="noopener">https://blog.csdn.net/catoop/article/details/80819638</a></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> SSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Arthas调整log日志等级</title>
      <link href="//p/arthas-log-level.html"/>
      <url>//p/arthas-log-level.html</url>
      
        <content type="html"><![CDATA[<p>阿里的开源Java诊断工具Arthas可以在线调整log等级</p><ol><li>查找当前类的classloader hashcode</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span><br></pre></td></tr></table></figure><ol start="2"><li>用OGNL获取logger</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl -c 1be6f5c3 '@com.example.demo.arthas.user.UserController@logger'</span><br></pre></td></tr></table></figure><ol start="3"><li>单独设置UserController的logger level</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl -c 1be6f5c3 '@com.example.demo.arthas.user.UserController@logger.setLevel(@ch.qos.logback.classic.Level@DEBUG)'</span><br></pre></td></tr></table></figure><ol start="4"><li>全局设置logger level</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl -c 1be6f5c3 '@org.slf4j.LoggerFactory@getLogger("root").setLevel(@ch.qos.logback.classic.Level@DEBUG)'</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Arthas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Arthas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Springboot去掉@RequestBody中字符串类型值的前后空格</title>
      <link href="//p/spring-boot-request-body-space.html"/>
      <url>//p/spring-boot-request-body-space.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">改造MappingJackson2HttpMessageConverter</blockquote><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>项目组提出要求，Springboot项目中，@ResquestBody标记的bean传入的字符串类型的值要去掉前后空格</p><a id="more"></a><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>因为项目默认使用 <strong>MappingJackson2HttpMessageConverter</strong> 作为 Json转换器， 于是乎重写一些方法做文章，具体实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span></span>&#123;</span><br><span class="line">  <span class="comment">//... 省略重写的其他方法</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.configureMessageConverters(converters);</span><br><span class="line">   <span class="comment">//对应无法直接返回String类型</span></span><br><span class="line">   converters.add(<span class="number">0</span>, <span class="keyword">new</span> MappingJackson2HttpMessageConverter()&#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> ObjectMapper <span class="title">getObjectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">super</span>.getObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">super</span>.getObjectMapper();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 重写read方法，然后做去掉前后空格处理，重新转换成object</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> contextClass</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> inputMessage</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">           * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@throws</span> HttpMessageNotReadableException</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">(Type type, Class&lt;?&gt; contextClass, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line">              Object object = <span class="keyword">super</span>.read(type, contextClass, inputMessage);</span><br><span class="line">              String json = JSONObject.toJSONString(object);</span><br><span class="line">              Map&lt;String,Object&gt; map = (Map&lt;String, Object&gt;) JSONObject.parse(json);</span><br><span class="line"></span><br><span class="line">              Set&lt;Map.Entry&lt;String, Object&gt;&gt; entrySet = map.entrySet();</span><br><span class="line"></span><br><span class="line">              Map&lt;String, Object&gt; removeSpaceMap = Maps.newHashMap();</span><br><span class="line">              <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : entrySet)&#123;</span><br><span class="line">                  <span class="keyword">if</span> (entry.getValue() <span class="keyword">instanceof</span> String)&#123;</span><br><span class="line">                      removeSpaceMap.put(entry.getKey(), ((String) entry.getValue()).trim());</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      removeSpaceMap.put(entry.getKey(),entry.getValue());</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">              String removeSpaceJson = JSON.toJSONString(removeSpaceMap);</span><br><span class="line">              <span class="keyword">return</span> gson.fromJson(removeSpaceJson, type);</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是上面的代码经过各种测试发现一个问题，Gson在处理Integer，Long非浮点型的数值类型时候，自动转换为Double来处理，这导致后续代码做一些数据转换的时候会出现问题，因为Gson内部在处理数据类型都当成Number类型，可以读一下源码，这样需要做如下的改动：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> contextClass</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inputMessage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HttpMessageNotReadableException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">(Type type, Class&lt;?&gt; contextClass, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line">    Object object = <span class="keyword">super</span>.read(type, contextClass, inputMessage);</span><br><span class="line">    String json = JSONObject.toJSONString(object);</span><br><span class="line">    Map&lt;String,Object&gt; map = (Map&lt;String, Object&gt;) JSONObject.parse(json);</span><br><span class="line"></span><br><span class="line">    Set&lt;Map.Entry&lt;String, Object&gt;&gt; entrySet = map.entrySet();</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; removeSpaceMap = Maps.newHashMap();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : entrySet)&#123;</span><br><span class="line">        <span class="keyword">if</span> (entry.getValue() <span class="keyword">instanceof</span> String)&#123;</span><br><span class="line">            removeSpaceMap.put(entry.getKey(), ((String) entry.getValue()).trim());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            removeSpaceMap.put(entry.getKey(),entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    String removeSpaceJson = JSON.toJSONString(removeSpaceMap);</span><br><span class="line">    <span class="keyword">return</span> JSONObject.parseObject(removeSpaceJson, type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注释掉Gson，转换默认将Integer，Long等转换成Double，内部处理看作Number</span></span><br><span class="line">    <span class="comment">/*Gson gson = new Gson();</span></span><br><span class="line"><span class="comment">    return gson.fromJson(removeSpaceJson, type);*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以为这样就结束了吗？哈哈，没有… 😒</p><p>以上我们传入的都是正常的JsonObject，比如这种格式的数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"commonName"</span>:<span class="string">"test2"</span>,</span><br><span class="line">    <span class="attr">"ver"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">"certificateRootType"</span>:<span class="string">"Z200"</span>,</span><br><span class="line">    <span class="attr">"expiredDate"</span>:<span class="string">"2118-01-01"</span>,</span><br><span class="line">    <span class="attr">"certificateName"</span>:<span class="string">"税务登记证 。"</span>,</span><br><span class="line">    <span class="attr">"commonCode"</span>:<span class="string">"suibian"</span>,</span><br><span class="line">    <span class="attr">"updateTime"</span>:<span class="string">"2018-07-12 13:09:14"</span>,</span><br><span class="line">    <span class="attr">"perpetual"</span>:<span class="number">2</span>,</span><br><span class="line">    <span class="attr">"certificateNo"</span>:<span class="string">"11111111"</span>,</span><br><span class="line">    <span class="attr">"certificateTypeName"</span>:<span class="string">"税务登记证"</span>,</span><br><span class="line">    <span class="attr">"imgInfoVOList"</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"url"</span>:<span class="string">"https://www.a.b.c/a.jpg"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"url"</span>:<span class="string">"https://www.a.b.c/b.jpg"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"producerType"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">"createTime"</span>:<span class="string">"2018-07-12 13:09:14"</span>,</span><br><span class="line">    <span class="attr">"supplier"</span>:<span class="number">1043</span>,</span><br><span class="line">    <span class="attr">"id"</span>:<span class="number">5016</span>,</span><br><span class="line">    <span class="attr">"startDate"</span>:<span class="string">"2018-01-01"</span>,</span><br><span class="line">    <span class="attr">"certificateType"</span>:<span class="string">"Z202"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是要有这种格式的数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"roleId"</span>:<span class="number">212</span>,</span><br><span class="line">        <span class="attr">"name"</span>:<span class="string">"上帝视角"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"roleId"</span>:<span class="number">212</span>,</span><br><span class="line">        <span class="attr">"name"</span>:<span class="string">"上帝视角"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"roleId"</span>:<span class="number">212</span>,</span><br><span class="line">        <span class="attr">"name"</span>:<span class="string">"上帝视角"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>如果是下面这种格式的，我们解析的时候就会报转换错误，所以针对下面JsonArray类型的数据，我们需要做特殊处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> contextClass</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inputMessage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HttpMessageNotReadableException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">(Type type, Class&lt;?&gt; contextClass, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line">    Object object = <span class="keyword">super</span>.read(type, contextClass, inputMessage);</span><br><span class="line">    String json = JSONObject.toJSONString(object);</span><br><span class="line">    String jsonResult = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (json.startsWith(<span class="string">"["</span>))&#123;</span><br><span class="line">        JSONArray jsonArray = JSONArray.parseArray(json);</span><br><span class="line">        <span class="keyword">if</span> (jsonArray != <span class="keyword">null</span> &amp;&amp; !jsonArray.isEmpty())&#123;</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; result = Lists.newArrayList();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;jsonArray.size(); i++)&#123;</span><br><span class="line">                Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) jsonArray.get(i);</span><br><span class="line">                Map&lt;String, Object&gt; removeSpaceMap = removeSpace(map);</span><br><span class="line">                result.add(removeSpaceMap);</span><br><span class="line">            &#125;</span><br><span class="line">         jsonResult = JSON.toJSONString(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = (Map&lt;String, Object&gt;) JSONObject.parse(json);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; removeSpaceMap = removeSpace(map);</span><br><span class="line">        jsonResult = JSON.toJSONString(removeSpaceMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//注释掉Gson，转换默认将Integer，Long等转换成Double，内部处理看作Number</span></span><br><span class="line">    <span class="comment">/*Gson gson = new Gson();</span></span><br><span class="line"><span class="comment">    return gson.fromJson(removeSpaceJson, type);*/</span></span><br><span class="line">    <span class="keyword">return</span> JSONObject.parseObject(jsonResult, type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">removeSpace</span><span class="params">(Map&lt;String, Object&gt; map)</span></span>&#123;</span><br><span class="line">  Set&lt;Map.Entry&lt;String, Object&gt;&gt; entrySet = map.entrySet();</span><br><span class="line"></span><br><span class="line">  Map&lt;String, Object&gt; removeSpaceMap = Maps.newHashMap();</span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : entrySet)&#123;</span><br><span class="line">      <span class="keyword">if</span> (entry.getValue() <span class="keyword">instanceof</span> String)&#123;</span><br><span class="line">          removeSpaceMap.put(entry.getKey(), ((String) entry.getValue()).trim());</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">          removeSpaceMap.put(entry.getKey(),entry.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> removeSpaceMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就应对大多数问题了</p><img itemprop="url image" src="/uploads/spring/httpmessageconverter.png" class="full-image" /><p>接下来需要具体了解一下，构建过程，如上图，在HttpInputMessage 通过 converter 转换成Object对象之前做处理，这样在Controller接收的时候就可以拿到处理后的对象了</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Springboot </tag>
            
            <tag> Json </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java实现文件下载并压缩成zip文件</title>
      <link href="//p/java-download-file-zip.html"/>
      <url>//p/java-download-file-zip.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">IO流，网络编程的基础</blockquote><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近在做Springboot分布式微服务项目，用到了文件上传和下载，文件上传是既有的功能，将文件或图片上传到S3服务器上，将生成的文件URL地址和截取的文件名存储到DB中，正常我们只需要给前端URL，通过浏览器就可以实现文件的下载了，但是我们在将文件上传到S3服务器之前是将文件名称进行转码的，如：文件test.docx上传到S3服务器之后的URL地址是： <em><a href="http://www.S3.xxx.com/files/abRsdf.docx" target="_blank" rel="noopener">http://www.S3.xxx.com/files/abRsdf.docx</a></em>, 这样我们下载下来的文件文件名就是 <em>abRsdf.docx</em>, 显然这是不符合我们要求的，下载的文件名应该是test.docx, 并且需要多个文件压缩成zip文件打包下载. 所以需要在response中做一些文章，修改文件名，以及做多文件的压缩。</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>因为DB中存储了文件的URL和文件名称，大概数据形式如下：</p><table><thead><tr><th align="left">序号</th><th align="left">url</th><th align="left">name</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><a href="http://www.S3.xxx.com/files/abRsdf.docx" target="_blank" rel="noopener">http://www.S3.xxx.com/files/abRsdf.docx</a></td><td align="left">test.docx</td></tr><tr><td align="left">2</td><td align="left"><a href="http://www.S3.xxx.com/files/lsdTew.docx" target="_blank" rel="noopener">http://www.S3.xxx.com/files/lsdTew.docx</a></td><td align="left">test1.docx</td></tr></tbody></table><a id="more"></a><h4 id="封装DB数据"><a href="#封装DB数据" class="headerlink" title="封装DB数据"></a>封装DB数据</h4><p>将DB中的url和name数据封装到类型为DownloadVO.java中，DownloadVO.java的代码很简单：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.base.Strings;</span><br><span class="line"><span class="keyword">import</span> com.viewhigh.epro.mall.vo.base.DownloadVO;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.lang.Collections;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOG = LoggerFactory.getLogger(DownloadUtil.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载单个文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> downloadVO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">toDownloadFile</span><span class="params">(DownloadVO downloadVO, HttpServletRequest request, HttpServletResponse response)</span><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String savePath = request.getServletContext().getRealPath(<span class="keyword">new</span> StringBuffer(File.separator).append(<span class="string">"attachment"</span>).append(File.separator).toString());</span><br><span class="line">        LOG.info(<span class="string">"The Path where file will storage is &#123;&#125;"</span>, savePath);</span><br><span class="line"></span><br><span class="line">        downloadFile(getFile(downloadVO, savePath), request, response, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在服务器生成文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> downloadVO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> savePath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getFile</span><span class="params">(DownloadVO downloadVO, String savePath)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(downloadVO.getUrl());</span><br><span class="line"></span><br><span class="line">            HttpURLConnection conn = (HttpURLConnection)url.openConnection(); <span class="comment">// 创建连接实例</span></span><br><span class="line">            conn.setConnectTimeout(<span class="number">3</span>*<span class="number">1000</span>); <span class="comment">//设置超时间为3秒</span></span><br><span class="line">            conn.setRequestProperty(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)"</span>); <span class="comment">//防止屏蔽程序抓取而返回403错误</span></span><br><span class="line">            conn.setRequestProperty(<span class="string">"Charset"</span>, <span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            inputStream = conn.getInputStream(); <span class="comment">//获取连接输入流</span></span><br><span class="line">            <span class="keyword">byte</span>[] getData = readInputStream(inputStream); <span class="comment">//获取字节数组</span></span><br><span class="line"></span><br><span class="line">            File saveDir = <span class="keyword">new</span> File(savePath); <span class="comment">// 创建文件存放路径</span></span><br><span class="line">            <span class="keyword">if</span> (!saveDir.exists())&#123;</span><br><span class="line">                saveDir.mkdir();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            File file = <span class="keyword">new</span> File(savePath,  downloadVO.getName()); <span class="comment">// 在新建路径下创建对应附件名称的文件</span></span><br><span class="line">            fileOutputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            fileOutputStream.write(getData);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> file;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭流</span></span><br><span class="line">            <span class="keyword">if</span>(fileOutputStream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                fileOutputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(inputStream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载多个文件，并压缩成zip</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> downloadVOS 待下载的文件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request Servlet请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response Servlet相应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> zipName 待生成的zip文件名成</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">toDownloadFiles</span><span class="params">(List&lt;DownloadVO&gt; downloadVOS, HttpServletRequest request, HttpServletResponse response, String zipName)</span><span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Collections.isEmpty(downloadVOS))&#123;</span><br><span class="line">            LOG.info(<span class="string">"The total of Attachment is &#123;&#125;"</span> , downloadVOS.size());</span><br><span class="line"></span><br><span class="line">            String savePath = request.getServletContext().getRealPath(<span class="keyword">new</span> StringBuffer(File.separator).append(<span class="string">"attachment"</span>).append(File.separator).toString());</span><br><span class="line">            LOG.info(<span class="string">"The Path where file will storage is &#123;&#125;"</span>, savePath);</span><br><span class="line"></span><br><span class="line">            List&lt;File&gt; files = <span class="keyword">new</span> ArrayList&lt;File&gt;(downloadVOS.size());</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 处理同名文件，如果存在，则以 a.txt, a(1).txt, a(2).txt</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Map&lt;String, Integer&gt; map = Maps.newHashMap();</span><br><span class="line">            <span class="keyword">for</span> (DownloadVO downloadVO : downloadVOS)&#123;</span><br><span class="line">                String fileName = downloadVO.getName();</span><br><span class="line">                <span class="keyword">if</span> (map.containsKey(fileName))&#123;</span><br><span class="line">                    map.put(fileName, map.get(fileName) + <span class="number">1</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    map.put(fileName, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (map.get(fileName) != <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">int</span> position = fileName.lastIndexOf(<span class="string">"."</span>);</span><br><span class="line">                    downloadVO.setName(<span class="keyword">new</span> StringBuffer(fileName.substring(<span class="number">0</span>, position)).append(<span class="string">"("</span>).append(map.get(fileName)).append(<span class="string">")"</span>).append(fileName.substring(position, fileName.length())).toString());</span><br><span class="line">                &#125;</span><br><span class="line">                File file = getFile(downloadVO, savePath);</span><br><span class="line">                files.add(file);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 生成zip文件</span></span><br><span class="line">            File fileZip = generateZipFile(files, savePath, zipName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 下载zip文件</span></span><br><span class="line">            downloadFile(fileZip, request, response, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 删除源文件</span></span><br><span class="line">            deleteSourceFile(files);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteSourceFile</span><span class="params">(List&lt;File&gt; files)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Collections.isEmpty(files))&#123;</span><br><span class="line">            files.forEach(File::delete);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从输入流中获取字节数组，根据 available 获取一次性读取的字节数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">byte</span>[] readInputStream(InputStream inputStream) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            count = inputStream.available();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[count];</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">while</span>((len = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">"current file length is &#123;&#125;"</span>, len);</span><br><span class="line">        bos.close();</span><br><span class="line">        <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成zip文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> savePath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> zipName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">generateZipFile</span><span class="params">(List&lt;File&gt; files, String savePath, String zipName)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        String zipFileName = zipName;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(zipFileName))&#123;</span><br><span class="line">            zipFileName = UUID.randomUUID().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        zipFileName = zipFileName + <span class="string">".zip"</span>;</span><br><span class="line">        File fileZip = <span class="keyword">new</span> File(savePath, zipFileName );</span><br><span class="line">        FileOutputStream fileOutputStream = <span class="keyword">null</span>; <span class="comment">// 文件输出流</span></span><br><span class="line">        ZipOutputStream zipOutputStream = <span class="keyword">null</span>; <span class="comment">// 压缩流</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileOutputStream = <span class="keyword">new</span> FileOutputStream(fileZip);</span><br><span class="line">            zipOutputStream = <span class="keyword">new</span> ZipOutputStream(fileOutputStream);</span><br><span class="line">            zipFile(files, zipOutputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (zipOutputStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">                zipOutputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fileOutputStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">                fileOutputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fileZip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 压缩文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> files</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">zipFile</span><span class="params">(List&lt;File&gt; files, ZipOutputStream outputStream)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> size = files.size();</span><br><span class="line">            <span class="comment">// 压缩列表中的文件</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                File file = (File) files.get(i);</span><br><span class="line">                zipFile(file, outputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">zipFile</span><span class="params">(File inputFile, ZipOutputStream outputstream)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        FileInputStream inStream = <span class="keyword">null</span>;</span><br><span class="line">        BufferedInputStream bInStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (inputFile.isFile()) &#123;</span><br><span class="line">                    inStream = <span class="keyword">new</span> FileInputStream(inputFile);</span><br><span class="line">                    bInStream = <span class="keyword">new</span> BufferedInputStream(inStream);</span><br><span class="line">                    ZipEntry entry = <span class="keyword">new</span> ZipEntry(inputFile.getName());</span><br><span class="line">                    outputstream.putNextEntry(entry);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> MAX_BYTE = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 最大的流为10M</span></span><br><span class="line">                    <span class="keyword">long</span> streamTotal = <span class="number">0</span>; <span class="comment">// 接受流的容量</span></span><br><span class="line">                    <span class="keyword">int</span> streamNum = <span class="number">0</span>; <span class="comment">// 流需要分开的数量</span></span><br><span class="line">                    <span class="keyword">int</span> leaveByte = <span class="number">0</span>; <span class="comment">// 文件剩下的字符数</span></span><br><span class="line">                    <span class="keyword">byte</span>[] inOutbyte; <span class="comment">// byte数组接受文件的数据</span></span><br><span class="line"></span><br><span class="line">                    streamTotal = bInStream.available(); <span class="comment">// 通过available方法取得流的最大字符数</span></span><br><span class="line">                    streamNum = (<span class="keyword">int</span>) Math.floor(streamTotal / MAX_BYTE); <span class="comment">// 取得流文件需要分开的数量</span></span><br><span class="line">                    leaveByte = (<span class="keyword">int</span>) streamTotal % MAX_BYTE; <span class="comment">// 分开文件之后,剩余的数量</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (streamNum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; streamNum; ++j) &#123;</span><br><span class="line">                            inOutbyte = <span class="keyword">new</span> <span class="keyword">byte</span>[MAX_BYTE];</span><br><span class="line">                            <span class="comment">// 读入流,保存在byte数组</span></span><br><span class="line">                            bInStream.read(inOutbyte, <span class="number">0</span>, MAX_BYTE);</span><br><span class="line">                            outputstream.write(inOutbyte, <span class="number">0</span>, MAX_BYTE); <span class="comment">// 写出流</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 写出剩下的流数据</span></span><br><span class="line">                    inOutbyte = <span class="keyword">new</span> <span class="keyword">byte</span>[leaveByte];</span><br><span class="line">                    bInStream.read(inOutbyte, <span class="number">0</span>, leaveByte);</span><br><span class="line">                    outputstream.write(inOutbyte);</span><br><span class="line">                    outputstream.closeEntry(); <span class="comment">// Closes the current ZIP entry</span></span><br><span class="line">                    <span class="comment">// and positions the stream for</span></span><br><span class="line">                    <span class="comment">// writing the next entry</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"文件不存在！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (bInStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">                bInStream.close(); <span class="comment">// 关闭</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (inStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">                inStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载zip文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isDelete</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">downloadFile</span><span class="params">(File file,HttpServletRequest request , HttpServletResponse response,<span class="keyword">boolean</span> isDelete)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        BufferedInputStream bufferedInputStream = <span class="keyword">null</span>;</span><br><span class="line">        OutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bufferedInputStream = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file.getPath()));</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[bufferedInputStream.available()];</span><br><span class="line">            bufferedInputStream.read(buffer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            response.reset(); <span class="comment">// 清空response</span></span><br><span class="line">            outputStream = <span class="keyword">new</span> BufferedOutputStream(response.getOutputStream());</span><br><span class="line">            response.setContentType(<span class="string">"application/octet-stream"</span>);</span><br><span class="line">            LOG.info(<span class="string">"fileName:"</span> + file.getName());</span><br><span class="line"></span><br><span class="line">            String userAgent = request.getHeader(<span class="string">"User-Agent"</span>);</span><br><span class="line">            String formFileName = file.getName();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 针对IE或者以IE为内核的浏览器：</span></span><br><span class="line">            <span class="keyword">if</span> (userAgent.contains(<span class="string">"MSIE"</span>) || userAgent.contains(<span class="string">"Trident"</span>) || userAgent.contains(<span class="string">"Edge"</span>)) &#123;</span><br><span class="line">                formFileName = java.net.URLEncoder.encode(formFileName, <span class="string">"UTF-8"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 非IE浏览器的处理：</span></span><br><span class="line">                formFileName = <span class="keyword">new</span> String(formFileName.getBytes(<span class="string">"UTF-8"</span>), <span class="string">"ISO-8859-1"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + formFileName);</span><br><span class="line">            outputStream.write(buffer);</span><br><span class="line">            outputStream.flush();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//是否将生成的服务器端文件删除</span></span><br><span class="line">            <span class="keyword">if</span>(isDelete)&#123;</span><br><span class="line">                file.delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span>  ex;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (bufferedInputStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">                bufferedInputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (outputStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="servlet路径问题"><a href="#servlet路径问题" class="headerlink" title="servlet路径问题"></a>servlet路径问题</h4><p>上面的代码将文件下载到了servlet的realPath中，顺便总结一下各种路径的差别</p><p>请求路径的URL <a href="http://localhost:8080/electest/system/elecMenuAction_menuHome.do" target="_blank" rel="noopener">http://localhost:8080/electest/system/elecMenuAction_menuHome.do</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"contentType------"</span>+request.getContentType());</span><br><span class="line">System.out.println(<span class="string">"requestcontextPath------"</span>+request.getContextPath());</span><br><span class="line">System.out.println(<span class="string">"servletPath----"</span>+request.getServletPath());</span><br><span class="line">System.out.println(<span class="string">"requestRealPath"</span>+request.getRealPath(<span class="string">""</span>));</span><br><span class="line">System.out.println(<span class="string">"realPath------"</span>+request.getServletContext().getRealPath(<span class="string">""</span>));</span><br><span class="line">System.out.println(<span class="string">"requestURI------"</span>+request.getRequestURI());</span><br><span class="line">System.out.println(<span class="string">"requestURL-------"</span>+request.getRequestURL());</span><br><span class="line">System.out.println(<span class="string">"contextPath-------"</span>+request.getServletContext().getContextPath());</span><br></pre></td></tr></table></figure><p>打印结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contentType------application/x-www-form-urlencoded</span><br><span class="line">requestcontextPath------/electest</span><br><span class="line">servletPath----/system/elecMenuAction_menuHome.<span class="keyword">do</span></span><br><span class="line">requestRealPathD:\tomcate\apache-tomcat-<span class="number">7.0</span>.63-windows-x64\apache-tomcat-<span class="number">7.0</span>.63\webapps\electest</span><br><span class="line">realPath------D:\tomcate\apache-tomcat-<span class="number">7.0</span>.63-windows-x64\apache-tomcat-<span class="number">7.0</span>.63\webapps\electest</span><br><span class="line">requestURI------/electest/system/elecMenuAction_menuHome.<span class="keyword">do</span></span><br><span class="line">requestURL-------http:<span class="comment">//localhost:8080/electest/system/elecMenuAction_menuHome.do</span></span><br><span class="line">contextPath---------/electest</span><br></pre></td></tr></table></figure><p>方法和代码的注释写的已经很详细了，具体的实现就不再详述了</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Springboot Json格式数据不返回null值属性</title>
      <link href="//p/spring-boot-json-return-non-null.html"/>
      <url>//p/spring-boot-json-return-non-null.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">Spring ResponseBody without null field</blockquote><blockquote><p>通常Restful返回的Json格式数据，里面包含很多为空值null的字段，我们没必要将这些字段返回给前端，应该给出更多的有效字段，所以我们需要在Converter Message的时候将这些null值字段给过滤掉</p></blockquote><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>添加 <strong>@JsonInclude(JsonInclude.Include.NON_NULL)</strong> 注解<br>该方法很简单，但是我们有太多的返回类型，一一添加也是很大的工作量，所以我们需要在转换的源头进行控制</p><a id="more"></a><h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>实现 <strong>WebMvcConfigurer</strong> 接口，添加 <strong>@EnableWebMvc</strong> 和 <strong>@Configuration</strong> 注解，然后重写 <strong>MappingJackson2HttpMessageConverter 中 getObjectMapper() 方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span></span>&#123;</span><br><span class="line">  <span class="comment">//... 省略重写的其他方法</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.configureMessageConverters(converters);</span><br><span class="line">   <span class="comment">//对应无法直接返回String类型</span></span><br><span class="line">   converters.add(<span class="number">0</span>, <span class="keyword">new</span> MappingJackson2HttpMessageConverter()&#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> ObjectMapper <span class="title">getObjectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">super</span>.getObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">super</span>.getObjectMapper();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样所有的null值都会被过滤掉，注意这里使用的是 <strong>JsonInclude.Include.NON_NULL</strong>， Json中的某个集合如果为空还是会返回空数组，我们希望把这样的数据也过滤掉，只需要将<strong>JsonInclude.Include.NON_NULL</strong> 修改为 <strong>JsonInclude.Include.NON_EMPTY</strong></p><p>这样就好了，返回给前端清晰有效的数据.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Json </tag>
            
            <tag> Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Docker 部署 Spring Boot</title>
      <link href="//p/docker-deploy-spring-boot.html"/>
      <url>//p/docker-deploy-spring-boot.html</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近陆续在通过SpringBoot搭建项目，往里面逐渐添加功能，项目地址<a href="https://github.com/FraserYu/springbootlearning.git" target="_blank" rel="noopener">SpringBootLearning</a>, 当总结Docker部署SpringBoot的时候，我遇到了一些问题，加以总结</p><a id="more"></a><h3 id="问题汇总"><a href="#问题汇总" class="headerlink" title="问题汇总"></a>问题汇总</h3><p>文章主要参考<a href="http://www.spring4all.com/article/992" target="_blank" rel="noopener">Spring Boot 2.0(四)：使用 Docker 部署 Spring Boot</a>, 因为我是已有的SpringBoot项目，不是简单的SpringBoot项目，所以使用Docker部署SpringBoot的时候遇到了一些问题，现总结如下：</p><ol><li><strong>mvn package</strong> 打包命令不能生成jar包到target目录下<br>因为Docker会用到jar包，所以在用Docker部署之前，先用Maven来进行打包，保证正确，但是使用命令并不能生成jar包，发现打包中打了我的测试用例类，测试用例有持续执行操作，当然其他持续操作也有可能出现这个问题，所以我在pom.xml中加入了plugin来过滤掉Test case.<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mvn 打包时省略test用例--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>$&#123;skipTests&#125;<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>通过Maven的docker插件来部署，遇到了两个问题：<blockquote><ul><li>[ERROR] Failed to execute goal com.spotify:docker-maven-plugin:1.0.0:build (default-cli) on project demo: Exception caught: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: org.apache.http.conn.HttpHostConnectException: Connect to localhost:2375 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused: connect -&gt; [Help 1]</li><li>[ERROR] Failed to execute goal com.spotify:docker-maven-plugin:1.0.0:build (default-cli) on project demo: Exception caught: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: javax.net.ssl.SSLHandshakeException: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target -&gt; [Help 1]</li></ul></blockquote></li></ol><p>通过查找资料在pom.xml中maven的docker插件中添加了如下内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dockerHost</span>&gt;</span>https://192.168.99.100:2376<span class="tag">&lt;/<span class="name">dockerHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dockerCertPath</span>&gt;</span>D:/Users/fraser.yu/.docker/machine/machines/default<span class="tag">&lt;/<span class="name">dockerCertPath</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker学习(四)——容器</title>
      <link href="//p/docker-container.html"/>
      <url>//p/docker-container.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">容器是镜像的一个运行实例，所不同的是，它有额外的可写文件层</blockquote><p>上一篇文章<a href="http://fraserlife.com/2017/11/06/Docker%E5%AD%A6%E4%B9%A0-%E4%B8%89-%E2%80%94%E2%80%94%E9%95%9C%E5%83%8F/#more" target="_blank" rel="noopener">Docker学习(三)——镜像</a>介绍了Docker的镜像，<br>包括 <em>获取镜像，查看镜像信息，搜寻镜像，删除镜像，创建镜像，存储和载入镜像，上传镜像</em>，接下来逐步拆分讲解Docker的核心内容之一——<strong>容器</strong>.</p><a id="more"></a><blockquote><p>Docker的容器十分轻量级，用户可以随时创建或删除容器</p></blockquote><h3 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h3><h4 id="单纯创建容器"><a href="#单纯创建容器" class="headerlink" title="单纯创建容器"></a>单纯创建容器</h4><p><strong>语法: docker create [OPTIONS] IMAGE [COMMAND] [ARG…]</strong></p><ol><li><p>为本地Ubuntu镜像创建容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker create -it ubuntu:latest</span><br></pre></td></tr></table></figure></li><li><p>查看本地启动的容器（注意观察容器的状态是Created,换句话说这个容器是终止状态，没有运行）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br></pre></td></tr></table></figure></li><li><p>容器信息解释</p><blockquote><ul><li>CONTAINER ID： 容器ID</li><li>IMAGE: 容器所运行镜像的名称</li><li>COMMAND: 运行容器时的命令</li><li>CREATED: 容器的创建时间</li><li>STATUS: 容器当前状态</li></ul></blockquote></li><li><p>详细信息请使用下面命令自行了解</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker create --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="启动容器方法一"><a href="#启动容器方法一" class="headerlink" title="启动容器方法一"></a>启动容器方法一</h4><p><strong>语法: docker start [OPTIONS] CONTAINER [CONTAINER…]</strong></p><ol><li><p>查看刚刚创建的容器ID，通过start命令来启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker start 93f</span><br></pre></td></tr></table></figure></li><li><p>重新查看容器信息（注意当前容器状态是Exited，即容器运行终止）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br></pre></td></tr></table></figure></li><li><p>详细信息请使用下面命令自行了解</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker start --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="启动容器方法二"><a href="#启动容器方法二" class="headerlink" title="启动容器方法二"></a>启动容器方法二</h4><p>创建容器和启动容器有一种更方便的命令来完成上面create 和 start 的操作.<br><strong>语法: docker run [OPTIONS] IMAGE [COMMAND] [ARG…]</strong></p><ol><li>为本地Ubuntu镜像在此创建容器并启动<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it ubuntu:latest</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解（和create是一样的）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h4 id="退出容器"><a href="#退出容器" class="headerlink" title="退出容器"></a>退出容器</h4>输入<strong>exit</strong>或者<strong>Ctrl+D</strong>来退出容器，对于所创建的bash容器，当使用exit命令退出之后，该容器就出于终止状态了，这是因为对于Docker容器来说，当运行的应用（此处以bash为例）退出后，容器也就没有继续运行的必要了.</li></ol><h4 id="守护态运行"><a href="#守护态运行" class="headerlink" title="守护态运行"></a>守护态运行</h4><p>更多的时候，需要让Docker容器在后台以守护态（Daemonized）形式运行，用户可以通过添加<strong>-d</strong> option来实现.</p><ol><li>运行容器，每隔一秒打印出hello world<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d ubuntu /bin/sh -c <span class="string">"while true; do echo hello world; sleep 1; done"</span></span><br></pre></td></tr></table></figure></li><li>获取容器的输出信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs ce90</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="终止容器"><a href="#终止容器" class="headerlink" title="终止容器"></a>终止容器</h3><p><strong>语法: docker stop [OPTIONS] CONTAINER [CONTAINER…]</strong><br>执行上述命令后，终止容器分为两个步骤，先向容器发送一个SIGTERM信号，10秒钟后会再次发送一个SIGKILL信号终止容器</p><ol><li>终止上文中启动的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stop ce90</span><br></pre></td></tr></table></figure></li><li>查看终止的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a -q</span><br></pre></td></tr></table></figure></li><li>启动容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker start ce90</span><br></pre></td></tr></table></figure></li><li>重启容器（将运行中的容器终止，并重新启动）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker restart ce90</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stop --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><p>上文中提到使用<strong>-d</strong>参数可以使Docker成守护态运行，但是用户无法看到容器的内部信息，而很多时候我们需要进入到容器内进行操作，Docker也提供了集中方法来实现这个功能</p><h4 id="docker-attach"><a href="#docker-attach" class="headerlink" title="docker attach"></a>docker attach</h4><p><strong>语法: docker attach [OPTIONS] CONTAINER</strong>, 运行该命令时，该容器必须是运行状态（UP）,如果没有运行，使用<strong>start</strong>命令，attach命令可以不用指定命令参数，默认执行上次run的命令参数<strong>/bin/bash</strong>, 但是当多个窗口同时attach到同一个容器的时候，所有窗口都会同步显示，当某个窗口因为某一个命令阻塞时，其他窗口就无法执行其他操作了，所以不建议使用.</p><ol><li>进入刚刚以守护态启动的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker attach 9d89</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker attach --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="docker-exec"><a href="#docker-exec" class="headerlink" title="docker exec"></a>docker exec</h4><p><strong>语法: docker exec [OPTIONS] CONTAINER COMMAND [ARG…]</strong>, 该命令至少需要一个命令参数</p><ol><li>进入刚刚一守护态启动的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it 9d89 /bin/bash</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><p><strong>语法: docker rm [OPTIONS] CONTAINER [CONTAINER…]</strong> 删除处于 <strong>终止状态</strong> 的容器，同时可以输入多个容器ID批量删除容器</p><ol><li>删除处于终止状态的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker rm 9d89</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker rm --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="导入和导出容器"><a href="#导入和导出容器" class="headerlink" title="导入和导出容器"></a>导入和导出容器</h3><h4 id="导出容器"><a href="#导出容器" class="headerlink" title="导出容器"></a>导出容器</h4><p>导出容器是指导出一个已经创建的容器到一个文件，不管该容器是否是处于运行状态<br><strong>语法: docker export [OPTIONS] CONTAINER</strong></p><ol><li>导出9d89容器到ubuntu_export.tar文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">export</span> 9d89 &gt; ubuntu_export.tar</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">export</span> --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="导入容器"><a href="#导入容器" class="headerlink" title="导入容器"></a>导入容器</h4><p>导出的文件又可以使用<strong>docker import</strong> 命令导入，成为镜像</p><ol><li>导入上文中的ubuntu_export.tar文件成为镜像<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat ubuntu_export.tar | docker import - <span class="built_in">test</span>/ubuntu:v1.0</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker import --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><p>我们在上一节中讲过载入镜像 <strong>docker load</strong> 命令导入镜像文件到本地镜像库，这节通过 <strong>docker import</strong> 命令来导入一个容器快照到本地镜像库，但是容器快照文件将丢弃所有历史数据和元数据（仅仅保存容器当前的快照状态）， 而镜像文件形式保存完整记录，体积要大，此外，容器快照导入标签可以重新指定标签元数据等，向上文中的test/ubuntu:v1.0</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker学习(三)——镜像</title>
      <link href="//p/docker-image.html"/>
      <url>//p/docker-image.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">镜像是Docker运行容器的前提</blockquote><p>上一篇文章<a href="http://fraserlife.com/2017/11/03/Docker%E5%AD%A6%E4%B9%A0-%E4%BA%8C-%E2%80%94%E2%80%94Docker%E6%9E%B6%E6%9E%84/#more" target="_blank" rel="noopener">Docker学习(二)——Docker架构</a>讲述了Docker的基本架构，接下来逐步拆分讲解Docker的核心内容之一——<strong>镜像</strong>.</p><blockquote><p>Docker 运行容器前需要本地存有对应的镜像，如果镜像不存在，Docker会尝试先从默认（Docker Hub公共注册服务器中的仓库）镜像仓库下载，用户也可以配置使用自己的仓库. 本章内容主要有：<em>获取镜像，查看镜像信息，搜寻镜像，删除镜像，创建镜像，存储和载入镜像，上传镜像</em>. 看着内容很多，其实熟悉Git的朋友，分分钟就可以理解上面的这些内容， 操作方式都是相通的, 话不多说，看命令说话.</p></blockquote><a id="more"></a><h3 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h3><p><strong>语法: docker pull NAME[:TAG]</strong></p><ol><li>从Docker Hub的Ubuntu仓库下载最新版本Ubuntu镜像(如果不指定tag，默认tag是latest,即下载最新版本)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull ubuntu</span><br></pre></td></tr></table></figure></li><li>从Docker Hub的Ubuntu仓库下载指定版本Ubuntu镜像<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull ubuntu:16.04</span><br></pre></td></tr></table></figure></li><li>我们前面讲过，默认是从Docker Hub的Registry中下载，所以以上的命令相当于<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull registry.hub.docker.com/ubuntu:latest</span><br><span class="line">$ docker pull registry.hub.docker.com/ubuntu:16.04</span><br></pre></td></tr></table></figure></li><li>从其他注册服务器下载Docker镜像（如DockerPool社区，需要指定完整的注册服务器地址）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull dl.dockerpool.com:5000/ubuntu</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="查看镜像信息"><a href="#查看镜像信息" class="headerlink" title="查看镜像信息"></a>查看镜像信息</h3><p><strong>语法：docker images</strong><br>通过该命令可以查看本地所有的镜像，说明一下执行该命令之后每列的含义</p><blockquote><ol><li>REPOSITORY: 来自于哪个仓库，同样是如果没有指定注册服务器的地址，那默认就是Docker Hub的仓库</li><li>TAG：镜像的标签信息，比如latest、16.04</li><li>IMAGE ID：镜像的唯一ID标识</li><li>CREATED:（镜像拉取到本地或者在本地创建镜像的时间）</li><li>VIRTUAL SIZE:镜像的大小</li></ol><p><em>repository是不同的仓库，tag是标记同一个仓库的不同的镜像</em></p></blockquote><h4 id="Tag打标记"><a href="#Tag打标记" class="headerlink" title="Tag打标记"></a>Tag打标记</h4><p>有时候镜像需要一个自己需要的tag标识，这会我们需要用到docker 的tag命令来方便我们管理镜像<br><strong>语法：docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</strong></p><ol><li>给镜像打上自己的标签<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag dl.dockerpool.com:5000/ubuntu:latest ubuntu:20171106_ubuntu</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><p>执行完以上命令再次查看[<strong>docker images</strong>]本地所有镜像，发现我们打了标记的镜像和被打标记的镜像的镜像ID竟然一样.这说明新打上标签的镜像只是指向了同一个镜像文件，只是别名不同，标签在这里就起到了引用或快捷方式的作用.</p><h4 id="查看镜像的详细信息"><a href="#查看镜像的详细信息" class="headerlink" title="查看镜像的详细信息"></a>查看镜像的详细信息</h4><p><strong>语法：docker inspect [OPTIONS] NAME|ID [NAME|ID]</strong><br><em>执行[docker inspect]命令会得到一个Json格式的信息，如果我们需要关注某一个部分，可以使用[-f]参数来使用，镜像ID使用前几个字符就可以，不用输入全部</em></p><ol><li>查看刚刚打了标记的Ubuntu镜像的详细信息(镜像ID因人而异)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect 5506de2b643b</span><br></pre></td></tr></table></figure></li><li>查看镜像指定的详细信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect -f &#123;&#123;<span class="string">".Architecture"</span>&#125;&#125; 5506</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="搜寻镜像"><a href="#搜寻镜像" class="headerlink" title="搜寻镜像"></a>搜寻镜像</h3><p><strong>语法：docker search [OPTIONS] TERM</strong></p><ol><li>搜寻mysql镜像<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker search mysql</span><br></pre></td></tr></table></figure></li><li>说明一下执行该命令之后每列的含义<blockquote><ul><li>NAME: 镜像名称</li><li>DESCRIPTION：竞相描述</li><li>STARTS：镜像星级（代表受欢迎程度）</li><li>OFFICIAL:是否为官方创建和维护的</li><li>AUTOMATED:是否自动创建（自动创建的资源允许用户验证镜像内容以及来源）</li></ul></blockquote></li></ol><h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><p><strong>语法：docker rmi [OPTIONS] IMAGE [IMAGE…]</strong>, IMAGE可以是镜像标签或者镜像ID，rmi其实就是remove image的缩写.</p><blockquote><p>删除镜像这里的规矩稍稍多一点但是遵循以下几个原则，不用背诵以下，会在后面的实践中逐步来验证</p><ol><li>当本地一个镜像有多个标签时，删除某一个标签不影响其他镜像</li><li>当本地一个镜像只有一个标签时，删除该标签会彻底删除该镜像</li><li>当通过镜像ID删除镜像的时候，会逐个删除指向该镜像的标签，最终删除镜像.</li><li>当有该镜像创建的容器存在时，镜像不会被删除，docker会更换该镜像ID，并且镜像没有名字.</li><li>当有该镜像创建的容器存在时,可以使用[-f] 参数来强制删除镜像（不建议这样做）</li><li>当有该镜像创建的容器存在时,应遵循先删除容器，然后再删除镜像</li></ol></blockquote><ol><li>删除mysql镜像<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker rmi mysql:latest</span><br></pre></td></tr></table></figure></li></ol><h3 id="创建镜像"><a href="#创建镜像" class="headerlink" title="创建镜像"></a>创建镜像</h3><p>创建镜像有三种方式：</p><ol><li>基于已有镜像的<strong>容器</strong>创建</li><li>基于本地模板导入</li><li>基于Dockerfile创建（最常用，此处先了解整个过程，后续章节经常使用的时候自然就会了）</li></ol><h4 id="基于已有镜像的容器创建新镜像"><a href="#基于已有镜像的容器创建新镜像" class="headerlink" title="基于已有镜像的容器创建新镜像"></a>基于已有镜像的容器创建新镜像</h4><p><strong>语法：docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</strong></p><ol><li>启动镜像（通过容器运行Ubuntu16.04, 并且进入bash环境），运行后通过[docker ps -a]来查看容器信息，当下主要关注容器ID<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it ubuntu:1604 /bin/bash</span><br></pre></td></tr></table></figure></li><li>创建test文件并且退出容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch <span class="built_in">test</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure></li><li>通过运行的容器创建新的镜像,执行成功后会返回新创建的镜像ID信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker commit -m <span class="string">"added a new file"</span> -a <span class="string">"fraser"</span> a925cb <span class="built_in">test</span>:latest</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解[“-m”:提交信息,”-a”:作者信息,”-p”:提交时暂停容器运行]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker commit --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="基于本地模板导入"><a href="#基于本地模板导入" class="headerlink" title="基于本地模板导入"></a>基于本地模板导入</h4><p>可以直接从一个操作系统模板文件导入一个镜像，推荐<a href="https://download.openvz.org/template/precreated/" target="_blank" rel="noopener">OpenVZ</a>提供的模板来创建(个人觉得这个应用的不是很多，了解即可)</p><ol><li>通过模板文件导入<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat ubuntu-16.04-x86_64.tar.gz | docker import - ubuntu:1604</span><br></pre></td></tr></table></figure></li></ol><h4 id="基于Dockerfile创建"><a href="#基于Dockerfile创建" class="headerlink" title="基于Dockerfile创建"></a>基于Dockerfile创建</h4><p>Dockerfile需要讲解的内容很多，包括里面各个指令的应用，我们会单独拿出一个章节来讲解<a href="www.baidu.com">Dockerfile</a>.</p><h3 id="存出和载入镜像"><a href="#存出和载入镜像" class="headerlink" title="存出和载入镜像"></a>存出和载入镜像</h3><h4 id="存出镜像"><a href="#存出镜像" class="headerlink" title="存出镜像"></a>存出镜像</h4><p><strong>语法：docker save [OPTIONS] IMAGE [IMAGE…]</strong> , 存出镜像到本地文件</p><ol><li>存出本地的ubuntu:1604镜像为ubuntu_1604.tar<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker save -o ubuntu_1604.tar ubuntu:1604</span><br></pre></td></tr></table></figure></li><li>详细信息请使用下面命令自行了解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker save --<span class="built_in">help</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="载入镜像"><a href="#载入镜像" class="headerlink" title="载入镜像"></a>载入镜像</h4><p><strong>语法：docker load [OPTIONS]</strong> , 从存出的本地文件中再导入到本地镜像库</p><ol><li>从ubuntu_1604.tar文件导入镜像到到本地镜像列表<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker load --input ubuntu_1604.tar</span><br><span class="line">或</span><br><span class="line">$ docker load &lt; ubuntu_1604.tar</span><br></pre></td></tr></table></figure></li></ol><h3 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h3><p><strong>语法：docker push [OPTIONS] NAME[:TAG]</strong><br>用户在DockerHub上完成注册之后，即可上传自制的镜像，但是需要打上带有<strong>user</strong>的标签（注册的用户名）</p><ol><li>将本地hello-world镜像加上标签<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag hello-world:latest fraseryu/helloworld:latest</span><br></pre></td></tr></table></figure></li><li>查看本地镜像列表可以看到打上标签的镜像<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker images</span><br></pre></td></tr></table></figure></li><li>登录完成DockerHub授权认证，输入刚刚在DockerHub上注册的用户名和密码<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker login</span><br></pre></td></tr></table></figure></li><li>push本地订制的镜像到DockerHub<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker push fraseryu/helloworld:latest</span><br></pre></td></tr></table></figure></li><li>登录DockerHub看到我们的镜像已经push成功<img itemprop="url image" src="/uploads/push.png"/></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker学习(二)——Docker架构</title>
      <link href="//p/docker-architect.html"/>
      <url>//p/docker-architect.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">像面向对象编程一样理解Docker镜像与容器</blockquote><p>上一篇文章<a href="http://fraserlife.com/2017/11/01/Docker%E5%AD%A6%E4%B9%A0-%E4%B8%80-%E2%80%94%E2%80%94Docker%E5%AE%89%E8%A3%85/#more" target="_blank" rel="noopener">Docker学习(一)——Docker安装</a>讲述了在Ubuntu下安装，安装完了要了解一下Docker架构与一些名词解释，这样对Docker后续的操作会有更好的理解.</p><p>Docker 使用客户端-服务器 (C/S) 架构模式，使用远程API来管理和创建Docker容器, 也就是说我们通过Docker客户端来完成对镜像以及容器的一系列操作</p><img itemprop="url image" src="/uploads/architecture.jpg" class="full-image" /><p>对于上面的图片出现的一系列名词可以这样理解：</p><a id="more"></a><table><thead><tr><th align="left">名词术语</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">Docker 镜像(Images)</td><td align="left">Docker 镜像是用于创建 Docker 容器的模板</td></tr><tr><td align="left">Docker 容器(Container)</td><td align="left">容器是独立运行的一个或一组应用</td></tr><tr><td align="left">Docker 客户端(Client)</td><td align="left">Docker 客户端通过命令行或者其他工具使用 Docker API (<a href="https://docs.docker.com/reference/api/docker_remote_api" target="_blank" rel="noopener">https://docs.docker.com/reference/api/docker_remote_api</a>) 与 Docker 的守护进程通信</td></tr><tr><td align="left">Docker 主机(Host)</td><td align="left">一个物理或者虚拟的机器用于执行 Docker 守护进程和容器</td></tr><tr><td align="left">Docker 仓库(Registry)</td><td align="left">Docker 仓库用来保存镜像，可以理解为代码控制中的代码仓库，Docker Hub(<a href="https://hub.docker.com" target="_blank" rel="noopener">https://hub.docker.com</a>) 提供了庞大的镜像集合供使用</td></tr></tbody></table><p><em>关于Registry我要多说一句，应该把它理解成管理仓库的仓库，这个仓库中有Ubuntu仓库，Apache仓库，Nginx仓库等， 每个小仓库还都管理不同version的镜像，如Ubuntu1604,Ubuntu1404等.</em></p><p>文章开头提到<strong>像面向对象编程一样理解Docker镜像与容器</strong>，看如下表格，一个类可以创建多个对象（除了单例模式），也就是说一个镜像可以有多个容器来运行.</p><table><thead><tr><th align="left">Docker</th><th align="left">面向对象</th></tr></thead><tbody><tr><td align="left">镜像</td><td align="left">类</td></tr><tr><td align="left">容器</td><td align="left">对象</td></tr></tbody></table><p>充分理解一下这篇架构图以及名词解释，就要进入接下来的Docker之旅了.</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol><li><a href="http://www.runoob.com/docker/docker-architecture.html" target="_blank" rel="noopener">Docker架构</a></li><li><a href="http://www.cnblogs.com/SzeCheng/p/6822905.html" target="_blank" rel="noopener">几张图帮你理解 docker 基本原理及快速入门</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker学习(一)——Docker安装</title>
      <link href="//p/docker-install.html"/>
      <url>//p/docker-install.html</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">Docker, incredible virtual machine</blockquote><img itemprop="url image" src="/uploads/dockerIs.png" class="full-image" /><h3 id="什么是Docker"><a href="#什么是Docker" class="headerlink" title="什么是Docker"></a>什么是Docker</h3><p>按照惯例，介绍一些历史，说明一下来龙去脉，至少知道它是怎么来的，又为什么会来，能干什么</p><blockquote><ol><li>Docker 是一个开源项目，诞生于 2013 年初，最初是 dotCloud 公司内部的一个业余项目。它基于 Google 公司推出的 Go 语言实现。 项目后来加入了 Linux 基金会，遵从了 Apache 2.0 协议，项目代码在 GitHub 上进行维护</li><li>Docker 自开源后受到广泛的关注和讨论，以至于 dotCloud 公司后来都改名为 Docker Inc。Redhat 已经在其 RHEL6.5 中集中支持 Docker；Google 也在其 PaaS 产品中广泛应用。</li><li>Docker 项目的目标是实现轻量级的操作系统虚拟化解决方案。 Docker 的基础是 Linux 容器（LXC）等技术。在 LXC 的基础上 Docker 进行了进一步的封装，让用户不需要去关心容器的管理，使得操作更为简便。用户操作 Docker 的容器就像操作一个快速轻量级的虚拟机一样简单。</li></ol></blockquote><a id="more"></a><h3 id="Docker与传统虚拟机的对比"><a href="#Docker与传统虚拟机的对比" class="headerlink" title="Docker与传统虚拟机的对比"></a>Docker与传统虚拟机的对比</h3><p>通过两张图，来理解一下Docker与传统虚拟机的对比，通过下面两张图能看出来Docker节省了哪些资源即可,其他的好处在后面的学习过程中陆续介绍<br><img itemprop="url image" src="/uploads/virtualization.png"/><br><img itemprop="url image" src="/uploads/docker.png"/></p><p>Docker目前分为两个版本</p><ol><li>Docker Enterprise Edition (Docker EE) 专为企业开发和IT团队设计，用于在大规模生产中构建，运送和运行关键业务应用程序Docker EE集成，认证和支持，为企业提供业界最安全的容器平台，使所有应用程序现代化</li><li>Docker Community Edition (Docker CE) 是开发人员和小团队的理想选择，希望开始使用Docker并尝试基于容器的应用程序Docker CE可在许多平台上使用，从桌面到云到服务器</li></ol><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>Docker系列学习主要通过 VirtualBox 在 Ubuntu16.04 中完成安装以及后续进阶课程的学习, Docker版本为DockerCE</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="安装Ubuntu16-04"><a href="#安装Ubuntu16-04" class="headerlink" title="安装Ubuntu16.04"></a>安装Ubuntu16.04</h4><p>VirtualBox 安装Ubuntu1604请参考<a href="http://blog.csdn.net/liaolu2999/article/details/52081438" target="_blank" rel="noopener">在virtualbox下安装ubuntu server 16.04</a></p><h4 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h4><p>按照Docker官网<a href="https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/" target="_blank" rel="noopener">Get Docker CE for Ubuntu</a>描述安装DockerCE</p><h5 id="检查安装条件"><a href="#检查安装条件" class="headerlink" title="检查安装条件"></a>检查安装条件</h5><p>Docker 要求 Ubuntu 系统的内核版本高于 3.10 ，查看本页面的前提条件来验证你的 Ubuntu 版本是否支持 Docker。<br>通过 uname -r 命令查看你当前的内核版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ uname -r</span><br></pre></td></tr></table></figure><h5 id="卸载旧的版本"><a href="#卸载旧的版本" class="headerlink" title="卸载旧的版本"></a>卸载旧的版本</h5><p>老的Docker版本我们叫做<strong>docker</strong>或<strong>docker-engine</strong>, 如果之前安装过，这里需要先卸载, Docker CE package现在叫做docker-ce</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get remove docker docker-engine docker.io</span><br></pre></td></tr></table></figure><h5 id="搭建Docker仓库"><a href="#搭建Docker仓库" class="headerlink" title="搭建Docker仓库"></a>搭建Docker仓库</h5><p>首次在宿主机上安装DockerCE，需要搭建Docker repository,搭建完成后，可以通过repository安装或更新Docker.</p><ol><li>更新apt package<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure></li><li>允许apt用https方式访问Docker仓库（命令太长可以用 <strong>\</strong> 符号换行）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates \</span><br><span class="line">  curl \</span><br><span class="line">  software-properties-common</span><br></pre></td></tr></table></figure></li><li>添加Docker的官方GPG密钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure></li><li>验证fingerprint</li></ol><p><strong>9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88</strong>, 用后八位字符即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key fingerprint 0EBFCD88</span><br></pre></td></tr></table></figure><ol start="5"><li>设置稳定版Repository<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo add-apt-repository \</span><br><span class="line">  <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">  stable"</span></span><br></pre></td></tr></table></figure></li></ol><h5 id="安装Docker-CE"><a href="#安装Docker-CE" class="headerlink" title="安装Docker CE"></a>安装Docker CE</h5><ol><li>更新apt索引<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure></li><li>安装最新版本的Docker CE<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install docker-ce</span><br></pre></td></tr></table></figure></li><li>生产环境指定Docker版本<br>生产环境为了稳定性会选择指定版本，而不是Dokcer的最新版本，查看可用版本：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ apt-cache madison docker-ce</span><br><span class="line"></span><br><span class="line">docker-ce | 17.09.0~ce-0~ubuntu | https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages</span><br></pre></td></tr></table></figure></li><li>安装指定Docker CE 版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install docker-ce=&lt;VERSION&gt;</span><br></pre></td></tr></table></figure></li><li>确认Docker CE 是否安装成功</li></ol><p><strong>仔细阅读docker run hello-world的输出内容，对于理解docker的工作原理有帮助</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run hello-world</span><br><span class="line">$ sudo docker version</span><br></pre></td></tr></table></figure><ol start="6"><li>启动Docker<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl start docker</span><br></pre></td></tr></table></figure></li><li>重新启动Docker<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart docker</span><br></pre></td></tr></table></figure></li></ol><h5 id="Docker命令去掉sudo"><a href="#Docker命令去掉sudo" class="headerlink" title="Docker命令去掉sudo"></a>Docker命令去掉sudo</h5><p>默认情况下，我们每次敲docker命令都需要sudo权限，下面的方法可以省去sudo方便很多.</p><ol><li>创建docker组<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo groupadd docker</span><br></pre></td></tr></table></figure></li><li>添加当前用户到docker组<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure></li><li>登出，重新登录shell</li><li>验证docker命令是否可以运行（注意没有sudo）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run hello-world</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>指数基金交易会产生哪些费用</title>
      <link href="//p/investment-index-fee.html"/>
      <url>//p/investment-index-fee.html</url>
      
        <content type="html"><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在购买指数基金时，我们会看到让人眼花缭乱的各种费用，既然理财了，就要知道：</p><ol><li>我们为了购买这些基金都发生了那些费用？</li><li>怎样购买方式能节省这些费用？</li></ol><p><strong>了解这些对于我们财富增长将会起到重要作用</strong>， 以下文章是借鉴前辈”银行螺丝钉” 的文章加以总结.</p><h3 id="钱都花到哪里去了"><a href="#钱都花到哪里去了" class="headerlink" title="钱都花到哪里去了"></a>钱都花到哪里去了</h3><p>申购费、赎回费、交易佣金、印花税、服务费、托管费、管理费……, 在了解这么对费用之前，我们需要知道指数基金按照购买方式可以分为：</p><a id="more"></a><ol><li><p>场内基金</p><blockquote><p>场内基金指的是上市（股市）交易的基金，只能用证券帐户购买，主要是封闭式基金和上市型开放式基金（LOF基金）</p></blockquote></li><li><p>场外基金</p><blockquote><p>场外基金不上市交易，是只能在指定的网点（银行、基金公司、证券公司等）申购的基金，如一般的开放式基金</p></blockquote></li></ol><p>场内基金，例如ETF基金，它既可以申购赎回，又可以买卖。申购赎回需要几十万起，买卖则是100股起，所以我们一般是通过买卖获取ETF基金。场外基金一般只有申购赎回，大部分是1000元起，我们一般通过申赎获取场外基金，先做一个表格来说明这些费用都发生在哪些基金上</p><table><thead><tr><th align="left">基金\费用</th><th align="left">申购费</th><th align="left">赎回费</th><th align="left">交易佣金</th><th align="left">印花税</th><th align="left">服务费</th><th align="left">托管费</th><th align="left">管理费</th></tr></thead><tbody><tr><td align="left">场内基金</td><td align="left">无</td><td align="left">无</td><td align="left">有</td><td align="left">有</td><td align="left">无</td><td align="left">有</td><td align="left">有</td></tr><tr><td align="left">场外基金</td><td align="left">有</td><td align="left">有</td><td align="left">无</td><td align="left">无</td><td align="left">有/无</td><td align="left">有</td><td align="left">有</td></tr></tbody></table><h4 id="费用详解"><a href="#费用详解" class="headerlink" title="费用详解"></a>费用详解</h4><ol><li><p>申购费和赎回费</p><blockquote><p>场内基金也可以申购，我在上面表格中没有写, 因为例如ETF基金申购一般是几十万起，我们一般不通过申购这一途径获取ETF基金，而是通过场内买卖ETF来获取。买卖跟股票一样，100股起买； 场外基金，一般都是申购获得。交易日下午3点前申购，按照当天收盘的基金净值申购；3点后，按照下一交易日收盘基金净值申购。 以我开始投资场外基金的平台南方基金来看下图：<img src="http://7xkyc7.com1.z0.glb.clouddn.com/licai_fee.png" alt="fee"></p></blockquote><p>如果频繁操作购买，1-1.5%的申购与赎回费用还是非常高的，购买1万元就要100到150元的成本，购买指数基金我们一般都会持有至少三年以上，现在好多基金平台都推出申购零手续费，如果持有超过两年也免掉赎回费用.</p></li><li><p>交易佣金(买卖佣金)</p><blockquote><p>交易佣金针对场内基金来的。上面说过，场内基金可以通过买卖来获得，跟股票一样。需要去券商开股票账户，目前基本所有券商开户都是免费的。交易费率跟股票是一样的，部分券商可以商议。不确定的话可以联系自己的券商客户经理确定，没有任何做广告的嫌疑，我现在用华泰证券，费率还是很合适的.</p></blockquote></li><li><p>印花税</p><blockquote><p>印花税也是针对场内的品种来说的，股票买卖交易是需要交印花税的。印花税是股票交易非常重要的一个税种，甚至可以起到调节股市牛熊的作用。印花税是在买卖股票交割的时候券商就代为扣收了，买卖完股票后第二天查下交割单就可以知道扣了多少印花税。目前股票交易的印花税是交易额的千分之一，单边收取，即买股票不收，卖股票收。<strong>对场内基金来说，目前不需要交印花税</strong></p></blockquote></li><li><p>销售服务费</p><blockquote><p>我们经常能看到一些基金公司宣传某只指数基金申赎费用全免。这里免申赎费用的基金指的是C类基金。是针对场外基金来说的。一般的场外指数基金，是收取申购赎回费，不管买卖频率如何。这样对于一些频繁操作场外基金的投资者，交易成本是非常高的。C类基金比较特殊。它不收取申购费用，一般持有一个月以上赎回也不收取赎回费用。但会固定收取一定比例的销售服务费，一般是0.4-0.6%。这样就把交易成本固定下来了, 依旧以南方基金举例<img src="http://7xkyc7.com1.z0.glb.clouddn.com/licai_fee1.png" alt="fee1"></p></blockquote><p>不过我投资指数基金一般是在低估值的时候分批买，高估值的时候分批卖，一般需要持有一年或多年以上。这种情况下挑选申购费一折的平台申购场外基金，交易成本可以控制在千一左右，持有两年以上也没有了赎回费；C类基金则需要固定交千四到千六，如果不是频繁申赎，不是特别好的选择</p></li><li><p>托管费管理费</p><blockquote><p>上面说的费用都是在基金交易相关的费用。实际上基金在运营的时候还会产生管理费和托管费。这两项费用会直接从基金净值中扣。管理费就是基金公司的一个非常重要的利润来源。主动型基金一般会收取基金规模的1.5%作为管理费。例如管理10个亿的资产的股票基金，一年会收取1500万的管理费。指数基金作为被动型基金，管理费率一般低一些。国内指数基金的平均管理费率在0.83%左右。部分规模较大、运行时间较长的基金，管理费率会降到0.5%。这些可以在基金的公告中查看。托管费是交给基金的托管方的。基金的庞大资产，并不是直接存放在基金公司，一般会在第三方托管方，例如某家大型银行。像我们熟知的50ETF（510050），它的托管方就是工商银行。国内指数基金的托管费率平均在0.17%左右，低的可以做到0.15%</p></blockquote></li></ol><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>按照上面的表格以及费用详细做出如下总结：</p><ol><li>总体来说，投资指数基金，无论场内还是场外，管理费和托管费都要交的，会从基金净值中扣（我们无能为力）</li><li>场内基金会收取交易佣金和印花税。目前场内基金印花税下调到了0，交易佣金不同券商不一样</li><li>场外基金如果不是C类基金，会收取申购费，赎回费持有超两年可免；C类基金适合频繁申赎的朋友，会收取约0.4-0.6%的销售服务费。定投的话选普通的场外基金就好，不用选C类（因为我们会持有这个基金至少3年以上）</li></ol><p>我们经常看到某一只股票上标注一个<strong>“融”</strong>字，那这个字的含义是什么呢？ 这个词距离资金量还不是很大的投资者来说其实是一个比较遥远的，因为能做到融资融券不同的券商对投资者还有有很高的规格限制的，不过这个“融”字的内在含义还是非常有意思的.</p><h3 id="融——融资融券"><a href="#融——融资融券" class="headerlink" title="融——融资融券"></a>融——融资融券</h3><p>融资融券是券商开拓的业务，都是发生在券商和投资者之间，和上市公司本生没关系。</p><blockquote><ul><li>融：就是扩大，开拓的意思</li><li>融资：其实就是借钱</li><li>融券：就是借股票</li></ul></blockquote><p>借钱我们好理解，但是为什么要借股票呢？我们知道中国股票市场只能做多，就是你买了股票只能等待上涨获利，如果股票下跌就没法获利了，而融券就提供了一种做空的工具。</p><!-- more --><p><strong>举例说明</strong></p><ol><li><p>融资：投资者看好一只股票在未来会有上升趋势，苦于手中没有银两来购买股票，于是乎打算向券商借钱来购买该股票，等到指定期限将钱还给券商同时还要支付一些利息（钱不能是白借的啊）</p><blockquote><p>张三看好股票A在未来会有上升趋势，手中却没有银两，张三已经具备了融资的资格（不同的券商标准不一样，请咨询具体的券商经理），于是乎向券商借了1万元钱以每股10元的价格购买了1000股，券商协定的还款日期到了，此时股票A的股价已经涨到了20元，这会我还是还券商1万元钱+利息，也就是说在这次融资的过程中（除去利息）赚了20000-10000=10000（元）</p></blockquote></li><li><p>融券：与融资相反，投资者觉得某股A具有明显的下跌空间，但是手中并没有该股，于是乎打算向券商借来股票卖出去</p><blockquote><p>张三觉得某股A具有明显的下跌空间，但是手中并没有该股，于是向券商借了100手于10元卖出，得10万元，等到该股下跌到9元后买回100手该股还给券商，买回只用了9万，获利1万元。这就是一种典型的融券</p><p>融券还有一种方式叫做对冲，试举例说明：<br>投资者当天于10元买入某股100手，当天就涨到于11元，投资者想于该点卖出，但是苦于中国股市是T+1制度，当天买进的股票当天不能卖出。这时你可以融券该股100手于11元卖出，而把手中的100手还给券商，就相当于做了个T+0.</p></blockquote></li></ol><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol><li>实际操作中还有很多限制，比如“标的”就是一种，你不能对任何股票都进行融券，而只能对券商指定的股票群进行融券，这个股票群就叫“标的”。</li><li>另一个限制就是券商手中有可能没有你想融券的“标的”，因为券商也不傻，你想卖的股票，多半券商也不想留在手中。。。所以在考虑融券之前要查询一下券商手中是否还有该股票。</li><li>另外，借，就要有利息，不管融资还是融券都按照相关市值的银行利息结算（大致如此），但是很多券商都规定：当天借当天还没利息，所以有利于做T+0</li></ol>]]></content>
      
      
      <categories>
          
          <category> Life </category>
          
          <category> 投资理财学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 费用 </tag>
            
            <tag> 指数基金 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java多态调用顺序</title>
      <link href="//p/java-polymorphism-order.html"/>
      <url>//p/java-polymorphism-order.html</url>
      
        <content type="html"><![CDATA[<h3 id="Java多态调用该案例"><a href="#Java多态调用该案例" class="headerlink" title="Java多态调用该案例"></a>Java多态调用该案例</h3><p>大家先看自行测试如下程序的输出结果是什么？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">show</span><span class="params">(D obj)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"A and D"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">show</span><span class="params">(A obj)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"A and A"</span>);  </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">show</span><span class="params">(B obj)</span></span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"B and B"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">show</span><span class="params">(A obj)</span></span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"B and A"</span>);  </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span></span>&#123;  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">D</span> <span class="keyword">extends</span> <span class="title">B</span></span>&#123;  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        A a1 = <span class="keyword">new</span> A();  </span><br><span class="line">        A a2 = <span class="keyword">new</span> B();  </span><br><span class="line">        B b = <span class="keyword">new</span> B();  </span><br><span class="line">        C c = <span class="keyword">new</span> C();  </span><br><span class="line">        D d = <span class="keyword">new</span> D();  </span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"1--"</span> + a1.show(b));  </span><br><span class="line">        System.out.println(<span class="string">"2--"</span> + a1.show(c));  </span><br><span class="line">        System.out.println(<span class="string">"3--"</span> + a1.show(d));  </span><br><span class="line">        System.out.println(<span class="string">"4--"</span> + a2.show(b));  </span><br><span class="line">        System.out.println(<span class="string">"5--"</span> + a2.show(c));  </span><br><span class="line">        System.out.println(<span class="string">"6--"</span> + a2.show(d));  </span><br><span class="line">        System.out.println(<span class="string">"7--"</span> + b.show(b));  </span><br><span class="line">        System.out.println(<span class="string">"8--"</span> + b.show(c));  </span><br><span class="line">        System.out.println(<span class="string">"9--"</span> + b.show(d));        </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>仔细思考哦…………….<br>来看答案，有没有意外发生？</p><pre><code>1--A and A  2--A and A  3--A and D  4--B and A  5--B and A  6--A and D  7--B and B  8--B and B  9--A and D  </code></pre><p>接下来主要针对第四个输出结果做出解释，其他的输出结果按照此规矩自然就能得出，请记住：</p><blockquote><p><strong>当超类对象引用变量引用子类对象时，被引用对象的类型而不是引用变量的类型决定了调用谁的成员方法，但是这个被调用的方法必须是在超类中定义过的，也就是说被子类覆盖的方法，但是它仍然要根据继承链中方法调用的优先级来确认方法，该优先级为：this.show(O)、super.show(O)、this.show((super)O)、super.show((super)O)</strong></p></blockquote><p>所以，这里a2是引用变量，为A类型，它引用的是B对象，因此按照上面那句话的意思是说有B来决定调用谁的方法,所以a2.show(b)应该要调用B中的show(B obj)，产生的结果应该是“B and B”，但是为什么会与前面的运行结果产生差异呢？这里我们忽略了后面那句话“但是这儿被调用的方法必须是在超类中定义过的”，那么show(B obj)在A类中存在吗？根本就不存在！所以这句话在这里不适用？那么难道是这句话错误了？非也！其实这句话还隐含这这句话：它仍然要按照继承链中调用方法的优先级来确认。所以它才会在A类中找到show(A obj)，同时由于B重写了该方法所以才会调用B类中的方法，否则就会调用A类中的方法。</p><h3 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h3><p>感谢<a href="http://blog.csdn.net/chenssy/article/details/12786385#" target="_blank" rel="noopener">作者原文</a></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多态 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OAuth2.0 详解</title>
      <link href="//p/oauth2-detail.html"/>
      <url>//p/oauth2-detail.html</url>
      
        <content type="html"><![CDATA[<h3 id="OAuth2-0-详解"><a href="#OAuth2-0-详解" class="headerlink" title="OAuth2.0 详解"></a>OAuth2.0 详解</h3><p>以下内容为转载<a href="http://www.cnblogs.com/blowing00/" target="_blank" rel="noopener">博主</a>的内容</p><blockquote><ol><li><a href="http://www.cnblogs.com/blowing00/p/4521135.html" target="_blank" rel="noopener">为什么需要 Oauth2.0 协议？</a></li><li><a href="http://www.cnblogs.com/blowing00/p/4523506.html" target="_blank" rel="noopener">开放平台</a></li><li><a href="http://www.cnblogs.com/blowing00/p/4524132.html" target="_blank" rel="noopener">Access Token 与 Refresh Token</a></li><li><a href="http://www.cnblogs.com/blowing00/p/4524192.html" target="_blank" rel="noopener">Implicit 授权方式</a></li><li><a href="http://www.cnblogs.com/blowing00/p/4524412.html" target="_blank" rel="noopener">Authorization Code 授权</a></li><li><a href="http://www.cnblogs.com/blowing00/p/4524591.html" target="_blank" rel="noopener">Resource Owner Password Credentials 授权和 Client Credentials 授权</a></li></ol></blockquote>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> 安全-协议-规范 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OAuth2.0 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hybris tomcat Jrebel热部署配置</title>
      <link href="//p/hybris-jrebel.html"/>
      <url>//p/hybris-jrebel.html</url>
      
        <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>Jrebel是非常强大的实现项目热部署的软件，当然也比较消耗电脑的性能，当如Hybris的这种启动需要一段时间的项目，对于后端开发人员来说，改动一些东西就要重启服务真的是一种折磨，浪费时间，接下来说明一下Jrebel在Hybris项目中的配置</p><h3 id="配置Jrebel"><a href="#配置Jrebel" class="headerlink" title="配置Jrebel"></a>配置Jrebel</h3><p>Jrebel可以通过IntelliJ IDEA来下载安装集成好的插件，也可以单独下载Jrebel的包 （请支持正版）</p><a id="more"></a><h4 id="方法一：通过IntelliJ-IDEA-插件"><a href="#方法一：通过IntelliJ-IDEA-插件" class="headerlink" title="方法一：通过IntelliJ IDEA 插件"></a>方法一：通过IntelliJ IDEA 插件</h4><p>如下图下载安装InteliJ IDEA 插件<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jrebel_jrebel.png" alt="Jrebel"></p><p>安装好之后我们就可以在IntelliJ IDEA的安装目录中看到该插件，接下来在Hybris的local.properties文件中来配置tomcat</p><pre><code>#JRebeltomcat.javaoptions=-agentpath:&quot;D:/Users/fraser/.IntelliJIdea2016.2/config/plugins/jr-ide-idea/lib/jrebel6/lib/jrebel64.dll&quot;  -DforceANSI=truetomcat.debugjavaoptions=-agentpath:&quot;D:/Users/fraser/.IntelliJIdea2016.2/config/plugins/jr-ide-idea/lib/jrebel6/lib/jrebel64.dll&quot; -Xdebug -Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=n -DforceANSI=true</code></pre><h4 id="方法二：通过安装包"><a href="#方法二：通过安装包" class="headerlink" title="方法二：通过安装包"></a>方法二：通过安装包</h4><p>下载Jrebel安装包来，将安装包解压到某一个目录下，然后同样配置local.properties 文件如下：</p><pre><code>#JREBELtomcat.javaoptions=-Xverify:none -javaagent:&quot;E:/MyProjectSpace/jrebel_5.6.0/jrebe/jrebel.jar=de.hybris.tomcat.HybrisWebappClassLoader60&quot;tomcat.debugjavaoptions=-Xverify:none -javaagent:&quot;E:/MyProjectSpace/jrebel_5.6.0/jrebe/jrebel.jar=de.hybris.tomcat.HybrisWebappClassLoader60&quot;-Xdebug -Xrunjdwp:transport=dt_socket,server=y,address=8060,suspend=y#可不配tomcat.generaloptions=-Xmx2G -Xms2G -XX:PermSize=500M -XX:MaxPermSize=300M -Xss256K -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+CMSPermGenSweepingEnabled -XX:+CMSClassUnloadingEnabled -XX:+UseCMSInitiatingOccupancyOnly -XX:+CMSParallelRemarkEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark  -XX:+PrintGCTimeStamps -XX:+PrintGCDetails -Xloggc:&quot;${HYBRIS_LOG_DIR}/tomcat/java_gc.log&quot; -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dorg.tanukisoftware.wrapper.WrapperManager.mbean=true -Djava.endorsed.dirs=..b/endorsed -Dcatalina.base=%CATALINA_BASE% -Dcatalina.home=%CATALINA_HOME% -Dfile.encoding=UTF-8 -Dlog4j.configuration=log4j_init_tomcat.properties -Djava.util.logging.config.file=jdk_logging.properties -Djava.io.tmpdir=&quot;${HYBRIS_TEMP_DIR}&quot; -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000</code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>启动Hybris服务器如看到如下信息就说明Jrebel配置成功：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jrebel_jrebel1.png" alt="jrebel1"></p><p>这样我们执行<strong>ant build</strong> 命令等待build成功，就可以实现热部署，如果遇到如下问题：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jrebel_jrebel2.png" alt="jrebel3"></p><p>找到<strong>D:\projects\hybrisHn\hybris\bin\ext-backoffice\backoffice\buildcallbacks.xml</strong> 文件，按照如下注释掉<strong><backoffice_remove_web_fragments/></strong> 即可</p><pre><code>&lt;macrodef name=&quot;backoffice_after_build&quot;&gt;    &lt;sequential&gt;        &lt;!--&lt;backoffice_remove_web_fragments/&gt;--&gt;        &lt;backoffice_create_web_fragments/&gt;    &lt;/sequential&gt;&lt;/macrodef&gt;</code></pre><p>重新尝试<strong>ant build</strong> 命令应该就可以build成功，快尝试一下吧</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hybris </tag>
            
            <tag> Jrebel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 根据关键字查看集群服务器的log</title>
      <link href="//p/linux-search-keyword-script.html"/>
      <url>//p/linux-search-keyword-script.html</url>
      
        <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>现在项目多数会采用集群部署的形式，进行负载均衡，来分担客户端大量请求的压力，当客户端请求发生异常，异常log只能在某一个服务器节点上产生，当服务器节点比较少时候，我们可以根据log的关键字来单个查找，但是当服务器节点多的时候我们还这么查找真的有些浪费时间而且不准确.</p><a id="more"></a><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>在某一台release 服务器上执行下面脚本即可完成多个节点的log信息的查询<br><strong>check_log_in_console.sh</strong>脚本内容如下</p><pre><code>#!/bin/bashif [ $# -lt 1 ]; then  echo &quot;please provide the content you want to find&quot;  echo &quot;usage: $0 [content] [date in yyyymmdd format]&quot;  exit 0fiif [ &quot;$2&quot; == &quot;&quot; ]; then  d=`date +%Y%m%d`else  d=$2fis=prd-hybris-padfor((i=1;i&lt;=4;i++))do    server=$s$i.bb.com    echo &quot;============check logs on $server====================&quot;    ssh app@$server &quot;grep &apos;$1&apos; /data/workspace/hybris/hybris/log/tomcat/console-$d.log&quot;        sleep 1doneecho &quot;done&quot;#exit 0</code></pre><p>这样我们只需要在该文件目录中执行</p><pre><code>./check_log_in_console.sh &quot;你要搜索的关键字&quot;  [回车]</code></pre><p>就会去以上节点中四个服务器中去查找你要搜索的关键字，打印出类似如下的log信息：</p><pre><code>============check logs on prd-hybris-pad1.bb.com======================check logs on prd-hybris-pad2.bb.com======================check logs on prd-hybris-pad3.bb.com======================check logs on prd-hybris-pad4.bb.com==========</code></pre>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring MVC 之 @ResponseStatus</title>
      <link href="//p/springmvc-response-status.html"/>
      <url>//p/springmvc-response-status.html</url>
      
        <content type="html"><![CDATA[<h3 id="ResponseStatus"><a href="#ResponseStatus" class="headerlink" title="@ResponseStatus"></a>@ResponseStatus</h3><p>Restful webservice请求会用到@ResponseStatus 注解，该注解可用于类级别上，也可以应用在方法级别上，代表请求响应的状态，通常就是返回HttpStatus的状态码，具体可查询每个状态码代，这里简单罗列一些：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CONTINUE(100, "Continue"),</span><br><span class="line">SWITCHING_PROTOCOLS(101, "Switching Protocols"),</span><br><span class="line">PROCESSING(102, "Processing"),</span><br><span class="line">CHECKPOINT(103, "Checkpoint"),</span><br><span class="line">OK(200, "OK"),</span><br><span class="line">CREATED(201, "Created"),</span><br><span class="line">ACCEPTED(202, "Accepted"),</span><br><span class="line">NON_AUTHORITATIVE_INFORMATION(203, "Non-Authoritative Information"),</span><br><span class="line">NO_CONTENT(204, "No Content"),</span><br><span class="line">RESET_CONTENT(205, "<span class="keyword">Reset</span> <span class="keyword">Content</span><span class="string">"),</span></span><br><span class="line"><span class="string">PARTIAL_CONTENT(206, "</span><span class="keyword">Partial</span> <span class="keyword">Content</span><span class="string">"),</span></span><br><span class="line"><span class="string">MULTI_STATUS(207, "</span>Multi-<span class="keyword">Status</span><span class="string">"),</span></span><br><span class="line"><span class="string">ALREADY_REPORTED(208, "</span>Already Reported<span class="string">"),</span></span><br><span class="line"><span class="string">IM_USED(226, "</span>IM Used<span class="string">"),</span></span><br><span class="line"><span class="string">MULTIPLE_CHOICES(300, "</span>Multiple Choices<span class="string">"),</span></span><br><span class="line"><span class="string">MOVED_PERMANENTLY(301, "</span>Moved Permanently<span class="string">"),</span></span><br><span class="line"><span class="string">FOUND(302, "</span><span class="keyword">Found</span><span class="string">"),</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="应用在类级别"><a href="#应用在类级别" class="headerlink" title="应用在类级别"></a>应用在类级别</h4><p>创建一个异常类，用该注解标注</p><pre><code>package com.zj.exception;import org.springframework.http.HttpStatus;import org.springframework.web.bind.annotation.ResponseStatus;@ResponseStatus(value=HttpStatus.FORBIDDEN,reason=&quot;用户不匹配&quot;)public class UserNotMatchException extends RuntimeException{}</code></pre><p>写一个目标方法来抛出异常</p><pre><code>@RequestMapping(&quot;/testResponseStatus&quot;)public String testResponseStatus(int i){    if(i==0)        throw new UserNotMatchException();    return &quot;hello&quot;;}</code></pre><p>  这样当我们请求该方法，如果出现异常，会将用户不匹配的信息返回给浏览器，让异常信息更加明确，而不是一堆异常信息代码</p><h4 id="应用在方法级别"><a href="#应用在方法级别" class="headerlink" title="应用在方法级别"></a>应用在方法级别</h4><pre><code>@ResponseStatus(value=HttpStatus.FORBIDDEN,reason=&quot;用户名不匹配&quot;)@RequestMapping(&quot;/testResponseStatus&quot;)public String testResponseStatus(int i){    if(i==0)        throw new UserNotMatchException();    return &quot;hello&quot;;}</code></pre><p><strong>ResponseStatus修饰目标方法，无论它执行方法过程中有没有异常产生，用户都会得到异常的界面。而目标方法正常执行</strong></p><p>这个情况要看项目的使用情况，通常会制定一个标准的异常信息显示，可以灵活使用.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring MVC 之 @initbinder</title>
      <link href="//p/springmvc-init-binder.html"/>
      <url>//p/springmvc-init-binder.html</url>
      
        <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在Web项目中，太多需要提交表单或者在请求URL中添加参数信息的操作，无论是前者还是后者，SpringMVC都将每个元素当做String来处理， 如果前台传入格式化为字符串的日期或这数值类型的时候就会报错（在SpringMVC中，bean中定义了Date，double等类型，如果没有做任何处理的话，日期以及double都无法绑定），我们手动来强制转型很是麻烦，SpringMVC 提供的@initbinder 就是解决这个问题</p><h3 id="initbinder"><a href="#initbinder" class="headerlink" title="@initbinder"></a>@initbinder</h3><p>在我的项目中是在BaseController中增加方法initBinder，并使用注解@InitBinder标注，那么spring mvc在绑定表单之前，都会先注册这些编辑器, Spring自己提供了大量的实现类，诸如CustomDateEditor ，CustomBooleanEditor，CustomNumberEditor等许多，基本上够用, 当然我们也可以自己来写这些编辑器.</p><a id="more"></a><h4 id="自定义编辑器"><a href="#自定义编辑器" class="headerlink" title="自定义编辑器"></a>自定义编辑器</h4><pre><code>import org.springframework.beans.propertyeditors.PropertiesEditor;  public class DoubleEditor extends PropertiesEditor {        @Override        public void setAsText(String text) throws IllegalArgumentException {            if (text == null || text.equals(&quot;&quot;)) {                text = &quot;0&quot;;            }            setValue(Double.parseDouble(text));        }        @Override        public String getAsText() {            return getValue().toString();        }    }  </code></pre><p>类似Long、Float等都可以这样写，然后将这些自定义的编辑器或Spring自带的编辑器放到BaseController中带有@initbinder的方法中注册就好.</p><pre><code>@InitBinder    protected void initBinder(WebDataBinder binder) {        binder.registerCustomEditor(Date.class, new CustomDateEditor(new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;), true));      binder.registerCustomEditor(int.class, new CustomNumberEditor(int.class, true));        binder.registerCustomEditor(int.class, new IntegerEditor());        binder.registerCustomEditor(long.class, new CustomNumberEditor(long.class, true));      binder.registerCustomEditor(long.class, new LongEditor());        binder.registerCustomEditor(double.class, new DoubleEditor());        binder.registerCustomEditor(float.class, new FloatEditor());    }  </code></pre><p>当然我们也可以将自定义的编辑器直接继承 <strong>PropertyEditorSupport</strong>， 因为：</p><pre><code>public class org.springframework.beans.propertyeditors.PropertiesEditor extends java.beans.PropertyEditorSupport {      </code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>非常感谢一下两位作者贡献整理的文章：</p><ol><li><a href="http://blog.csdn.net/axin66ok/article/details/17938095#" target="_blank" rel="noopener">spring mvc使用@InitBinder 标签对表单数据绑定</a></li><li><a href="http://www.cnblogs.com/shenxiaoquan/p/5753351.html" target="_blank" rel="noopener">@InitBind来解决字符串转日期类型</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringMVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java中的ArrayList的容量</title>
      <link href="//p/java-arraylist-capacity.html"/>
      <url>//p/java-arraylist-capacity.html</url>
      
        <content type="html"><![CDATA[<ol><li><p>List接口的大小可变数组的实现。实现了所有可选列表操作，并允许包括 null 在内的所有元素。</p></li><li><p>ArrayList继承于List接口，除继承过来的方法外，还提供一些方法来操作内部用来存储列表的数组的大小。</p></li><li><p>每个ArrayList实例都有一个容量。该容量是指用来存储列表元素的数组的大小。它总是至少等于列表的大小。随着向ArrayList中不断添加元素，其容量也自动增长。并未指定增长策略的细节，因为这不只是添加元素会带来分摊固定时间开销那样简单。</p><a id="more"></a></li><li><p>ArrayList是经常会被用到的，一般情况下，使用的时候会像这样进行声明：</p><pre><code>List arrayList = new ArrayList();</code></pre><p>如果像上面这样使用默认的构造方法，初始容量被设置为10。当ArrayList中的元素超过10个以后，会重新分配内存空间，使数组的大小增长到16。<br>可以通过调试看到动态增长的数量变化：10-&gt;16-&gt;25-&gt;38-&gt;58-&gt;88-&gt;…</p></li><li><p>也可以使用下面的方式进行声明：</p><pre><code>List arrayList = new ArrayList(4);</code></pre><p>将ArrayList的默认容量设置为4。当ArrayList中的元素超过4个以后，会重新分配内存空间，使数组的大小增长到7。<br>可以通过调试看到动态增长的数量变化：4-&gt;7-&gt;11-&gt;17-&gt;26-&gt;…</p></li><li><p>那么容量变化的规则是什么呢？请看下面的公式：</p><pre><code>((旧容量 * 3) / 2) + 1</code></pre><p>注：这点与C#语言是不同的，C#当中的算法很简单，是翻倍。 一旦容量发生变化，就要带来额外的内存开销，和时间上的开销。所以，在已经知道容量大小的情况下，推荐使用下面方式进行声明：List arrayList = new ArrayList(CAPACITY_SIZE); 即指定默认容量大小的方式。</p></li></ol><p>感谢原文作者：<a href="http://blog.csdn.net/arui319/article/details/3557743" target="_blank" rel="noopener">原文</a></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ArrayList </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins自动化部署Hybris</title>
      <link href="//p/jenkins-hybris-deploy.html"/>
      <url>//p/jenkins-hybris-deploy.html</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>项目开发时间不算紧张，知道项目应用Jenkins 持续集成实现自动化部署，这个部署是如何实现的，向架构师取经研究之后做此记录.</p><h3 id="部署架构拓扑图"><a href="#部署架构拓扑图" class="headerlink" title="部署架构拓扑图"></a>部署架构拓扑图</h3><p>以下是项目部署架构简易拓扑图，不包括Solr服务器的部署, Prod Env采用Cluster Deployment的方式.  </p><a id="more"></a><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jenkins_tp.png" alt="部署拓扑图"></p><blockquote><p>运维人员搭建Jenkins服务器之后，每位被授权的开发人员都可以访问Jenkins 工作主页， 当push代码之后，统一在指定时间点build (Jenkins没有采用有push代码自动build的方式 ).</p><ol><li>开发人员Push 代码</li><li>Build QA1, 功能测试通过之后进行下一步</li><li>Build QA2, 功能测试通过之后进行下一步</li><li>等待发布版本时间节点</li><li>Build Stage环境，功能测试通过之后进行下一步 （拓扑图中没有显示Stage环境）</li><li>Build Prod 环境， 功能测试通过之后成功发布.</li></ol></blockquote><p>开发人员只需要点击Jenkins控制台的Build，即可完成自动化部署，这正是Jenkins 带来的便利，接下来就解释一下Jenkins 整个工作过程.</p><h3 id="Jenkins-持续集成过程详解"><a href="#Jenkins-持续集成过程详解" class="headerlink" title="Jenkins 持续集成过程详解"></a>Jenkins 持续集成过程详解</h3><p>生产环境是采用集群部署，和QA环境是有所区别的，下面针对生产环境和QA环境分别作解释</p><h4 id="Common-环境解释"><a href="#Common-环境解释" class="headerlink" title="Common 环境解释"></a>Common 环境解释</h4><p>Jenkins 的Home Directory 是  </p><pre><code>/var/lib/jenkins</code></pre><h4 id="QA环境部署"><a href="#QA环境部署" class="headerlink" title="QA环境部署"></a>QA环境部署</h4><blockquote><p>以QA1 环境为例，item名称为 <strong>qa_honor_hybris</strong>,  workspace的路径是Jenkins 的workspace路径与item名称的拼接，这样当前item的<strong>$workspace</strong>的路径为</p></blockquote><pre><code>/var/lib/jenkins/workspace/qa_honor_hybris</code></pre><ol><li><p>点击build之后，Jenkins会按照该item配置好的Git Repository 来拉取最新代码到workspace中</p></li><li><p>执行自定义Shell 脚本(Jenkins 控制台写好的脚本)</p><pre><code># 1. 移除掉工作区旧代码rm -rf /data/qa_honor_hybris/hybris/bin/custom# 2. copy 拉取下来的最新代码到工作区中cp -r $WORKSPACE/bin/custom /data/qa_honor_hybris/hybris/bin# 3. copy local.properties  和 localextensions.xml 到 工作区config目录下cp $WORKSPACE/config/local.properties /data/qa_honor_hybris/hybris/configcp $WORKSPACE/config/localextensions.xml /data/qa_honor_hybris/hybris/config# 5. 进入工作区platform 目录cd /data/qa_honor_hybris/hybris/bin/platform# 6. 设置基本环境变量，当然可以Jenkins 设置好export JAVA_HOME=/usr/local/jdk1.8export JRE_HOME=/usr/local/jdk1.8/jreexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATHexport PATH=$JAVA_HOME/bin:$PATH# 7. 指定ant 目录并且build，执行该步骤是为了检测项目是否能build成功. ./setantenv.shant clean all# 8. 切换到工作区build 目录下cd /data/qa_honor_hybris/build./build_and_deploy.sh</code></pre></li><li><p><strong>./build_and_deploy.sh</strong> 脚本内容</p><pre><code>#!/bin/bash# 1. 进入工作区目录cd /var/lib/jenkins/workspace/qa1-honor-hybrisecho &quot;build for honor hybris qa1&quot;# 删除workspace 历史内容echo &quot;create honor source code tar ball&quot;rm -rf honorrm -rf honor.tar.gz# 创建文件夹，等待打包mkdir honor# copy workspace 最新代码拷贝到 刚刚新建的honor 文件夹中cp -r /var/lib/jenkins/workspace/qa1-honor-hybris/bin honorcp -r /var/lib/jenkins/workspace/qa1-honor-hybris/config/qa honor# 将honor 文件夹压缩打包tar -zcvf honor.tar.gz honor# 将打包的honor.tar.gz 远程copy到 QA1 服务器的workspace 中echo &quot;======copy tar ball to qa1 server(10.11.12.233)=====&quot;scp honor.tar.gz app@10.11.12.233:/data/build_workspace# 进入到QA1 环境并且进入workspace, 停掉QA1 的服务echo &quot;===build hybris and start hybris on qa1 server===&quot;ssh app@10.11.12.233 &apos;cd /data/build_workspace;. ./stop.sh&apos;# 执行QA1相应路径下的脚本.ssh app@10.11.12.233 &apos;cd /data/build_workspace;. ./build_and_start.sh&apos;echo &quot;build_and_deploy done&quot;exit 0</code></pre></li><li><p><strong>./build_and_start.sh</strong> 脚本内容</p><pre><code>#!/bin/bash# 1. 删除掉honor 文件夹（确保文件夹删除，下面其实已经删除了一次）rm -rf honor# 2. 赋予可读可写可执行的权限chmod 755 honor.tar.gz# 3. 解压刚刚传输过来的压缩包，并赋予可读可写可执行的权限tar -zxvf honor.tar.gzchmod -R 755 honor# 4. 删除掉旧的Hybris代码echo &quot;remove old honor hybris source code...&quot;rm -rf /data/build_workspace/honor-hybris/hybris/bin/customrm -rf /data/build_workspace/honor-hybris/hybris/config/local.propertiesrm -rf /data/build_workspace/honor-hybris/hybris/config/localextensions.xml# 5. copy刚刚解压出来的honor文件夹的内容到工作区echo &quot;copy new honor source code...&quot;cd /data/build_workspacecp -r honor/* honor-hybris/hybriscp honor/qa/local_qa1.properties honor-hybris/hybris/config/local.propertiescp honor/qa/localextensions.xml honor-hybris/hybris/config/localextensions.xml# 6. 删除解压出来的文件夹rm -rf honor# 7. 设置环境变量echo &quot;begin to start qa1...&quot;export JAVA_HOME=&quot;/usr/local/jdk1.8.0_101&quot;export PATH=$JAVA_HOME/bin:$PATHcd /data/build_workspace/honor-hybris/hybris/bin/platform. ./setantenv.shant clean all# 8. 直接以debug模式启动（方便远程调试，但是Jenkins build进度条始终是红色，不影响使用，还没找到这个解决办法）. ./hybrisserver.sh debugexit 0</code></pre></li></ol><p>以上是QA环境还不涉及到多node的情况，接下来会介绍Prod 的情况，大体流程和QA环境相似，只不过是多了处理node的情况.</p><h4 id="Prod-环境部署"><a href="#Prod-环境部署" class="headerlink" title="Prod 环境部署"></a>Prod 环境部署</h4><blockquote><p>Jenkins 在build之后会将最新的代码pull到release服务器， 然后在release服务器上执&gt; 行脚本，将代码发布到各个服务器上, 在release服务器的<strong>/data</strong> 目录下有两个目录</p><ol><li><strong>/data/install</strong>: 将环境所需的软件、Licence等存放在此，这些只是第一次发布的时候会用到</li><li><strong>/data/build</strong>: 这是真正build的所需要的目录</li></ol></blockquote><ol><li><p>点击build之后，Jenkins会按照该item配置好的Git Repository 来拉取最新代码到workspace中</p></li><li><p>执行自定义Shell 脚本(Jenkins 控制台写好的脚本, 和QA环境类似，注意目录的改变)</p><pre><code>rm -rf /data/prod_honor_hybris/hybris/bin/customcp -r $WORKSPACE/bin/custom /data/prod_honor_hybris/hybris/bincp $WORKSPACE/config/local.properties /data/prod_honor_hybris/hybris/configcp $WORKSPACE/config/localextensions.xml /data/prod_honor_hybris/hybris/configcd /data/prod_honor_hybris/hybris/bin/platformexport JAVA_HOME=/usr/local/jdk1.8export JRE_HOME=/usr/local/jdk1.8/jreexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATHexport PATH=$JAVA_HOME/bin:$PATH. ./setantenv.shant clean allcd /data/prod_honor_hybris/build./build_and_deploy.sh</code></pre></li><li><p><strong>./build_and_deploy.sh</strong> 脚本内容</p><pre><code>#!/bin/bashcd /var/lib/jenkins/workspace/prod-honor-hybrisecho &quot;build for honor hybris product&quot;echo &quot;create honor source code tar ball&quot;rm -rf honorrm -rf honor.tar.gzmkdir honorcp -r /var/lib/jenkins/workspace/prod-honor-hybris/bin honorcp -r /var/lib/jenkins/workspace/prod-honor-hybris/config/prod honortar -zcvf honor.tar.gz honor# 1. 生产上要备份原有的压缩包，以防万一进行恢复版本echo &quot;======backup original tar in release server(10.11.12.232)=====&quot;ssh app@10.11.12.232 &quot;cp /data/build/product/honor.tar.gz /data/build/product/honor.tar.gz_backup&quot;echo &quot;======copy tar ball to release server(10.11.12.232)=====&quot;scp honor.tar.gz app@10.11.12.232:/data/build/productecho &quot;build_and_deploy done&quot;exit 0</code></pre></li></ol><ol start="4"><li><p>发布内容前端服务器，进入到Prod Release 服务器相应目录执行脚本<strong>app_release.sh</strong></p><blockquote><p>主要动态循环IP地址，将文件传送到不同的服务器，执行相应服务器的脚本.</p></blockquote><pre><code>#!/bin/bashif [ $# -lt 2 ]; then  echo &quot;please provide server start index and end index&quot;  echo &quot;usage: $0 [start] [end]&quot; # exit 0fis=prd-hybris-padbaseIp=11.12.126.let ipStartNum=$1+54echo &quot;release artifact to hybris server from $s$1 to $s$2&quot;for((i=$1;i&lt;=$2;i++))do    server=$s$i.xxx.com    ipAddr=$baseIp$ipStartNum    echo &quot;============deploy on $server====================&quot;    echo &quot;copy Hybris production Deployment ZIP to $server&quot;    scp /data/build/product/honor.tar.gz app@$server:/data/workspace    echo &quot;build hybris on $server and start hybris&quot;    ssh app@$server &quot;cd /data/workspace;./stop.sh; nohup ./build_and_start.sh $ipAddr  &gt;./build.log 2&gt;&amp;1 &amp; &quot;    let ipStartNum=$ipStartNum+1        sleep 1doneecho &quot;done&quot;#exit 0</code></pre></li><li><p>Prod 服务器目录结构</p></li></ol><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jenkins_prod1.png" alt="目录结构"></p><ol start="6"><li><p>进入到Prod 服务器之一 查看<strong>./stop.sh</strong> 脚本内容</p><pre><code>#!/bin/bashcd /data/workspace/hybris/hybris/bin/platform. ./setantenv.sh &amp;&amp; ./hybrisserver.sh stop</code></pre></li><li><p>查看<strong>./build_and_start.sh</strong>内容（内容有些复杂）</p><pre><code>#!/bin/bashrm -rf honorchmod 755 honor.tar.gztar -zxvf honor.tar.gzchmod -R 755 honorecho &quot;remove old honor hybris source code...&quot;rm -rf /data/workspace/hybris/hybris/bin/customrm -rf /data/workspace/hybris/hybris/config/local.propertiesrm -rf /data/workspace/hybris/hybris/config/localextensions.xmlecho &quot;copy new honor source code...&quot;cp -r honor/* hybris/hybriscp honor/prod/local.properties hybris/hybris/config/local.propertiescp honor/prod/localextensions.xml hybris/hybris/config/localextensions.xmlcp template.tomcat.context.tpl hybris/hybris/config/tomcat/tomcat_context.tplsed -c -i &apos;s/.*name=&quot;backoffice&quot;.*/&lt;!-- &lt;extension name=&quot;backoffice&quot; \/&gt; --&gt;/g&apos; hybris/hybris/config/localextensions.xmlsed -c -i &apos;s/.*requires-channel=&quot;https&quot;.*/&lt;intercept-url pattern=&quot;\/\*\*&quot; requires-channel=&quot;https&quot;\/&gt;/g&apos; hybris/hybris/bin/custom/honor/honorcommercewebservices/web/webroot/WEB-INF/config/v2/security-v2-spring.xml  sed -c -i &apos;s/.*name=&quot;mcc&quot;.*/&lt;!-- &lt;extension name=&quot;mcc&quot; \/&gt; --&gt;/g&apos; hybris/hybris/config/localextensions.xml#echo cluster.id=$1 &gt;&gt; hybris/hybris/config/local.propertiesecho -e &quot;\ncluster.broadcast.method.jgroups.tcp.bind_addr=$1&quot; &gt;&gt; hybris/hybris/config/local.propertiesecho -e &quot;\ntask.processing.enabled=fase&quot; &gt;&gt; hybris/hybris/config/local.propertiesecho -e &quot;\nhac.webroot=/hac&quot; &gt;&gt; hybris/hybris/config/local.propertiesrm -rf honorecho &quot;begin to start server...&quot;export JAVA_HOME=&quot;/usr/local/jdk1.8.0_101&quot;export PATH=$JAVA_HOME/bin:$PATHcd /data/workspace/hybris/hybris/bin/platform. ./setantenv.shant clean all. ./hybrisserver.sh startexit 0</code></pre></li></ol><ol start="8"><li><p><strong>template.tomcat.context.tpl</strong> 文件内容</p><pre><code>#if (  $contextPath != &apos;/hmc&apos; &amp;&amp;  $contextPath != &apos;/hac&apos; &amp;&amp;  $contextPath != &apos;/backoffice&apos; &amp;&amp;  $contextPath != &apos;/advancedexport&apos; &amp;&amp;  $contextPath != &apos;/admincockpit&apos; &amp;&amp;  $contextPath != &apos;/mcc&apos; &amp;&amp;  $contextPath != &apos;/reportcockpit&apos; &amp;&amp;     $contextPath != &apos;/importcockpit&apos; &amp;&amp;    $contextPath != &apos;/cscockpit&apos; &amp;&amp;    $contextPath != &apos;/cmscockpit&apos; &amp;&amp;  $contextPath != &apos;/cmscockpitRegular&apos; &amp;&amp;  $contextPath != &apos;/productcockpit&apos; &amp;&amp;    $contextPath != &apos;/chinacheckoutaddon&apos; &amp;&amp;  $contextPath != &apos;/instore&apos; &amp;&amp;  $contextPath != &apos;/virtualjdbc&apos; &amp;&amp;  $contextPath != &apos;/erpintegration&apos; &amp;&amp;  $contextPath != &apos;/acceleratorservices&apos; &amp;&amp;  $contextPath != &apos;/commercesearchsampledata&apos; &amp;&amp;  $contextPath != &apos;/solrfacetsearch&apos;)#if($contextDescription &amp;&amp; $contextDescription != &apos;&apos;)            &lt;!-- $contextDescription --&gt;#end            &lt;Context path=&quot;$contextPath&quot; docBase=&quot;$contextDocBase&quot; $!contextAdditionalAttributes&gt;                &lt;Manager pathname=&quot;&quot; /&gt;#if($contextLoader &amp;&amp; $contextLoader != &apos;&apos;)                $contextLoader#end#if($contextAdditionalElements &amp;&amp; $contextAdditionalElements != &apos;&apos;)                $contextAdditionalElements#end            &lt;/Context&gt;#end</code></pre></li></ol><ol start="9"><li><p>发布内容后端服务器，进入到Prod Release 服务器相应目录执行脚本<strong>backend_release.sh</strong></p><pre><code>#!/bin/bashif [ $# -lt 2 ]; then  echo &quot;please provide server start index and end index&quot;  echo &quot;usage: $0 [start] [end]&quot; # exit 0fis=prd-hybrisbaseIp=10.0.126.let ipStartNum=$1+52echo &quot;release artifact to hybris server from $s$1 to $s$2&quot;for((i=$1;i&lt;=$2;i++))do    server=$s$i.xxxx.com    ipAddr=$baseIp$ipStartNum    echo &quot;============deploy on $server====================&quot;    echo &quot;copy Hybris production Deployment ZIP to $server&quot;    scp /data/build/product/honor.tar.gz app@$server:/data/workspace    echo &quot;build hybris on $server and start hybris&quot;    ssh app@$server &quot;cd /data/workspace;./stop.sh; nohup ./build_and_start.sh  $ipAddr &gt;./build.log 2&gt;&amp;1 &amp; &quot;    let ipStartNum=$ipStartNum+1        sleep 1doneecho &quot;done&quot;#exit 0</code></pre></li></ol><ol start="10"><li><p><strong>security-v2-spring.xml</strong> 文件内容</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!-- [y] hybris Platform Copyright (c) 2000-2016 SAP SE or an SAP affiliate company. All rights reserved. This software is the confidential and proprietary information of SAP (&quot;Confidential Information&quot;). You shall not disclose such Confidential Information and shall use it only in accordance with the terms of the license agreement you entered into with SAP.--&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;       xmlns:security=&quot;http://www.springframework.org/schema/security&quot;       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/security        http://www.springframework.org/schema/security/spring-security.xsd&quot;&gt;    &lt;http pattern=&quot;/v2/**&quot; entry-point-ref=&quot;oauthAuthenticationEntryPointV2&quot;          access-decision-manager-ref=&quot;webSecurityAccessDecisionManager&quot;          xmlns=&quot;http://www.springframework.org/schema/security&quot; create-session=&quot;stateless&quot;&gt;        &lt;anonymous username=&quot;anonymous&quot; granted-authority=&quot;ROLE_ANONYMOUS&quot;/&gt;        &lt;!--&lt;session-management session-authentication-strategy-ref=&quot;fixation&quot;/&gt;--&gt;&lt;intercept-url pattern=&quot;/**&quot; requires-channel=&quot;https&quot;/&gt;        &lt;port-mappings&gt;            &lt;port-mapping http=&quot;#{configurationService.configuration.getProperty(&apos;tomcat.http.port&apos;)}&quot;                          https=&quot;#{configurationService.configuration.getProperty(&apos;tomcat.ssl.port&apos;)}&quot;/&gt;            &lt;port-mapping http=&quot;#{configurationService.configuration.getProperty(&apos;embeddedserver.http.port&apos;)}&quot;                          https=&quot;#{configurationService.configuration.getProperty(&apos;embeddedserver.ssl.port&apos;)}&quot; /&gt;        &lt;/port-mappings&gt;        &lt;custom-filter ref=&quot;resourceServerFilter&quot; before=&quot;PRE_AUTH_FILTER&quot;/&gt;        &lt;access-denied-handler ref=&quot;oauthAccessDeniedHandlerV2&quot;/&gt;        &lt;headers &gt;            &lt;content-type-options /&gt;            &lt;hsts include-subdomains=&quot;true&quot; max-age-seconds=&quot;16070400&quot; /&gt;            &lt;xss-protection /&gt;            &lt;security:frame-options disabled=&quot;true&quot;/&gt;        &lt;/headers&gt;        &lt;security:csrf disabled=&quot;true&quot;/&gt;    &lt;/http&gt;    &lt;bean id=&quot;oauthAuthenticationEntryPointV2&quot; parent=&quot;oauthAuthenticationEntryPoint&quot;&gt;        &lt;property name=&quot;exceptionRenderer&quot; ref=&quot;oAuth2ExceptionRendererV2&quot;/&gt;    &lt;/bean&gt;    &lt;bean id=&quot;oauthAccessDeniedHandlerV2&quot; parent=&quot;oauthAccessDeniedHandler&quot;&gt;        &lt;property name=&quot;exceptionRenderer&quot; ref=&quot;oAuth2ExceptionRendererV2&quot;/&gt;    &lt;/bean&gt;    &lt;bean id=&quot;oAuth2ExceptionRendererV2&quot; parent=&quot;oAuth2ExceptionRenderer&quot;&gt;        &lt;property name=&quot;messageConverters&quot; ref=&quot;messageConvertersV2&quot;/&gt;    &lt;/bean&gt;&lt;/beans&gt;</code></pre></li></ol><p>大家看到了好处，也看到了Jenkins 不同服务器的部署基本类似，就是苦力活了， 接下来会将docker的部署陆续添加进来.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring AOP</title>
      <link href="//p/spring-aop.html"/>
      <url>//p/spring-aop.html</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Spring AOP 的道理懂得，但是很少在项目中使用，刚巧这个项目中有用到，将AOP的理解以及使用中遇到的问题加以总结记录</p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>设想一下，项目已接近尾声，经理说为了项目验收，更好的监控程序调用日志，需要在每个方法调用前或调用后加上日志，天啊，这是多大的工作量，项目中至少有几百个方法，我们要做这种无脑的工作了吗？ 如果不懂得Spring AOP面向切面编程的道理，那这个体力活看来是费力不讨好的事情，接下来让我们慢慢剖析Spring AOP 的道理.</p><h3 id="Java-动态代理"><a href="#Java-动态代理" class="headerlink" title="Java 动态代理"></a>Java 动态代理</h3><p>Java23中设计模式之一代理模式，Spring AOP充分利用了Java 动态代理功能来实现（对动态代理有所理解的可以跳过该段内容），即便没有Spring AOP 我们也能够通过Java  动态代理解决上述问题.  在Java 动态代理中有两个重要的接口或类：</p><blockquote><ol><li><strong>InvocationHandler</strong> （Interface）</li><li><strong>Proxy</strong> （Class）</li></ol></blockquote><a id="more"></a><p>这一个接口和类是实现我们动态代理所必须用到的，其实这种设计模式可以联想到我们现实生活中的代购或代理商:<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/Spring_springaop.png" alt="enter image description here"></p><p>这是什么，怎么好像和我们说的项目中需要不沾边际，项目快要结束了，满项目鞋子和衣服方法已经写好，突然项目经理说要给鞋子和衣服加上包装（日志），刚好代理商可以轻松做到这个，每次客户调用鞋子和衣服方法时，只需要调用代理商暴露出来的鞋子和方法即可, 还没懂？ 没关系，程序猿看代码还是最实际的.</p><h4 id="InvocationHandler"><a href="#InvocationHandler" class="headerlink" title="InvocationHandler"></a>InvocationHandler</h4><p>看一下官方定义：</p><blockquote><p><em>InvocationHandler is the interface implemented by the invocation handler of a proxy instance. Each proxy instance has an associated invocation handler. When a method is invoked on a proxy instance, the method invocation is encoded and dispatched to the invoke method of its invocation handler.</em> —— InvocationHandler 是一个接口，它被一个代理类实例的handler所实现，每一个代理类实例都有其对应的handler, 当一个代理实例的方法被调用，方法的调用就交给了它对应的handler来处理</p></blockquote><p>InvocationHandler 接口只定义了一个方法：</p><pre><code>Object invoke(Object proxy, Method method, Object[] args) throws Throwable;</code></pre><ol><li>proxy : 代理类对象</li><li>method : 我们调用真实对象的某个方法</li><li>args : 我们调用真是对象的某个方法接受的参数</li></ol><h4 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h4><p>看一下官方定义：</p><blockquote><p>Proxy provides static methods for creating dynamic proxy classes and instances, and it is also the superclass of all dynamic proxy classes created by those methods.  —— Proxy提供一个静态方法用来创建动态代理类实例，并且是所有代理类的父类</p></blockquote><p>Proxy 类中最常用的方法是：</p><pre><code>/***Returns an instance of a proxy class for the specified interfaces that dispatches method invocations to the specified invocation handler*/public static Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h) {    try {        Class e = getProxyClass(loader, interfaces);        return e.getConstructor(new Class[]{InvocationHandler.class}).newInstance(new Object[]{h});    } catch (RuntimeException var4) {        throw var4;    } catch (Exception var5) {        throw new CodeGenerationException(var5);    }}</code></pre><ol><li>loader :  一个ClassLoader对象，定义了由哪个ClassLoader对象来对生成的代理对象进行加载</li><li>interfaces : 一个Interface对象的数组，表示的是我将要给我需要代理的对象提供一组什么接口，如果我提供了一组接口给它，那么这个代理对象就宣称实现了该接口(多态)，这样我就能调用这组接口中的方法了</li><li>h : 一个InvocationHandler对象，表示的是当我这个动态代理对象在调用方法的时候，会关联到哪一个InvocationHandler对象上</li></ol><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><h4 id="定义Subject-接口："><a href="#定义Subject-接口：" class="headerlink" title="定义Subject 接口："></a>定义Subject 接口：</h4><pre><code>public interface Subject{    public void shoes();    public void clothes(String str);}</code></pre><h4 id="定义接口真实实现类"><a href="#定义接口真实实现类" class="headerlink" title="定义接口真实实现类"></a>定义接口真实实现类</h4><pre><code>public class RealSubject implements Subject{    @Override    public void shoes()    {        System.out.println(&quot;This is shoes method without packaging&quot;);    }    @Override    public void clothes(String str)    {        System.out.println(&quot;hello: &quot; + str);    }}</code></pre><h4 id="定义动态代理类，并实现InvocationHandler-接口"><a href="#定义动态代理类，并实现InvocationHandler-接口" class="headerlink" title="定义动态代理类，并实现InvocationHandler 接口"></a>定义动态代理类，并实现InvocationHandler 接口</h4><pre><code>public class DynamicProxy implements InvocationHandler{    //这个就是我们要代理的真实对象    private Object subject;    //构造方法，给我们要代理的真实对象赋初值    public DynamicProxy(Object subject)    {        this.subject = subject;    }    @Override    public Object invoke(Object object, Method method, Object[] args)            throws Throwable    {        //在代理真实对象前我们可以添加一些自己的操作，比如给鞋子和衣服做包装        System.out.println(&quot;before packaging&quot;);        System.out.println(&quot;Method:&quot; + method);        //当代理对象调用真实对象的方法时，其会自动的跳转到代理对象关联的handler对象的invoke方法来进行调用        method.invoke(subject, args);        //在代理真实对象后我们也可以添加一些自己的操作，加完包装之后的一些售后服务        System.out.println(&quot;after packaging&quot;);        return null;    }}</code></pre><h4 id="看看客户端类的定义"><a href="#看看客户端类的定义" class="headerlink" title="看看客户端类的定义"></a>看看客户端类的定义</h4><pre><code>public class Client{    public static void main(String[] args)    {        //我们要代理的真实对象        Subject realSubject = new RealSubject();        //我们要代理哪个真实对象，就将该对象传进去，最后是通过该真实对象来调用其方法的        InvocationHandler handler = new DynamicProxy(realSubject);        /*         * 通过Proxy的newProxyInstance方法来创建我们的代理对象，我们来看看其三个参数         * 第一个参数 handler.getClass().getClassLoader() ，我们这里使用handler这个类的ClassLoader对象来加载我们的代理对象         * 第二个参数realSubject.getClass().getInterfaces()，我们这里为代理对象提供的接口是真实对象所实行的接口，表示我要代理的是该真实对象，这样我就能调用这组接口中的方法了         * 第三个参数handler， 我们这里将这个代理对象关联到了上方的 InvocationHandler 这个对象上         */        Subject subject = (Subject)Proxy.newProxyInstance(handler.getClass().getClassLoader(), realSubject                .getClass().getInterfaces(), handler);        System.out.println(subject.getClass().getName());        subject.shoes();        subject.clothes(&quot;clothes, it&apos;s without packaging&quot;);    }}</code></pre><h4 id="控制台的输出结果"><a href="#控制台的输出结果" class="headerlink" title="控制台的输出结果"></a>控制台的输出结果</h4><pre><code>$Proxy0before packagingMethod:public abstract void com.xiaoluo.dynamicproxy.Subject.shoes()This is shoes method without packagingafter packagingbefore packagingMethod:public abstract void com.xiaoluo.dynamicproxy.Subject.clothes(java.lang.String)hello: clothes, it&apos;s without packagingafter packaging</code></pre><p>Proxy.newProxyInstance 生成代理对象时所需要的invocationHandler 参数更像是代理商和供应商之间的物流，当代理商需要供应商的鞋子时候，需要告诉这个物流去取鞋子.  一个代理商当然也代理多个品牌，这就是为什么参数中interfaces 是数组形式，至此关于Java 动态代理就告一段落了，我们来看看Spring AOP , 道理都是相通的.</p><h3 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><h4 id="术语解释"><a href="#术语解释" class="headerlink" title="术语解释"></a>术语解释</h4><table><thead><tr><th align="left">术语名称</th><th align="left">对应解释</th><th align="left">官方术语描述</th></tr></thead><tbody><tr><td align="left">Aspect</td><td align="left">它是一个包含一系列API的模块，同时提供横切的需求，比如日志记录.</td><td align="left">A module which has a set of APIs providing cross-cutting requirements. For example, a logging module would be called AOP aspect for logging. An application can have any number of aspects depending on the requirement.</td></tr><tr><td align="left">Join point</td><td align="left">应用程序真正会发生通知行为的一个点</td><td align="left">This represents a point in your application where you can plug-in AOP aspect. You can also say, it is the actual place in the application where an action will be taken using Spring AOP framework.</td></tr><tr><td align="left">Advice</td><td align="left">可以理解为通知，在目标程序执行前通知还是执行后通知</td><td align="left">This is the actual action to be taken either before or after the method execution. This is actual piece of code that is invoked during program execution by Spring AOP framework.</td></tr><tr><td align="left">Pointcut</td><td align="left">Join Point的集合，程序中所有想切入的点的集合</td><td align="left">This is a set of one or more joinpoints where an advice should be executed. You can specify pointcuts using expressions or patterns as we will see in our AOP examples.</td></tr></tbody></table><h4 id="Advice-通知"><a href="#Advice-通知" class="headerlink" title="Advice 通知"></a>Advice 通知</h4><table><thead><tr><th align="left">术语名称</th><th align="left">对应解释</th><th align="left">官方术语描述</th></tr></thead><tbody><tr><td align="left">before</td><td align="left">在调用目标方法之前通知</td><td align="left">Run advice before the a method execution</td></tr><tr><td align="left">after</td><td align="left">在调用目标方法之后通知，不管目标方法是否执行成功</td><td align="left">Run advice after the a method execution regardless of its outcome.</td></tr><tr><td align="left">after-returning</td><td align="left">当目标方法成功执行没有任何异常之后</td><td align="left">Run advice after the a method execution only if method completes successfully</td></tr><tr><td align="left">after-throwing</td><td align="left">after 或 after-returning 运行之后捕获异常</td><td align="left">Run advice after the a method execution only if method exits by throwing an exception.</td></tr><tr><td align="left">around</td><td align="left">运行目标方法前后环绕</td><td align="left">Run advice before and after the advised method is invoked</td></tr></tbody></table><pre><code>try{   //前置通知        //环绕通知           //调用目标对象方法        //环绕通知   //后置通知 }catch(){   //异常通知 }finally{   //终止通知 }</code></pre><h4 id="Spring-XML配置"><a href="#Spring-XML配置" class="headerlink" title="Spring XML配置"></a>Spring XML配置</h4><pre><code>&lt;context:annotation-config/&gt;    &lt;aop:config proxy-target-class=&quot;true&quot; expose-proxy=&quot;true&quot;&gt;        &lt;aop:aspect ref=&quot;capitalModification&quot;&gt;            &lt;aop:pointcut id=&quot;handleOrder&quot; expression=&quot;execution(* com.honor.facades.app.order.HonorOrderFacade.handleCapital(..))                || execution(* com.honor.facades.serviceOrder.HonorServiceOrderFacade.handleCapital(..))                || execution(* com.honor.facades.aftersales.HonorReturnFormFacades.handleCapital(..))&quot;/&gt;            &lt;aop:after method=&quot;capitalAndRecordModification&quot;  pointcut-ref=&quot;handleOrder&quot;/&gt;            &lt;aop:after-throwing throwing=&quot;ex&quot; method=&quot;capitalAndRecordModificationExceptionHandle&quot;  pointcut-ref=&quot;handleOrder&quot;/&gt;        &lt;/aop:aspect&gt;    &lt;/aop:config&gt;&lt;bean id=&quot;capitalModification&quot; class=&quot;com.honor.core.customerCapital.impl.DefaultCapitalModificationStrategy&quot;&gt;        &lt;property name=&quot;customerCapitalService&quot; ref=&quot;customerCapitalService&quot;/&gt;        &lt;property name=&quot;honorSuperOrderService&quot; ref=&quot;honorSuperOrderService&quot;/&gt;        &lt;property name=&quot;honorBillService&quot; ref=&quot;honorBillService&quot;/&gt;    &lt;/bean&gt;</code></pre><p>多个pointcut 可以用 || 或 or 来实现.</p><h3 id="项目使用中遇到的问题"><a href="#项目使用中遇到的问题" class="headerlink" title="项目使用中遇到的问题"></a>项目使用中遇到的问题</h3><p>关于AOP无法切入同类调用方法的问题<br>Controller 层方法A调用了Facade层方法B，可是B内调用了方法C, 我们想使用AOP织入方法C, 当程序运行后， 始终找不到代理方法，意味着织入C没有成功,</p><pre><code>public class MyController{    public void methodA(){        myFacade.methodB();    }}public class MyController{    public void methodB(){        myFacade.methodC();    }    public void methodC(){        System.out.println(&quot;bingo&quot;);    }}public class Aspect {       @AfterReturning(execution(* Facade.methodB(..)))       public void after() {           Logger.info(after call and do something);      }  }  </code></pre><p>我们发现在 AopContext.class 中：</p><pre><code>public static Object currentProxy() throws IllegalStateException {        Object proxy = currentProxy.get();        if(proxy == null) {            throw new IllegalStateException(&quot;Cannot find current proxy: Set \&apos;exposeProxy\&apos; property on Advised to \&apos;true\&apos; to make it available.&quot;);        } else {            return proxy;        }    }</code></pre><p>解决办法：</p><ol><li><p>设置proxy-target-class=”true”expose-proxy=”true”</p><pre><code>&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;expose-proxy=&quot;true&quot;/&gt;  </code></pre></li><li><p>手动指定代理调用方法</p><pre><code>((Facade) AopContext.currentProxy()).methodB();  </code></pre></li></ol><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>非常感谢以下几位博主，在你们认真的博客上学到了许多.</p><ol><li><a href="http://blog.csdn.net/lirui0822/article/details/8555691" target="_blank" rel="noopener">http://blog.csdn.net/lirui0822/article/details/8555691</a></li><li><a href="http://www.cnblogs.com/xiaoluo501395377/p/3383130.html" target="_blank" rel="noopener">http://www.cnblogs.com/xiaoluo501395377/p/3383130.html</a></li></ol><p>同时修改AOP函数返回值及获取函数参数请参考以下文章：</p><ol><li><a href="http://blog.csdn.net/cleverutd/article/details/8607491" target="_blank" rel="noopener">http://blog.csdn.net/cleverutd/article/details/8607491</a></li><li><a href="https://my.oschina.net/itblog/blog/211693" target="_blank" rel="noopener">https://my.oschina.net/itblog/blog/211693</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> AOP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins学习之邮箱配置</title>
      <link href="//p/jenkins-config-mail.html"/>
      <url>//p/jenkins-config-mail.html</url>
      
        <content type="html"><![CDATA[<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>开发人员build project 之后，build结果无论是成功还是失败，都要及时的通知组内其他成员了解最新情况，邮件通知这时候就派上用场，恰巧 Jenkins 提供了这么一个功能，不过该功能还是过于单一，如不能编写email template 来格式化邮件内容，但<strong>Extended E-mail Notification</strong>（Jenkins 邮件插件）实现了更高级的功能，接下来逐步看一下 Jenkins 邮件功能的配置</p><h3 id="配置邮件服务器"><a href="#配置邮件服务器" class="headerlink" title="配置邮件服务器"></a>配置邮件服务器</h3><p>以管理员身份登录，在 Jenkins 首页click <strong>Manage Jenkins</strong>, 然后 click <strong>Configure System</strong>, 下拉到页面的最底部 <strong>E-mail Notification</strong> 处：</p><a id="more"></a><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jenkins_mail1.png" alt="E-mail Notification"></p><p>此处我用了网易<strong>yeah.net</strong>的邮箱，User Name(邮箱账号)，Password(邮箱密码)，在Test e-mail recipient(接收邮件)，不过配置了这些仅仅是配置邮件服务器地址、账号和密码，但是jenkins不知道采用哪个邮箱去发送，所以我们需要在该处配置发送的邮箱，并且要和管理员的邮箱一致</p><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jenkins_mail2.png" alt="admin"></p><p>到此点击一下<strong>Test configuration</strong> button 看一下测试结果，如果测试不成功要检查一下管理员邮箱是否有开通 SMTP服务，登录你设置的邮箱开通SMTP</p><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/mail3.png" alt="smtp"></p><p>设置完之后测试结果为<strong>成功</strong></p><p>当我们在project 中配置build之后的行为时，可以添加邮件通知，这样在接收人列表中的人都可以接受到build的结果：</p><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jenkins_mail4.png" alt="build"></p><p>build 一下项目，看一下有没有收到邮件通知吧.</p><h3 id="安装Email插件"><a href="#安装Email插件" class="headerlink" title="安装Email插件"></a>安装Email插件</h3><p>Jenkins 首页 —— Manage Jenkins —— Manage Plugins，安装该插件<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jenkins_mail5.png" alt="plugin"></p><p>重新启动Jenkins, 可以在刚刚配置邮件的上方看到已安装好的email 插件<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/jenkins_mail6.png" alt="mail plugin"></p><p>这样编辑<strong>Default Content</strong> 字段来编写email template, 支持 HTML 标签.  这样在项目构建后行为中选择<strong>Editable Email Notificatioin</strong> 来发布build的结果</p><p><strong>NOTE:</strong> 大家看不懂的字段多多点开字段右侧的问号，里面的说明还是非常清晰的. 邮件插件的其他小功能也请自行研究.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>巧用PostMan</title>
      <link href="//p/postman-advanced-usage.html"/>
      <url>//p/postman-advanced-usage.html</url>
      
        <content type="html"><![CDATA[<p>现在越发的认识到巧用工具提高工作效率的重要性，接下来看一下PostMan带来的便利</p><h3 id="业务情景"><a href="#业务情景" class="headerlink" title="业务情景"></a>业务情景</h3><p>在实际工作中，当App或其他渠道来调用Java后台接口的时候，我们通常会用到PostMan这个工具来模拟调用，当需要token来作为验证的时候，当每次请求的token发生变化的时候我们同时要改变其他请求URL中的token内容，这样很麻烦，降低工作效率，PostMan的环境变量解决了这个问题</p><a id="more"></a><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/postman_manage_env.png" alt="添加环境变量"><br>and<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/postman_add_get.png" alt="增加"><br>and<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/postman_add_post.png" alt="添加变量"><br>and<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/postman_token_url.png" alt="token_url"><br>and<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/postman_token_script.png" alt="script"><br>and<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/postman_get_token.png" alt="get token"><br>and<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/postman_use_token.png" alt="user token"></p><p>至此设置环境变量结束，其他功能会陆续补充.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PostMan </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git Ignoring Files</title>
      <link href="//p/git-ignore.html"/>
      <url>//p/git-ignore.html</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>以下内容根据<a href="https://help.github.com/articles/ignoring-files/" target="_blank" rel="noopener">Git Help</a>以及<a href="https://git-scm.com/docs/gitignore" target="_blank" rel="noopener">Git Docs</a> 整理翻译</p><h3 id="Ignoring-files-忽略文件"><a href="#Ignoring-files-忽略文件" class="headerlink" title="Ignoring files(忽略文件)"></a>Ignoring files(忽略文件)</h3><p>有时候会有一些我们不想Git 提交一些文件到GitHub/GitLab，下面有几种方式让我们告诉Git来忽略哪些文件.</p><a id="more"></a><h4 id="Create-a-local-gitignore（创建局部-本地的-gitignore文件）"><a href="#Create-a-local-gitignore（创建局部-本地的-gitignore文件）" class="headerlink" title="Create a local .gitignore（创建局部/本地的.gitignore文件）"></a>Create a local .gitignore（创建局部/本地的.gitignore文件）</h4><blockquote><p>如果在local repository（仓库）中创建一个名为<strong>.gitignore</strong>的文件，在你commit（提交）动作之前，Git 将会读取<strong>*.gitignore</strong>文件去判断哪些文件或者目录需要忽略掉. 同时这个文件应该push到remote repository, 这样clone该repository的用户都会共享ignore的规则. 当然GitHub上维护了一个官方的、针对许多流行的操作系统、环境、语言的<strong>.gitignore</strong> <a href="https://github.com/github/gitignore" target="_blank" rel="noopener">文件样例</a></p></blockquote><p>在终端，定位到Git repository所在位置，输入以下命令来创建<strong>.gitignore</strong>文件（当然在windows环境可以直接在仓库位置鼠标右键创建名为.gitignore的文件即可）</p><pre><code>touch .gitignore</code></pre><p><strong>注意</strong>：如果某个文件已经被提交，此时你想让git 忽略它，这是你把这个文件添加到<strong>.gitignore</strong>文件中，git也不会忽略它，此时我们必须先untrack这个文件，这样Git才会忽略这个文件</p><pre><code>git rm --cached FILENAME</code></pre><h4 id="Create-a-global-gitignore（创建全局-gitignore文件）"><a href="#Create-a-global-gitignore（创建全局-gitignore文件）" class="headerlink" title="Create a global .gitignore（创建全局.gitignore文件）"></a>Create a global .gitignore（创建全局.gitignore文件）</h4><blockquote><p>通常我们会有多个repository，如果多个仓库需要的规则类似，我们还需要为每一个repository都新建一个<strong>.gitignore</strong> 文件吗？显然我们此刻需要一个全局的方式来管控所有的repository. 有两种方式来创建该全局文件：</p></blockquote><ol><li><p>当安装了Git之后，在git 主目录(Windows环境C:\Users\Fraser)下会有一个<strong>.gitconfig</strong>文件，里面指定了如下内容：</p><pre><code>[user][core]    excludesfile = D:\\Users\\fraser\\Documents\\gitignore_global.txt[user][user]    name = XXXXX    email = XXXXX@qq.com</code></pre><p>也就是说我们把规则定义在<strong>gitignore_global.txt</strong>文件中就好. 或者指定其他文件， 这个文件是windows自动生成的</p></li><li><p>通过命令指定<strong>.gitignore_global</strong>的文件</p><pre><code>git config --global core.excludesfile ~/.gitignore_global</code></pre><p>通常.gitignore_global文件也是放在主目录下.</p></li></ol><h4 id="Explicit-repository-excludes-明确仓库忽略的文件"><a href="#Explicit-repository-excludes-明确仓库忽略的文件" class="headerlink" title="Explicit repository excludes(明确仓库忽略的文件)"></a>Explicit repository excludes(明确仓库忽略的文件)</h4><blockquote><p>如果你不想创建一个<strong>.gitignore</strong>文件并且share给其他人，你可以创建一个不需要提交到repository的规则，比如我使用IntelliJ IDEA编辑器，编辑器会生成一些相应文件，但是同事使用Eclipse，也就是说IntelliJ IDEA编辑器生成的文件规则并不适用Eclipse，所以我们需要用另外方法来处理这种情况.</p></blockquote><p>用编辑器打开<strong>.git/info/exclude</strong>，将规则加载这里即可,这个git是不会提交的.</p><h3 id="Ignore-规则说明"><a href="#Ignore-规则说明" class="headerlink" title="Ignore 规则说明"></a>Ignore 规则说明</h3><p>gitignore - Specifies intentionally untracked files to ignore</p><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>上面我们说到了我们可以采用多种方式来让git ignore文件，同时配置了这些文件，优先级是什么呢？</p><ol><li><strong>Level1</strong><br>命令行执行的命令(很少用)</li><li><strong>Level2</strong><br>仓库中的<strong>.gitignore</strong> 文件</li><li><strong>Level3</strong><br>$GIT_DIR/info/exclude</li><li><strong>Level4</strong><br>全局的配置：core.excludesFile</li></ol><h4 id="PATTERN-FORMAT规则说明"><a href="#PATTERN-FORMAT规则说明" class="headerlink" title="PATTERN FORMAT规则说明"></a>PATTERN FORMAT规则说明</h4><ol><li>空行，没有任何实际ignore意义，只是作为可读性的分隔符</li><li>“#”号开头代表该行是注释，如果在前面加上“\”，则转义成以“#”开头</li><li>“!” 是重新让git check in 某文件的意思，但是该文件的父目录被exclude，re-include 该文件Git是做不到的. 同样可以加上”&quot;来转义，<strong>!important!.txt</strong>和<strong>!important!.txt</strong></li><li>以“/”结束，如<strong>foo/</strong> 会匹配foo以及foo下面的子文件夹，但是不会匹配foo/下面的任何文件.</li><li>* 是通配符，如*.c，会匹配所有.c为后缀的文件</li><li>** 的含义非常多：</li></ol><ul><li>A leading “**” followed by a slash means match in all directories. For example, “<strong>/foo” matches file or directory “foo” anywhere, the same as pattern “foo”. “</strong>/foo/bar” matches file or directory “bar” anywhere that is directly under directory “foo”.</li><li>A trailing “/**” matches everything inside. For example, “abc/**” matches all files inside directory “abc”, relative to the location of the .gitignore file, with infinite depth.</li><li>A slash followed by two consecutive asterisks then a slash matches zero or more directories. For example, “a/**/b” matches “a/b”, “a/x/b”, “a/x/y/b” and so on.</li></ul>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows下删除过长文件路径或过长文件名的文件</title>
      <link href="//p/delete-long-name-file-in-windows.html"/>
      <url>//p/delete-long-name-file-in-windows.html</url>
      
        <content type="html"><![CDATA[<p>在Windows下，删除文件时报错”文件路径太长或者文件名太长”，无论是Shift+Del、进入子目录一点点删除都不可以以及使用Windows内置命令都不可以，但是我电脑中装有node，于是安装<strong>【rimraf】</strong>——是专门用于删除模块的插件</p><blockquote><p>官方描述：A deep deletion module for node (like rm -rf)</p></blockquote><pre><code>npm install -g rimraf</code></pre><p>使用方法：</p><a id="more"></a><ol><li><p>进入project目录</p><pre><code>cd project/</code></pre></li><li><p>删除hybris目录及目录下所有文件</p><pre><code>rimraf hybris</code></pre></li></ol><p>可以看到，hybris目录及其所有子目录及文件全部删除干净，非常爽。</p><p>感谢<a href="http://blog.csdn.net/crper/article/details/50458369" target="_blank" rel="noopener">原作者</a>的分享</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git配置多个账号（GitLab和GitHub）</title>
      <link href="//p/git-multiple-account.html"/>
      <url>//p/git-multiple-account.html</url>
      
        <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>现在好多公司用GitLab作为项目管理工具，自己也会有开源项目在GitHub上，按照以往的配置全局的用户貌似在这种情形下就没有作用了（公司的项目需要用公司邮箱，自己的项目需要用自己的邮箱），此时就要做Git多账户的管理与设置。</p><h3 id="Git支持的协议"><a href="#Git支持的协议" class="headerlink" title="Git支持的协议"></a>Git支持的协议</h3><p>Git主要支持四中协议： file:// , git://,  http(s)://, ssh://, 这里主要说明一下http(s)和ssh协议的区别。</p><h4 id="https-和-SSH-的区别"><a href="#https-和-SSH-的区别" class="headerlink" title="https 和 SSH 的区别"></a>https 和 SSH 的区别</h4><blockquote><ol><li>前者可以随意克隆github上的项目，而不管是谁的；而后者则是你必须是你要克隆的项目的拥有者或管理员，且需要先添加 SSH key (这里就是添加公钥，取得管理员的信任)，否则无法克隆。</li><li>https url 在push的时候是需要验证用户名和密码的，而 SSH 在push的时候，是不需要输入用户名的，如果配置SSH key的时候设置了密码，则需要输入密码的，否则直接是不需要输入密码的。</li></ol></blockquote><a id="more"></a><h3 id="Git设置多账户"><a href="#Git设置多账户" class="headerlink" title="Git设置多账户"></a>Git设置多账户</h3><h4 id="检查本机是否已有SSH-Key"><a href="#检查本机是否已有SSH-Key" class="headerlink" title="检查本机是否已有SSH Key"></a>检查本机是否已有SSH Key</h4><pre><code>$ cd ~/.ssh$ ls</code></pre><p>如果存在会有两个秘钥文件id_rsa(私钥)和id_rsa.pub(公钥)，如果没有则需要下一步的创建。</p><h4 id="创建SSH-Key"><a href="#创建SSH-Key" class="headerlink" title="创建SSH Key"></a>创建SSH Key</h4><p>输入如下命令：</p><pre><code>$ ssh-keygen -t rsa -C &quot;your_email@example.com&quot;</code></pre><p>参数解析：</p><blockquote><ul><li>-t 指定密钥类型，默认是 rsa ，可以省略。</li><li>-C 设置注释文字，比如邮箱。</li><li>-f 指定密钥文件存储文件名。</li></ul></blockquote><p>以上代码省略了 -f 参数，因此，运行上面那条命令后会让你输入一个文件名，用于保存刚才生成的 SSH key 代码，如：</p><pre><code>Generating public/private rsa key pair.# Enter file in which to save the key (/c/Users/you/.ssh/id_rsa): [Press enter]</code></pre><p>当然，你也可以不输入文件名，直接车，使用默认文件名（推荐），那么就会生成 id_rsa 和 id_rsa.pub 两个秘钥文件。</p><p>接着又会提示你输入两次密码（该密码是你push文件的时候要输入的密码，而不是github管理者的密码），这样别人用你的机器没有密码是不可能随便push代码的，一种安全性的体现，当然，你也可以不输入密码，直接按回车。那么push的时候就不需要输入密码，直接提交到github上了。</p><pre><code>Enter passphrase (empty for no passphrase):# Enter same passphrase again:</code></pre><p>在此案例中，就需要输入两个email来创建个相应的SSH Key:</p><pre><code>$ ssh-keygen -t rsa -C &quot;personal@example.com&quot; (个人邮箱)$ ssh-keygen -t rsa -C &quot;company@example.com&quot; (公司邮箱)</code></pre><p>此时在.ssh 目录下应该会有下面四个文件：</p><pre><code>id_rsa  id_rsa.pub  id_rsa_company  id_rsa_company.pub</code></pre><p>将公钥id_rsa.pub和id_rsa_company.pub 分别添加到GitHub和GitLab上，怎样添加请自行查询，至此，我们已经有两个用户（可以更多），怎样指定要连接GitHub还是GitLab呢？这样就需要解决多用户的权限问题。</p><h4 id="多用户权限问题"><a href="#多用户权限问题" class="headerlink" title="多用户权限问题"></a>多用户权限问题</h4><p>GitHub/GitLab使用SSH与客户端连接。如果是单用户（A），生成密钥对后，将公钥保存至 GitHub/GitLab，每次连接时SSH客户端发送本地私钥（默认~/.ssh/id_rsa）到服务端验证。单用户情况下，连接的服务器上保存的公钥和发送的私钥自然是配对的。但是如果是 多用户 （A,B），我们在连接到第二个帐号时，B保存的是自己的公钥，但是SSH客户端依然发送默认私钥，即A的私钥，那么这个验证自然无法通过, 所以需要让SSH客户端发现B的私钥。</p><ol><li><p>查看系统SSH Key</p><pre><code>$ ssh-add -l</code></pre><p>如果提示：</p><pre><code>$ Could not open a connection to your authentication agent.</code></pre><p>可以输入如下命令然后重新输入：<strong>ssh-add -l</strong></p><pre><code>$ ssh-agent bash</code></pre><blockquote><p><strong>ssh-agent bash命令解释：</strong><br>ssh-agent是专为既令人愉快又安全的处理RSA和DSA密钥而设计的特殊程序，不同于ssh，ssh-agent是个长时间持续运行的守护进程（daemon），设计它的唯一目的就是对解密的专用密钥进行<strong>高速缓存</strong>。ssh包含的内建支持允许它同ssh-agent通信，允许ssh不必每次新连接时都提示您要密码才能获取解密的专用密钥。对于ssh-agent，您只要使用ssh-add把专用密钥添加到ssh-agent的高速缓存中。这是个一次性过程；用过ssh-add之后，ssh将从ssh-agent获取您的专用密钥，而不会提示要密码短语来烦您了。<br>如果出现如下提示信息说明没有SSH Key在代理中</p></blockquote><pre><code>$ The agent has no identities.</code></pre><p>下面可以手动加入SSH Key 到代理中：</p><pre><code>$ ssh-add ~/.ssh/id_rsa_company</code></pre><p>可以使用如下命令remove SSH Key</p><pre><code>$ ssh-add -D</code></pre></li><li><p>配置config 路由文件<br>config文件即绑定私钥和远程服务器的关系，以我的config文件为例：</p><pre><code># 该文件用于配置私钥对应的服务器# 默认自己GitHub的配置Host github HostName github.com User FraserYu PreferredAuthentications publickey IdentityFile ~/.ssh/id_rsa# 公司所用GitLab的配置Host gitlab HostName gitlab.com #(可以是域名/IP地址) User Fraser PreferredAuthentications publickey IdentityFile ~/.ssh/id_rsa_company         </code></pre></li><li><p>测试<br>输入如下命令进行GitLab和GitHub的测试(注意命令中用了Host的别名)：</p><pre><code>$ ssh -T git@github$ ssh -T git@gitlab$ git clone git@github:username/project.git</code></pre></li><li><p>用户名邮箱配置<br>Git全局配置和单个仓库的用户名邮箱配置，学习git的时候, 大家刚开始使用之前都配置了一个全局的用户名和邮箱</p><pre><code>$ git config --global user.name &quot;github&apos;s Name&quot;$ git config --global user.email &quot;github@xx.com&quot;$ git config --list</code></pre><p>如果你公司的项目是放在自建的gitlab上面, 如果你不进行配置用户名和邮箱的话, 则会使用全局的, 这个时候是错误的, 正确的做法是针对公司的项目, 在项目根目录下进行单独配置</p><pre><code>$ git config user.name &quot;gitlab&apos;s Name&quot;$ git config user.email &quot;gitlab@xx.com&quot;$ git config --list</code></pre><p>git config –list查看当前配置, 在当前项目下面查看的配置是全局配置+当前项目的配置, 使用的时候会优先使用当前项目的配置</p></li><li><p>除了默认的id_rsa是被git默认读取，我们每次打开终端都需要执行 <strong>ssh-add ～/.ssh/id_rsa_company</strong>， 这样十分麻烦，以MacOs为🌰，我们可以将其添加到 KeyChain Access， 执行命令 <strong>ssh-add -K [path/to/your/ssh-key]</strong>，  如：ssh-add -K ～/.ssh/id_rsa_company 即可</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chrome保存网页为脱机文件</title>
      <link href="//p/chrome-save-offline-file.html"/>
      <url>//p/chrome-save-offline-file.html</url>
      
        <content type="html"><![CDATA[<h2 id="Chrome-浏览器保存网页为脱机文件"><a href="#Chrome-浏览器保存网页为脱机文件" class="headerlink" title="Chrome 浏览器保存网页为脱机文件"></a>Chrome 浏览器保存网页为脱机文件</h2><p>我们经常需要将一些网页保存为脱机文件，这样即便没有网络我们也可以正常的浏览，IE浏览器将网页另存为在选择文件类型的地方会有选择*.mht, 可是Chrome 却没有这个选项，接下来教大家如何通过Chrome来保存网页为mht文件</p><ol><li><p>打开浏览器输入 <strong>chrome://flags/</strong></p></li><li><p>通过关键字搜索<strong>save</strong> 或 <strong>另存为</strong>如下图：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/chrome_mht.png" alt="mht"></p></li><li><p>点击<strong>Enable</strong>或<strong>使用</strong>，重新启动浏览器</p></li><li><p>鼠标右键另存为选择类型和保存路径如下图：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/chrome_save.png" alt="save"></p></li><li><p>等待下载完成即可</p></li></ol><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Chrome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git 使用流程</title>
      <link href="//p/git-workflow.html"/>
      <url>//p/git-workflow.html</url>
      
        <content type="html"><![CDATA[<h3 id="Git分支管理策略"><a href="#Git分支管理策略" class="headerlink" title="Git分支管理策略"></a>Git分支管理策略</h3><p>首先share一下Ruan老师的博客内容：<a href="http://www.ruanyifeng.com/blog/2012/07/git.html" target="_blank" rel="noopener">Git分支管理策略</a> ，读过之后，理解Master、Develop、临时分支（feature、release、fixbug）的基本意思，这里写的就更加透彻了：<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">A successful Git branching model</a>， 项目中如果按照这种严格规范来执行版本的管理，应该是会取得成功的结果.  仔细阅读这个workflow深刻的体会：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/git_workflow.png" alt="Git Branch Model"></p><h3 id="Git-使用实战情景说明"><a href="#Git-使用实战情景说明" class="headerlink" title="Git 使用实战情景说明"></a>Git 使用实战情景说明</h3><p>为什么不罗列出来Git的命令列表，因为罗列在这貌似也很难深刻理解命令的含义，也不知道怎样去使用，所以做一些情景案例来说明git命令</p><a id="more"></a><h4 id="跟踪GitHub上开源项目"><a href="#跟踪GitHub上开源项目" class="headerlink" title="跟踪GitHub上开源项目"></a>跟踪GitHub上开源项目</h4><p>当在Github中遨游一阵，发现了喜欢的项目想在本地研究，同时还想跟踪了解源项目的最新动态，我们需要如下的一些步骤：</p><ol><li><p>Fork (分叉)<br>在跟踪的开源项目上点击Fork，会发现分叉到你的Repo中，此时我们应用如下命令将项目clone到local Repo, https或ssh两种都可以</p><pre><code>$ git clone git@github.com:YOUR-USERNAME/REPO-NAME$ git clone https://github.com/YOUR-USERNAME/REPO-NAME</code></pre><p>此时可以通过如下命令来查看remote的版本，即你自己的remote Repo的信息</p><pre><code>$ git remote -v</code></pre><p>得到如下结果：</p><pre><code>https://github.com/YOUR_USERNAME/YOUR_FORK.git (fetch)https://github.com/YOUR_USERNAME/YOUR_FORK.git (push)</code></pre></li><li><p>添加 fork 源仓库的地址<br>我们的目的不但是要在本地修改自己想要的代码，还要了解最新的源的动态，所以我们需要用如下命令：</p><pre><code>$ git remote add originProject https://github.com/ORIGINAL_OWNER/ORIGINAL_REPO.git</code></pre><p>同样应用 <strong>git remote -v</strong>命令会的到如下结果：</p><pre><code>origin https://github.com/YOUR_USERNAME/YOUR_FORK.git (fetch)origin https://github.com/YOUR_USERNAME/YOUR_FORK.git (push)originProject https://github.com/ORIGINAL_OWNER/ORIGINAL_REPO.git(fetch)originProject https://github.com/ORIGINAL_OWNER/ORIGINAL_REPO.git (push)</code></pre><p>此处的originProject 可以是你取得任意的名字, 就是给远程主机取个名字</p><pre><code>$ git remote add &lt;主机名&gt; &lt;网址&gt;</code></pre></li><li><p>Fetch源<br>当你要跟踪源动态，就要fetch一份到本地Repo</p><pre><code>$ git fetch originProject</code></pre><p>通过如下命令查看分支：</p><pre><code>$ git branch</code></pre></li><li><p>合并源到本地<br>首先切换到本地master分支</p><pre><code>$ git checkout master</code></pre><p>之后merge源到本地master</p><pre><code>$ git merge originProject/master</code></pre><p>这个地方可能会有冲突，需要解决冲突完成merge，最后将merge好的代码push到自己remote</p><pre><code>git push origin master</code></pre></li></ol><h4 id="本地上传代码到GitHub"><a href="#本地上传代码到GitHub" class="headerlink" title="本地上传代码到GitHub"></a>本地上传代码到GitHub</h4><p>通常会在本地写点程序，然后放到github来管理，此时我们怎样把本地的代码上传到github呢</p><ol><li><p>git初始化<br>新建一个文件夹，初始化</p><pre><code>$ git init</code></pre><p>你的项目code应该在这个文件夹中</p></li><li><p>添加项目文件到本地Repo<br>我们需要将本地的code添加到本地的Repo中，add . 代表添加全部文件</p><pre><code>$ git add .</code></pre></li><li><p>提交文件到本地Repo<br>添加文件之后，我们需要commit文件到本地Repo，并且标记注释</p><pre><code>$ git commit -m &quot;注释语句&quot;</code></pre></li><li><p>在github上新建Repo<br>在github上新建Repo，并且copy Repo的https或ssh URL</p><pre><code>$ git remote add origin https://github.com/YOUR_USERNAME/YOUR_FORK.git</code></pre></li><li><p>Pull远程代码<br>在push之前我们需要pull remote 代码</p><pre><code>$ git pull origin master</code></pre></li><li><p>Push本地代码到remote<br>我们已经提交代码到本地Repo，此时我们需要push到remote</p><pre><code>$ git push -u origin master</code></pre></li></ol><h4 id="更改远程URL"><a href="#更改远程URL" class="headerlink" title="更改远程URL"></a>更改远程URL</h4><p>在实际场景中我们会遇到Git服务器迁移了，这样我们.git仓库存储的remote repository的地址信息就是错误的，所以需要更改这个URL. 请参考Git Help之<a href="https://help.github.com/articles/changing-a-remote-s-url/" target="_blank" rel="noopener">Changing a remote’s URL</a></p><p>如果你觉得你合并后的状态是一团乱麻，想把当前的修改都放弃，你可以用下面的命令回到合并之前的状态：</p><pre><code>$ git reset --hard HEAD</code></pre><p>或者你已经把合并后的代码提交，但还是想把它们撒销：</p><pre><code>$ git reset --hard ORIG_HEAD</code></pre><p>但是刚才这条命令在某些情况会很危险，如果你把一个已经被另一个分支合并的分支给删了，那么 以后在合并相关的分支时会出错。</p><h3 id="Git远程操作命令详解"><a href="#Git远程操作命令详解" class="headerlink" title="Git远程操作命令详解"></a>Git远程操作命令详解</h3><p>有了基本的了解，我们还是在这里引用一下Ruan老师的博客内容，慢慢理解与体会 <a href="http://www.ruanyifeng.com/blog/2014/06/git_remote.html" target="_blank" rel="noopener">Git远程操作详解</a> 和 <a href="http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html?utm_source=tool.lu" target="_blank" rel="noopener">Git常用命令清单</a>, 同时还要把廖雪峰老师的Git教程简介：<a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" target="_blank" rel="noopener">Git远程操作详解</a>放在这里，都是最好的学习资料，后续我还会继续补充. 有疑问可以留言，加入git实用情景中.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WeChatFeedback</title>
      <link href="//p/english-common-model.html"/>
      <url>//p/english-common-model.html</url>
      
        <content type="html"><![CDATA[<p><strong>郑重声明： 未经同意，不得转载</strong></p><h2 id="微信作业反馈2016"><a href="#微信作业反馈2016" class="headerlink" title="微信作业反馈2016"></a>微信作业反馈2016</h2><h3 id="万能句型"><a href="#万能句型" class="headerlink" title="万能句型"></a>万能句型</h3><h4 id="万能句型第一发-got-to-get"><a href="#万能句型第一发-got-to-get" class="headerlink" title="万能句型第一发[got to get]"></a>万能句型第一发[got to get]</h4><p>先附上两张图片来做一个总览，接下来逐个举例说明：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/wechat_1.1.jpg" alt="第一张"><br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/wechat_1.2.jpg" alt="第二张"></p><a id="more"></a><p>万能句型前面搭配：</p><table><thead><tr><th align="left">序号</th><th align="left">搭配</th><th align="left">省略’ve或’s</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I’ve</td><td align="left">可以</td></tr><tr><td align="left">2</td><td align="left">We’ve</td><td align="left">可以</td></tr><tr><td align="left">3</td><td align="left">You’ve</td><td align="left">可以</td></tr><tr><td align="left">4</td><td align="left">They’ve</td><td align="left">可以</td></tr><tr><td align="left">5</td><td align="left">He’s</td><td align="left">不可以</td></tr><tr><td align="left">6</td><td align="left">She’s</td><td align="left">不可以</td></tr></tbody></table><p>万能句型举例：</p><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/wechat_1.3.png" alt="第三张"></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get going</td><td align="left">我得走了</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I got to get used to it</td><td align="left">我得适应某物</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I got to get used to this bed</td><td align="left">我得适应这张床</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I got to get Used to the new computer</td><td align="left">我得适应这个新电脑</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got to get used to waking up early</td><td align="left">我得适应早起</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I got to get Used to eating less</td><td align="left">我得适应少吃点</td><td align="left"></td></tr><tr><td align="left">7</td><td align="left">I got to get Used to drinking tea</td><td align="left">我得适应喝茶</td><td align="left"></td></tr></tbody></table><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/wechat_1.4.png" alt="第四张"></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get a life</td><td align="left">我得得到一个生活（想象：天天宅在家里，突然醒悟对自己说这句话）</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I got to get a nicer house</td><td align="left">我得得到/有/买一个更好的房子</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I got to get a girl friend</td><td align="left">我得有个女朋友</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I got to get an invite</td><td align="left">我得得到/收到一个邀请</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got to get an extra plate</td><td align="left">我得要一个额外的盘子</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I got to get an apartment</td><td align="left">我得有/买/得到个公寓</td><td align="left"></td></tr><tr><td align="left">7</td><td align="left">I got to get a coffee</td><td align="left">我得来杯咖啡</td><td align="left"></td></tr></tbody></table><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/wechat_1.5.png" alt="第五张"></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get serious</td><td align="left">我得变得严肃点</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I got to get stronger</td><td align="left">我得变得更强壮</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I got to get taller</td><td align="left">我得更高一点</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I got to get healthier</td><td align="left">我得更健康一些</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got to get better at sth</td><td align="left">我得更擅长某事</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I got to get better at doing sth</td><td align="left">我得更擅长做某事</td><td align="left"></td></tr><tr><td align="left">7</td><td align="left">I got to get faster at sth</td><td align="left">我得更快速于某事</td><td align="left"></td></tr><tr><td align="left">8</td><td align="left">I got to get faster at doing sth</td><td align="left">我得更快速于做某事</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get more [sth] 得得到更多</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get more than that</td><td align="left">我得得到更多，比手里拥有的更多</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I got to get more clothes</td><td align="left">我得有/得到更多衣服</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I got to get more money</td><td align="left">我得得到/拥有更多钱</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get started [doing sth] 开始做某事，多指需要一段时间过程的事情，不是一瞬间就能搞定的</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get started writing my report</td><td align="left">我得开始写我的报告</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I got to get started working on my project</td><td align="left">我得开始做我的项目</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I got to get started planning my wedding</td><td align="left">我得开始筹划婚礼</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I got to get started moving these boxes</td><td align="left">我得开始搬这些盒子了</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got to get started cooking dinner</td><td align="left">我得开始做饭了</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get [adv]副词/[prep]介词</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get up</td><td align="left">我得起床了</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">You got to get up early tomorrow</td><td align="left">你明早得早起</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I got to get started planning my wedding</td><td align="left">我得开始筹划婚礼</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I got to get started moving these boxes</td><td align="left">我得开始搬这些盒子了</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got to get started cooking dinner</td><td align="left">我得开始做饭了</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get back…某人得回去、回家</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get back</td><td align="left">我得回家 （有时候说回家不一定非要有home）</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">You got to get back to work[sth]</td><td align="left">你得回去工作了</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">She’s got to get back on that horse</td><td align="left">她得再坚持一次（俚语，之前从马上掉下来一次，再次回到马上）</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">He’s got to get back soon.</td><td align="left">他得马上回来</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got to get back in the game</td><td align="left">我得回到老行当（爱好，工作，喜好) 算是重操旧业</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get there…某人得到达某处</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get there at 4</td><td align="left">我得4点到那</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">You got to get there on time</td><td align="left">你得回去工作了</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">She’s got to get there in time</td><td align="left">她得及时到那</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">He’s got to get there before it’s too late</td><td align="left">他赶紧到那儿，不然就晚了</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get out…  某人得出去/跑走/避免、摆脱</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get out of here</td><td align="left">我得离开这</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">She’s got to get out of work</td><td align="left">她得摆脱工作（一起看电影，她工作很忙，要是想去需要先摆脱工作）</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">He’s got to get out of this relationship</td><td align="left">他得摆脱这段关系的纠缠</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">You got to get out of bed</td><td align="left">你得离开床（滚下床）</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get [to smw] / [to the smw] /[smw] 某人得去某个地方</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get to school</td><td align="left">我得去学校</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">You got to get to work</td><td align="left">你得去上班</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">He’s got to get home.</td><td align="left">他得回家</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">We got to get to the hospital</td><td align="left">我们得去医院</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">You got to get to the part where [SVO]主谓宾</td><td align="left">你得去把（电视，剧集等）看到哪个段落，哪一集</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get [Sb][sth] 某人得给某个人送某个东西</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get to you a gift</td><td align="left">我得给你送个礼物</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">You got to get him a girlfriend</td><td align="left">你得给他找个女朋友</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">We got to get them a car</td><td align="left">我们得给他弄辆车</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">We got to get to the hospital</td><td align="left">我们得去医院</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">They got to get me a job</td><td align="left">他们得给我找个工作</td><td align="left"></td></tr></tbody></table><p><strong>[Sb] got to get [Sb][smw] 某人得送某个人去某个地方</strong></p><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got to get you to school</td><td align="left">我得送你去学校</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">You got to get me home</td><td align="left">你得送我回家</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">We got to get them a car</td><td align="left">我们得给他弄辆车</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I got to get you out of here.</td><td align="left">我得让你离开这儿</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got to get this off the wall.</td><td align="left">我得把这东西从墙上弄下来作</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">She’s got to get all this stuff into the luggage</td><td align="left">她得把所有东西塞进行李箱</td><td align="left"></td></tr></tbody></table><h3 id="Mar"><a href="#Mar" class="headerlink" title="Mar"></a>Mar</h3><h4 id="Mar-29th"><a href="#Mar-29th" class="headerlink" title="Mar 29th"></a>Mar 29th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I don’t know what to do</td><td align="left">这个看起来也很好</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Give it to him</td><td align="left">把这个给他吧</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I made an important decision today</td><td align="left">我今天做了个很重要的决定</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I have to leave early last night</td><td align="left">差不多是时候了</td><td align="left"></td></tr></tbody></table><h4 id="Mar-30th"><a href="#Mar-30th" class="headerlink" title="Mar 30th"></a>Mar 30th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">This one looks good too</td><td align="left">这个看起来也很好</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I tried to talk to him</td><td align="left">我试着想跟他聊(但他不听)</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">It’s hard to tell</td><td align="left">这不好说</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">It’s about time</td><td align="left">差不多是时候了</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I can’t tell, can you</td><td align="left">我看不出来，你可以吗</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I’ve decided to move forward with it</td><td align="left">我决定继续前进</td><td align="left"></td></tr></tbody></table><h4 id="Mar-31st"><a href="#Mar-31st" class="headerlink" title="Mar 31st"></a>Mar 31st</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">What do you mean</td><td align="left">你想表达什么，你什么意思</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">We could do that</td><td align="left">当有人提议我们一起做一件事时，好啊，我们可以做.. 事</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Don’t let your guard down</td><td align="left">别放松警惕</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">It might take a while</td><td align="left">这可能需要一段时间</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">It won’t take too long</td><td align="left">不会花费太长时间的</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Don’t tell me the answer</td><td align="left">不要告诉我答案</td><td align="left"></td></tr><tr><td align="left">7</td><td align="left">I’ve decided to move forward with it</td><td align="left">我决定继续前进</td><td align="left"></td></tr></tbody></table><h3 id="Apr"><a href="#Apr" class="headerlink" title="Apr"></a>Apr</h3><h4 id="Apr-4th"><a href="#Apr-4th" class="headerlink" title="Apr 4th"></a>Apr 4th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Yep, pretty much</td><td align="left">对，差不多</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Keep pushing, come on</td><td align="left">用力推，使劲</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I always keep people at distance</td><td align="left">我一直都跟别人保持距离</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">They have deep pocket</td><td align="left">他们有的是钱</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I got a backup plan</td><td align="left">我已经留了后手</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">You guys got to keep pace</td><td align="left">你们得跟我节奏</td><td align="left"></td></tr></tbody></table><h4 id="Apr-5th"><a href="#Apr-5th" class="headerlink" title="Apr 5th"></a>Apr 5th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Stop being stupid</td><td align="left">别傻了</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I couldn’t help but notice</td><td align="left">我无法不注意到</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">We’ll stop by on weekends</td><td align="left">我们周末回过来的</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">You’re very upbeat today</td><td align="left">你今天这是出奇的活跃啊</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Can you stop being so loud</td><td align="left">你不能小点声吗</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Can you help me</td><td align="left">能帮我一下吗</td><td align="left"></td></tr></tbody></table><h4 id="Apr-6th"><a href="#Apr-6th" class="headerlink" title="Apr 6th"></a>Apr 6th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">We need to take a step back</td><td align="left">咱们需要退一步</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I have to stop by my place first</td><td align="left">我得先回家一趟</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I need to go pick up my friend</td><td align="left">我要去接我的朋友</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I have to make up for past mistakes</td><td align="left">我必须弥补我过去的错误</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Can you grab me a coke</td><td align="left">能给我带个可乐吗</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Don’t rub my fact in it</td><td align="left">别在伤口上撒盐</td><td align="left"></td></tr></tbody></table><h4 id="Apr-7th"><a href="#Apr-7th" class="headerlink" title="Apr 7th"></a>Apr 7th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">He didn’t show up for work</td><td align="left">他没来上班</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">She dressed up for her interview</td><td align="left">她为面试打扮的</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">You need to stand up for yourself</td><td align="left">你要维护你自己</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I got a backup plan</td><td align="left">我已经留了后手</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Can you stop moping</td><td align="left">别再这么消沉了好吗</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I bought my son a popup book</td><td align="left">我给我儿子买了本立体故事书</td><td align="left"></td></tr></tbody></table><h4 id="Apr-11st"><a href="#Apr-11st" class="headerlink" title="Apr 11st"></a>Apr 11st</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I’d take christmas alone any day</td><td align="left">我宁愿自己过圣诞节</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I take classes on line</td><td align="left">我在网上上课</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Why don’t you ask questions</td><td align="left">你怎么不问问题</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I’ll take care of it</td><td align="left">我觉得你很可爱</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">You look gorgeous</td><td align="left">你看起来好迷人</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">You look great too</td><td align="left">你看起来也很棒</td><td align="left"></td></tr></tbody></table><h4 id="Apr-12nd"><a href="#Apr-12nd" class="headerlink" title="Apr 12nd"></a>Apr 12nd</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">He gets a big kick out of it</td><td align="left">他从这件事中收货很多乐趣</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">He wears thick glasses</td><td align="left">他带着厚厚的眼镜</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">You look good</td><td align="left">你气色不错啊</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I think you look cute</td><td align="left">我觉得你很可爱</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Is this a trick question</td><td align="left">你问的这个问题是个陷阱吗</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I bought a new bookcase from IKEA</td><td align="left">我从宜家买了个新书柜</td><td align="left"></td></tr></tbody></table><h4 id="Apr-13rd"><a href="#Apr-13rd" class="headerlink" title="Apr 13rd"></a>Apr 13rd</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">They make good pizza here</td><td align="left">他们这的Pizza很不错</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I’ve got an electric guitar</td><td align="left">我得到了一把电吉他</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">He’s a very romantic guy</td><td align="left">他是个很浪漫的人</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Who’s milk carton is this</td><td align="left">这盒奶是谁的</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">It’s all a big coverup</td><td align="left">这全是演示</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">That’s a big cat</td><td align="left">那只猫真肥</td><td align="left"></td></tr></tbody></table><h4 id="Apr-14th"><a href="#Apr-14th" class="headerlink" title="Apr 14th"></a>Apr 14th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Either the dog goes or I go</td><td align="left">让狗离开，要么我走</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">He sent me a gag gift for christmas</td><td align="left">他送了我一个搞怪的圣诞礼物</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">What do you say, big guy</td><td align="left">你怎么看哥们</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Can we at least hug goodbye</td><td align="left">我们能至少拥抱一下来告别吗</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">He took credit for my work</td><td align="left">他把我的功劳占为己有</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">These are big cups</td><td align="left">这些杯子好大</td><td align="left"></td></tr></tbody></table><h4 id="Apr-18th"><a href="#Apr-18th" class="headerlink" title="Apr 18th"></a>Apr 18th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">She’s so great</td><td align="left">她真好</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">This is so unfair</td><td align="left">这个太不公平了</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">This is sick</td><td align="left">真变态</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I leave for work at seven in the morning</td><td align="left">我早上七点去上班</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I live for dance</td><td align="left">我是为了跳舞而生</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Breath through the pain</td><td align="left">咬咬牙</td><td align="left"></td></tr></tbody></table><h4 id="Apr-19th"><a href="#Apr-19th" class="headerlink" title="Apr 19th"></a>Apr 19th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I lost Monica’s shoes</td><td align="left">我把莫妮卡的鞋子丢了</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">yes, she is</td><td align="left">她确实是</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Let show them who’s boss</td><td align="left">让他们看看谁才是老板</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">What does she do?</td><td align="left">她是做什么的</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Why is she here</td><td align="left">她为什么在这</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">How long has she been in the bathroom</td><td align="left">她在洗手间多长时间了</td><td align="left"></td></tr></tbody></table><h4 id="Apr-20th"><a href="#Apr-20th" class="headerlink" title="Apr 20th"></a>Apr 20th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">These are nice shoes</td><td align="left">这鞋子不错</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I think he’s shy</td><td align="left">我想他是害羞</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I really like this shirt</td><td align="left">我特别喜欢这件衣服</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">This is because she doesn’t like you</td><td align="left">这是因为她不喜欢你</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">How is she doing</td><td align="left">她现在状态怎么样啊</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">What she like</td><td align="left">她人怎么样啊</td><td align="left"></td></tr></tbody></table><h4 id="Apr-21st"><a href="#Apr-21st" class="headerlink" title="Apr 21st"></a>Apr 21st</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Go and have fun</td><td align="left">去好好地玩</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Houseflies live for a day</td><td align="left">果蝇只活一天</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">What kind of food are they serving</td><td align="left">他们提供哪些种类的食物</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">It’s cruel twist of fate</td><td align="left">这是个残酷的命运反转</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I have to leave for work</td><td align="left">我得走了去上班了</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I have faith in you</td><td align="left">我对你有信心</td><td align="left"></td></tr></tbody></table><h4 id="Apr-25th"><a href="#Apr-25th" class="headerlink" title="Apr 25th"></a>Apr 25th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Of course she likes me</td><td align="left">他当然喜欢我啊</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">She hasn’t, has she</td><td align="left">她没有，对吧</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">How is that possible</td><td align="left">怎么可能这样</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Give it back</td><td align="left">把它还给我</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">It’s hard to say goodbye</td><td align="left">说再见真不容易</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Give me my credit card</td><td align="left">把我的信用卡给我</td><td align="left"></td></tr></tbody></table><h4 id="Apr-26th"><a href="#Apr-26th" class="headerlink" title="Apr 26th"></a>Apr 26th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">How could that even be possible</td><td align="left">这是怎么可能的啊</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">What are you up to</td><td align="left">干啥啊你</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">It’s just another one of his pipe dream</td><td align="left">这是他的另一个白日梦</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Let’s get back to the topic at hand</td><td align="left">咱们言归正传</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Henry’s rock bottom lately</td><td align="left">亨利最近想入了人生的谷底</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Let’s look the big picture</td><td align="left">咱们从大局着想</td><td align="left"></td></tr></tbody></table><h4 id="Apr-27th"><a href="#Apr-27th" class="headerlink" title="Apr 27th"></a>Apr 27th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">This is my big break</td><td align="left">这是我的重大突破</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">This is a public place</td><td align="left">这是公共区域</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">It’s no big deal</td><td align="left">没什么大不了的</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">It broke down this morning</td><td align="left">它今天早晨坏掉了</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">How bad could it be</td><td align="left">能坏到哪去呢</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">so, how’d go</td><td align="left">怎么样了</td><td align="left"></td></tr></tbody></table><h4 id="Apr-28th"><a href="#Apr-28th" class="headerlink" title="Apr 28th"></a>Apr 28th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I think I should go</td><td align="left">我觉得我该走了</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I think you need to read the subtitle</td><td align="left">我想你需要看字幕</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">We can’t stop, we got to keep going</td><td align="left">我们不能停，我们得继续</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">oh yeah, big time</td><td align="left">是的，相当的</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">You got to give it back</td><td align="left">你得换回去</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">good bye</td><td align="left">再见</td><td align="left"></td></tr></tbody></table><h3 id="May"><a href="#May" class="headerlink" title="May"></a>May</h3><h4 id="May-2nd"><a href="#May-2nd" class="headerlink" title="May 2nd"></a>May 2nd</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Don’t I know you?</td><td align="left">我好像在哪见过你</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I did, didn’t I?</td><td align="left">我做了，对吧？</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Don’t even try it</td><td align="left">想也别想</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I wouldn’t even care</td><td align="left">我一点都不会在乎的</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Listen to me</td><td align="left">你听我说</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Let’s move on to something else</td><td align="left">咱们讨论下个吧</td><td align="left"></td></tr></tbody></table><h4 id="May-3rd"><a href="#May-3rd" class="headerlink" title="May 3rd"></a>May 3rd</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Shouldn’t I do something about this</td><td align="left">我不应该做些什么吗</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I don’t mean to be rude</td><td align="left">我不是故意冒犯你</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">There’s no reason to do that</td><td align="left">没有必要这样</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I haven’t spoken to him in years</td><td align="left">我好几年都没和他说话了</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Let’s move on to something else</td><td align="left">咱们聊下一个话题吧</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Do you believe in Santa Claus</td><td align="left">你相信圣诞老公公吗</td><td align="left"></td></tr></tbody></table><h4 id="May-4th"><a href="#May-4th" class="headerlink" title="May 4th"></a>May 4th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">There are plenty of intelligent inventors</td><td align="left">有很多聪明的发明家</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I’m on a international flight to Canada</td><td align="left">我正在坐一个国际航班去Canada</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">There are twenty presenters scheduled for today</td><td align="left">今天安排了20个演讲者</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">There are identical twins</td><td align="left">同卵双胞胎</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">He works in the entertainment industry</td><td align="left">他在娱乐圈工作</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Why won’t he listen to me</td><td align="left">他为什么不听我的话</td><td align="left"></td></tr></tbody></table><h4 id="May-5th"><a href="#May-5th" class="headerlink" title="May 5th"></a>May 5th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Why does he do that</td><td align="left">他为什么那么做</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Why doesn’t he come to me</td><td align="left">他为什么不来找我</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Did he mention us</td><td align="left">他提到我们了吗</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">There he is</td><td align="left">他在那</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I thought he was nice</td><td align="left">我觉得他挺好的啊</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I think about him all the time</td><td align="left">我一直在想他</td><td align="left"></td></tr></tbody></table><h4 id="May-10th"><a href="#May-10th" class="headerlink" title="May 10th"></a>May 10th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I’ll take him to the store</td><td align="left">我会带他去商店</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I’m looking for him</td><td align="left">我在找他</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Let him do what he wants</td><td align="left">让他做他想做的</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Can you tell him for me</td><td align="left">你能替我告诉她吗</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I’ll give him back his book</td><td align="left">我会把他的书还给他</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">It’s his, not mine</td><td align="left">是他的，不是我的</td><td align="left"></td></tr></tbody></table><h4 id="May-11th"><a href="#May-11th" class="headerlink" title="May 11th"></a>May 11th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">They found a gun in his hand</td><td align="left">他们在他收找到一把枪</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">This is his office</td><td align="left">这是他的办公室</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">When is his birthday</td><td align="left">什么时候是他的生日</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Don’t push her</td><td align="left">别逼她/别推她</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I walked her out to the bus stop</td><td align="left">我把她送到了车站</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I wanna make her breakfast</td><td align="left">我想给她做早餐</td><td align="left"></td></tr></tbody></table><h4 id="May-12th"><a href="#May-12th" class="headerlink" title="May 12th"></a>May 12th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">He really told her off</td><td align="left">他臭骂了她一顿</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I went to the mall with her</td><td align="left">我跟她一起去了商场</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">You’ve got to call her</td><td align="left">你得给她打个电话</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Is it her birthday today</td><td align="left">今天是她的生日吗</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I think his idea’s good</td><td align="left">我觉得他的主意挺好</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Is this his wallet</td><td align="left">这是他的钱包吗</td><td align="left"></td></tr></tbody></table><h4 id="May-16th"><a href="#May-16th" class="headerlink" title="May 16th"></a>May 16th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Get in the car</td><td align="left">上车</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">It’s not in there</td><td align="left">不在那里</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">This is my first night in BJ</td><td align="left">这是我在北京的第一夜</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">He’s out in the hallway</td><td align="left">他在外面的走廊</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">It hit me right in the eye</td><td align="left">正好打到我的眼睛</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">What’s that in the car</td><td align="left">车里那个是什么</td><td align="left"></td></tr></tbody></table><h4 id="May-17th"><a href="#May-17th" class="headerlink" title="May 17th"></a>May 17th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">This is a important day for me</td><td align="left">这对我是一个重要的日子</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Martin said the milk is rotten</td><td align="left">马丁说牛奶已经过期了</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Would you like some sweetener for your coffee</td><td align="left">你想加一些甜味剂给你的咖啡吗</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Can you draw the curtains</td><td align="left">你能拉上那个窗帘吗</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I wanna help lighten the load</td><td align="left">我想帮忙分担一些重量</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I’ve written a letter to him</td><td align="left">我已经给他写信了</td><td align="left"></td></tr></tbody></table><h4 id="May-18th"><a href="#May-18th" class="headerlink" title="May 18th"></a>May 18th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I need to buy a hair straightener</td><td align="left">我需要买一个直发加班</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I just got a new kitten</td><td align="left">我刚刚买了一只小猫</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Have you seen my mittens</td><td align="left">你看到我的连指手套了吗</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Have you eaten yet</td><td align="left">你吃饭了吗</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I lost a button</td><td align="left">我丢了一个扣子</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Are you certain that he left</td><td align="left">你确定他已经走了吗</td><td align="left"></td></tr></tbody></table><h4 id="May-19th"><a href="#May-19th" class="headerlink" title="May 19th"></a>May 19th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">The dentist is going to whiten my teeth</td><td align="left">牙医将会给我的牙齿美白</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">It’s disheartening news</td><td align="left">这是个令人沮丧的消息</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Please enlighten me</td><td align="left">请指引我</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I wanna shorten my bangs</td><td align="left">我想剪短我的刘海</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">The wall is crooked, it needs to be straightened</td><td align="left">这堵墙歪了，需要重新调整</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">The horror movie we saw was frightening</td><td align="left">我们看过的那个恐怖片很可怕</td><td align="left"></td></tr></tbody></table><h4 id="May-23rd"><a href="#May-23rd" class="headerlink" title="May 23rd"></a>May 23rd</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">What about you</td><td align="left">那你呢</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Can I get you something to drink</td><td align="left">你想要喝点什么吗</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">That’s what you said</td><td align="left">你就是这么说的啊</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">There’s something that you should know</td><td align="left">有些事情你应该知道</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Look at you, you’re mess</td><td align="left">看看你，你一团糟</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I thought you left already</td><td align="left">我以为你已经走了</td><td align="left"></td></tr></tbody></table><h4 id="May-24th"><a href="#May-24th" class="headerlink" title="May 24th"></a>May 24th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">I got you flowers</td><td align="left">我给你买了花</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Don’t you wanna know?</td><td align="left">你不想知道吗</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Is that what you’re saying</td><td align="left">你说的是这个意思吗</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">What did you do</td><td align="left">你做了什么</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Would you give it a rest</td><td align="left">你能不能别折腾了</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">How could you do that to me</td><td align="left">你怎么能这样对我</td><td align="left"></td></tr></tbody></table><h4 id="May-25th"><a href="#May-25th" class="headerlink" title="May 25th"></a>May 25th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Hey, I’m glad you’re here</td><td align="left">嘿，幸亏你来了</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Should you be doing that</td><td align="left">你应该这么做吗</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I told you yesterday that I’m busy today</td><td align="left">我昨天就跟你说了我今天很忙</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">He said you wanted to go home</td><td align="left">他说了你想回家</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I’m sorry I stood you up last night</td><td align="left">不好意思昨天晚上放了你鸽子</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Why would you do that</td><td align="left">你为什么那么做</td><td align="left"></td></tr></tbody></table><h4 id="May-26th"><a href="#May-26th" class="headerlink" title="May 26th"></a>May 26th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Did you sleep okay</td><td align="left">你睡得好吗</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">How did you do that</td><td align="left">你是怎么做的</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I don’t need your pity</td><td align="left">我不需要你的可怜</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I brought you some books</td><td align="left">我给你带了书</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Why can’t you go</td><td align="left">你为什么不能去</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">Don’t let your guard down</td><td align="left">你别放松警惕</td><td align="left"></td></tr></tbody></table><h4 id="May-30th"><a href="#May-30th" class="headerlink" title="May 30th"></a>May 30th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">What are you talking about?</td><td align="left">你在说什么啊</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">What’s going on</td><td align="left">最近怎么样</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">What are you doing here</td><td align="left">你在这里做什么</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I’m tell you, this guys mean business</td><td align="left">我跟你讲，他们是玩真的</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Yeah, that’s right, keep walking</td><td align="left">没错，继续走</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I’m having the time of my life</td><td align="left">我正在享受一生中最快乐的时光</td><td align="left"></td></tr></tbody></table><h4 id="May-31st"><a href="#May-31st" class="headerlink" title="May 31st"></a>May 31st</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">What are you saying?</td><td align="left">你什么意思啊</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Quit being such a wuss</td><td align="left">别做胆小鬼了</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">What are you looking at</td><td align="left">你看什么呢</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">What are you trying to do</td><td align="left">你想做什么</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">When are we starting</td><td align="left">我们什么时候开始</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">I’m getting you home</td><td align="left">我送你回家</td><td align="left"></td></tr></tbody></table><h3 id="Jun"><a href="#Jun" class="headerlink" title="Jun"></a>Jun</h3><h4 id="Jun-1st"><a href="#Jun-1st" class="headerlink" title="Jun 1st"></a>Jun 1st</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Hey, I’m talking to you</td><td align="left">嘿，我正和你讲话呢</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">He’s going into the house</td><td align="left">他正要走进那个房子</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I’ve been waiting all day</td><td align="left">我等了一整天</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Stop shouting at me</td><td align="left">别冲我嚷嚷</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">They’re fighting again</td><td align="left">他们又吵起来了</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">When are we meeting</td><td align="left">我们什么时候见面</td><td align="left"></td></tr></tbody></table><h4 id="Jun-2nd"><a href="#Jun-2nd" class="headerlink" title="Jun 2nd"></a>Jun 2nd</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">He keeps hitting on her</td><td align="left">他一直在搭讪她</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I’m putting out the cigarette</td><td align="left">我正在把烟灭了</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">What’s he eating</td><td align="left">他在吃什么</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">This is exciting</td><td align="left">这个好刺激</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">I was putting on my jacket</td><td align="left">我当时在穿夹克</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">He keeps putting it off</td><td align="left">他一直在拖延</td><td align="left"></td></tr></tbody></table><h4 id="Jun-6th"><a href="#Jun-6th" class="headerlink" title="Jun 6th"></a>Jun 6th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">They aren’t coming, are they？</td><td align="left">他们不回来了，对吧？</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">She couldn’t have done that</td><td align="left">他不会做那样的事的</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">She would have asked for permission</td><td align="left">他本来可以先征求许可的</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">I would have done it differently</td><td align="left">如果是我我不会这么做</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">It’d been done before</td><td align="left">早就有人做过了</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">You shouldn’t have said anything</td><td align="left">你本来什么都不应该讲的</td><td align="left"></td></tr></tbody></table><h4 id="Jun-7th"><a href="#Jun-7th" class="headerlink" title="Jun 7th"></a>Jun 7th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Where have you been ?</td><td align="left">你到哪去了？</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Why are you so annoying?</td><td align="left">你为什么这么生气？</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">Doesn’t he know</td><td align="left">他不知道吗？</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">When have you ever cared about me?</td><td align="left">你什么时候在乎过我？</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">She would told me if she could</td><td align="left">如果可以的话她一定会告诉我的</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">He wasn’t even here when it happened</td><td align="left">事情发生的时候他不在这里</td><td align="left"></td></tr></tbody></table><h4 id="Jun-8th"><a href="#Jun-8th" class="headerlink" title="Jun 8th"></a>Jun 8th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">You need not have done that</td><td align="left">你不需要做那件事</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">They haven’t had a chance</td><td align="left">他们一直没有机会</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">It will do for now</td><td align="left">暂时这样就可以了</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">It couldn’t have been him</td><td align="left">不可能是他</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Where’s our food</td><td align="left">我们的吃的在哪</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">He wouldn’t have done that to you</td><td align="left">[如果是他]他不会对你这么做的</td><td align="left"></td></tr></tbody></table><h4 id="Jun-9th"><a href="#Jun-9th" class="headerlink" title="Jun 9th"></a>Jun 9th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">It had better be good</td><td align="left">最好是好事</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">Where has she been？</td><td align="left">她到哪去了</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">It would be nice if you could cut me some slack</td><td align="left">你要是对我要求松一点就好了</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">It couldn’t have been her</td><td align="left">不可能是她</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">There is a good restaurant on the corner</td><td align="left">街角有一家好吃的饭店</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">When have I ever led you wrong?</td><td align="left">我什么时候带你走过弯路</td><td align="left"></td></tr></tbody></table><h4 id="Jun-13th"><a href="#Jun-13th" class="headerlink" title="Jun 13th"></a>Jun 13th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Who did you talk to?</td><td align="left">你和谁说过了</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">What did you do?</td><td align="left">你做了什么</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">When did you go?</td><td align="left">你是什么时候去的</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Where did you put it?</td><td align="left">你放哪儿去了</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Why did you do that ?</td><td align="left">你为什么这么做了</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">How did you do that?</td><td align="left">你是怎么做到的</td><td align="left"></td></tr></tbody></table><h4 id="Jun-14th"><a href="#Jun-14th" class="headerlink" title="Jun 14th"></a>Jun 14th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Who do you talk to?</td><td align="left">你平时和谁说啊</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">What do you do?</td><td align="left">你是做什么的</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">When do you go?</td><td align="left">你什么时候要去</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">Where do you put it?</td><td align="left">你平时放哪</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Why do you do that ?</td><td align="left">你为什么这么做</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">How do you do that?</td><td align="left">这是怎么做到的</td><td align="left"></td></tr></tbody></table><h4 id="Jun-15th"><a href="#Jun-15th" class="headerlink" title="Jun 15th"></a>Jun 15th</h4><table><thead><tr><th align="left">序号</th><th align="left">句子</th><th align="left">翻译</th><th align="left">连读音标</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">You got to get ahead</td><td align="left">你得想办法出人头地</td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">I wanted to talk about the future</td><td align="left">我想聊聊未来</td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">I don’t know if that’s good idea</td><td align="left">我不知道那是不是一个好主意</td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">You should come to the party</td><td align="left">你应该参加那个聚会</td><td align="left"></td></tr><tr><td align="left">5</td><td align="left">Let me give it a shot</td><td align="left">让我试一试</td><td align="left"></td></tr><tr><td align="left">6</td><td align="left">You want to give me a crack at it</td><td align="left">让我试试好吗</td><td align="left"></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Life </category>
          
          <category> English </category>
          
      </categories>
      
      
        <tags>
            
            <tag> English </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVC之RequestMapping注解</title>
      <link href="//p/springmvc-requestmapping-annotation.html"/>
      <url>//p/springmvc-requestmapping-annotation.html</url>
      
        <content type="html"><![CDATA[<h1 id="SpringMVC之RequestMapping注解"><a href="#SpringMVC之RequestMapping注解" class="headerlink" title="SpringMVC之RequestMapping注解"></a>SpringMVC之RequestMapping注解</h1><hr><h3 id="什么是RequestMapping注解"><a href="#什么是RequestMapping注解" class="headerlink" title="什么是RequestMapping注解"></a>什么是RequestMapping注解</h3><p>在SpringMVC的API中我们发现对@interface RequestMapping 有如下的定义：</p><blockquote><p>*Annotation for mapping web requests onto specific handler classes and/or handler methods. Provides a consistent style between Servlet and Portlet environments, with the semantics adapting to the concrete environment. *</p></blockquote><p>翻译过来的意思就是通过在在类和方法上的限制来匹配request</p><a id="more"></a><h3 id="RequestMapping的几大属性"><a href="#RequestMapping的几大属性" class="headerlink" title="RequestMapping的几大属性"></a>RequestMapping的几大属性</h3><p>在Spring4.2.4的API中发现RequestMapping有八大属性来mappingURL请求</p><ol><li><p><strong>value</strong></p><blockquote><p> *In a Servlet environment this is an alias for path(). For example @RequestMapping(“/foo”) is equivalent to @RequestMapping(path=”/foo”). *<br>在Servlet中value就是表示path，表示请求的路径的mapping, 支持通配符形式</p></blockquote></li><li><p><strong>method</strong></p><blockquote><p><em>The HTTP request methods to map to, narrowing the primary mapping: *</em>GET, POST, HEAD, OPTIONS, PUT, PATCH, DELETE, TRACE. ***<br>Http请求中有以上几种方式，我们可以通过加入method来限制mapping范围</p></blockquote></li><li><p><strong>params</strong></p><blockquote><p><em>Same format for any environment: a sequence of “myParam=myValue” style expressions, with a request only mapped if each such parameter is found to have the given value. Expressions can be negated by using the “!=” operator, as in “myParam!=myValue”. “myParam” style expressions are also supported, with such parameters having to be present in the request (allowed to have any value). Finally, “!myParam” style expressions indicate that the specified parameter is not supposed to be present in the request. *<br>请求参数中必须有key*</em>等于<strong>某个value或者key必须</strong>不等于<strong>某个value，多个条件是</strong>与**的关系。</p></blockquote></li><li><p><strong>headers</strong></p><blockquote><p><em>Same format for any environment: a sequence of “My-Header=myValue” style expressions, with a request only mapped if each such header is found to have the given value. Expressions can be negated by using the “!=” operator, as in “My-Header!=myValue”. “My-Header” style expressions are also supported, with such headers having to be present in the request (allowed to have any value). Finally, “!My-Header” style expressions indicate that the specified header is not supposed to be present in the request.</em></p></blockquote></li></ol><p><strong><em>Also supports media type wildcards (</em>), for headers such as Accept and Content-Type. For instance,will match requests with a Content-Type of “text/html”, “text/plain”, etc. *</strong><br>和params属性类似，支持通配符匹配。</p><pre><code>@RequestMapping(value = &quot;/something&quot;, headers = &quot;content-type=text/*&quot;)</code></pre><ol start="5"><li><p><strong>name</strong></p><blockquote><p><em>Assign a name to this mapping. Supported at the type level as well as at the method level! When used on both levels, a combined name is derived by concatenation with “#” as separator.</em><br>给mapping命名，支持在类和方法上使用该属性，联合起来的name用#来分隔</p></blockquote></li><li><p><strong>consumes</strong></p><blockquote><p>*The consumable media types of the mapped request, narrowing the primary mapping. The format is a single media type or a sequence of media types, with a request only mapped if the Content-Type matches one of these media types. Examples:</p></blockquote><pre><code>consumes = &quot;text/plain&quot;consumes = {&quot;text/plain&quot;, &quot;application/*&quot;}</code></pre><blockquote><p>*Expressions can be negated by using the “!” operator, as in “!text/plain”, which matches all requests with a Content-Type other than “text/plain”. *<br>consumes数组里面可以是一个或多个值，只要匹配到他们其中一个即可。</p></blockquote></li><li><p><strong>produces</strong></p><blockquote><p><em>he producible media types of the mapped request, narrowing the primary mapping. The format is a single media type or a sequence of media types, with a request only mapped if the Accept matches one of these media types. Examples:</em></p></blockquote><pre><code>produces = &quot;text/plain&quot;produces = {&quot;text/plain&quot;, &quot;application/*&quot;}produces = &quot;application/json; charset=UTF-8&quot;</code></pre><blockquote><p>*It affects the actual content type written, for example to produce a JSON response with UTF-8 encoding, “application/json; charset=UTF-8” should be used. Expressions can be negated by using the “!” operator, as in “!text/plain”, which matches all requests with a Accept other than “text/plain”. *<br>指定返回的内容类型，仅当request请求头中的(Accept)类型中包含该指定类型才返回</p></blockquote></li><li><p><strong>path</strong></p><blockquote><p><em>In a Servlet environment only: the path mapping URIs (e.g. “/myPath.do”). Ant-style path patterns are also supported (e.g. “/myPath/</em>.do”). At the method level, relative paths (e.g. “edit.do”) are supported within the primary mapping expressed at the type level. Path mapping URIs may contain placeholders (e.g. “/${connect}”) *</p></blockquote></li></ol><p>以上所有属性都是来限制mapping要求的，但是常用的是<strong>params、method、consumes</strong>.</p><h3 id="验证属性"><a href="#验证属性" class="headerlink" title="验证属性"></a>验证属性</h3><ol><li><p><strong>value</strong><br>value支持通配符的表现形式,  <strong>?</strong>表示匹配文件名中的一个字符, * 表示匹配任意一个或多个字符, ** 表示匹配多层路径的一个或多个字符, @PathVariable算是URL参数的占位符。</p><pre><code>@RequestMapping(value=&quot;/?/testValue1/{id}&quot;)public String testValue1(@PathVariable(&quot;id&quot;) String id){    System.out.println(&quot;value测试&quot; + id);    return SUCCESS;}</code></pre><blockquote><p><strong>URL</strong>:  <a href="http://localhost:8080/springMVC1/demo/a/testValue1/28" target="_blank" rel="noopener">http://localhost:8080/springMVC1/demo/a/testValue1/28</a><br><strong>Result</strong>:  value测试28</p></blockquote><p>现在我们遇到一种情况，如果我们的id是1.2.0007.9 这种类型的字符，如果在还向上面那样来传参数只会的到1.0这样的结果，于是我们需要用到正则表达式：</p><pre><code>@RequestMapping(value=&quot;/?/testValue1/{id：.*}&quot;)        public String testValue1(@PathVariable(&quot;id&quot;) String id){            System.out.println(&quot;value测试&quot; + id);            return SUCCESS;        }</code></pre><p> 写成{id:.*} 或 {id:.+} 都可以。</p></li><li><p><strong>method</strong><br>jsp部分代码如下：</p><pre><code>&lt;dl&gt;    &lt;dt&gt;Test method&lt;/dt&gt;    &lt;dd&gt;        &lt;a href=&quot;demo/testMethod_GET&quot;&gt;Method_GET&lt;/a&gt;    &lt;/dd&gt;    &lt;dd&gt;        &lt;form action=&quot;demo/testMethod_POST&quot; method=&quot;post&quot;&gt;            &lt;input type=&quot;submit&quot; value=&quot;Method_POST&quot;/&gt;        &lt;/form&gt;    &lt;/dd&gt;    &lt;dd&gt;        &lt;form action=&quot;demo/testMethod_DELETE&quot; method=&quot;post&quot;&gt;            &lt;input type=&quot;hidden&quot; name=&quot;_method&quot; value=&quot;DELETE&quot;/&gt;            &lt;input type=&quot;submit&quot; value=&quot;Method_DELETE&quot;/&gt;        &lt;/form&gt;    &lt;/dd&gt;    &lt;dd&gt;        &lt;form action=&quot;demo/testMethod_PUT&quot; method=&quot;post&quot;&gt;            &lt;input type=&quot;hidden&quot; name=&quot;_method&quot; value=&quot;PUT&quot;/&gt;            &lt;input type=&quot;submit&quot; value=&quot;Method_PUT&quot;/&gt;        &lt;/form&gt;    &lt;/dd&gt;&lt;/dl&gt;</code></pre><p>GET和POST方法很好理解，可是在DELETE方法和PUT方法中我们却加入了一个hidden类型的input，值分别为DELETE和PUT，为什么要加这个隐藏域，我们先来看一下Spring中org.springframework.web.filter.HiddenHttpMethodFilter类的一段源码：</p><pre><code>public static final String DEFAULT_METHOD_PARAM = &quot;_method&quot;;private String methodParam = DEFAULT_METHOD_PARAM;@Overrideprotected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)throws ServletException, IOException {    String paramValue = request.getParameter(this.methodParam);    if (&quot;POST&quot;.equals(request.getMethod()) &amp;&amp; StringUtils.hasLength(paramValue)) {        String method = paramValue.toUpperCase(Locale.ENGLISH);        HttpServletRequest wrapper = new HttpMethodRequestWrapper(request, method);        filterChain.doFilter(wrapper, response);    }    else {        filterChain.doFilter(request, response);    }}</code></pre><p>这段代码的主要意思就是如果_method中存在值，并且是post方法，那我们的servlet对这个方法进行处理，为了完成这个功能我们需要进一步在web.xml中配置这个org.springframework.web.filter.HiddenHttpMethodFilter，如下：</p><pre><code>&lt;!-- org.springframework.web.filter.HiddenHttpMethodFilter 可以将post请求转为PUT和DELETE请求 --&gt;&lt;filter&gt;    &lt;filter-name&gt;HiddenHttpMethodFilter&lt;/filter-name&gt;    &lt;filter-class&gt;org.springframework.web.filter.HiddenHttpMethodFilter&lt;/filter-class&gt;&lt;/filter&gt;&lt;filter-mapping&gt;    &lt;filter-name&gt;HiddenHttpMethodFilter&lt;/filter-name&gt;    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt;</code></pre><p>现在我们来看JAVA后台controller中的代码，如下：</p><pre><code>@RequestMapping(value=&quot;/testMethod_GET&quot;, method=RequestMethod.GET)public String testMethod_GET(){    System.out.println(&quot;This is GET method&quot;);    return SUCCESS;}@RequestMapping(value=&quot;/testMethod_POST&quot;,method=RequestMethod.POST)public String testMethod_POST(){    System.out.println(&quot;This is POST method&quot;);    return SUCCESS;}@RequestMapping(value=&quot;/testMethod_DELETE&quot;, method=RequestMethod.DELETE)public String testMethod_DELETE(){    System.out.println(&quot;This is DELETE method&quot;);    return SUCCESS;}@RequestMapping(value=&quot;/testMethod_PUT&quot;, method=RequestMethod.PUT)public String testMethod_PUT(){    System.out.println(&quot;This is PUT method&quot;);    return SUCCESS;}        </code></pre></li><li><p><strong>params</strong><br>jsp部分代码如下：</p><pre><code>&lt;dl&gt;    &lt;dt&gt;Test params&lt;/dt&gt;    &lt;dd&gt;        &lt;a href=&quot;demo/testParams?username&amp;age=10&quot;&gt;testParams&lt;/a&gt;    &lt;/dd&gt;&lt;/dl&gt;</code></pre><p>Java的Controller代码如下：</p><pre><code>@RequestMapping(value=&quot;/testParams&quot;, params={&quot;username&quot;,&quot;age!=0&quot;})public String testParams(){    System.out.println(&quot;testParams&quot;);    return SUCCESS;}</code></pre><p>params={“username”,”age!=0”}代表请求参数中<strong>必须</strong>有username和age这两个参数，同时age不能等于0.</p></li><li><p><strong>headers</strong><br>headers属性同params类似，都是可以以数组的形式来进行约束。需要什么样的请求参数可以通过开发者工具来查看请求中都有什么样的参数。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Spring-Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 注解 </tag>
            
            <tag> annotation </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Maven Project</title>
      <link href="//p/maven-project-structure.html"/>
      <url>//p/maven-project-structure.html</url>
      
        <content type="html"><![CDATA[<h1 id="创建Maven-Web-Project"><a href="#创建Maven-Web-Project" class="headerlink" title="创建Maven Web Project"></a>创建Maven Web Project</h1><hr><h3 id="什么是Maven"><a href="#什么是Maven" class="headerlink" title="什么是Maven"></a>什么是Maven</h3><p>在<a href="http://maven.apache.org/" target="_blank" rel="noopener">Apache Maven</a> 官网上的说明是：<em>Apache Maven is a software project management and comprehension tool. Based on the concept of a project object model (POM), Maven can manage a project’s build, reporting and documentation from a central piece of information.</em>   翻译过来的基本意思就是：<strong>Maven是基于项目对象模型(POM)，可以通过一小段描述信息来管理项目的构建，报告和文档的软件项目管理工 具。</strong></p><a id="more"></a><h3 id="使用Maven管理项目的好处"><a href="#使用Maven管理项目的好处" class="headerlink" title="使用Maven管理项目的好处"></a>使用Maven管理项目的好处</h3><ol><li><p>对第三方依赖库进行统一的版本管理。</p><blockquote><p>只要用了Maven就不用再为每个项目复制spring.jar和hibernate.jar了，Maven会在你需要的时候，自动把这些第三方依赖库找到，你需要编译，Maven就把这些jar包放到classpath里，你需要打包，Maven2就帮你把需要的jar包都复制到WEB- INF/lib/目录下。</p></blockquote></li><li><p>统一项目的目录结构</p><blockquote><p> 可以保证所有项目的目录结构都是一样的，目录结构统一的好处就是，你要找源代码就去src/main/java/下，你要找需要放到classpath下的资源，就去src/main/resources/下，你要找单元测试对应的代码和资源，就去src/test/下。每个目录下放什么东西，程序编译，发布的时候，每个目录起什么作用都很清楚明了，不会出现打开项目找不到要找的文件的情况。</p></blockquote></li><li><p>统一软件构建阶段</p><blockquote><p>Maven2把软件开发的过程划分成了几个经典阶段，比如你先要生成一些java代码，再把这些代码复制到特定位置，然后编译代码，复制需要放到 classpath下的资源，再进行单元测试，单元测试都通过了才能进行打包，发布。</p></blockquote></li><li><p>支持多种插件</p><blockquote><p>在<a href="http://maven.apache.com/和http://mojo.codehaus.org/上可以找到大量的Maven2插件，通过这些插件可以完成多种多样的扩展功能。" target="_blank" rel="noopener">http://maven.apache.com/和http://mojo.codehaus.org/上可以找到大量的Maven2插件，通过这些插件可以完成多种多样的扩展功能。</a></p></blockquote></li></ol><p>以上只是概念性的东西，陆续会用实例证明以上好处</p><h3 id="下载及安装Maven"><a href="#下载及安装Maven" class="headerlink" title="下载及安装Maven"></a>下载及安装Maven</h3><ol><li>访问<a href="http://maven.apache.org/" target="_blank" rel="noopener">Maven</a> 下载：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_download_maven.png" alt="down load Maven"><br/>                 </li><li>以Windows 环境为例，将下载的<strong>apache-maven-3.3.9-bin.zip</strong> 解压到某一磁盘目录下，<strong>apache-maven-3.3.9</strong> 作为<strong>MAVEN_HOME</strong> 目录，<br/>       </li><li>新建本地Maven仓库（Repository），编辑<strong>apache-maven-3.3.9\conf\setting.xml</strong> 文件，在本地建立仓库（任意一次盘文件夹下即可）<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_mavenRepo.png" alt="Maven Repo"><br/>       </li><li>环境变量可配置也可不配置，如果用到命令行必须要配置环境变量。<blockquote><ol><li>新建系统变量MAVEN_HOME, 并指定目录：E:\Java_Web\apache-maven-3.3.9-bin\apache-maven-3.3.9</li><li>编辑系统变量Path，增加%MAVEN_HOME%\bin;</li><li>命令行下（cmd）检测Maven 版本： mvn -v  </li></ol><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_mavenEnv.png" alt="maven_env_configuration"></p></blockquote></li></ol><h3 id="Eclipse下配置Maven"><a href="#Eclipse下配置Maven" class="headerlink" title="Eclipse下配置Maven"></a>Eclipse下配置Maven</h3><ol><li>现在新版本的Eclipse已经集成了Maven插件，在Windows-Preferences-Maven节点下的Installations添加Maven, 最后<strong>勾选上添加的Maven</strong>。<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_addMaven.png" alt="Add Maven"><br/>       </li><li>在Windows-Preferences-Maven节点下的User Setting设置setting.xml 文件<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_mavenSetting.png" alt="User Setting"><br/>       ### 新建Maven Web Project</li><li>鼠标邮件New Maven Project<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_new_maven1.png" alt="step1"><br/></li><li>选择Artifact ID<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_new_maven2.png" alt="step2"><br/></li><li>填写required text<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_new_maven3.png" alt="step3"><br/></li><li>pom.xml 上鼠标邮件run as <strong>Maven install</strong>, 会发现关于这个项目的war包在Maven仓库中已经生成<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_3_Maven_new_maven4.png" alt="step4"></li></ol><h3 id="常用MVN命令"><a href="#常用MVN命令" class="headerlink" title="常用MVN命令"></a>常用MVN命令</h3><blockquote><ol><li>mvn  help:system 自动在本用户下创建   ~/.m2/repository</li><li>mvn clean compile     清理编译</li><li>mvn clean test  清理测试</li><li>mvn clean package 清理打包</li><li>mvn clean install  清理将打包好的jar存入 本地仓库  注意是本地仓库</li><li>mvn archetype:generate 使用Archetype生成项目骨架</li><li>mvn clean deploy  根据pom中的配置信息将项目发布到远程仓库中</li></ol></blockquote><h3 id="Maven项目目录结构说明"><a href="#Maven项目目录结构说明" class="headerlink" title="Maven项目目录结构说明"></a>Maven项目目录结构说明</h3><blockquote><ol start="2"><li>src/main/java :正式内容包路径</li><li>src/mian/resources :正式的配置文件路径</li><li>src/test/java :测试包路径</li><li>src/test/resources :测试的配置文件路径</li><li>src/main/webapp : war 资源目录</li></ol></blockquote><h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>更多关于<a href="http://mark.leanote.com/post/%E4%BD%BF%E7%94%A8IntelliJ-IDEA-14%E5%92%8CMaven%E5%88%9B%E5%BB%BAjava-web%E9%A1%B9%E7%9B%AE" target="_blank" rel="noopener">IntelliJ IDEA 下创建Maven项</a></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>English</title>
      <link href="//p/spoken-english.html"/>
      <url>//p/spoken-english.html</url>
      
        <content type="html"><![CDATA[<h3 id="连读"><a href="#连读" class="headerlink" title="连读"></a>连读</h3><ol><li><p><strong>You’re gonna wanna get more experiences before you apply</strong>    </p><blockquote><p>before 可以读成 /b fɔr/， you和apply之间加w的音</p></blockquote></li><li><p><strong>I just wanted to have a look at her resume before you hired her</strong>     </p><blockquote><p>wanted to 读成 /wa nI tə/， nt+vowel,省t wanted=/wɑntɪd/=/wɑnɪd/,  at her 读成/æ dər/   hired her 同理不发h的音</p></blockquote></li><li><p>*<em>Give up or make decision because you can’t have it both ways *</em></p><blockquote><p>give up or 读成/gɪ vʌ pər/ , because 读成/kɔz/, 同时注意 can’t和can的读音区别</p></blockquote></li><li><p><strong>Didn’t it <em>seem</em> kinda cold last night</strong></p><blockquote><p>Didn’t it /dɪ dɪn nɪ/</p></blockquote></li><li><p><strong>And your daddy didn’t understand？</strong></p><blockquote><p>/ ə njər dæ di dɪ ‘ə nʌn dər sdænd?/</p></blockquote><a id="more"></a></li><li><p><strong>How does he expect me to buy stuff</strong></p><blockquote><p>/ hɑu dʌ ziks bekt mi də bɑi sdʌf?/</p></blockquote></li><li><p><strong>You’re probably gonna wanna train the new intern because he is hopeless**</strong></p><blockquote><p>probable可以省略中间的b的音 /‘prɑbəli/  new intern之间加w的音，  because he is /kɔ zɪs/</p></blockquote></li><li><p><strong>Look I’m really tired, so can we go home?</strong></p><blockquote><p>look I’m /lʊ kai m/</p></blockquote></li><li><p><strong>Who else wants to see a movie?</strong></p><blockquote><p>who else 中间有w的音  see a 中间有j的音</p></blockquote></li><li><p><strong>Oh,we do, but not just yet.</strong></p><blockquote><p>/Ouwi dµ, bʌ’ nɑ’ dʒʌ sje’/</p></blockquote></li><li><p><strong>But it won’t work out</strong></p><blockquote><p>/bʌ’ɪ’ woun’ wər kɑu’/</p></blockquote></li><li><p><strong>This might be a bad idea</strong></p><blockquote><p>be a 中间有j的音    idea中间也有j的音</p></blockquote></li><li><p><strong>But I’m gonna do it anyway</strong></p></li><li><p><strong>What if I had taken that job at Merrill Lynch?</strong></p><blockquote><p>/wʌ dɪ fɑi hæ’ tei kɪn ðæ’ dʒɑ bæ’ meər rəl lintʃ? /</p></blockquote></li><li><p><strong>Well, why didn’tyou take the job?</strong></p><blockquote><p>/Wel wɑi dɪ ‘ən tʃµ teik ðə dʒɑb/</p></blockquote></li><li><p><strong>Do you not wanna be seen with me?</strong></p><blockquote><p>/də jμ nɑ’ wɑ nəbi sin wɪθ mi?/</p></blockquote></li><li><p>** we’renot gonna hide it anymore.**</p><blockquote><p>/wər nɑ’ gʌ nə hɑi dɪ dæ ni mɔr /</p></blockquote></li><li><p><strong>Here, let me give it a shot</strong>   让我试一试</p><blockquote><p>give it a shot /ɡɪ vɪ də ʃɑ/</p></blockquote></li><li><p><strong>When are we gonna hang out?</strong> 我们什么时候出去玩一玩</p><blockquote><p>when are we /we nar wi/</p></blockquote></li><li><p><strong>This isn’t what I wanted</strong></p><blockquote><p>wanted /wɑnɪd/</p></blockquote></li><li><p><strong>Matt can’t be that fat, can he?</strong></p><blockquote><p>重音： can’t、 that， can he /cæni/</p></blockquote></li><li><p><strong>It’d’ve been nice to go out today</strong></p><blockquote><p>It’d’ve = It would have /I’ dI dIv/</p></blockquote></li><li><p><strong>when am I going to get promoted</strong></p><blockquote><p>when am I /we nə maɪ/</p></blockquote></li><li><p><strong>Is it a school night and she has a lot of homework to do?</strong></p><blockquote><p>/ɪ zɪ də sguəl nɑi’ ən ᵗʃi hæ zə lɑ də houmwərk tə dµ/</p></blockquote></li><li><p><strong>When’s her birthday?</strong></p><blockquote><p>/wen tsər bərθ dei/</p></blockquote></li><li><p><strong>Would you give it a rest</strong> 你省省吧，休息一下吧， （不要喋喋不休了，能停停吗）</p></li><li><p><strong>He is gonna wish he was never born</strong></p><blockquote><p>wish he /wɪʃi/ 此处省略h</p></blockquote></li><li><p><strong>could you… hold out that ring and ask me to marry you?</strong></p><blockquote><p>/kʊ dʒµ… houl dɑu’ ðæ’ riŋ ŋən… æs mi də mæ rijµ?/ that 咬舌停顿，略读</p></blockquote></li><li><p><strong>How much is it?</strong></p><blockquote><p>/hɑu mʌ tʃɪ zɪ’ ?/  重音在is上</p></blockquote></li><li><p><strong>I thought that it mattered what I said or where I said it</strong></p><blockquote><p>/ɑi θɔ’ ðæ dɪ’ mædərd wʌdɑi sed, ɔr weərrɑise dɪ’/</p></blockquote></li><li><p><strong>He knows what it’s about</strong></p><blockquote><p>/hi nou zwʌ dɪtsə bɑu’/</p></blockquote></li><li><p><strong>You wanted it to be a surprise.</strong></p><blockquote><p>/ jµ wanɪ dɪ’ tə bi jə sә’praiz /</p></blockquote></li><li><p><strong>I never had a bike of my own</strong></p><blockquote><p>/ɑine vər hæ də bɑi kə mɑi ʲoun /</p></blockquote></li><li><p><strong>Not really, I got to drag him around, too!</strong></p><blockquote><p>/ nɑ’rɪlli, ɑi gɑ’ tə dræg hɪ mə rɑun’ tµ! /  (注意是gɑ’ tə， 表示“我也有拖着他跑的”， 不是“我得拖着他跑”)</p></blockquote></li><li><p><strong>I’m sorry we can’t store your childhood things anymore.</strong></p><blockquote><p>/ɑim sɔr ri wi kæn’ tsdɔr jər tʃɑild hʊ’ θiŋ ze nimɔr./</p></blockquote></li><li><p>** I used to love to play restaurant.**</p><blockquote><p>/ɑi jµs tə lʌv tə plei res dər rɔn’/</p></blockquote></li><li><p><strong>She’s not as pretty as she was when she was 29</strong></p><blockquote><p>/ʃis nɑ dəz prɪ di ʲæ ʃi wʌz wen ᵗʃi wʌz twe ni nɑin/</p></blockquote></li><li><p><strong>Ms. Greene would like to establish some ground rules before she comes out</strong></p><blockquote><p>/mɪs grin wʊ’ lɑik tµ ʷɪs dæblɪʃ sʌm grɑun’ ruəlz bə fɔr ʃi kʌm zɑu’/</p></blockquote></li><li><p><strong>No, I love it.Thank you</strong></p><blockquote><p>/nouʷɑi lʌvɪ’ θæŋkjµ/</p></blockquote></li><li><p><strong>Now that you’re a couple, we don’t get two presents from you guys?</strong></p><blockquote><p>/nɑuðæ’ jər rə kʌpəl, wi doun’ge’ tµprezɪnᵗs frʌ mjµ gɑiz?/</p></blockquote></li><li><p><strong>you have got to try this cheesecake</strong></p><blockquote><p>/jµhæv gɑ’ tə trɑi ðɪs tʃiz keik /</p></blockquote></li><li><p><strong>Somebody sent it to us</strong></p><blockquote><p>/sʌmbɑ di se nɪ’ tµ ʷʌs/</p></blockquote></li><li><p><strong>I’ll be right with you</strong></p><blockquote><p>/ɑlbi rɑi’ wɪ θjµ /</p></blockquote></li><li><p><strong>I was not staring at her</strong></p><blockquote><p>/ɑiwʌz nɑ’ tsdeər riŋ ŋæ’ hər/</p></blockquote></li><li><p><strong>In college, Ross used to wear leg warmers!</strong></p><blockquote><p>/ ɪn kɑ lɪdʒ, rɔs jµs tə weər le gwɑər mərz/</p></blockquote></li><li><p><strong>Monica couldn’t tell time ’til she was 13</strong></p><blockquote><p>/mɑ nɪ kə kʊ ‘ən tel tɑi mʌn tɪl ʃi wʌz θər tin/</p></blockquote></li><li><p><strong>We used to be very close</strong></p><blockquote><p>/ wi jµs tə bi ve ri klous/</p></blockquote></li><li><p><strong>It’s not a big deal!</strong></p><blockquote><p>/ɪts nɑ də bɪ’ diəl/</p></blockquote></li><li><p><strong>What did you say when you made up your vows?</strong></p><blockquote><p>/ wʌ dɪ dʒµ sei we njµ mei dʌ’ jər vɑuz?/</p></blockquote></li><li><p><strong>I am supposed to be writing my vows and all I have is this!</strong></p><blockquote><p>/ɑim sʌ pous tə bi rɑi diŋ mɑi vɑuz ə nɑl lɑihæv ɪz ðɪs./</p></blockquote></li><li><p><strong>Those boots are amazing</strong></p><blockquote><p>/ðouz bµ tsɑər rə mei ziŋ/</p></blockquote></li></ol><h3 id="金牌音标"><a href="#金牌音标" class="headerlink" title="金牌音标"></a>金牌音标</h3><ol><li><strong>/v/</strong><blockquote><p>同“飞”的口型，喉咙震动</p></blockquote></li></ol><p><strong><em>never ever over very give have love everything every even move believe leave everybody haven live five everyone whatever drive leaving moving alive movie giving forever lovely given evening cover seven leaving loved voice above evil save government forgive private</em></strong></p><ol start="2"><li><strong>/ð/</strong><blockquote><p>舌头放在上下齿之间或者舌头顶在牙齿上，喉咙震动</p></blockquote></li></ol><p><strong><em>the than those that other this these there then they  mother father another together brother though either rather others</em></strong></p><ol start="3"><li><p><strong>/ʒ/ /ʃ/</strong></p><blockquote><p>英文单词以sion sure sual rsion为结尾的包含ʒ音，同she的口型，嘟起嘴唇，喉咙震动, 注意不同于汉语的“湿”</p><p><strong><em>conclusion confusion decision division occasion provision television vision</em></strong><br><strong><em>exposure measure pleasure disclosure, enclosure, leisure, treasure</em></strong><br><strong>*usual visual casual *</strong><br><strong><em>aversion conversion dispersion immersion perversion version</em></strong><br><strong><em>action cooperation inflation situation appreication</em></strong></p></blockquote></li><li><p><strong>/ai/ /au/ /n/</strong></p><blockquote><p> <strong>发/n/ 舌头要贴上颚</strong><br> /ai/  阿姨<br> <strong>behind bind blind wind find mind</strong></p><p>/au/  啊屋   /aun/ 联想“云”字<br><strong>bound hound count mount pound found down brown town downtown</strong></p></blockquote></li><li><p><strong>/‘ən/</strong></p><blockquote><p>/ə/ 嘴巴全部放松喉咙震动， 很懒很放松的“饿”</p><p><strong>certain certainly  fountain(喷泉，泉水) mountain curtain（窗帘） shorten written bitten gotten sweeten（减轻，使变甜） forgottten kitten(小猫) mitten(手套)</strong><br>/tən/ 通常drop t</p></blockquote></li><li><p><strong>/‘əl/</strong></p><blockquote><p>/ə/ 嘴巴全部放松喉咙震动， 很懒很放松的“饿” /l/ 舌尖向上卷碰到牙齿, 嘴唇不动， 拉长“楼”的音</p><p>*<em>people able pull bicycle table uncle principle deal heal meal rural actural formal legal *</em></p></blockquote></li><li><p><strong>/r/</strong></p><blockquote><p>舌头向后上转是正常的r（在末尾） 动作回去就是r的另一个发音（在开头）， 通常r 既在末尾又要在开头都发音， 如teacher is /titʃɚr rIs/</p><p>r在开头： rain ring read ride role room<br>r在末尾: wider easier higher dear poker</p></blockquote></li><li><p><strong>/t/ /d/</strong></p><blockquote><p>清辅音和浊辅音就是喉咙有没有震动,用气弹那么一下<br>talked take top installed leged learnt student</p></blockquote></li><li><p><strong>/ʊ/</strong></p><blockquote><p>类似于“饿”的读音， 但是没有“饿”这个音喉咙那么用力</p><p><strong>good look book took hood cook could would should put</strong></p></blockquote></li><li><p><strong>/i/ /ɪ/</strong></p><blockquote><p>将“叶”字分解.</p><p>*<em>it, fit hit bit itch(痒) lip sit *</em></p></blockquote></li></ol><h3 id="美语口语"><a href="#美语口语" class="headerlink" title="美语口语"></a>美语口语</h3><h4 id="2016-3-2-Future-World"><a href="#2016-3-2-Future-World" class="headerlink" title="2016.3.2 Future World"></a>2016.3.2 Future World</h4><p><strong>J: ** <em>Did u hear the Apple Pay is coming to China? It means we can *</em>pay with</strong> our Iphone, isn’t that <strong>nifty*</strong></p><blockquote><p><strong>pay with</strong>: 用… 支付;     <strong>nifty</strong>: /‘nɪfti/  </p></blockquote><p><strong>X:</strong> <em>That’s pretty <strong>slick</strong>, <strong>who would’ve thought that one day</strong> we could <strong>make payments</strong> with a mobile phone? Technology seems to make our lives better and better, what do u think the future <strong>has in store for</strong> us <strong>over</strong> the next 50 years</em></p><blockquote><p><strong>slick</strong> 等同 nifty，表示高科技的小物件比较酷<br><strong>who would’ve thought that one day…</strong>  谁能想到有一天…<br><strong>sth has/have in store for</strong> 等同于 sth will happen in the future</p></blockquote><p><strong>J:</strong> <em>I think *</em>things** will continue to get smaller, Maybe one day our <strong>cellphone</strong> will be <strong>the size of a grain of rice*</strong></p><blockquote><p><strong>things</strong> 日常的东西<br><strong>cellphone</strong>  在美国手机经常用这个词<br><strong>the size of a grain of rice</strong> 米粒儿一样的大小</p></blockquote><p><strong>X:</strong> * <strong>That’d be pretty cool</strong>! Maybe  it will be <strong>implanted</strong> in our bodies, we’ll see a greater <strong>integration</strong> between man and machine*</p><blockquote><p><strong>That’d be pretty cool</strong>   一种猜测，虚拟语气<br><strong>implant</strong>  植入<br><strong>integration</strong>  集成  IC卡（Integrated Circuit Card）</p></blockquote><p><strong>J:</strong> <em>I think VR(virtual reality) is <strong>the next big thing</strong>, I bet <strong>stem cell</strong> research will <strong>make great strides</strong> as well, maybe we can grow a new in the lab(laboratory) organ instead of transplanting some else’s</em></p><blockquote><p><strong>the next big thing</strong> 成为主流，something that is not popular now, but will be popular and mainstream in the future<br><strong>make great strides</strong> 取得更大进步<br><strong>stem cell</strong> 干细胞</p></blockquote><p><strong>X:</strong> <em>I’d rather work than become a *</em>couch potato***</p><blockquote><p><strong>couch potato</strong>  沙发土豆 指懒人</p></blockquote><h4 id="2016-3-7-Online-Learning"><a href="#2016-3-7-Online-Learning" class="headerlink" title="2016.3.7 Online Learning"></a>2016.3.7 Online Learning</h4><p><strong>X:</strong> <em>I thought you <strong>were supposed to</strong> have class now? what are you doing at your home?</em></p><blockquote><p>were supposed to 本应该干什么却没干</p></blockquote><p><strong>J:</strong> <em>I’m having class, can’t you see?</em></p><blockquote><p>have class 上课</p></blockquote><p><strong>X:</strong> <em>What do you mean? you’re at home on your computer</em></p><blockquote><p>what do you mean? 什么意思？ 期待对方给予答案<br>on your computer 面对电脑. I’m on my computer 我正在用电脑. on the internet 上网. I’m on the bus 我在公交车上</p></blockquote><p><strong>J:</strong> <em>Come on, *</em>get with the times,** a lot of people are taking classes online now, it’s perfect for <strong>workaholics(工作狂)</strong> like me, <strong>not only that</strong>, you can go online and learn <strong>just about anything</strong>, right now, i’m studying <strong>economics</strong>. The best thing is I can choose the time I want to study, the time isn’t <strong>set in stone*</strong></p><blockquote><p>get with the times 跟上时代的潮流<br>take class = have class 上课 (where are you taking class? i’m taking class online)<br>not only that 不仅如此<br>just about anything 几乎所有的事情/东西， just在这里指几乎<br>economy 经济 economics 经济学 economist 经济学家<br>set in stone 设置在石头上，表示“固定,永久不变的”， isn’t set in stone 不固定</p></blockquote><p><strong>X:</strong> <em>I had no idea that you could learn online</em></p><blockquote><p>have no idea 是完全不知道， i don’t know 有时候还表示一些不确定在里面</p></blockquote><p><strong>J:</strong> <em>You should <strong>jump on the bandwagon</strong> and study online too</em></p><blockquote><p>jump on the bandwagon 跟上潮流.   keep up with trend, trend本身就是一个大的趋势，所以千万不要写big trend，  从汉语的解释big就是累赘</p></blockquote><p><strong>X:</strong> <em>I’d love to, Maybe next semester I can pick some online classes, Right now my *</em>thesis** is <strong>driving me bonkers*</strong></p><blockquote><p>thesis /‘θisɪs/  比较正式的论文<br>drive me bonkers/nuts/crazy 让我抓狂</p></blockquote><p><strong>J:</strong> <em>What do you so <strong>stressed about</strong>? I thought you had the whole semester to get it done</em></p><blockquote><p>stress about 抓狂（什么东西压着你）</p></blockquote><p><strong>X:</strong> <em>Yeah, I did, but I procrastinated until the very last minute, Now i’m paying the price</em></p><blockquote><p>procrastinate /pro’kræstɪnet/ 耽搁、延迟<br>pay the price 付出代价</p></blockquote><p><strong>J:</strong> <em>Just take it easy, Rome is not built in a day, you know?</em></p><blockquote><p>Rome is not built in a day 罗马不是一天建成的</p></blockquote><p><strong>J:</strong> * <strong>Good thing</strong> you are here, my computer <strong>crashed</strong>, now i can’t <strong>boot</strong> it, I have to finish my homework <strong>by the end of the day</strong>, can you <strong>help me out</strong>， I’m really pressed for time with this homework*</p><blockquote><p>good thing 幸亏， 类似于thanks god.<br>crashed 可以表示电脑死机<br>boot 启动 boot an electronic device (启动电子设备)<br>by the end of the day 截止到今天<br>help me out 帮我渡过难关/困难<br>pressed for time 时间紧迫</p></blockquote><p><strong>X:</strong> * <strong>You scratch my back, I will scratch your back</strong>, it’s only fair*</p><blockquote><p>you scratch my back, i’ll scratch your back  你挠挠我都后背，我挠挠你的后背，指互帮互助</p></blockquote><p><strong>J:</strong> <em>Alright, you win， It works, you really are *</em>a Jack of all trades***</p><blockquote><p>a Jack of all trades 某人各种工作都干得很好，一个什么都会做的人 表示什么都会</p></blockquote><p><strong>X:</strong> <em>So you are gonna *</em>renege on our deal<strong>? <em>*that’s cold</em></strong></p><blockquote><p>renege on our deal/go back on your words/go back on your promise 反悔<br>that’s cold 一种心理描述， “太不靠谱了” 心灰意冷</p></blockquote><h4 id="2016-3-10-Visiting-a-friend-in-the-hospital"><a href="#2016-3-10-Visiting-a-friend-in-the-hospital" class="headerlink" title="2016.3.10 Visiting a friend in the hospital"></a>2016.3.10 Visiting a friend in the hospital</h4><p><strong>J:</strong> <em>What a pleasant surprise</em></p><blockquote><p>I’m so happy to see you 表示非常高兴</p></blockquote><p><strong>X:</strong> <em>How ya doin’, Sis? I thought I’d pay you a visit, I bet you are pretty lonely here in the hospital all by yourself</em></p><blockquote><p>How are you doing? 在口语中可以说 How ya doin’, 表示问候“怎么样了”<br>pay a visit to sb = pay sb a visit (拜访某人)</p></blockquote><p><strong>J:</strong> <em>That’s so sweet of you, my mom just left a few minutes ago, I’m surprised you didn’t bump into her as you were coming up</em></p><blockquote><p>so sweet of you = so kind of you (你真好)<br>bump into sb (偶然遇到某人， 强调偶然性)</p></blockquote><p><strong>X:</strong> <em>Oh rats, That would’ve been great to catch up with her, I haven’t seen her in ages, anyways, how’d your operation go?</em></p><blockquote><p>oh rats 真可惜，很可惜<br>catch up with sb (Talk with someone who you haven’t seen in a long time 和很久没见的人唠嗑聊天)<br>I haven’t see her in ages (我好久没见到她了， long time no see)<br>How’d (did) your operation/holiday/birthday go? (… 过得怎么样)？</p></blockquote><p><strong>J:</strong> <em>It was success, The doctor said I will be back to normal in no time, Although, i’m feeling a little woozy(头晕) from the anesthesia(麻药)</em></p><blockquote><p>I will be back to normal in no time = I’ll get back on my feet soon = I’ll fully recover soon<br>anesthesia /,ænəs’θiʒə/ 麻药</p></blockquote><p><strong>X:</strong> <em>That’s a relief, I would’ve come earlier had I known</em></p><blockquote><p>That’s a relief (那我就放心了)</p></blockquote><p><strong>J:</strong> <em>Two days ago, I was helpig my mom do the dishes when I slipped and fell on my knee,Thankfully, we didn’t have to call ambulance, my mom rushed me to the ER(emergency room)</em></p><blockquote><p>do the dishes 洗碗<br>thankfully 非常幸运地<br>rush sb to smw = send sb smw quickly (飞速的把某人送到某地)</p></blockquote><p><strong>X:</strong> <em>Good thing your mom was there to help you out. I brought you some stuff to munch on, beef jerky, your favorite</em></p><blockquote><p>munch on = to snack on = to eat<br>beef jerky 牛肉干  pork jerky 猪肉干</p></blockquote><p><strong>J:</strong> <em>This will make me feel even better, I should stay in the hospital a little longer, I don’t mind being pampered by you</em></p><blockquote><p>pamper /‘pæmpɚ/ to take really good care of someone 精心照料</p></blockquote><p><strong>X:</strong> <em>Is there anything I can do for you</em> (常用口语， 我能为你做些什么事情吗)<br><strong>J:</strong> <em>You can go pick up some medicine for me at drug store, take this prescription and get me three bottles of painkillers and three bottles of penicillin, The drug store is on the first floor to the left of entrance, on your way back, help me ask the nurse on duty, if I’ll be able to come home tomorrow</em></p><blockquote><p>drug store = pharmacy （药房）<br>prescription 处方， painkiller 止痛药， penicillin 青霉素<br>The drug store is on the first floor to the left of entrance  （注意描绘方位）<br>on your way back 在你回来的路上<br>on duty  值班</p></blockquote><h4 id="2016-3-14-Negotiating-with-Landlords"><a href="#2016-3-14-Negotiating-with-Landlords" class="headerlink" title="2016.3.14 Negotiating with Landlords"></a>2016.3.14 Negotiating with Landlords</h4><p><strong>L:</strong> <em>After seeing the apartment, are you satisfied with everything?</em></p><blockquote><p>be satisfied with 对… 满意<br>look for a house/place 找房子</p></blockquote><p><strong>X:</strong> <em>I think so, I just have a few questions if you don’t mind</em></p><blockquote><p>if you don’t mind 如果你不介意，一种非常客气的说法，可以放在句子开头也可以放在句子末尾</p></blockquote><p><strong>L:</strong> <em>Okay, shoot</em></p><blockquote><p>shoot 非常口语化的表达“请直说，但说无妨，问吧”</p></blockquote><p><strong>X:</strong> <em>I’m on the fence about choosing the big room or the small room, they are both very nice</em></p><blockquote><p>I’m on the fence about sth/doing sth 表示“不大确定，还在犹豫”<br>to sit on the fence  “墙头草“的意思  he is to sit on the fence</p></blockquote><p><strong>L:</strong> <em>If I were you, I’d pick the bigger room, it’s closer to the bathroom and the view is facing the city, it’s really the best of both worlds</em></p><blockquote><p>the view is facing the city 窗子冲着市区景色<br>it’s really the best of both worlds 两全其美</p></blockquote><p><strong>X:</strong> <em>You’re right, I’m a sucker for beautiful scenery, Okay, i’m sold, the big room it is, what’s the next step?</em></p><blockquote><p>I’m a sucker for sth 我对… 没有抵抗力<br>i’m sold 我要了/我买了<br>the big room it is 就是这个大房间了， .. it is 表示就是.. 了   Pizza it is  就是披萨了</p></blockquote><p><strong>L:</strong> <em>If you are sure you’d like to live here, we require that all of tenants sign a one year lease agreement, then I need your John Hancock here</em></p><blockquote><p>lease agreement 租约，  通常连用<br>John Hancock 签名 = autograph (所有签名的单词都可以通用在任何场合)</p></blockquote><p><strong>X:</strong> <em>There you go, are we finished?</em><br><strong>L:</strong> <em>That’s it, here is your key, you’re free to move in anytime, if you have any question, please give us a call and we’ll glad to assit you</em></p><blockquote><p>move in 搬进来，入住</p></blockquote><p><strong>L:</strong> <em>Hello, Mr. Gao, how is the new apartment?</em><br><strong>X:</strong> <em>Well.. it’s great, but there is a slight problem</em></p><blockquote><p>slight problem 小问题，一种委婉的说法</p></blockquote><p><strong>L：</strong> <em>What’s the matter?</em><br><strong>X:</strong> <em>There’s a huge pest(害虫、虫子、有害之物) problem in the kitchen, I’m worried that it might come into my room *<br><strong>L:</strong> *What kind of pests are we talking about?</em><br><strong>X:</strong> <em>Roaches</em></p><blockquote><p>roach (蟑螂) 全程cockroach</p></blockquote><p><strong>L:</strong> <em>I’m very sorry to hear that, have you tried cleaning the kitchen thoroughly(彻底地，完全地)</em><br><strong>X:</strong> <em>That’s why I came here, isn’t there something that you can do?</em><br><strong>L:</strong> <em>I’m afraid not</em><br><strong>X:</strong> <em>But you are my landlord, I thought your slogan was “above and beyond the call of duty”</em></p><blockquote><p>slogan 口号<br>above and beyond the call of duty 竭尽全力做某事，全心全意做某事</p></blockquote><p><strong>L:</strong> <em>You mustn’t have read the fine print in the contract. it says here on line 217 that we are not responsible for any bug infestations</em></p><blockquote><p>fine print 小字体 large print 大字体<br>infestation /ɪnfɛs’teʃən/  感染，侵扰</p></blockquote><p><strong>X:</strong> <em>I see， in that case, I’ll have to hire a prefessional to get rid of the bugs</em></p><blockquote><p>in that case 那么，在这种情况下<br>get rid of 清除..</p></blockquote><h4 id="2016-3-16-House-of-Cards"><a href="#2016-3-16-House-of-Cards" class="headerlink" title="2016.3.16 House of Cards"></a>2016.3.16 House of Cards</h4><p><strong>J:</strong> <em>Hi,Xiaogao, why do you have those bags under your eyes, have you not been sleeping well lately?</em></p><blockquote><p>bags under one’s eyes = to have dark shadows under one’s eyes, usually from a lack of sleep (由于睡眠不足导致的黑眼圈)</p></blockquote><p><strong>X:</strong> <em>You can say that</em></p><blockquote><p>you can say that (你可以这么说） 等同于yes，表示肯定</p></blockquote><p><strong>J:</strong> <em>Care to elaborate?</em></p><blockquote><p>care to elaborate = can you please explain?  能解释一下吗？ 详细说说？</p></blockquote><p><strong>X:</strong> <em>I’ve been binging on House of Cards lately, season 4 came out last week, and my eyes have been glued to the screen ever since</em></p><blockquote><p>binge on sth/doing sth = to over indulge in sth 过渡做某事， 这里指疯狂追剧纸牌屋<br>binge drinking (酗酒，豪饮)<br>come out 上映， 多用于影片<br>one’s eyes have been glued to the screen = to be infatuated with a movie or show to the point where you don’t want to do anything 眼睛贴在屏幕上了，意指沉迷于电影或电视节目而无心做其他事</p></blockquote><p><strong>J:</strong> <em>Season 4 is already out? I just remember just a few years ago when the first season came out back in early 2013. It seems like just yesterday</em></p><blockquote><p>It seems like just yesterday （used to refer to something that isstill fresh in one’s memory） 恍如昨日的感觉</p></blockquote><p><strong>X:</strong> <em>Yeah, I’m hooked on it, I think it is so cool that Netflix was able to make such a successful online-only web television series, They really broke new grounds</em></p><blockquote><p>Be hooked on sth = to be addicted to sth 沉迷于某事，上瘾<br>hook up<br>online-only web television 只在网络上播放的网剧<br>break new grounds （to accomplish something that hasn’t been accomplished before） 完成从未被完成过的事，常指开创新局面</p></blockquote><p><strong>J:</strong> <em>Did you know the first season received nine prime time Emmy Award nominations, The whole world seems like to love this political drama</em></p><blockquote><p>receive .. award 获得.. 奖项<br>political drama （A drama series that has a political background） 有政治背景的剧集</p></blockquote><p><strong>X:</strong> <em>I think Kevin Spacey and Robin Wright’s acting is outstanding! The first three seasons kept me on the edge of my seat during each episode. I love Neve Campbell’s performance in season 4! She’s one of my favorite actresses of all time.</em></p><blockquote><p>outstanding 这里指演技出神入化，很棒<br>[Something] keeps you on the edge of your seat = [something] is very suspenseful 非常具有悬念的某事  这里指很刺激<br>of all time 一直以来</p></blockquote><p><strong>J:</strong> <em>So, how is season 4? I heard there are some similarities(相似之处) between season 4 and the American election campaign. Is that true?</em><br><strong>X:</strong> <em>That’s right! There certainly are parallels（相似之处） between season 4’s script and the 2016 primary campaign. Are you sure you want me to go into specifics? It might spoil（剧透） it for you?</em></p><blockquote><p>Go into specifics = talk about something in detail (详细说，仔细解释)</p></blockquote><p><strong>J:</strong> <em>On second thought, I think you’d better wait until I watch itmyself.</em></p><blockquote><p>on second thought 经过再一次考虑</p></blockquote><p><strong>X:</strong> <em>Well, all I can say is get ready for more suspense and nail-biting drama! It’s so fun to watch Frank Underwood climb up the ladder of power!</em></p><blockquote><p>all that I can say is = what I can say is （具体查看语法定语从句）<br>nail-biting (咬指甲，指非常刺激的剧情)<br>climb up the ladder = to ascend in rank, power, or status （字面爬上梯子，意指达到某种权力)</p></blockquote><h4 id="2016-3-23-Artificial-Intelligence"><a href="#2016-3-23-Artificial-Intelligence" class="headerlink" title="2016.3.23 Artificial Intelligence"></a>2016.3.23 Artificial Intelligence</h4><p><strong>J：</strong> <em>I didn’t know you played Go(围棋)</em><br><strong>X:</strong> <em>I don’t, but I really wanna learn it, Did you hear about the amazing archievement of Google’s AI robot AplhaGo?</em></p><blockquote><p>hear about 听说<br>archievement 成就，非常大的词汇，表示很了不起的成果</p></blockquote><p><strong>J:</strong> <em>I heard about it, why are you so excited? *<br><strong>X:</strong> *Because it’s the first AI program that could beat a professional player at the most complex board game mankind（人类） has ever created.</em></p><blockquote><p>board game 棋盘游戏</p></blockquote><p><strong>J:</strong> <em>I thought computers have been able to beat humans at chess for a long time, what’s the big deal?</em></p><blockquote><p>for a long time = in ages<br>what’s the big deal? 有什么大不了的，多大的事</p></blockquote><p><strong>X:</strong> <em>You’re right, but there is a huge difference between chess and Go, computers could easily beat humans because it’s way less complicated. computers don’t need to be smart to win at chess, they just need to be fast, a computer  can use technique called brute forceto(BF) win at chess, this is not possible with Go, AlphaGo use reall AI called deep learning in order to solve problem.</em></p><blockquote><p>there is a huge difference between A and B   (A 和 B有很大的不同)<br>way less complicated  (此处的way相当于very /much)<br>deep learning (深度学习)<br>win at sth （赢得什么/取胜）</p></blockquote><p><strong>J:</strong> <em>I think I understand now, but why does this matter for mankind?</em></p><blockquote><p>why does this matter for mankind?   (但此事为何对人类事关重要？)</p></blockquote><p><strong>X:</strong> <em>such as complex weather conditions,disease control, and global warming issues</em><br><strong>J:</strong> <em>I heard the AI robot only won 4 out of 5 matches. Does that mean that AI has room for improvement?</em></p><blockquote><p>4 out of 5 五分之四  四分之三：three fourths= three quarters 五分之三：three fifths  分数的表达法：分子用基数词,分母要用序数词,分子大于1时,分母的序数词后加s.对于四分之一,常用quarter来表示.<br>sth has room for improvement  （sth 还有进步空间）</p></blockquote><p><strong>X:</strong> <em>That’s right. The robot isn’t perfect, but it certainly impressed the entire world. Some of AlphaGo’s moves were described as “beautiful” by Go fans.</em></p><blockquote><p>sth impressed sb  （.. 给某人留下深刻印象）<br>AlphaGo’s moves  此处的move表示棋路</p></blockquote><p><strong>J:</strong> <em>This is getting scary. Are robots going to take over the world?</em></p><blockquote><p>take over (控制/接管)</p></blockquote><p><strong>X：</strong> <em>Although Google’s AI victory marked a major milestone for artificial intelligence, the world is still a long way away from mimicing true human intelligence.</em></p><blockquote><p>mark a major milestone  (标识一个重要的里程碑)<br>mimic /‘mɪmɪk/ vt. 模仿，摹拟<br>A long way away from… = 与…差得很远</p></blockquote><h4 id="2016-3-28-Horoscope"><a href="#2016-3-28-Horoscope" class="headerlink" title="2016.3.28 Horoscope"></a>2016.3.28 Horoscope</h4><p><strong>J:</strong> <em>We’ve already talked about the first six zodiac signs, I think it’s time we talk about the last six . Pop quiz</em></p><blockquote><p>first six 前六个 last six 后六个<br>pop quiz 考考你</p></blockquote><p><strong>X:</strong> <em>These people love justice(公正) and fairness（公平）， they also work well with other people</em></p><blockquote><p>work well with sb 非常融洽的和某人合作、 配合默契</p></blockquote><p><strong>J:</strong> <em>Libras are known to be cooperative(有合作精神的), they don’t like violence（暴力） or injustice（不公正） of any kind.</em><br><strong>X:</strong> <em>Scorpios seem quiet and cool on the outside, but they are actually really emotional(内心感情丰富) and passionate(富有激情) on the inside</em></p><blockquote><p>on the outside 外表  on the inside 内心</p></blockquote><p><strong>J:</strong> <em>I heard they make really great leaders, they don’t like being lied  to, so make sure you’re always honest to a Scorpio</em></p><blockquote><p>make great leaders 非常会做领导 注意make的用法</p></blockquote><p><strong>X:</strong> <em>Sagittarius are deep thinkers</em></p><blockquote><p>deep thinkers 思想家/思想者</p></blockquote><p><strong>J:</strong> <em>They are really extroverted and optimistic, it’s hard for a Sagittarius to feel down， we’ve finally reached the last three zodiac signs(星座)</em></p><blockquote><p>extroverted/introverted  (外向的/内向的)<br>optimistic/pessimistic （乐观的/悲观的）<br>feel down (不开心，情绪低落)<br>reach 到达， 到达了最后三个，就代表剩下三个</p></blockquote><p><strong>X:</strong> <em>These people is known for their professionalism and traditional values , they are really serious people</em></p><blockquote><p>professionalism and traditional values （专业精神和传统价值观）<br>serious people (严肃认真的人， 高冷)</p></blockquote><p><strong>J:</strong> <em>Let’s move on, it should not surprise you that the symbol of Aquarius the water bearer,  they can also be boisterous and energetic. They love to lend a helping hand to those in need.</em></p><blockquote><p>it should not surprise you (毫无疑问，不会让你感到惊讶)<br>boisterous /ˈbɔɪ.stɚ.əs/ 喧闹的, 精力旺盛的<br>lend a helping hand to sb 帮助某人</p></blockquote><p><strong>X:</strong> <em>The Pisces is a very gentle and affectionate(深情的，有爱心的) person. They are there for you when you need to spill your guts. Why would I want to be like you?</em></p><blockquote><p>spill your guts 说心里话<br>why would I wannt to be like you?  为什么我要像你一样？</p></blockquote><p><strong>十二星座</strong> Aries /ˈer.iːz/ 白羊座 Taurus /ˈtɔːr.əs/ 金牛座 Gemini /ˈdʒem.ə.naɪ/ 双子座 cancer /ˈkæn.sɚ/ 巨蟹座 Leo /ˈliː.oʊ/ 狮子座 Virgo /ˈvɝː.ɡoʊ/  处女座 Libra /ˈliː.brə/ 天秤座 Scorpio /ˈskɔːr.pi.oʊ/ 天蝎座 Sagittarius /ˌsædʒ.əˈter.i.əs/ 射手座 Capricorn  /ˈkæp.rə.kɔːrn/ 摩羯座 Aquarius /əˈkwer.i.əs/ 水瓶座 Pisces /ˈpaɪ.siːz/ 双鱼座</p><h4 id="2016-3-30-Airport-English"><a href="#2016-3-30-Airport-English" class="headerlink" title="2016.3.30 Airport English"></a>2016.3.30 Airport English</h4><p><strong><em>Xiaogao is at the airport checking in(办理登机), Jingjing plays the part of the airline employee</em></strong><br><strong>J:</strong> <em>Hello sir, where are you flying today? (您此行飞往何处？)</em><br><strong>X:</strong> <em>I’m headed to Detroit.</em></p><blockquote><p>be headed to smw 前往某地， 不能指从外地回家<br>Head to = to go to 去（往）某地</p></blockquote><p><strong>J：</strong> <em>Can I please see your passport? do you have any goods to declare?</em></p><blockquote><p>declare 申报， 指过海关的申报</p></blockquote><p><strong>X：</strong> <em>Here’s my passport, no goods to declare this time.</em><br><strong>J:</strong> <em>Okay, will you be checking in any bags?</em></p><blockquote><p>check in (既可以指办理登机，也可以指托运行李，此处是后者)</p></blockquote><p><strong>X:</strong> <em>Yes, Just this one</em><br><strong>J:</strong> <em>Please place it on the scale, oh *</em>your bag is overweight（超重）, I’m afraid you’ll have to pay a small fee***</p><blockquote><p>place it on the scale(秤: a device to measure weights) 把它放在秤上<br>pay a small fee (此处要用fee， tip指吃完饭给的小费)<br>I’m afraid that （恐怕…） I’m afraid of (害怕…)  注意二者的区别</p></blockquote><p><strong>X:</strong> <em>That’s fine, here you go(给你)</em><br><strong>J:</strong> <em>Here’s your boarding pass, you’ll begin boarding at 10:05 at gate D12</em></p><blockquote><p>boarding pass (登机牌)</p></blockquote><p><strong>X:</strong> <em>Thanks ma’am</em></p><blockquote><p>ma’am /mɑːm/ 对女士饿一种礼貌的称呼，不在乎结婚与否</p></blockquote><p><strong><em>Xiao Gao is going through the security check. Jing Jing plays the part of the customs agent</em></strong></p><blockquote><p>go through 通过<br>security check 安检</p></blockquote><p><strong>J:</strong> <em>Please take your laptop out of your bag and place it in a bin</em>(指安检的小盒子)<br><strong>X:</strong> <em>No problem, should I take my shoes off too?</em><br><strong>J:</strong> <em>Yes, sir, you can put your shoes in another bin, please step through the metal detector.</em></p><blockquote><p>step through （走过） 注意和go through的区别<br>metal detector （金属探测器）</p></blockquote><p><strong>X:</strong> <em>I’m gonna have to pat your down, do you have any metal items in your pockets?</em></p><blockquote><p>pat one’s down (很形象的说明“搜查身体”， 原意是拍拍你的身体)  to search someone’s clothes for items they shouldn’t have</p></blockquote><p><strong>J:</strong> <em>No, I think it might be the belt buckle, it’s made of metal.</em></p><blockquote><p>belt buckle (皮带扣)</p></blockquote><p><strong>X:</strong> <em>You are free to go, don’t forget to grab your things</em></p><blockquote><p>grab sth （拿上某物）<br>grab a bite to eat/ grab sth to eat</p></blockquote><p><strong><em>Xiao Gao is onthe airplane getting ready to take off. Jing Jing plays the part of the stewardess(指空姐)</em></strong></p><blockquote><p>Flight attendants/stewardess 空乘人员</p></blockquote><p><strong>J:</strong> <em>Here is a hot towel(毛巾) for you.Would you care for a pair of head phones?</em></p><blockquote><p>care for sth (需要…)<br>head phones (耳机)</p></blockquote><p><strong>X:</strong> <em>I will take a pair(指一对耳机)， BTW， could I have a cup of water, please?</em><br><strong>J:</strong> <em>Coming right up, and here’s some peanuts(花生) and pretzels（椒盐脆饼） for you to snack on.</em></p><blockquote><p>coming right up (马上送过来)<br>snack on = munch on (食用, 当零食吃)</p></blockquote><p><strong>X:</strong> <em>Thanks! Those are my favorite!</em></p><blockquote><p>favorite 此处是形容词作名词，直接单数形式</p></blockquote><p><strong><em>The captain makes an announcement（机长开始广播）</em></strong><br><strong>Good morning ladies and gentlemen. This is your captain speaking. We have been cleared for takeoff(名词：起飞). We’ll be leaving in just a few minutes. Please sit down and fasten your seatbelts. We expect to arrive in Detroit in 12 hours. Thank you for flying with Happy Airlines. Flight attendants, prepare for takeoff!</strong></p><p><strong>扩展翻译</strong></p><blockquote><ol><li>哪里是落地签办理处？<br>Where can I find the visa on arrival office?</li><li>我在28号安检口等待安检<br>I’m waiting at gate 28 for a security check</li><li>可以免费托运多重的行李？<br>What’s the heaviest amount of luggage that we can check for free?</li><li>转机时是否需要取行李?行李可以直达目的地吗？<br>Do I have to grab my luggage during connecting flights? Can we send my luggage directly to my destination?</li><li>紧急出口在哪儿？<br>Where’s the emergency exit?</li></ol></blockquote><h4 id="2016-4-6-Camping"><a href="#2016-4-6-Camping" class="headerlink" title="2016.4.6 Camping"></a>2016.4.6 Camping</h4><p><strong>J:</strong> <em>What are you gonna do for the weekend?</em></p><blockquote><p>what are you gonna do/what are you plans/what you have in mind for the weekend?   周末打算做什么</p></blockquote><p><strong>X:</strong> <em>I haven’t decided yet, it’s still up in the air as to whether I’ll go camping with my friends or go bike riding through the countryside(郊外).</em></p><blockquote><p>I haven’t decided <strong>yet</strong>. （注意加上yet更加完整，表示“我还没有决定”）<br>sth is still up in the air （某事还没决定，此处是事没确定）<br>sb is on the fence about sth （某人还在犹豫某事， 此处是人在犹豫）<br>as to （至于…. ）</p></blockquote><p><strong>J:</strong> <em>Both of those things sound really tiring. why don’t you stay in town and hang out with your friends?</em></p><blockquote><p>tiring: sth is tiring that makes you tired.<br>注意hang out 和 play的区别, play跟多的是指小朋友之间的玩耍，hang out 指逛街之类的</p></blockquote><p><strong>X:</strong> <em>I’m an outdoorsman, I love nature, and besides, lately the weather has taken a turn for the better.</em></p><blockquote><p>outdoorsman  （户外运动控）<br>take a turn （转个弯，变化） 多数用于天气/身体 take a turn for the better/worse</p></blockquote><p><strong>J:</strong> <em>I guess different things make us happy, I use my weekend to catch some shuteye</em></p><blockquote><p>catch some shuteye (补觉)</p></blockquote><p><strong>X:</strong> <em>I think you’d really like camping,how about we both go camping this weekend?</em><br><strong>J:</strong> <em>I don’t know, is it expensive?</em><br><strong>X:</strong> <em>Not at all, but I’d appreciate some help with gas money. it’s a long drive out to the campsite(度假营地)</em></p><blockquote><p>not at all (一点也不，注意连读)<br>I’d appreicate some help …  非常委婉客气的说法<br>It’s a long drive out to the campsite/hospital/my mom house (去..的路程很远)</p></blockquote><p><strong>J:</strong> <em>I’ll spring for gas, can I help with anything else?</em></p><blockquote><p>spring (作动词讲意思：拿出..东西)  pay for = spring for the ticket/dinner   </p></blockquote><p><strong>X:</strong> <em>I’ll let you set up a tent, you’ll love it</em></p><blockquote><p>set up a tent = pitch a tent （搭帐篷）</p></blockquote><p><strong>J:</strong> <em>It sounds like I’m getting the raw end of the deal, I heard that can be a lot of work</em></p><blockquote><p>get the raw end of the deal (raw 生的， is not fair， 意思是吃了亏，拿到了不好的一端)</p></blockquote><p><strong>X:</strong> <em>Don’t worry, I’ll help you through it. so are we on for the weekend?</em></p><blockquote><p>I’ll help you throught it = I’ll help you out (我会帮你搞定它)<br>are we on .. (我们说定了..嘛？) are we on for tonight/the weekend? （说好今晚/周末？）</p></blockquote><p><strong>J:</strong> <em>we’re on</em>  说定了</p><p><strong>J:</strong> <em>You should have looked at the weather report before we left.I can’t believe it’s raining right now, this is the pits</em></p><blockquote><p>I can’t believe it’s raining/April 4<br>This is the pits (pit: the hole in the ground, 表示不理想的情况， 太糟糕了)</p></blockquote><p><strong>X:</strong> <em>Don’t worry, we still have a good time, hurry up and pitch the tent before we get any wetter.</em></p><blockquote><p>hurry up and pitch the tent before we get any wetter (快来，在我们淋湿之前把帐篷打起来，注意此处比较级的运用，更加地道)</p></blockquote><p><strong>J:</strong> <em>There a lot of poles(杆子), I don’t know what to do first.</em><br><strong>X:</strong> <em>There is nothing to it, watch me, there, all done</em></p><blockquote><p>there is nothing to it (没难度，很简单)</p></blockquote><p><strong>J:</strong> <em>I guess that wasn’t so bad, so what are we supposed to do now? it’s too cold and wet to be outside right now.</em><br><strong>X:</strong> <em>How about we make dinner in tent? I brought a portable stove and some ramen</em></p><blockquote><p>portable （唯一表示“便携式”的单词）<br>ramen 拉面</p></blockquote><p><strong>J:</strong> <em>Now you’re talking, cooking is right up my alley, ok, Xiaogao, just sit back and relax, i’m gonna cook up a mean bowl of noodles.</em></p><blockquote><p>you’re talking (太好了，很同意这么做，表示赞成)<br>sth is right up one’s alley = sb is good at sth<br>a mean bowl/dish of sth (一碗特别好吃的…)</p></blockquote><p><strong>X:</strong> <em>Hey, you should come camping more often! You seem like a pro!</em></p><blockquote><p>pro 此处表示专家， 注意和professor的区别， 此处不能用professor， pro表示很专业<br>more ofen 表示“经常”</p></blockquote><p><strong>J:</strong> <em>What can I say? I guess I’m just good at everything I do!</em></p><blockquote><p>what can I say (我能说什么呢？ 很炫耀的一种说法)<br>I’m good at everything I do = I’m a Jack of all trades (我什么事都能做好， 我是个全才)</p></blockquote><h4 id="2016-4-11-30-day-Challenge"><a href="#2016-4-11-30-day-Challenge" class="headerlink" title="2016.4.11 30-day Challenge"></a>2016.4.11 30-day Challenge</h4><p><strong>X:</strong> <em>My friends and I are gonna go see Zootopia and then go grab a bite to eat, you in?</em></p><blockquote><p>grab a bite to eat 吃点东西<br>A: you in? B: yes, I’m in / no, I’ll pass</p></blockquote><p><strong>J:</strong> <em>I’ll pass</em><br><strong>X:</strong> <em>What? I thought you were dying to see that movie</em></p><blockquote><p>be dying to do sth = Yearning to do something (非常/渴望想做某事)</p></blockquote><p><strong>J:</strong> <em>I do really wanna see that movie, but I’ve got other plans, Lately I’ve been helping people at the old folks’ home</em></p><blockquote><p>old folks’ home = nursing home (敬老院，前者多用于口语中)</p></blockquote><p><strong>X:</strong> <em>Why would you do that instead of going to the movies? That doesn’t make sense</em></p><blockquote><p>make sense (有意义)<br>That doesn’t make sense (根本没道理，讲不通)</p></blockquote><p><strong>J:</strong> <em>I made a commitment to myself that I will do something good every day for 30days, I recently attented a TED seminar（专题讨论会） by Matt, He talked about the benefits of doing something for 30 days straight.</em></p><blockquote><p>make a commitement (做承诺)<br>注意此处Straight的用处</p></blockquote><p><strong>X:</strong> <em>Oh yeah, tell me about it.</em></p><blockquote><p>tell me about it = care to elaborate</p></blockquote><p><strong>J:</strong> <em>He said it’s a greate way to improve yourself-confidence. It’s also a great way to force yourself to do something that you’ve always wannted to do, but never got around to actually doing</em></p><blockquote><p>improve yourself-confidence (注意：提升自信心要用improve)<br>push sb to do sth = force sb to do sth<br>get around to doing sth (抽时间做某事) 在<strong>肯定句</strong>中： finally get around to doing sth 在<strong>否定句</strong>中： never get around to doing sth</p></blockquote><p><strong>X:</strong> <em>Oh, that sounds like something I should do…</em><br><strong>J:</strong> <em>I think you’d love it. You can pick something that you’re willing to do for 30 days, for example, writing a 50,000-word short story. Every day you just have to write 1667 words, but the tough part is that you can’t go to sleep until you’ve finished what you promised yourself you’d do.</em></p><blockquote><p>the tough part (最艰难的部分)</p></blockquote><p><strong>X:</strong> <em>I think I’ll give this a shot.Okay, have fun helping the old people. I’m off to the movies!</em></p><blockquote><p>give it/this a shot （试一试）<br>have fun doing sth (有兴趣做某事)<br>I’m off (我走了，可用于结束一天的工作指“下班”)</p></blockquote><p><strong>J:</strong> * You look a lot thinner than the last time we met.*</p><blockquote><p>package some pounds （变胖）</p></blockquote><p><strong>X:</strong> <em>I took your advice and decided to go on a diet for 30 days. So far, I’ve stuck to my diet really well.</em></p><blockquote><p>go on a diet (节食、减肥)<br>stick to doing sth/sth （坚持做某事）</p></blockquote><p><strong>J:</strong> <em>That’s great! So, tell me about it? What exactly are you doing?</em></p><blockquote><p>what exactly are you doing? (你到底做了什么)</p></blockquote><p><strong>X:</strong> * I promised myself that I would eat healthy for at least 30 days. I also promised myself to get lots of exercise by walking and going to the gym.*<br><strong>J:</strong> <em>How are you making sure that you eat heathy?</em><br><strong>X:</strong> * I weigh all of my food on a digital scale before I eat it. Then I calculate the amount of calories. Right now, I only eat about 1900 calories a day. It’s really helped me slim down.*</p><blockquote><p>digital scale (电子秤)  关联2016.3.30 Airport English 中 place it on the scale<br>slim down (瘦身，瘦下来)</p></blockquote><p><strong>J:</strong> <em>I can see that! You look like a completely different person!</em> (你简直像换了一个人，注意completely的使用)<br><strong>X:</strong> <em>By the way, are you still sticking to your commitment?</em><br><strong>J:</strong> <em>My 30-day commitment ended two weeks ago, but I felt so good about myself that I decided to keep it as a healthy habit. I still try to do one good thing every day. I love it!</em></p><h4 id="2016-4-18-Getting-Money-Back"><a href="#2016-4-18-Getting-Money-Back" class="headerlink" title="2016.4.18 Getting Money Back"></a>2016.4.18 Getting Money Back</h4><p><strong>X:</strong> <em>Can I talk to you for a minute? I’d like to pick your brains about something.</em></p><blockquote><p>pick someone’s brains (询问/征求某人意见) Can I get your advice?</p></blockquote><p><strong>J:</strong> <em>I’m all ears, what’s up?</em></p><blockquote><p>I’m all ears (浑身上下都是耳朵，指在认真听，洗耳恭听)</p></blockquote><p><strong>X:</strong> <em>I lent my friend 500RMB two weeks ago, and he still hasn’t paid me back, I’m at a loss of what to do</em></p><blockquote><p>borrow sth from sb (从某人借某物)<br>lend sth to sb (借给某人某物)<br>pay me back (还钱给我)<br>I’m at a loss [of]…  我困惑.. 不知道怎么办  I don’t know what to do.</p></blockquote><p><strong>J:</strong> <em>You could give him the benefit of the doubt, maybe he forget about the money</em></p><blockquote><p>give sb the benefit of the doubt (暂且相信某人 站在对方的立场上想，给某人一次证明自己的机会)</p></blockquote><p><strong>X:</strong> * That’s a lot of money to forget about. I’m really starting to get angry now.*<br><strong>J:</strong> <em>I suggest you sit down with him and have a heart-to-heart talk. whatever you do, don’t lash out and accuse him of stealing your money, he really might have forgotten.</em></p><blockquote><p>heart-to-heart talk (坦诚的，开诚布公的谈话)<br>lash out (用言语攻击、狠批)  don’t lash out (不要说伤人的话，不要情绪太冲动失控)<br>accuse sb of doing sth (谴责/斥责/指控某人做某事， 不见得有证据的指控/斥责)</p></blockquote><p><strong>X:</strong> <em>I think I’d better keep him at arm’s length from now on</em></p><blockquote><p>keep sb at arm’s length (和某人保持距离)</p></blockquote><p><strong>J:</strong> <em>Don’t jump to conclusions so fast, talk to him about it first, and then draw your conclusion.</em></p><blockquote><p>jump to conclusions (妄下结论)<br>draw one’s conclusion (下结论)</p></blockquote><p><strong>X:</strong> <em>Okay, I’ll keep you posted</em></p><blockquote><p>keep you posted (告知某人某事，我会保持更新消息， 有消息就告诉你, 可以用在邮件书写中)</p></blockquote><p><strong>J:</strong> <em>Were you able to get your money back?</em></p><blockquote><p>get money back (还钱)</p></blockquote><p><strong>X:</strong> <em>Yeah, but it was no walk in the park.</em></p><blockquote><p>a walk in the park (轻而易举)<br>a pain in the neck (脖子上有疼痛，指不顺利，有麻烦)<br>twists and turns  (故事上的“曲折”) The story is twists and turns</p></blockquote><p><strong>J:</strong> <em>What do you mean?</em><br><strong>X:</strong> <em>I asked him if he could give me my money back, and he told me that it had completely slipped his mind.</em></p><blockquote><p>slip one’s mind (忘得一干二净)</p></blockquote><p><strong>J:</strong> <em>So did he give the money back to you then</em><br><strong>X:</strong> <em>He only gave me 300. He said he will give me the other 200 next week once he gets paid. But then I remembered that he was going on vacation next week, so I called him on his bluff</em></p><blockquote><p>call sb bluff （揭穿某人）</p></blockquote><p><strong>J:</strong> <em>Did he come clean?</em></p><blockquote><p>come clean (变得清晰 指说真话 老实交代)</p></blockquote><p><strong>X:</strong> <em>Yes, he apologized and gave me the other 200 the next day. He said he has been really tight for cash lately.</em></p><blockquote><p>tight for cash (手头紧)</p></blockquote><p><strong>J:</strong> <em>It sounds like youburied the hatchet with him?</em></p><blockquote><p>bury the hatchet (埋掉战争、斧头, 指“和解；冰释前嫌”)</p></blockquote><p><strong>X:</strong> <em>Yeah, I decided to let bygones be bygones. Now we’re back to being good friends,just like before.</em></p><blockquote><p>let bygones be bygones (过去的事就让过去吧， 既往不咎)</p></blockquote><p><strong>J:</strong> * I’m glad you listened to me and were able to remain friends with him.*</p><blockquote><p>remain friends (维持朋友关系)</p></blockquote><p><strong>X:</strong> <em>what would I do without you?</em></p><h4 id="2016-4-20-Taxi-English"><a href="#2016-4-20-Taxi-English" class="headerlink" title="2016.4.20 Taxi English"></a>2016.4.20 Taxi English</h4><p><strong>JJ is visiting NewYork for the first time. XG plays the part of the taxi driver.</strong><br><strong>JJ:</strong> <em>Thanks so much for stopping, do you know how to get to Times Square(时代广场) from here?</em></p><blockquote><p>how to get to smw from here? 从这怎样去smw</p></blockquote><p><strong>XG：</strong> <em>Hop in, so, is this your first time to The Big Apple?</em></p><blockquote><p>hop in （上车）/ hop out (下车)  hop本意是“跳”<br>NYC(NewYork city 别称叫The Big Apple)</p></blockquote><p><strong>JJ：</strong> <em>Yeah, it sure is, I never thought NewYork was <strong>this</strong> big, It reminds me of ShangHai,China</em></p><blockquote><p>It sure is (当然了，确实是这样)<br>this （此处表示强调， 增强描述语气）<br>remind sb of sth （让某人想起某事）</p></blockquote><p><strong>XG:</strong> <em>You’re from China, eh?  wow, that’s a long way from NewYork. when did you land?</em></p><blockquote><p>it’s a long way from swm (距离某地很远)<br>when did you land (什么时候到的) = when did you arrive</p></blockquote><p><strong>JJ:</strong> <em>Last night, I’m still a little jet lagged</em></p><blockquote><p>I’m still a little jet lagged (我现在仍然有点时差疲劳) tired from the time difference between two places<br>i’m lagging  (通常是指“我网络延迟”)</p></blockquote><p><strong>XG：</strong> <em>Well, welcome to Manhattan(曼哈顿) ， where else are you gonna see while you’re here?</em><br><strong>JJ:</strong> *I’m planning on visiting Central Park(中央公园) and of course , the Empire State Building(帝国大厦), maybe you can tell me some good places to visit? *</p><blockquote><p>I’m planning on doing sth (正打算某事)</p></blockquote><p><strong>XG：</strong> <em>It’d be my pleasure, I think you should add the Statue of Liberty(自由女神) to your list, it’s a must-see</em></p><blockquote><p>must-see(必看的[地方]) must-do(必做的[事情])</p></blockquote><p><strong>JJ：</strong> <em>tha’s a greate idea.</em><br><strong>XG:</strong> <em>If you’re into animals, you should check out the Bronx ZOO(布朗克斯动物园), The 9/11 memorial is also a place you can’t miss, and since you’re laddy, I bet you like shopping, right?</em></p><blockquote><p>be into sth (特别喜欢某物/事)<br>check out (去看看， 在酒店结账退房也可以用check out)<br>A place you can’t miss (非要去看不可的地方)<br>The 9/11 memorial is also a place you can’t miss (注意句子结构用法)</p></blockquote><p><strong>JJ：</strong> <em>That’s right</em><br><strong>XG：</strong> <em>Well， you’ll love downtown Manhattan(曼哈顿闹市区)， <strong>there’s enough shopping malls there to keep you busy for days</strong>. but make sure you save some money for Coney island(康尼岛), there’s a lot of things to do, If you have enough energy, You should check out NewYork’s night life, You won’t be disappointed.</em><br><strong>JJ:</strong> <em>Thanks so much, those are some great tips!(小攻略)</em><br><strong>XG：</strong> <em>Here we are, Times Square! That’ll be $32.50（thirty two dollars and fifty cents）</em><br><strong>JJ:</strong> <em>Here’s $35, <strong>keep the change</strong>. By the way, can you tell me how to get to the music store?</em></p><blockquote><p>keep the change = You can keep the tip(留着小费吧)</p></blockquote><p><strong>XG：</strong> <em>Sure, walk two blocks east. You’ll see it on your right.Good luck</em></p><blockquote><p>walk two blocks east (向东走两条街， 注意之路方向词的用法)</p></blockquote><p><strong>扩展：</strong></p><ol><li>纽约市共分为五区〈Borough〉：布朗〈The Bronx〉、布鲁克林〈Brooklyn〉、曼哈顿〈Manhattan〉、皇后〈Queens〉、及李奇文(又称为列治文)〈Richmond (Staten Island)〉。</li><li>put your arm out (伸出手，想象叫出租车的样子)</li></ol><h4 id="2016-4-25-Vacation-English"><a href="#2016-4-25-Vacation-English" class="headerlink" title="2016.4.25 Vacation English"></a>2016.4.25 Vacation English</h4><p><strong>Xiao Gao is checking into a hotel(办理入住酒店). Jing Jing plays the part of the front desk employee</strong><br><strong>JJ:</strong> <em>How may I help you?</em><br><strong>XG:</strong> <em>I have a reservation under the name Gao</em></p><blockquote><p>A: I have a reservation. B: under which name (用哪个名字预定的)</p></blockquote><p><strong>JJ：</strong> <em>Wait a moment while I’ll look you up, XG, is that right?</em></p><blockquote><p>look [sth] up (查询)</p></blockquote><p><strong>XG：</strong> <em>Yes, that’s right</em><br><strong>JJ:</strong> <em>It looks like you have booked a queen size bed?</em></p><blockquote><p>queen size bed （大床房） King size bed (超级大床房)</p></blockquote><p><strong>XG：</strong> <em>BTW, could you tell me some fun things to do around here? it’s my first time to Miami.</em><br><strong>JJ:</strong> <em>You asked the right person, I used to work as a tour guide before getting this job at the hotel, I think you should check out Miami beach, it’s a great place to get a tan, At Miami beach, you can go on a speed boat tour, afterwards（然后）, you should take a boat to the Bahamas(巴哈马)， it’s a paradise, you’ll love the restaurants and bars there</em></p><blockquote><p>you asked the right person (你问对人了)<br>get a tan (晒的美黑) (tan 既可以是名词， 也可以是动词 I’m tanning now)<br>get a sunburnt(晒红， 就是指晒伤了)<br>sea sick (晕船)<br>go on a speed boat(快艇)/sth tour (来一个…游)<br>it’s a paradise (就是一个天堂啊)</p></blockquote><p><strong>XG：</strong> <em>thanks, I’m gonna get my swim suit on and hit the beach</em></p><blockquote><p>swim suit (泳衣)<br>you look good  in the suit. the suit looks nice on you (注意介词in和on的使用)<br>hit the beach (奔向海滩，注意动词hit的使用，指去哪)</p></blockquote><p><strong>XG is at a restaurant at the Bahamas. Jing Jing plays the part of the restaurant employee</strong><br><strong>JJ：</strong> <em>Sir, table for one?</em></p><blockquote><p>table for one/two (一位/两位吗)<br>A: how many? (几位？) B: table for six (六个人)</p></blockquote><p><strong>XG</strong> <em>Yes, Please</em><br><strong>JJ:</strong> <em>Smoking or non?</em> (您想坐吸烟区还是非吸烟区)<br><strong>XG：</strong> <em>Non, please</em><br><strong>JJ:</strong> <em>right this way, *</em>Can I get started off with a something to drink?***</p><blockquote><p>right this way (这边请)<br>Can I get started off(start off 就相当于start) with a something to drink?</p></blockquote><p><strong>XG:</strong> <em>How about a martini(马丁尼)</em><br><strong>JJ:</strong> <em>Coming right up, do u still need a minute to look at the menu?</em></p><blockquote><p>coming right up (马上就来)</p></blockquote><p><strong>XG：</strong> <em>What are your specials today?</em> (今天的特价菜是什么？)<br><strong>JJ：</strong> <em>Today our specials are steak（牛排） and potatoes（土豆） and roasted salmon（烤三文鱼）. Do any of those sound good?</em><br><strong>XG：</strong> <em>I’ll go with the steak please.</em></p><blockquote><p>I’ll have / go with + 菜名  （我要点什么.. ）</p></blockquote><p><strong>JJ：</strong> <em>Okay, I’ll be right back with your order.</em> （您的单很快就来）<br><strong>JJ:</strong> <em>How are we doing? Can I get you another martini?</em></p><blockquote><p>how are we doing (怎么样，外国像国内需要叫服务员，他们会四处走来照顾顾客需求)</p></blockquote><p><strong>XG：</strong> <em>No, thank you, I’m feeling a bit tipsy already. I’ll take the check, though.</em></p><blockquote><p>I’m feeling a bit tipsy already(我感觉有点微醺了) / I’m feeling a little tipsy/woozy (I think I’ve caught a buzz). I gotta foot the bill.<br>I’ll take the check ， though(我要买单了, though就算是一种语气词“了”)</p></blockquote><p><strong>JJ：</strong> <em>You got it. Here you are. I’ll be back to pick that up in a few minutes.(我过一会回来拿）</em></p><blockquote><p>you got it (没问题)</p></blockquote><p><strong>扩展：</strong></p><ol><li>四大洋： the Pacific [pə’sɪfɪk] Ocean (太平洋),the Atlantic [ət’læntɪk] (Ocean)(大西洋),the Indian Ocean(印度洋),the Arctic [‘ɑrktɪk] Ocean (北冰洋)</li><li>Hurricane crashed the Florida last week (飓风上周袭击了弗罗里达州)</li></ol><h4 id="2016-5-4-House-Warming-Party"><a href="#2016-5-4-House-Warming-Party" class="headerlink" title="2016.5.4 House Warming Party"></a>2016.5.4 House Warming Party</h4><p><strong>JJ:</strong> <em>XG, how’s the guest list coming along?</em></p><blockquote><p>how’s [sth] coming along? (sth进展的怎么样，还没有结束)</p></blockquote><p><strong>XG：</strong> <em>It’s pretty good, I’ve already thought of 30 people who we should invite.</em><br><strong>JJ:</strong> <em>I think you should limit your guest list, after all we’re on a tight budget. hosting so many people could be really expensive.</em></p><blockquote><p>on a tight budget (预算有限)  注意和tight for cash的理解区别<br>hosting (邀请)</p></blockquote><p><strong>XG：</strong> <em>You’re right, what about invitations? maybe we should use social media instead of paper invitations in order to cut down on costs</em></p><blockquote><p>what about（直接提出选择、想法） 和 how about（有了一个，提出另外一个）<br>cut down on costs (减少开支)</p></blockquote><p><strong>JJ：</strong> <em>Good idea, make sure you request an RVSP so that we can play for foods and drinks better.</em></p><blockquote><p>RVSP (Répondez s’il vous plait(French for “please respond”) 敬请回复,收到请回复)</p></blockquote><p><strong>XG：</strong> <em>Speaking of food, I think we should have finger foods that people can munch on while they mingle.</em></p><blockquote><p>speaking of [sth] (说道sth)<br>saying [sth] （比如sth）<br>finger foods (foods that are convenient to eat with your hands 能用手拿着吃的方便食物)<br>mingle (Mingle = to socialize 陌生人之间的社交)</p></blockquote><p><strong>JJ:</strong> <em>I was thinking we should hire a catering service to provide our food . that way we can focus on decorating our new home, we want it to look nice when the guests arrive.</em></p><blockquote><p>catering service (a service that provides food for an event or party 为特定活动提供餐饮服务)</p></blockquote><p><strong>XG：</strong> <em>Great party huh？</em><br><strong>JJ：</strong> <em>Yeah， it sure is, the music is great, and the food is even better.</em></p><blockquote><p>it sure is (确实，给与肯定)</p></blockquote><p><strong>XG：</strong> <em>Who do you know here?</em> (你都认识这里的谁，注意表达)<br><strong>JJ：</strong> <em>I’m JJ’s friend, we went to school together.</em></p><blockquote><p>we went to school together (可以表示我们过去时同学)</p></blockquote><p><strong>XG：</strong> <em>Oh cool. Xiao Gao and I are on the same basketball team. Nice to meet you. I’m Bob, by the way.</em></p><blockquote><p>注意口语对话中 by the way 的使用， 顺便介绍一下自己</p></blockquote><p><strong>JJ：</strong> <em>I’m Jennifer. Nice to meet you too. Did you get to go on a tour of the place yet? It’s such a nice home. I’m so happy for them</em></p><blockquote><p>go on a tour of the place (在这个房子里四处转转了吗？)  联想 go on a speed boat tour (来一个快艇游)  注意灵活使用</p></blockquote><p><strong>XG：</strong> <em>Yeah, I’m surprised at how much space they have. Anyways, would you like to go grab some refreshments（零食，点心）? I see you’re almost done with your drink. The turkey is splendid（非常好）.</em></p><blockquote><p>sb is done with sth (某人的sth快做完了/sth快没了)  I’m done with my work.</p></blockquote><p><strong>JJ：</strong> <em>I’m a vegan（ 严格素食主义者）, so I don’t eat meat. But I’ll join you for some more spirits.</em></p><blockquote><p>spirits (we just use the word “spirits” to refer to liquor(酒) in general, so we only use it in plural(复数) form (spirits). We can’t say “I’d like a spirit”, instead we should say specifically what kind you want, such as “I’d like a shot of vodka” or “I’d like a glass of whiskey”)</p></blockquote><p><strong>XG:</strong> <em>Do you think I could get your phone number? You seem like a really cool person. We’re always looking for more members on our basketball team. It’s open to both guys and girls. Think you’d be interested?</em></p><blockquote><p>在国外要异性电话就是对对方有好感， 委婉一些可以提出一些借口如（You seem like a really cool person）</p></blockquote><h4 id="2016-5-9-Obsessive-Compulsive-Disorder-（OCD）"><a href="#2016-5-9-Obsessive-Compulsive-Disorder-（OCD）" class="headerlink" title="2016.5.9 Obsessive Compulsive Disorder （OCD）"></a>2016.5.9 Obsessive Compulsive Disorder （OCD）</h4><p><strong>JJ：</strong> <em>Quit biting your nails, it’s a bad habit.</em><br><strong>XG:</strong> <em>It’s a bad habit, I’ve done it since I was a kid.</em><br><strong>JJ:</strong> <em>Sounds like you got OCD, do you do it a lot?</em><br><strong>XG:</strong> <em>Yeah, pretty often, do you ever tweak out about things like that?</em></p><blockquote><p>tweak out about sth = freak out about sth = worry about sth</p></blockquote><p><strong>JJ:</strong> <em>Sometimes, when I’m about to put my earbuds(塞入式耳机) in to listen to music, I always have to make sure that the R and L are in the correct ear.</em></p><blockquote><p>be about to do sth(马上要做某事)  I’m about to leave. (我马上要离开)</p></blockquote><p><strong>XG：</strong> <em>Do you know what else drive me nuts? After I set the alarm at night to wake me up in the morning, I gotta check again like 5 minutes later to make sure I acturally set it.</em></p><blockquote><p>drive sb nuts/crazy/bonkers/up the wall 让某人抓狂</p></blockquote><p><strong>JJ：</strong> <em>Year, sometimes I have to make sure over and over that I locked the door at night before I sleep.</em></p><blockquote><p>over and over (反复，一遍又一遍）</p></blockquote><p><strong>XG：</strong> <em>I can’t stand it when someone doesn’t completely clean the blackboard in school, I feel really weird in class and keep looking at.</em></p><blockquote><p>I can’t stand it (我不能忍受)</p></blockquote><p><strong>JJ：</strong> <em>I remember when I was going to school and our test grades would be out for us to look at, I would never go and see my score.</em><br><strong>XG:</strong> <em>Sounds like we’re both a little OCD. Hey, what does OCD stand for anyway?</em><br><strong>JJ:</strong> <em>You tell me! Why don’t you go home and do some research about it?</em><br><strong>XG:</strong> <em>Geez, is being bossy one of your OCD habits too?</em>  (天哪，难道发号施令也是你的强迫症症状之一吗？)<br><strong>JJ:</strong> <em>So, what did you find out about OCD?</em><br><strong>XG:</strong> <em>it stands for <strong>Obsessive Compulsive Disorder</strong>, Basicly it’s when you have a lot of anxiety and you do a lot of repetitive behaviors to make the anxiety go away.</em></p><blockquote><p>(大致就是说你有很多的焦虑，并且必须通过重复某种行为才让这种焦虑消失。)</p></blockquote><p><strong>JJ:</strong> <em>What kinds of behaviors are you talking about? Did you find out about anything new</em><br><strong>XG:</strong> <em>Yeah I did. Do you know what hoarders(囤积控) are?</em></p><blockquote><p>herder (牧人)</p></blockquote><p><strong>JJ:</strong> * I think so. Aren’t they the people who have to round up a bunch(群) of sheep?*</p><blockquote><p>round up sth (收集 聚集 归拢 )</p></blockquote><p><strong>XG：</strong> * No, those are called herders（牧人）, I’m talking about hoarders! H-O-A-R-D-E-R-S. Hoarders! Hoarding is when you keep a lot of things and don’t throw them away, even if they are worthless or meaningless.*<br><strong>JJ：</strong> <em>I don’t know, Xiao Gao… Your room is pretty messy（杂乱的）. Do you think you might ….</em></p><blockquote><p>messy (指家，办公室，头发杂乱的，小朋友吃饭弄得哪里都是也可以用 )</p></blockquote><p><strong>XG：</strong> <em>Hey! My room is messy but it’s not that bad!</em><br><strong>JJ：</strong> <em>Anyways, do a lot of people suffer from this disorder?</em><br><strong>XG：</strong> <em>It’s fairly（相当） common. Actually, it’s the fourth-most diagnosed mental（心理的） disorder. <strong>One in fifty</strong> people have been diagnosed with it in the United States.</em><br><strong>JJ：</strong> <em>Uh oh! We’re doomed! We probably have it too!</em></p><blockquote><p>You’re so dead (你死定了)  We’re doomed（我们死定了）</p></blockquote><p><strong>XG：</strong> <em>Don’t worry! I think we’re okay. I also learned that just because you might have some obsessive behaviors, doesn’t mean that you have OCD.</em><br><strong>JJ：</strong> <em>Is it treatable?</em><br><strong>XG：</strong> <em>Yes. The good news is that this mental disorder is treatable with therapy(治疗，疗法) and medication!</em></p><h4 id="2016-5-11-At-The-Crossroads"><a href="#2016-5-11-At-The-Crossroads" class="headerlink" title="2016.5.11 At The Crossroads"></a>2016.5.11 At The Crossroads</h4><p><strong>JJ:</strong> <em>Hey,XG why do you look so stressed out? do you have a lot of homework or something?</em></p><blockquote><p>stressed out (抓狂)<br>or something 放在问句的结尾类似汉语的“..吧/吗”</p></blockquote><p><strong>XG：</strong> <em>Well， it’s just it, school’s going fine this year… but I’m not sure about next year.</em></p><blockquote><p>well, it’s just it (就是这么回事)<br>I’m not sure about sth (不确定sth)</p></blockquote><p><strong>JJ：</strong> <em>I don’t get it, you said school’s going fine now, why do you have an issue at school year?</em></p><blockquote><p>I don’t get it (我没明白) = I don’t understand<br>You got it (多数是回答对话指“没问题”)</p></blockquote><p><strong>XG:</strong> <em>The way things are looking now, I don’t think I’ll be able to fork up enough money for tuition next year.</em></p><blockquote><p>the way things are looking now (照目前来看)<br>fork up <a href="支付，花一大笔钱">money</a> = pay a large amount of money.</p></blockquote><p><strong>JJ:</strong> <em>That’s not good, so what are you gonna do?</em><br><strong>XG:</strong> <em>I was planning on working at a factory this summer and saving up some money and maybe take out a student loan, that way, I should be able to go to school next year.</em></p><blockquote><p>take out a [student] loan  (申请助学贷款)<br>that way (那样的话)<br>save up (储蓄， 存储)</p></blockquote><p><strong>JJ：</strong> <em>Problem solved, right? what are you worrying about?</em></p><blockquote><p>worry about sth = tweak out about sth = freak out about sth</p></blockquote><p><strong>XG:</strong> <em>I got a job offer to work as an English teacher, I wouldn’t be able to go to school on such a low salary, but I think it would be really fun, so now I’m having second thoughts, Maybe I should take the teaching English position instead.</em></p><blockquote><p>have second thoughts (犹豫，再加思索)<br>on second thought (经过再次思考)<br>instead 放在句尾使用</p></blockquote><p><strong>JJ：</strong> <em>You have to think this through carefully, On one hand the English teaching job is fun, that’s right, but on the other hand you wouldn’t be able to fulfill your long term goal of getting a bachelor’s degree, I don’t think it’s in your best interests to take the English teaching job</em></p><blockquote><p>think sth through [carefully] (充分的考虑某事)<br>on one hand … on the other hand … （一方面… 另一方面…）<br>fulfill your long term goal (完成/实现长远目标， fulfill 可以指完成目标、需求、愿望)<br>in one’s best interests (对某人最好的利益， 是某人最好的选择)</p></blockquote><p><strong>XG：</strong> *But I think that teaching job will help me in the future to land a better job, don’t you think it will look good on my resume, if I had some teaching experience. *</p><blockquote><p>land a job (获得工作)<br>注意experience是经验的时候不可数</p></blockquote><p><strong>JJ：</strong> <em>It might help, but I think having a bachelor’s degree on your resume will look even better. you really have to weight the pros and cons</em></p><blockquote><p>在简历上用 on resume<br>weight the pros and cons (权衡利弊)</p></blockquote><p><strong>XG：</strong> *But working in the factory will be so boring, I’d much rather do something that would make me happy, it’s always been one of my dreams *</p><blockquote><p>I would rather do sth(我宁愿做sth)</p></blockquote><p><strong>JJ:</strong> <em>Well, that’s part of growing up and being responsible. This experience will make you a better and more responsible person in the future. Trust me, a bachelor’s degree is worth much more than a temporary English teaching job. Plus, you don’t even know for sure if you’ll like teaching English. Anyways, you could always make learning English your hobby at night when you come home from work. Next semester at school, maybe you could take an English elective class. If you’re certain you really like teaching English, then next semester maybe you could tutor a child on the weekend and at the same time make some extra money?</em></p><blockquote><p>that’s part of growing up （这就是成长的一部分）<br>A is worth much more than B  (A比B更有价值/意义)<br>elective class (选修课) mandatory class(必修课)<br>tutor a child (指导孩子，做家教)</p></blockquote><p><strong>XG：</strong> <em>Okay, you’ve convinced me. I’m gonna do what’s best for myself and work hard to earn enough money to pay for school! Thanks so much, Jing Jing.</em></p><blockquote><p>you’ve convinced me (你说服了我)</p></blockquote><h4 id="2016-5-16-Left-and-Right-Handedness"><a href="#2016-5-16-Left-and-Right-Handedness" class="headerlink" title="2016.5.16 Left and Right Handedness"></a>2016.5.16 Left and Right Handedness</h4><p><strong>JJ:</strong> <em>Have you ever wondered how hard it must be for people who are left-handed(左撇子) to use a computer, the computer mouse is made for right-handed(右撇子) people.</em></p><blockquote><p>Have you ever wondered … （你有没有想过…）<br>mouse (鼠标)， wireless mouse (hamster仓鼠， 因为没有尾巴.)</p></blockquote><p><strong>XG:</strong> <em>Year, it must be hard, my sister is lefty and she seems to do alright.</em></p><blockquote><p>lefty (左撇子， 比left-handed 更加口语化)</p></blockquote><p><strong>JJ：</strong> <em>So do people choose to be left-handed or is it something that they’re born with?</em></p><blockquote><p>something that they’re born with (他们与生俱来的，他们生来就有的)</p></blockquote><p><strong>XG：</strong> <em>The actual reasons why some people are left-handed are still a little vague（谜）, but scientists think that it has to do with people’s genetics（遗传学，基因学） and the environment they grew up in. Studies also show that about 15% of the population is left-handed.</em></p><blockquote><p>vague (谜)<br>the environment they grew up in (注意in不能丢掉， 成长<strong>在</strong>环境中)<br>studies/study/research show[s] 研究表明</p></blockquote><p><strong>JJ：</strong> <em>So besides holding a pen with their left hand, are there any other differences between left-handers and right-handers?</em><br><strong>XG：</strong> <em>Actually, yes.</em><br><strong>JJ：</strong> <em>I heard left-handed people are kinda clumsy（笨拙的）, is that true?</em><br><strong>XG：</strong> <em>No, it’s not. There are a lot of social stigmas（社会偏见） about left-handed people that are completely false.In reality, left-handed people tend to be more athletic（运动的）. Also, left-handed people seem to have better problem-solving skills.</em></p><blockquote><p>social stigmas (社会偏见，指根深蒂固的偏见) —— To be a nonreader carries a social stigma.<br>bias about/against sth (对某事有偏见)  bias toward/against sb (对某人.. 的偏见)<br>outright wrong (完全没有根据的错误)</p></blockquote><p><strong>JJ:</strong> <em>Wow, I kinda wish I were left-handed now</em><br><strong>XG:</strong> <em>Did you know that a lot of famous people were left-handed? Like Barak Obama and Prince William of England.</em><br><strong>JJ:</strong> <em>That’s really interesting. I’m gonna go home and see what I can learn about right-handed people now. Take care!</em></p><blockquote><p>A: see ya B: take care / A: take care B: see ya （对话中双方）</p></blockquote><p><strong>XG：</strong> <em>See ya.</em><br><strong>JJ：</strong> <em>So, did you find out anything about right-handed people?</em></p><blockquote><p>find out sth （调查/查询到sth）</p></blockquote><p><strong>XG：</strong> <em>Well, there’s one major plus to being a right-handed person: most items in life are geared towards right-handed people. Everything from water bubblers to door handles.Other than that, there’s really no intellectual advantage to being right-handed.</em></p><blockquote><p>plus (在此处指“好处，优点”)<br>gear toward sb (专门为sb制造的)<br>water bubblers (饮水机) water fountain (户外饮水泉)<br>other than that (除此之外)</p></blockquote><p><strong>JJ：</strong> * So, do right-handed people use the right side of their brain and left-handed people use the left?*<br><strong>XG：</strong> <em>No, it’s actually the opposite. Right-handed people are left-brain oriented and vice versa.</em></p><blockquote><p>money oriented (金钱导向的)<br>vice versa (反之亦然)</p></blockquote><p><strong>XG：</strong> <em>Are there any people that can use both left and right hands equally well?</em><br><strong>JJ：</strong> <em>Yes, these people are called ambidextrous（ 双手都使用得非常灵巧的）. It’s incredibly rare, but you can actually teach yourself to become ambidextrous.</em><br><strong>XG：</strong> <em>Really? So you mean I could teach myself how to use my left hand to do things?</em><br><strong>JJ：</strong> <em>Yes, but don’t expect it to be a cinch. You might have grey whiskers by the time you master it.</em></p><blockquote><p>a cinch = walk in a park = a piece of cake<br>have grey whiskers  (白发苍苍，指变老的时候)</p></blockquote><p><strong>XG:</strong> <em>Cool,well,I’m gonna go practice some left-handed food eating. You coming?</em></p><blockquote><p>you coming? (你来吗)</p></blockquote><h4 id="2016-5-23-Personality-Traits"><a href="#2016-5-23-Personality-Traits" class="headerlink" title="2016.5.23 Personality Traits"></a>2016.5.23 Personality Traits</h4><p><strong>XG:</strong> <em>Ouch! I just got bit again by another skeeter(蚊子)! I think summer is just around the corner.</em></p><blockquote><p>Summer is just around the corner (夏天就要来了)</p></blockquote><p><strong>JJ：</strong> <em>Yeah, you must have sweet blood.</em><br><strong>XG：</strong> <em>Well, all I know is that my blood type is “A”, I’m not sure if it’s sweet or not.</em><br><strong>JJ：</strong> <em>Oh, you know your blood type eh? Did you know that there’s been a lot of research done about blood type in relation to personality?</em><br><strong>XG：</strong> <em>No, I didn’t,can you enlighten me?</em></p><blockquote><p>enlighten me (给我讲讲，让我明白受教)</p></blockquote><p><strong>JJ：</strong> <em>As you know,there are four possible blood types that a human being can have: A, B, AB, and O. Since you’re A, let me tell you a few things about your personality.</em><br><strong>XG：</strong> <em>Okay, give it your best shot.</em></p><blockquote><p>Let me give it a shot (让我试一试)<br>give it your best shot (你来试试吧)</p></blockquote><p><strong>JJ：</strong> <em>Most type As are sensitive to the needs of others and are good listeners.</em><br><strong>XG：</strong> <em>Yeah, well,doesn’t this describe everyone?</em><br><strong>JJ：</strong> * Hold on! I’m not done yet! You’re also detail-oriented, creative and inventive. On the outside, you seem really calm, but on the inside, you are filled with anxiety and worry.*</p><blockquote><p>on the outside (在外表看来) on the inside (在内心看来)</p></blockquote><p><strong>XG：</strong> <em>You’re lying! I think you are describing me on purpose.</em></p><blockquote><p>… on purpose (… 是故意的)</p></blockquote><p><strong>JJ：</strong> <em>I’m not kidding! The research really shows this. Also, type As are usually shy and sensitive, and a lot of them are perfectionists（完美主义者）.</em><br><strong>XG：</strong> <em>That’s me to a T!</em></p><blockquote><p>.. to a T (表示准确极了，完全精准的描述)</p></blockquote><p><strong>JJ：</strong> <em>Romantically,type As work best with other type As and ABs.</em></p><blockquote><p>Romantically (感情上说)</p></blockquote><p><strong>XG：</strong> <em>What do type As end up doing for jobs?</em><br><strong>JJ:</strong> <em>Common type A career choices include accountants, librarians, economists, computer programmers and writers.</em><br><strong>XG:</strong> <em>I was once a computer programmer! Does it say anything about us being really stressed out(压力大)?I’m usually pretty tense（紧张） during the day.</em><br><strong>JJ：</strong> <em>Yes it does,actually. Most type As often bottle up anxiety in order to get along with others. Many of them are tense, impatient, and unable to sleep well.</em></p><blockquote><p>bottle up emotions [anxiety] (把焦虑藏起来，想象瓶子装起来一个东西并且把瓶塞塞上，在感情藏在心里，不告诉别人，也不释放出来)</p></blockquote><p><strong>XG：</strong> <em>Ahh! It’s like you’re reading my mind! What blood type are you? Tell me now!!</em></p><blockquote><p>read my mind (读心)</p></blockquote><p><strong>JJ：</strong> <em>That’s for you to determine. Go home and research all the different blood types, then let’s see if you can guess it correctly!</em><br><strong>XG:</strong> <em>Okay, Jingjing, I’ve done my research. I think I know which blood type you are.</em><br><strong>JJ:</strong> <em>Oh yeah? Which one?</em><br><strong>XG:</strong> <em>You’re a type B!</em><br><strong>JJ:</strong> <em>You’re right.But how did you come to that conclusion?</em></p><blockquote><p>come to that conclusion. (怎么得出这个结论，有一个循序渐进的过程在里面)</p></blockquote><p><strong>XG:</strong> <em>Well, it said type Bs are easygoing(随和的), creative, original and flexible.</em><br><strong>JJ：</strong> <em>Can you say something more concrete（具体的）?</em><br><strong>XG：</strong> <em>Well, it says that type Bs are globally-oriented people. Also, it says that you learn best through listening. On top of that（并且）, it says you are goal-oriented and ambitious.</em></p><blockquote><p>on top of that (并且)</p></blockquote><p><strong>JJ：</strong> <em>It’s true, I am good at listening, that’s why I like working on the radio.</em><br><strong>XG：</strong> * It also said you aren’t a very picky person, and you don’t worry about little things too much.*</p><blockquote><p>a picky person (一个挑剔的人，计较的人)</p></blockquote><p><strong>JJ:</strong> <em>Yup, for example, I don’t say anything to you when you come to work dressed like a slob (没有条理，邋遢的人).</em><br><strong>XG:</strong> <em>Hey! That wasn’t very nice.</em><br><strong>JJ:</strong> <em>How about romance-wise?</em></p><blockquote><p>romance-wise (感情方面，感情角度)<br>time-wise (时间方面，时间角度)</p></blockquote><p><strong>XG：</strong> <em>Type Bs do best with other type Bs and ABs.</em></p><blockquote><p>do best with others = work together well.</p></blockquote><p><strong>JJ:</strong> <em>Anything else?</em><br><strong>XG:</strong> <em>Basically, you are thoughtful like type As and ambitious like Os. It’s a very interesting blood type. But do you know what the smoking gun was that made me convinced you were blood type B?</em></p><blockquote><p>smoking gun (让你破案的线索，确凿证据，  想象冒烟的枪，破案的线索)</p></blockquote><p><strong>JJ：</strong> <em>No, what was it?</em><br><strong>XG：</strong> <em>Common career choices for type B, such as cooks, military leaders（军官）, talk show hosts and journalists!</em><br><strong>JJ：</strong> <em>That’s me,indeed! Good job, Greg! So we talked about blood type As and blood type Bs, but do you remember me telling you there was also a blood type AB?</em></p><blockquote><p>do you remember sb doing sth</p></blockquote><p><strong>XG:</strong> <em>Yeah, Ido, I found them to be the most interesting of all!</em><br><strong>JJ:</strong> <em>Me too. Not surprisingly, they have both A and B traits(特性).Sometimes they’re shy and outgoing（外向的，extroverted）, hesitant and confident.</em><br><strong>XG:</strong> <em>Type ABs often stand out like a sore thumb among other types. They are trustworthy and like to help others.</em></p><blockquote><p>stand out like a sore thumb （杰出，突出，鹤立鸡群）<br>trustworthy (可靠的)</p></blockquote><p><strong>JJ：</strong> <em>They also think logically and are determined to do things correctly.</em></p><blockquote><p>think logicaly/emotionally/rationally (逻辑、感性、理性)</p></blockquote><p><strong>XG：</strong> <em>Type ABs can find a soul mate with any other blood type.</em></p><blockquote><p>soul mate （灵魂伴侣）</p></blockquote><p><strong>JJ：</strong> <em>Did you know that both John F. Kennedy and Marilyn Monroe are type ABs?</em><br><strong>XG：</strong> <em>Yeah, what a coincidence! What’s even more interesting is that only about 2%～5% of the population are blood type AB.</em></p><blockquote><p>what a coincidence (太巧了)</p></blockquote><p><strong>JJ：</strong> <em>They’re really charming（迷人的，可爱的） and popular. They don’t sweat the small stuff.</em></p><blockquote><p>sweat the small stuff (不拘小节，不纠结于小事情, 不为小事烦心)</p></blockquote><p><strong>XG：</strong> <em>So what do type ABs usually do for work?</em><br><strong>JJ：</strong> <em>Well, some common type AB careers are bartenders（调酒师）, lawyers, teachers and sales people（销售）.</em><br><strong>XG：</strong> <em>There’s never a dull moment in a type ABs life. If you can find one for a friend, consider yourself lucky! Well, we’ve talked about A, B, and AB. We haven’t even said a thing about type O yet.</em></p><blockquote><p>There’s never a dull moment in sth (在sth上一点也不单调)  There’s never a dull moment in GFG<br>consider yourself lucky (你实在太幸运了)</p></blockquote><p><strong>JJ：</strong> <em>Type Os are really unique. They’re responsible, decisive（有决心的）, organized（有条理的）, and practical（务实的）.</em><br><strong>XG：</strong> <em>That’s right. Type Os are shot callers. They often end up being bankers,politicians, gamblers（赌徒）, investment brokers（投资经纪人）, and pro athletes</em></p><blockquote><p>shot caller (法令开枪的人，指“决策人”)</p></blockquote><p><strong>JJ：</strong> <em>They tend to be loners（独行侠） or leaders and are self-reliant（自立的） and daring（勇敢的）.</em><br><strong>XG：</strong> <em>They cope with stress better than any other blood types and don’t get sick that much.</em></p><blockquote><p>cope with sth (处理sth) （可以再也不用handle了， 欧耶）</p></blockquote><p><strong>JJ：</strong> <em>They also have a strong build （健康的体魄）and like to stay active.</em><br><strong>XG：</strong> <em>Being hard-headed（头脑清晰冷静的） and determined to succeed helps them to reach their goals.</em></p><blockquote><p>be determined to do sth (决心要做某事)<br>reach one’s goal (实现目标)</p></blockquote><p><strong>JJ：</strong> <em>They’re also really creative and are often the center of attention.</em></p><blockquote><p>the center of attention (关注的焦点) Children offen wanna be the center of attention.</p></blockquote><p><strong>XG:</strong> <em>That’s right, they are the social butterflies that you meet in life from time to time.</em></p><blockquote><p>social butterfly (善于交际的，没有贬义)<br>from time to time (不时，有时）</p></blockquote><p><strong>JJ：</strong> <em>What I found most interesting is that they seem to use their five senses better than the other blood types.</em><br><strong>XG：</strong> <em>Well, now we know a lot more about different blood types. I’m still surprised at how accurately it described me.</em></p><blockquote><p>be surprised at sth (吃惊… )</p></blockquote><h4 id="2016-6-1-Awesome-Brand-New-Book-Is-Out"><a href="#2016-6-1-Awesome-Brand-New-Book-Is-Out" class="headerlink" title="2016.6.1 Awesome Brand New Book Is Out"></a>2016.6.1 Awesome Brand New Book Is Out</h4><p><strong>JW:</strong> <em>Hey, Anya. How’s it hanging? What are you doing</em></p><blockquote><p>how’s it hanging? = what’s going on? = how you’re doing ? （最近怎么样）</p></blockquote><p><strong>AY:</strong> <em>I’m listening to Going for Gold. Normally I’d be studying the book, but I’ve already gone through the whole thing</em></p><blockquote><p>normally (一般来说)<br>Go through the whole thing = to finish something entirely, front to back (完成某事)</p></blockquote><p><strong>JW:</strong> <em>Oh, I love Going for Gold. I can’t imagine life without it.</em></p><blockquote><p>I can’t imagine life without it (标准句型，注意使用，“不敢想象生活没有它会怎样”)</p></blockquote><p><strong>AY：</strong> <em>Me too. I bought Jing Jing and Xiao Gao’s first book last year. Also, I listen to their show using an app on my phone. I like to look at the script（文本） on WeChat</em><br><strong>JW：</strong> <em>:I get home from work pretty late at night, but Jing Jing always hosts an evening show online for those of us who like to self-study（自学）. I’ve gotten so much out of it. I’ve learned so many native phrases(用语，短语)!</em></p><blockquote><p>I’ve gotten so much out of it (我觉得收获很大)</p></blockquote><p><strong>AY:</strong> <em>This is the best program I’ve ever listened to. It totally changed the way I study English. I wasn’t learning native stuff in the past, in fact it was mostly Chinglish（中式英语）. By following Going for Gold, not only have I learned how to express myself, but I’ve learned correct pronunciation and have gained confidence in speaking.</em></p><blockquote><p>gain confidence (获得自信) improve confidence (提升自信)</p></blockquote><p><strong>JW：</strong> <em>The first book was awesome because it came with an MP3 CD. The second book is even better because you can download the dialogues for free. I’m definitely buying the second book so I can keep learning.</em></p><blockquote><p>sth1 came with sth2 (sth1随身附带sth2)</p></blockquote><p><strong>AY：</strong> <em>:I’ve already passed the show on to several of my friends, classmates, and even family members. I really liked watching Xiao Gao’s videos that he used to post on Weibo. I hope he posts more in the future. It was a great way to learn!</em></p><blockquote><p>pass sth on to sb = to share [something] with other people (多指口头分享)<br>post (发布东西)</p></blockquote><p><strong>JW：</strong> <em>I heard there was a way to get an autographed copy of the new book. Is that true?</em></p><blockquote><p>autographed copy of the new book (新书的签名版)</p></blockquote><p><strong>AY：</strong> <em>Yeah, we just have to follow Jing Jing’s Weibo account and forward comments about the book, then we’ll be eligible for a raffle（抽奖）. They’ll announce the winners on the weekend.</em></p><blockquote><p>be eligible for sth/doing sth (有资格做某事)</p></blockquote><p><strong>JW：</strong> <em>I heard this book is a limited edition. I’d better hurry up and buy it!</em></p><blockquote><p>limited edition (限量版)<br>I’d better hurry up and buy it! (我得赶紧入手)</p></blockquote><p><strong>AY：</strong> <em>Yeah, what are you waiting for? Next Monday will be the first class of the new book. I’m gonna participate more in the WeChat challenges each week, because the more I practice, the better I get. This is another reason why I love this radio show so much!</em><br><strong>JW：</strong> <em>Hey, we forgot the most important part: Going for Gold is free! We can learn so many things without paying anything. That is so awesome!</em></p><blockquote><p>so much feedback (注意用much)</p></blockquote><h4 id="2016-6-6-Bad-Habits"><a href="#2016-6-6-Bad-Habits" class="headerlink" title="2016.6.6 Bad Habits"></a>2016.6.6 Bad Habits</h4><p><strong>JJ:</strong> <em>Pee yew! What’s that awful smell?</em></p><blockquote><p>Pee yew (咿呀, 口语化的表达， 通常和 what’s that awful smell 什么味道这么难闻)</p></blockquote><p><strong>XG:</strong> <em>Don’t look at me! I took a shower today!</em></p><blockquote><p>take a shower (洗澡，指淋浴)  shower 也可以当动词使用， I showered today (我今天洗澡了)</p></blockquote><p><strong>JJ：</strong> <em>No, I mean… something smells like smoke. *<br><strong>XG：</strong> *Oh, I recently picked up a bad habit. I started smoking a few weeks ago</em></p><blockquote><p>pick up a bad habit （养成一个坏习惯）</p></blockquote><p><strong>JJ：</strong> <em>Really? Why did you start doing that?</em></p><blockquote><p>Why did you start doing that (你是怎样开始的？ )</p></blockquote><p><strong>XG：</strong> <em>I bummed a cigarette from my friend one day. After that, I got hooked.</em></p><blockquote><p>bum (to ask someone for something without intending to pay for it), (有一天我从我朋友那儿顺了一根烟)<br>get hooked [on sth] ([对某事]上瘾)</p></blockquote><p><strong>JJ：</strong> <em>Well, I think you should kick the habit!</em></p><blockquote><p>kick the habit (改掉那个习惯)</p></blockquote><p><strong>XG：</strong> <em>I want to, but it’s really hard!</em><br><strong>JJ：</strong> <em>You know what they say: Bad habits are like comfortable beds, easy to get into, hard to get out of.</em></p><blockquote><p>you know what they say [that]…(俗话说…)</p></blockquote><p><strong>XG:</strong> <em>You can say that again. So, do you have any suggestions on how to quit?</em></p><blockquote><p>you can say that again (你说的太对了，用以表示“肯定”)<br>suggestions on … (…的建议)</p></blockquote><p><strong>JJ：</strong> <em>I heard the patch（戒烟贴片） works really well. Why don’t you give it a try and see if it helps?</em><br><strong>XG：</strong> <em>Okay, I’ll give it a shot. Talk to you later!</em><br><strong>JJ：</strong> <em>Hey, Xiaogao.Were you able to quit smoking yet?</em><br><strong>XG：</strong> * Yes, thank God! It was really hard, but I finally did it.*</p><blockquote><p>It was really hard, but I finally did it (可以常用，表示经过一番努力取得成功，很有成就感的感脚)</p></blockquote><p><strong>JJ：</strong> <em>I’m sure it was, after all, old habits die hard. So did you use the patch?</em></p><blockquote><p>old habits die hard (旧习难改)</p></blockquote><p><strong>XG：</strong> <em>No, the patch was a rip off, so I didn’t buy it.</em></p><blockquote><p>sth is a rip off (…太贵了)</p></blockquote><p><strong>JJ：</strong> <em>So how did you do it?</em><br><strong>XG：</strong> <em>I went cold turkey. It’s the cheapest and most effective method there is.</em></p><blockquote><p>go/went code turkey (采用简单粗暴的方法, 立刻完全停止做某事，不借助任何药物的帮助，也不给自己留时间慢慢来)</p></blockquote><p><strong>JJ：</strong> <em>Wow, good for you! How do you feel now? Did you have any withdrawals?</em></p><blockquote><p>withdrawal (副作用，瘾。因为没有获得足够自己已经上瘾的物质，例如咖啡因、尼古丁、酒精等，而造成的难受的感觉)<br>phisical suffering</p></blockquote><p><strong>XG：</strong> <em>For the first three days I had a headache,after that it was smooth sailing.</em></p><blockquote><p>smooth sailing (一帆风顺)</p></blockquote><p><strong>JJ：</strong> <em>Well, I’m glad you’ve given yourself a new lease of life. In the future, don’t bum anymore cigarettes!</em></p><blockquote><p>a new lease of life=新面貌，在经历一段艰辛后迎来的崭新生活<br>don’t bum anymore cigarettes (以后可别再沾烟了)</p></blockquote><p><strong>XG:</strong> <em>I learned my lesson, I won’t make that mistake again!</em></p><blockquote><p>I learned my lesson.=吸取了教训。指某人犯过一次错误后，不会再犯类似的错误。<br>I won’t make that mistake again = 我不会再犯那样的错</p></blockquote><h4 id="2016-6-13-Getting-Along-with-Co-workers"><a href="#2016-6-13-Getting-Along-with-Co-workers" class="headerlink" title="2016.6.13 Getting Along with Co-workers"></a>2016.6.13 Getting Along with Co-workers</h4><p><strong>XG:</strong> <em>Ohhh, Jingjing! I have been having the worst time at work lately! My co-workers are driving me up the wall.</em></p><blockquote><p>drive sb nuts/crazy/up the wall/bonkers/ lose sb’s nerve</p></blockquote><p><strong>JJ:</strong> <em>Well, you came to the right person. You know I’m always here to listen when you want to vent your feelings. So what’s up? Who is bothering you and why?</em></p><blockquote><p>you came to the right person (你问对人了)<br>vent one’s feelings (吐槽，发泄情绪)</p></blockquote><p><strong>XG：</strong> <em>Well, my cube mate, Jerry, smacks gum all day. It’s so distracting（分心的） and discourteous（无礼的）!</em></p><blockquote><p>cubicle的口语化简称 cube (指办公室的工位)<br>smack gum (嚼口香糖出声音)<br>slurp  smack （都指出声音的咀嚼东西）</p></blockquote><p><strong>JJ：</strong> <em>Have you ever thought about asking him to not chew so loudly? Or how about asking your boss if you can change cubicles?</em></p><blockquote><p>have you ever thought about sth</p></blockquote><p><strong>XG:</strong> <em>I’ve thought about that, but we’re working on the same project together, I don’t want to make him upset. Anyways, I can live with this problem, but there’s some other things at work that are making me lose my nerve too.</em></p><blockquote><p>work on sth<br>make sb upset （让某人心烦）<br>live with sth (忍受sth)<br>lose my nerve （忍无可忍，让我抓狂）</p></blockquote><p><strong>JJ：</strong> <em>Yeah? Like what?</em></p><blockquote><p>like what（什么事？）, like who（比如谁？）, like when（什么时候）</p></blockquote><p><strong>XG：</strong> <em>My other co-worker, Bob, takes all the credit for the work I do. I designed a website last week for our company, Bob only edited two pictures, but he told everyone that he did the whole thing! It’s so unfair!</em></p><blockquote><p>take all the credit for sth （抢功占为己有）</p></blockquote><p><strong>JJ：</strong> <em>Yeah, I feel you. That’s happened to me a couple times too. I suggest you tell Bob that he isn’t being a team player. You have a right to tell him how much it upset you, but be careful not to lose your temper and start screaming at him. He probably doesn’t realize what he did.</em></p><blockquote><p>I feel you (我理解你 I understand you)<br>you have a/every/the right to do sth<br>lose one’s temper (失态，发脾气)<br>scream/yell at sb （大吼大叫某人）</p></blockquote><p><strong>XG：</strong> <em>You’re probably right. Wow, you sure know a lot about this kind of situation.Can you give me some more advice?</em></p><blockquote><p>can you give me some more advice? = can I pick your brains?</p></blockquote><p><strong>JJ:</strong> <em>I tell you what, it’s almost lunch time. Let’s go sit down at a restaurant and I’ll tell you some rules of thumb for dealing with difficult people at work.</em></p><blockquote><p>a rule of thumb=经验法则，为适宜的行为提供指导<br>deal with sb （和某人相处，打交道）</p></blockquote><p><strong>Jingjing and Xiaogao sit down at a restaurant and begin their conversation</strong><br><strong>JJ:</strong> <em>Alright, Xiaogao, rule number one: when you’re at work, make sure you always carry your own weight.That means you should always do what’s asked of you and try not to let other co-workers pick up the slack.</em></p><blockquote><p>carry your own weight (做好分内的事，不能要求别人为你做)<br>pick up the slack (替别人做他们应该做但没有做的)</p></blockquote><p><strong>XG:</strong> <em>Okay, that I can do. But what about when my co-workers are in a grumpy mood? Sometimes I want to lash out at them.</em></p><blockquote><p>grumpy（mood）=脾气暴躁，生气或不友善<br>lash out at sb （向某人发火）， yell at sb, lay into sb(痛斥某人)<br>I am so gonna do (我特别想做)</p></blockquote><p><strong>JJ:</strong> <em>That brings me to rule number two: no matter how other people act at work, you should always maintain a professional attitude. That means you should talk to people with respect at all times. If something bothers you, you can talk to your boss or the HR department.</em></p><blockquote><p>maintain a professional attritude (保持专业的态度)</p></blockquote><p><strong>XG：</strong> <em>I have another co-worker who sits close to me, her name is Amanda. She’s always on the phone with her boyfriend talking up a storm. It’s really distracting, just like Jerry chewing his gum(没有复数形式，本身就是复数). What should I do about that? She’s a girl, is it okay to confront her about it?</em></p><blockquote><p>She’s always on the phone with her boyfriend talking up a storm,It’s really distracting (她总是和她的男朋友煲电话粥。这真的很让人分心)<br>talk up a storm (滔滔不绝的讲)<br>confront sb (直面某人)</p></blockquote><p><strong>JJ：</strong> <em>Of course it’s okay. Just remember to stay professional and ask nicely. She probably doesn’t realize that she’s being a chatterbox. If you ask her nicely I’m sure she’ll keep her voice down.</em></p><blockquote><p>She probably doesn’t realize that she’s being a chatterbox (她可能没有意识到自己一直在喋喋不休)<br>keep her voice down</p></blockquote><p><strong>XG:</strong> <em>Thanks for all your advice. I have to get back to work now, wish me luck.</em><br><strong>JJ:</strong> <em>One last thing, Xiaogao. Just remember that the most important thing at work is getting along with your co-workers. If you have a bad relationship with them, then you will start to hate your job, or maybe your coworkers will despise(鄙视) you. A happy workplace is a healthy workplace!</em></p><p><strong>XG：</strong> <em>Got it. Okay, I gotta run. Talk to you later!</em><br><strong>JJ：</strong> <em>Hey, Xiaogao! You didn’t pay the bill! Waaaaiiit! Oh… forget it!</em></p><blockquote><p>pay the bill (买单)<br>forget it （算了吧）</p></blockquote><h4 id="2016-6-20-A-Fork-in-a-Road"><a href="#2016-6-20-A-Fork-in-a-Road" class="headerlink" title="2016.6.20 A Fork in a Road"></a>2016.6.20 A Fork in a Road</h4><p><strong>XG:</strong> <em>Hey, Jing Jing,why do you look so vexed?</em></p><blockquote><p>vexed = annoyed (心烦意乱的)</p></blockquote><p><strong>JJ:</strong> <em>I’ve come to a fork in the road, I don’t know what to do. Can you give me some advice?</em></p><blockquote><p>Come to a fork in the road = be in a position where you must make a tough decision (人生做重要决定的关口)<br>give sb some advice/pointers/tips （给某人建议）</p></blockquote><p><strong>XG：</strong> <em>Sure, I’ll trymy best. What’s up?</em><br><strong>JJ：</strong> <em>Well, I’ve been working as an RN at an ICU unit for the past four years, but I feel like I’ve hit a plateau. It’s the same thing over and over, the night shift is really taking a toll on me. But three years ago, a teacher got me thinking, and I started to look into nursing overseas. I began to study professional English with the hopes of one day working as a nurse abroad.</em></p><blockquote><p>RN (Registered Nurse) 注册护士<br>ICU (Intensive Care Unit) 重症监护室<br>hit a plateau = to be unable to make any more progress (到达瓶颈处)<br>overcome / break out/ surmount the plateau 克服瓶颈<br>night shift/day shift (夜班/白班)<br>take a toll on sb = If something takes its/a toll, it causes suffering, deaths, or damage<br>get one thinking (启发，给了某人一个灵感)<br>look into (钻研，研究)</p></blockquote><p><strong>XG：</strong> <em>It sounds like a no-brainer.What’s holding you back?</em></p><blockquote><p>no-brainer = requiring no thought; an easy decision (不需要费脑子的决定)<br>hold sb back = make [one] hesitate （让人犹豫不决）</p></blockquote><p><strong>JJ：</strong> <em>I took a test in Singapore from the SNB and passed with flying colors. Just as I was about to make my next move, my parents and boyfriend complained that I shouldn’t go abroad to be a nurse. They’re worried that I won’t be able to adapt to the way of life and work environment over there. And once I go to work abroad, I’ll lose my job here in China. My parents don’t have really high expectations of me, they’ve never demanded that I find a super high paying job. As long as I am near their side they’ll be happy.</em></p><blockquote><p>pass with flying colors (高分通过)<br>have high expectations of/on sb (对某人有很高的期待)</p></blockquote><p><strong>XG：</strong> <em>Well I think that might be the problem right there. Look at what you’re saying: it will make your parents happy if you stay at the same hospital. Did they ever consider what would make you happy? If you’ve studied English so hard and are able to pass the Singapore test, why should they be worried about you not being able to adapt to life abroad?</em></p><blockquote><p>I think that might be the problem right there (我觉得这可能就是问题的所在)<br>be adapt to env/sth (适应…)</p></blockquote><p><strong>JJ:</strong> <em>What they don’t know is, Singapore was just my first step. My ultimate goal is to go to America to work as an RN. I’m confused about that too. Should I first use Singapore as a stepping stone and work there for a bit, or should I go directly to the United States to work?</em></p><blockquote><p>ultimate goal (终极目标，最终目标)<br>stepping stone (垫脚石，敲门砖)</p></blockquote><p><strong>XG：</strong> <em>That’s a tough call. Considering you’re only 27 years old, you’re still young and can do many things. If you wait any longer, you might miss your chance. I think going to Singapore first would be a good idea because you can prepare for what it feels like to work abroad. You might also learn important skills there that will help you when you go to the United States to work. I’m 32 years old. I’m preparing to start my second Master’s degree. I had to make this decision on my own.Taking a risk and coming to China was the best decision I ‘ve ever made in my life.</em></p><blockquote><p>tough call = a hard decision<br>make a call = make a decision<br>you never too old to learn sth new<br>take a risk (冒险)</p></blockquote><p><strong>JJ：</strong> <em>Okay, I’m starting to feel better now. But what if I can’t find a job anywhere?</em><br><strong>XG:</strong> <em>Unless people stop becoming sick, you’ll be able to find a job as a nurse anywhere on Earth. Good luck to you!</em></p><h4 id="2016-6-22-Saying-Goodbye"><a href="#2016-6-22-Saying-Goodbye" class="headerlink" title="2016.6.22 Saying Goodbye"></a>2016.6.22 Saying Goodbye</h4><p><strong>XG:</strong> <em>Well, Jingjing, I’m afraid I’m going to have to cut my stay short here in Beijing.</em></p><blockquote><p>cut my stay short (提前离开) We had to cut short our holiday because Richard was ill.</p></blockquote><p><strong>JJ:</strong> <em>What? You mean you’re gonna split(离开)? Why? I thought you liked it here?</em><br><strong>XG：</strong> <em>Don’t worry, I’ll be back. I’m just going home to straighten out my visa.</em></p><blockquote><p>strainghten sth out / out sth = to solve a problem or to deal successfully with a confusing situation  (解决问题)</p><ul><li>Once we get these problems straightened out, we should be all right.<br>straighten sb out = to improve someone’s behaviour</li><li>I thought that once he got a girlfriend that would straighten him out.</li></ul></blockquote><p><strong>JJ:</strong> <em>Oh, okay, phew! Well, when are you coming back?</em></p><blockquote><p>phew (那还好，哎呀，你吓死我了，语气词，指松了一口气)</p></blockquote><p><strong>XG:</strong> <em>Probably in a month or so. But I have to leave soon. My visa expires in a couple of days so it’s a race against the clock to get back home as soon as possible.</em></p><blockquote><p>Probably in a month or so (一个月左右，注意 or so)<br>race against the clock=分秒必争，指着急</p></blockquote><p><strong>JJ:</strong> <em>Oh, I see. Well, when you come back hopefully you’ll have all the time in the world. It’s no fun being pressed for time. Hey, do you have anyone that will send you to the airport?</em></p><blockquote><p>have all time in the world (有大量的时间; 指不必担心或有压力)<br>It’s no fun being pressed for time(这么紧迫实在太痛苦了)<br>pressed for time (时间紧迫)</p></blockquote><p><strong>XG:</strong> <em>No, I was gonna take a cab there. Unless…</em></p><blockquote><p>take a cab (坐出租车)</p></blockquote><p><strong>JJ：</strong> <em>Of course I’ll take you! You know you don’t have to ask that!</em></p><blockquote><p>注意You know you don’t have to ask that! 语气</p></blockquote><p><strong>XG：</strong> <em>Really? You’re the greatest!</em><br><strong>JJ：</strong> <em>I know I am! What time does your flight leave?</em></p><blockquote><p>I know I am (比较骄傲的说：我也这么认为的)<br>What time does your flight[交通工具] leave? （你的航班几点起飞）</p></blockquote><p><strong>XG：</strong> <em>Nine in the morning, do you think you can handle that?</em></p><blockquote><p>handle (搞定，此处以为来得及吗)</p></blockquote><p><strong>JJ：</strong> <em>I’ll be at your place at 6:00 on the dot. See you then!</em></p><blockquote><p>on the dot/sharp(准时准点，只能用在整点, 如7:00 on the dot，不能说7:15 on the dot</p></blockquote><p><strong>XG：</strong> <em>I must say, Jingjing. I have to take my hat off for you, you said you’d be at my place at 6:00 sharp and you were. I really appreciate it!</em></p><blockquote><p>I got to say/ I got to tell you (老实说)<br>take my hat for sb (脱帽致敬)<br>I really appreciate it</p></blockquote><p><strong>JJ:</strong> <em>No problem, you know I always keep my word. Well, right now it’s only 7:00. You still have some time to kill before your plane leaves.</em></p><blockquote><p>keep my word (说话算话)<br>you have my word (保密 不泄密) renege on our deal/go back on your words/go back on your promise 反悔<br>have some time to kill=有空闲时间来消磨</p></blockquote><p><strong>XG:</strong> <em>Okay, let’s go get a cup of coffee. It’s my treat. (Xiaogao saysto the coffee shop worker) Two cups of coffee please.</em></p><blockquote><p>It’s my treat (我请客)</p></blockquote><p><strong>JJ:</strong> <em>Wow! This coffee is so strong! It just about knocked my socks off! I don’t usually drink coffee this early in the morning.</em></p><blockquote><p>knock one’s socks off=（通常指口味或气味）非常浓烈。例如，一杯二锅头会“knock</p></blockquote><p><strong>XG:</strong> <em>Yeah, this is some good stuff. You know, Jingjing, I’m really gonna miss you.</em><br><strong>JJ:</strong> <em>Now is not the time to get all emotional. Here, I brought you a going away gift.</em></p><blockquote><p>现在还不是催泪的时候。看，我给你带了一个告别礼物</p></blockquote><p><strong>XG:</strong> <em>A gift? Why did you do that?</em><br><strong>JJ:</strong> <em>It’s common for Chinese to give a gift when someone is coming or going. You didn’t know?</em><br><strong>XG:</strong> * No, I didn’t. That’s so nice of you. Can I open it?*<br><strong>JJ:</strong> <em>Be my guest.</em></p><blockquote><p>be my guest = of course 请便</p></blockquote><p><strong>XG:</strong> <em>Cool! A new watch! I needed a new one!</em><br><strong>JJ:</strong> * I’m glad you like it.*<br><em>(The loud speaker at the airport says Now boarding flight1423 to Detroit.) That’s my flight. I gotta bounce(颠了，离开). Thanks for everything,Jingjing. I’ll see you when I get back.</em></p><h4 id="2016-6-27-Meeting-Someone-at-The-Airport"><a href="#2016-6-27-Meeting-Someone-at-The-Airport" class="headerlink" title="2016.6.27 Meeting Someone at The Airport"></a>2016.6.27 Meeting Someone at The Airport</h4><p><strong>M:</strong> <em>Hey! Long time no see! Thanks so much for picking me up!</em></p><blockquote><p>pick up sb/skill/knowledge/friend</p></blockquote><p><strong>JJ:</strong> <em>No problem! Your plane was a little late coming in. You must be beat!</em></p><blockquote><p>You must be beat (你一定累了吧)   I’m beat 反义 I’m wired</p></blockquote><p><strong>M:</strong> <em>I’m fine, I chugged a bunch of coffee on the plane, so now I’m wired.</em></p><blockquote><p>chug （a drink）=灌（饮料） drink a lot of sth very quickly<br>wired=相其兴奋的</p></blockquote><p><strong>JJ:</strong> <em>So? How was your trip? Tell me all about it.</em><br><strong>M:</strong> <em>I had a great time. It was really nice to see my family. I just wish that I could have stayed a little longer.</em><br><strong>JJ:</strong> <em>Well, you know what they say:all good things must come to an end. You should just be happy that you even got to go on vacation at all. I’ve been working here the past month, lucky you!</em></p><blockquote><p>you know what they say, all good things must come to an end  (一切美好的事物都会有尽头，天下无不散的筵席)<br>go on vacation</p></blockquote><p><strong>M:</strong> <em>That’s true! Oh, I almost forgot, I got a present for you while I was in America. Here you go, hope you like it!</em></p><blockquote><p>here you go 就是给你..  there you go 有点类似归还东西</p></blockquote><p><strong>JJ:</strong> <em>Thanks… but what is it?</em><br><strong>M:</strong> <em>It’s a voodoo doll（巫毒娃娃）.</em><br><strong>JJ：</strong> <em>A what doll?</em><br><strong>M:</strong> <em>A voodoo doll. I bought it in New Orleans（新奥尔良） where voodoo is heavily practiced（盛行）. This doll will bring you luck and protection. I hope it works!</em><br><strong>JJ：</strong> <em>Cool, I love it! I hope you didn’t spend too much money on it?</em><br><strong>M:</strong> <em>Nah, in New Orleans they’re a dime a dozen.</em></p><blockquote><p>a dime a dozen=常见而便宜的东西  </p></blockquote><p><strong>JJ:</strong> <em>Okay, that’s good. Let’s hit the road now. We should get back home before the sun goes down.</em></p><blockquote><p>hit the road (上路)<br>sun goes down (太阳落山)</p></blockquote><p><strong>M:</strong> <em>Well, we finally made it.Thanks again for the ride, Jingjing.</em></p><blockquote><p>give me a ride (载我一程)</p></blockquote><p><strong>JJ：</strong> <em>Don’t mention it.</em><br><strong>M:</strong> <em>By the way, can I give you some gas money?</em><br><strong>JJ:</strong> <em>Don’t worry about it. Just take me to the airport next month when I go to see my parents and we’ll be even.</em></p><blockquote><p>we’ll be even (我们就扯平了)</p></blockquote><p><strong>M:</strong> <em>Okay, cool. Hey, why don’t you come in and drink a glass of lemonade(柠檬水) with me before you go home? It’s the least I could do for you.</em><br><strong>JJ：</strong> <em>That sounds like it will hit the spot! It seems like this heat wave will never end! Hey, while we’re at it how about we watch a DVD too?</em></p><blockquote><p>hit the spot (正中要害，正合我意)<br>heat wave (热浪，不能用hot， hot weather, heat wave)</p></blockquote><p><strong>M:</strong> <em>I’d love to, but I have to wake up at the crack of dawn tomorrow to go to work.</em></p><blockquote><p>crack of dawn (破晓)</p></blockquote><p><strong>JJ：</strong> <em>Really? Geez（天啊）, I never knew you were such an early bird.</em></p><blockquote><p>early bird/night owl</p></blockquote><p><strong>M:</strong> <em>Yup… Don’t you wake up early to go to work too?</em><br><strong>JJ:</strong> <em>Not as early as you. I’m more of a night owl. I like staying up late and working on my computer.</em></p><blockquote><p>I’m more of a night owl (我其实是个夜猫子)</p></blockquote><p><strong>M:</strong> <em>Oh… Well, let’s go inside and get that ice cold glass of lemonade that’s waiting for us!</em></p><blockquote><p>dog days of summer (had nothing to do，闲着，像夏天狗热了躺在地上什么也不干)</p></blockquote><h4 id="2016-7-4-Don’t-text-and-drive"><a href="#2016-7-4-Don’t-text-and-drive" class="headerlink" title="2016.7.4 Don’t text and drive"></a>2016.7.4 Don’t text and drive</h4><p><strong>M:</strong> <em>Ah! Jingjing! I’m in a grind!</em></p><blockquote><p>I’m in a grind/bind (我好痛苦，不方便，尴尬， 指精神情感的，不是身体上的)</p></blockquote><p><strong>JJ:</strong> <em>What’s the matter? You look like you’ve seen a ghost!</em> （你看起来像见了鬼一样）<br><strong>M:</strong> <em>Yeah, I just got in a wreck. My parents are gonna bite my head off.</em></p><blockquote><p>get in a wreck (出了车祸，基本上就是报销了，成本大于2000美元)<br>fender bender (车祸，成本小于2000美元，可以修理)<br>bite sb head off (yell at sb, 大喊大叫，指非常生气)</p></blockquote><p><strong>JJ：</strong> <em>Really? Are you okay? How about your car?</em><br><strong>M:</strong> <em>I’m fine, but my car is totaled! They gave that car to me last year when I graduated college, it cost thirty grand! I don’t know what to do!</em></p><blockquote><p>totaled (“完蛋了”， 不能直接说totaled，需要结合上下文， I wrecked my car totally)<br>grand (1000美元)</p></blockquote><p><strong>JJ：</strong> <em>Just stay calm! Accidents happen. I’m sure it wasn’t your fault.</em></p><blockquote><p>stay calm (保持冷静)</p></blockquote><p><strong>M:</strong> <em>Actually it was. I really goofed up, Jingjing. I was texting and driving. I wasn’t paying attention to the road.</em></p><blockquote><p>goofed up/messed up/screw up (出大错，搞砸了)<br>text (可以动词使用， I’ll text you， 我会给你发信息)</p></blockquote><p><strong>JJ：</strong> <em>Mark! What’s gotten into you? That doesn’t seem like something you’d do!</em></p><blockquote><p>what’s gotten into you (你是怎么想的？ 脑袋进水了吗)</p></blockquote><p><strong>M:</strong> <em>I know. I don’t know what I was thinking. Jingjing, what am I supposed to do?!</em></p><blockquote><p>what am I supposed to do (what should I do?  但是前者更常用，表达更好一点)</p></blockquote><p><strong>JJ：</strong> <em>Look, you need to be blunt with your parents and tell them what happened. I’m sure they’ll forgive you! After all, they’re your parents.</em></p><blockquote><p>be blunt with sb (坦率的说，不顾及对方感受，有点简单粗暴，只是如实说出来)</p></blockquote><p><strong>M:</strong> <em>Okay, I’m gonna go home now and spill the beans.</em></p><blockquote><p>spill the beans (如是说，更强调实话实说，注意和be blunt with sb 的区别)</p></blockquote><p><strong>JJ：</strong> <em>So? How did it go with your parents? Are they ticked off?</em></p><blockquote><p>ticked off (生气，之前忍了几次了  这次彻底爆发了， 忍无可忍)</p></blockquote><p><strong>M:</strong> <em>No. They were more worried than anything. They were just happy I wasn’t hurt. The good news is that the insurance will cover the cost of the car.</em></p><blockquote><p>cover the cost of the car (保险公司将会赔付我汽车的损失)</p></blockquote><p><strong>JJ:</strong> <em>Wow, it sounds like they are letting you off pretty easy. What’s the catch?</em></p><blockquote><p>let sb off pretty easy(放你一马，很容易的放过你)<br>what’s the catch (有什么条件)</p></blockquote><p><strong>M:</strong> <em>The catch is that they are making me pay the deductable(抵扣款), and they told me I’m not allowed to send text for a month.</em><br><strong>JJ：</strong> <em>No text messages? I think I would go bananas! I love sending texts. I bet you can’t wait for this month to go by, huh?</em></p><blockquote><p>go bananas (疯掉了，但是没有伤害的，no harm)</p></blockquote><p><strong>M:</strong> <em>That’s right, next month I’ll be like a dog with two tails. Although, I swear I’ll never send another text while driving again.</em></p><blockquote><p>I’ll be like a dog with two tails (恢复自由了，指非常高兴)</p></blockquote><p><strong>JJ：</strong> <em>Look on the bright side, at least you’ll save a lot of money this month by not having to send texts. Texting can be expensive.</em></p><blockquote><p>look on the bright/down/dark side (往好处/坏处想)</p></blockquote><p><strong>M:</strong> <em>That’s true! I never thought about that. With all this left over money(省下来的钱), I think I might go buy some books that I’ve been wanting to read.</em><br><strong>JJ：</strong> <em>See, Mark. This whole ordeal（磨难） has turned out to be a blessing in disguise.</em></p><blockquote><p>turn out to be a blessing in disguise (因祸得福)</p></blockquote><p><strong>M:</strong> <em>Hey, how come you always seem to cheer me up? Do you have magical powers or something?</em></p><blockquote><p>cheer sb up (鼓励某人，激励某人)</p></blockquote><p><strong>JJ：</strong> <em>No, I’m just awesome!（我就是天才，比较骄傲的口吻） That’s all…</em></p><h3 id="英语语法"><a href="#英语语法" class="headerlink" title="英语语法"></a>英语语法</h3><h4 id="定语从句"><a href="#定语从句" class="headerlink" title="定语从句"></a>定语从句</h4><h5 id="定语从句相关基本概念"><a href="#定语从句相关基本概念" class="headerlink" title="定语从句相关基本概念"></a>定语从句相关基本概念</h5><blockquote><ol><li>定语从句的定义：用作定语的从句叫定语从句</li><li>定语从句结构：<strong>先行词 + 引导词 + 定语从句</strong></li><li>先行词：被定语从句所修饰的名词或代词</li><li>定语从句的位置：紧跟先行词（名词或代词）之后</li><li>引导词：引导定语从句的词（包括关系代词和关系副词）</li></ol><ul><li>关系代词：<strong>that/who/whom/which/as</strong></li><li>关系副词：<strong>when/where/why</strong></li></ul></blockquote><h5 id="引导词的功能"><a href="#引导词的功能" class="headerlink" title="引导词的功能"></a>引导词的功能</h5><blockquote><ol><li>连接先行词和定语从句。（相当于桥梁）</li></ol><ul><li>*I like the book which I bought. *         </li></ul><ol start="2"><li>在定语从句中充当一定的成分（关系代词充当主语或宾语，关系副词充当状语）。</li></ol><ul><li>*This is the man who studied with me. *（关系代词做主语）</li><li><em>This is the man with whom I studied. * (关系代词做宾语, 将介词提前)</em></li></ul></blockquote><h5 id="定语从句类型"><a href="#定语从句类型" class="headerlink" title="定语从句类型"></a>定语从句类型</h5><p>定语从句有限制性和非限制性两种。限制性定语从句是先行词不可缺少的部分，去掉它主句意思往往不明确；非限制性定语从句是先行词的附加说明，去掉了也不会影响主句的意思，它与主句之间通常用逗号分开，以下是简单例子说明：</p><blockquote><ul><li><em>This is the house which I bought last month</em> （限制性定语从句）</li><li><em>The house, which I bought last month, is very nice</em> (非限定性定语从句)</li></ul></blockquote><p>(一) 限制性定语从句（主句和定语从句之间无逗号隔开）</p><blockquote><ul><li><em>The man <strong>who</strong> you’re talking <strong>to</strong> is my friend.</em></li><li><em>The man <strong>to whom</strong> you’re talking is my friend.</em></li><li><em>I need a pencil  <strong>with which</strong> I can write a letter</em></li><li><em>I need a piece of paper <strong>on which</strong> I can write a letter</em></li><li><em>The man (*</em>who/whom/that** 都可以) I talked <strong>about</strong> at the meeting is from Peking University. *</li><li><em>The man <strong>about whom</strong> I talked at the meeting）is from Peking University.</em></li><li><em>The palace (<strong>which/that</strong> 都可以) I often pay a visit <strong>to</strong> was built in the 17th century.</em></li><li><em>The palace <strong>to which</strong> I often pay a visit was built in the 17th century</em></li></ul><p><strong>总结</strong>： 介词可以放到<strong>关系代词之前</strong>也可以放在<strong>句子末尾</strong>，放在关系代词之前是很地道的书写方式，介词只能加宾语，于是只有 <strong>介词+which</strong> 和 <strong>介词+whom</strong>两种形式， who在定语从句中既可以做主语也可以做宾语，作宾语可以与whom互换，但是如果有介词，必须要用whom， 另外paper单独指论文，一页纸要用a piece of paper, 北京大学要用Peking University，BJ University指北京的大学。</p></blockquote><p>(二) 非限制性定语从句 （主句和定于从句之间有逗号分隔）<br>当当先行词是专有名词或物主代词和指示代词所修饰时，其后的定语从句通常是非限制性的</p><blockquote><ul><li><em>Charles Smith, who was my former teacther, retired last year</em></li><li><em>My house, which I bought last month, has got a lovely garden</em></li><li><em>The novel, which I have reading three times, is very touching</em></li></ul></blockquote><p>非限制性定语从句还能将整个主句作为先行词,对其进行修饰,这时从句谓语动词要用第三人称单数</p><blockquote><p><em>He seems not to have grasped what I meant, which greatly <strong>upsets</strong> me</em> 他似乎没抓住我的意思，这使我心烦</p></blockquote><p>由介词+关系代词（whom/which）引导</p><blockquote><ul><li><em>I live in a house far away from city, <strong>in front of which</strong> is a big tree.</em>  其中far away from city 做后置定语</li><li><em>There is an apple tree standing there at the gate, on which are many apples</em></li></ul></blockquote><p>由“代词/名词+of+whom/which”或“of which/ whom +名词/代词”(先行词指人用whom,指物用which)引导。One, some, any, none,all, both, several, many, most, neither, either等词、数词、分数或百分比与of whom或of which连用。</p><blockquote><ul><li><em>He has five children, two of whom are abroad.</em>  (He has five children, and two of them are abroad. 外国人不喜欢重复，所以将连词去掉并且把them换成which， 因为这里which就是指代them)</li><li><em>We have three books, none of which is/are interesting.</em> (We have three books, but none of them is/are interesting 道理同上)</li></ul></blockquote><p>whose引导非限定性定语从句</p><blockquote><ul><li><em>The house, whose window faces South, is mine</em></li></ul></blockquote><p><strong>注意：</strong> 关系代词<strong>that</strong>和关系副词<strong>why</strong>不能引导非限制性定语从句</p><h5 id="引导词（关系代词）that-which-who用法详解"><a href="#引导词（关系代词）that-which-who用法详解" class="headerlink" title="引导词（关系代词）that/which/who用法详解"></a>引导词（关系代词）that/which/who用法详解</h5><p>（一） 当先行词是<strong>物</strong>时，关系代词(that/which)只用that的情况</p><blockquote><ol><li>当先行词被序数词或形容词最高级修饰时，只能用that, 当然that也可以省略<br>This is <strong>the best</strong> film <strong>that</strong> has been shown this year.<br>This is <strong>the first</strong> book <strong>that</strong> I borrow from the library<br>He is <strong>the first</strong> student <strong>that/who</strong> came to school today   (student 是人，所以可以用who)</li><li>当先行词为两个或两个以上分别指人和物的名词时，只能用that<br>He talked about <strong>the teachers and the school that</strong> he had visited.</li><li>当先行词本身是all的，只能用that<br>All that(what) I want to say to you is “Thank you”  (all that=what)<br>Go over all that (what) we learned</li><li>先行词为something, anything, nothing, everything, thing时, 只能用that<br>I’ll tell you anything that I know.</li><li>当先行词前有all, much, little, many, (a) few, every, some, any, no, only, the very, one of, the only, the last, the next等修饰语时<br>This is one of the books <strong>in which</strong> I’m very interested （有介词就要用which）<br>This is the only book that I read.<br>He is the only one of the boys that likes playing the piano.</li><li>当先行词在以who或which开头的特殊疑问句中时，用that引导以避免混淆．<br>Who is the man that is talking with the lady?<br>Which of you that know the answer can come to the front?</li><li>当先行词是在定语从句中作表语时，用that<br>He likes the girl that sheused to be.</li></ol></blockquote><p>（二）当先行词是物时，关系代词(that/which)只用which的情况</p><blockquote><ol><li>作介宾且介词置于引导词之前时．<br>The room <strong>in which</strong> he lives is very large.</li><li>引导非限定性定语从句时（主，宾都用which,都不能省略）<br>Football, which is a very interesting game, is played all over the world.<br>The house, which I visited yesterday, is very large.</li><li>which指整个句子的内容或部分内容，引导非限定性定语从句<br>He always makes fun of me, which upsets me.</li></ol></blockquote><p>（三）其他特殊情况</p><blockquote><ol><li>先行词是these, those指人时，关系代词只用who<br>Those who are playing over there are my students</li><li>先行词是人称代词(he, she…)时，关系代词只用who<br>He who doesn’t reach the Great Wall is not a true man</li><li>不定代词someone, anyone,everyone, no one, somebody, anybody, everybody作先行词时，关系代词用who<br>Anybody who breaks the rules would be pubnished  (注意是breaks，Anybody在意思上指“全部”， 语法上只做第三人称单数用)</li><li>先行词是the only one of +可数名词复数，在定语从句中作主语时，定语从句中的谓语用单数形式, 因为此时限定的是the only one <strong>注意以下两个例句定语从句speak的形式区别</strong><br>He is the only one of the students who(口语)/that <strong>speaks</strong> Japanese in our class<br>He is one of the students who <strong>speak</strong> Japanese in our class</li><li>当先行词是the way, 在定语从句中充当方式状语时（the way表＂以…方式／方法＂），引导词通常用that或省略，也可用in which．<br>I don’t like the way (that) you speak<br>I don’t like the way in which you speak</li><li>关系代词或关系副词在从句中充当一个句子成分，因此要注意避免从句中句子成分的重复出现<br>This isthe most beautiful place that I have visited it. (错误: it重复，that在这里已经做宾语 ）<br>his isthe most beautiful place thatI have visited</li><li>定语从句中关系代词或关系副词的选择取决于它们在从句中所充当的句子成分。如作主语和宾语用关系代词；作状语，用关系副词<br>I’ll never forget the day when I went abroad myself.我永远记得我独自在国外的日子, （这里的the day 是一个抽象的概念，指一段日子）<br>I’ll never forget the days that we spent together.我永远不会忘记我们一起度过的那些天/日子, (这里的the days是一个具体的概念)</li></ol><p><strong>the day (minute)等表时间的单数名词后+关系副词when</strong>  （表抽象的一段时间）<br><strong>the days(minutes)等表时间的复数名词后+关系代词that 、which</strong> （表具体的一段时间）</p></blockquote><h5 id="定从经典组合（介词-关系代词）十大难点"><a href="#定从经典组合（介词-关系代词）十大难点" class="headerlink" title="定从经典组合（介词+关系代词）十大难点"></a>定从经典组合（介词+关系代词）十大难点</h5><p><strong>Note:</strong> 介词+关系代词主要看结构<br>（一） 介词+which在定语从句中分别作时间、地点和原因<strong>状语</strong>，代替相应的关系副词when,where和why，<strong>介词+which合化 when/where/why</strong></p><blockquote><ol><li>I still remember the day <em>on which(when)</em> I first came to school   （我仍然记得当初来学校的那一天）</li></ol><p><strong>理解：</strong> I came to school on the day.<br>2. The factory <em>in which(where)</em> I work is a large one. (我工作的工厂是一个大工厂)<br><strong>理解：</strong> factory不可能做work的宾语（工作工厂）， 是在工厂工作， I work in the factory<br>3. This is the reason <em>for which(why)</em> he was late (这就是他为什么迟到的原因)<br><strong>理解：</strong> reason不可能做late的宾语， be late for因为什么迟到</p></blockquote><p>（二） 介词+which（指物）/ whom（指人）在定语从句中作地点状语，表示存在关系，定语从句主谓一般要倒置。 <strong>打南边来了一个喇嘛；背上背着一个胖娃娃</strong></p><blockquote><ol><li>They arrived at a farm house, in front of which sat a small boy 他来到一处农舍，(农舍)前边坐着一个小男孩。</li></ol><p><strong>理解：</strong> a small boy sat in front of the farm house（此时a small boy是主语， sat 是谓语）, 地点状语做主语之后，主谓倒装， a small boy 做sat的宾语<br>2. I saw a man,on the head of whom stood a bird.<br><strong>理解：</strong>  道理同上 a bird stood on the head of a man. 地点状语在前，主谓倒装</p></blockquote><p>（三） 介词+ which（指物）/ whom（指人）在定语从句中作目的、方式或地点状语。这种结构中的介词一般受动词或介词后的名词所制约。<strong>找定语从句里的动词看它应该搭配什么介词</strong></p><blockquote><ol><li>Could you tell me for whom you brought this coat (你能告诉我这件衣服是给谁买的吗？)</li></ol><p><strong>理解：</strong> buy sth for sb, for whom 在此处是目的，指给某人<br>2. The man, from whom I learned the news, is an engineer. (这人是一位工程师，我是从他那里得到这消息的。)<br><strong>理解：</strong> learn sth from sb ，此处是方式</p></blockquote><p>（四） 介词+which/whom，用于被动结构的定语从句中，作状语，说明动作的发出者。 <strong>被动的使用是为了更加强调动作发出者的厉害</strong></p><blockquote><ol><li>The wolf by which the sheep was killed was shot (伤害羊的那只狼被打死了)</li></ol><p><strong>理解：</strong> the sheep was killed by the wolf, 上面句子中的which就是表示the wolf.<br>2. The man by whom the wolf was shot was a good hunter. 打死狼的那人是个好猎手。<br><strong>理解：</strong> the wolf was shot by the man, 上面句子中的whom表示the man</p></blockquote><h4 id="倒装句"><a href="#倒装句" class="headerlink" title="倒装句"></a>倒装句</h4><h5 id="英语倒装结构的六大形式详解"><a href="#英语倒装结构的六大形式详解" class="headerlink" title="英语倒装结构的六大形式详解"></a>英语倒装结构的六大形式详解</h5><p>（一） 否定副词位于句首时的倒装<br>在正式文体中，<strong>never, seldom, rarely, little,hardly, scarcely, no sooner, no longer, nowhere</strong> 等含有否定意义的副词若位于句首，则其后要用部分倒装：</p><blockquote><ol><li>I shall never forgive him -&gt; Never shall I forgive him. 我永远不会宽恕他。</li><li>He seldom goes out for dinner -&gt; Seldom does he go out for dinner. 他很少出去吃饭。</li><li>She hardly has time to listen to music -&gt; Hardly does she have time to listen to music. 她几乎没时间听音乐。</li><li>He little realizes how important this meeting is -&gt; Little doeshe realize how important this meeting is. 他不甚明白这个会议的重要性</li><li>We had no sooner reached the airport than the plane took off -&gt; No sooner had we reached the airport than the plane took off. 我们刚到机场,飞机就起飞了。</li></ol><p><strong>注意：</strong> in no time(立即，马上)位于句首时，其后无需用倒装语序：  In no time he worked out the problem. 他马上就算出了那道题。</p></blockquote><p>(二) only+状语”位于句首时的倒装<br><strong>当一个状语受副词only的修饰且置于句首时，其后用部分倒装语序：</strong></p><blockquote><ol><li>Only then did he realize that he was wrong. 到那时他才意识到他错了。</li><li>Only in this way are you able to do it well. 你只有用这种方法才能把它做好。</li><li>Only when he returned home did he realize what had happened.  当他回到家里时，才知道出了什么事。</li></ol></blockquote><p>(三) so+adj. / adv.”位于句首时的倒装<br><strong>副词so后接形容词或副词位于句首时，其后用部分倒装</strong></p><blockquote><ol><li>The weather was so cold that we had to stay at home. -&gt; So cold was the weather that we had to stay at home. 天气太冷，我们只好呆在家里。</li><li>Light travels so fast that we can hardly imagine its speed -&gt; So fastdoes light travel that we can hardly imagine its speed.  光速很快，我们几乎没法想像它的速度。</li><li>The attack was so sudden that we had no time to escape -&gt; So suddenwas the attack that we had no time to escape. 袭击来得非常突然，我们来不及逃跑。</li></ol><p><strong>总结：</strong> 此类型的原句就是so…that (如此.. 以至于..)</p></blockquote><p>(四) so+助动词+主语”倒装当要表示前面提出的某一肯定的情况也同样适合于后者</p><blockquote><p>You are young and so am I. (你年轻，我也年轻)  注意： 不能省略and, so am I 是一个句子，需要连接<br>She likes music and so do I. (她喜欢音乐，我也喜欢）<br>If he can do it,so can I. (要是他能做此事，我也能) 注意“逗号”的使用， 条件从句<br><strong>若前面提出某一否定的情况，要表示后者也属于同样的否定情况，则应将其中的so改为neither或nor</strong><br>You aren’t young and neither am I. (你不年轻，我也不年轻)<br>She hasn’t read it and nor have I. (她没有读它，我也没有读)<br><strong>注意该结构与表示强调或同意的“so+主语+特殊动词”结构的区别, 此种情况不需要倒装</strong><br>A: “It was cold yesterday.(昨天很冷)”  B: “So it was. (的确很冷)”<br>A: “Father, you promised.(爸爸，你答应过的)” B: “Well,so I did. （嗯，是答应过）”<br><strong>注意： so + adj/adv 基本可以互换such a/an + adj + n, such开头的也要倒装，但是互换有时会改变表达情感</strong></p></blockquote><p>（五） 由not only…but also引出的倒装当not only…but also位于句首引出句子时，not only 后的句子通常用部分倒装形式， <strong>but also 后面正常语序</strong></p><blockquote><p>Not only is he a teacher, but also he is a poet. (他不仅是一位教师，而且是一位诗人)<br>Not only did he speak more correctly, but also he spoke more easily. (不仅他讲得更正确，也讲得更不费劲了)</p><p><strong>注意：</strong> not only .. but also 中but also不一定非要连在一起，也可以只留but或只留also ： Not only is he a teacher, but he is also a poet (这样写更舒服地道)</p></blockquote><p>(六) 虚拟条件句的省略与倒装<br><strong>当if引导的虚拟条件从句中含有had, were, should等时，如将if省略，则要将had, were, should等移到主语前，构成倒装句</strong></p><blockquote><p>If you had come yesterday, you would have seen him. -&gt; Had you come yesterday, you would have seen him.<br>If you should require anything give me a ring. -&gt; Should you require anything give me a ring.<br>If it were not for your help,I would still be homeless. -&gt; Were it not for your help, I would still be homeless.  (要不是你帮助，我会仍然无家可归)<br><strong>省略if后提前的had不一定是助动词</strong><br>If I had money, I would buy it. -&gt; Had I money, I would buy it. (此处的had是实意动词)</p></blockquote><p>（七） As 引导的让步状语从句倒装<br><strong>as作“虽然”解，引导让步状语从句时，必须将表语、状语或动词原形提到as前面。此时应注意几点：</strong></p><ol><li>若提前的表语是没有形容词修饰的单数可数名词，要省略不定冠词；</li><li>若提前的是动词原形(多为不及物动词)，与之连用的通常是may, might, will, would等，且这些词都要保留在原来的位置上(主语后)；</li><li>though有时也可像as这样使作倒装， although绝对不能倒装**</li></ol><blockquote><p>Tired（形容词） as I was, I tried to help them. 虽然我很累，我还是努力帮助他们。 =Although I was tired, I tried to help them.<br>Try（动词） as he would, he couldn’t open the door. 他试过多次了, 却仍打不开那门。 =Although he would try, he couldn’t open the door.<br>Search(动词） as they would, they would find nobody in the house. 无论怎样搜查，他们在房子里仍然没有找到一个人。 =Although they would search, they would find nobody in the house.<br>Hard(副词） as (though) they tried, they couldn’t make her change her mind. 尽管他们做了很大努力，却没法让她改变主意。 =Although they tried hard, they couldn’t make her change her mind.<br>Boy(名词无冠词） as he was, he behaved like a girl. 他虽是个男孩，但举止却像个女孩。 =Although he was a boy, he behaved like a girl.</p></blockquote><h4 id="状语从句"><a href="#状语从句" class="headerlink" title="状语从句"></a>状语从句</h4><p><strong>状语主要是用来修饰动词和形容词的，以表明动作发生或状态存在的时间、地点、原因、目的、结果等。状语从句即指在主从复合句中用作状语的从句。状语从句主要用来修饰主句或主句的谓语</strong><br>（一） <strong>时间状语从句</strong><br><em>时间状语从句用表示时间的连词连接一个句子作状语，这样的主从复合句就是时间状语从句, 常用引导词：when, as, while, as soon as, before, after, since , till, until</em></p><ol><li><p>由when,while, as引导的时间状语从句的区别用法</p><blockquote><ul><li><strong>when引导的从句的谓语动词可以是延续性的动词，又可以是瞬时动词, 并且when有时表示“就在那时”</strong><br>When she came in, I stopped eating.她进来时，我在吃饭。(瞬时动词) [came in 此时是瞬间动词， 她进来我有注意到她，吃饭停了一下]<br>When I lived in the countryside, I used to carry some water for him.当我的住在农村时，我常常为他担水。（延续性的动词） [live in 是延续性动词，一直在住着]<br>We were about to leave when he came in.我们就要离开，就在那时他进来了。（就在那时）  </li></ul><p><strong>总结：</strong> when 引导的从句有激活主句的感觉，从句的内容要平行并列主句.</p><ul><li><strong>While引导的从句的谓语动作必须是延续性的，并强调主句和从句的动作同时发生（或者相对应）。并且while有时还可以表示对比</strong><br>My wife was reading the newspaper, while I was watching TV. 我妻子在看报纸，我在看电视。(was reading是延续性的动词，并且was reading和was watching同时发生)<br>I like playing football while you like playing basketball.我喜欢踢足球，而你喜欢打篮球。 (此处表示对比)</li></ul><p><strong>总结：</strong> while后面始终要加延续性动词</p><ul><li><strong>As表示“一边……一边”，as引导的动作是延续性的动作，一般用于主句和从句动作同时发生；as也可以强调“一先一后。</strong><br>We always sing as we walk.我们总是边走边唱。（as表示“一边……一边”） [这里强调我们持续这样很长时间，像是一辈子的习惯]<br>As we was going out, it began to snow. 当我们出门时，开始下雪了。（as强调句中两个动作紧接着先后发生，而不强调开始下雪的特定时间）</li></ul><p><strong>总结：</strong> as表示的持续性甚至是一种习惯</p><p><strong>Note:</strong> 主从复合句，要强调的东西在前面写，这也是英文的的使用习惯，强调的东西始终放在第一位 .</p></blockquote></li><li><p>由before和after引导的时间状语从句的区别用法</p><blockquote><ul><li><strong>before引导的从句不再用否定式的谓语，并且当before引导的从句位于主句之后，有时译成“就，才”或“ 还没来得及… 就”。还要注意主句和从句之间的时间关系。当主句用将来时，从句总是用现在时；如果before引导的从句谓语用的是过去时，则主句动词多用过去完成时，这样以便体现动作发生的先后</strong><br>It will be four days before they come back. （主将从现，一一对应） (他们要过四天才能回来)<br>Einstein almost knocked me down before he saw me. （几乎同时发生） (爱因斯坦几乎把我撞倒才看到我)<br>My father had left for Canada just before the letter arrived. （主过完从过） (我父亲恰好在信到之前去加拿大了)</li></ul><p><strong>leave for smw</strong> (离开去某地)<br>They had not been married four months before they were divorced. (他们结婚还不到四个月就离婚了)</p><ul><li><strong>after表示主句动作发生在从句动作之后。主句和从句的动作的时间关系正好与before引导的从句相反</strong><br>After you think it over, please let me know what you decide. (你仔细考虑过以后，告诉我你是怎样决定的)<br>After we had finished the work, we went home. (完成工作之后，我们回家了) （从句用过去完成时，主句用一般过去时）</li></ul></blockquote></li><li><p>till或until引导的时间状语从句的区别</p><blockquote><ul><li><strong>till和until一般情况下两者可以互换，但是在强调句型中多用until,但是注意注意注意：①如果主句中的谓语动词是瞬时动词时，必须用否定形式；②如果主句中的谓语动词是延续性动词时，用肯定或否定形式都可以，但表达的意思不同。③till不可以用在句首，而until可以放在句首。</strong><br>I didn’t go to bed until（till）my father came back. (直到我父亲回来我才上床睡觉。)<br>It was not until the meeting was over that he began to teach me English. (直到散会之后他才开始教我英语)<br>I worked until he came back.我工作到他回来为止。（前肯意为否）<br>I didn’t work until he came back.他回来我这才开始工作。（前否意为肯）<br>Please wait until I arrived.在我到达之前请等我。</li></ul></blockquote></li><li><p>since引导的时间状语从句的用法</p><blockquote><ul><li><strong>since引导的从句的谓语动词可以是延续性的动词，又可以是瞬时动词。一般情况下，从句谓语动词用一般过去时，而主句的谓语动词用现在完成时。但在It is ＋时间＋since从句的句型中，主句多用一般现在时</strong><br>I have been in Beijing since you left. （主现完从过去） (自从你离开以来，我一直在北京了)<br>Where have you been since I last saw you? （主现完从过去） (自上次我和你见面以后，你到哪里去了？)<br>It is four years since my sister lived in Beijing. (我妹妹不在北京住有四年了)（今日重点句型，表示相反意思）</li></ul></blockquote></li><li><p>在时间状语从句中</p><blockquote><ul><li><strong>当主句是一般将来时或祈使句表示将来的意义时，时间状语从句用一般现在时</strong><br>I’ll let him know as soon as she comes.（主将从现） (她一来，我就会让你知道)</li></ul></blockquote></li></ol><p>（二） <strong>原因状语从句</strong><br><strong>用表示原因的连词连接一个句子作状语，这样的主从复合句就是原因状语从句，原因状语从句通常由because, since, as,for 引导</strong></p><table><thead><tr><th align="left">项目</th><th align="left">位置</th><th align="left">内涵</th><th align="left">语气</th><th align="left">能否回答why</th></tr></thead><tbody><tr><td align="left">because(因为)</td><td align="left">主句前或者后，通常放在后面为好</td><td align="left">直接因果关系，或一些不太想说的原因</td><td align="left">强</td><td align="left">能</td></tr><tr><td align="left">as(由于)</td><td align="left">主句前或者后</td><td align="left">双方都知道的原因</td><td align="left">弱</td><td align="left">不能</td></tr><tr><td align="left">since/now that (既然)</td><td align="left">主语前</td><td align="left">双方都知道原因</td><td align="left">弱</td><td align="left">不能</td></tr><tr><td align="left">for (因为)</td><td align="left">句中，通常由逗号隔开</td><td align="left">补充说明原因或推断的依据</td><td align="left">弱</td><td align="left">不能</td></tr></tbody></table><blockquote><ol><li>because表示直接原因，语气最强。Because引导的原因状语从句多放在主句之后。回答由why提出的问题，只能用because。<br>I was absent from the meeting because I was ill.</li><li>as和since语气较弱，一般用来表示明显的原因,即众所周知或当事人都知道，由as和since引导的原因状语从句多放在句首<br>As it is raining, we will not go to the park.   (PS:下雨就在眼前，都知道)<br>Now that/ Since everybody is here, let’s begin our meeting.</li><li>for有时也可引出表示原因的分句，但它只能位于后面，对前一分句加以解释或推断<br>It must have rained last night, for the ground is wet．</li></ol></blockquote><p>(三) <strong>目的状语从句</strong><br>*<em>用表示目的的连词连接一个句子作状语，这样的主从复合句就是目的状语从句，目的状语从句通常由so that, in order to , in case, for fear *</em></p><blockquote><ol><li>I hired a boat so that I could go fishing. (我租了一条船去钓鱼)</li><li>Take your raincoat in case it rains (should rain). (带上雨衣以防下雨)</li><li>He studied hard in order that he could pass the exam. (他努力学习是为了能通过考试)</li></ol><p><strong>注意： in case 和 for fear 的区别：</strong> in case 指“假如某种情况出现,我们要……” 同时发生的可能性非常大不可避免,for fear指“我们要……以免某种情况出现”,前者强调主语的能动性</p><ul><li>He worked hard for fear that he might be fired by the boss (他拼命地干活惟恐被老板解雇)</li><li>He walked fast for fear that he should be late. (他快走,以免迟到)</li></ul><p><strong>注意： so that既可引导目的状语从句，又可引导结果状语从句。区别这两种从句的办法有两个</strong></p><ul><li>目的状语从句里往往带有情态动词can, could, may, might等,从意思上看，目的状语从句往往表示的目的很明确<br>Speak clearly so that they may understand you. (目的状语从句)<br>Jack is badly ill so that he has to rest. (结果状语从句)</li></ul></blockquote><p>（四） <strong>条件状语从句</strong><br><strong>用表示条件的连词连接一个句子作状语，这样的主从复合句就是条件状语从句，引导条件状语从句的从属连词主要有if, unless，as long as, 激活条件</strong></p><ol><li>Don’t come unless I telephone (除非我打电话，否则你别来)</li><li>If you watch carefully you will **see how to do it (如果你仔细看，你会看出该怎样做)</li><li>I’ll help you with your English if I am free tomorrow (如果我明天有空，我就帮你辅导英语)</li><li>He won’t be late unless he is ill (除非他病了，否则他不会迟到)<blockquote><p><strong>注意：</strong></p><ul><li>祈使句连词要在中间</li><li>在条件状语从句里，谓语动词通常用现在时态表示将来的动作或状态（主将从现），但是条件是不可能发生或实现的就是虚拟语气了，“If I were you ”</li></ul></blockquote></li></ol><p>（五） <strong>结果状语从句</strong><br><strong>引导结果状语从句的从属连词主要有so that, so…that，such…that等</strong></p><ol><li><p>在由so…that引导的结果状语从句中，so是副词，与形容词连用。其结构是: “…so + 形容词（副词）+ that + 从句</p><blockquote><ul><li>The hall is so big that it can hold 2,000 people  (这个大厅大得能容纳2000人)</li><li>Mother lives so far away that we hardly ever see her (妈妈住得太远了我们都无法常见面)</li><li>He shut the window with such force that the glass broke (他关窗子用力太大，玻璃都震破了)</li></ul></blockquote></li><li><p>在由such…that引导的结果状语从句中，such是形容词，它修饰的可以是单数或复数可数名词，也可以是不可数名词；名词前面可以带形容词，也可不带。如果是单数可数名词，前面需加不定冠词a或an</p><blockquote><ul><li>It was such a hot day that nobody wanted to do anything (天太热了，没人愿意干活)</li><li>He made such rapid progress that he did very well in the mid-term. (他进步很快，期中表现非常好)</li></ul></blockquote></li><li><p>如果名词前由many, much, little, few等词修饰时，只能用so, 不用such, 即“多多少少只能用so”</p><blockquote><ul><li>Soon there were so many deer(单复数一样) that they ate up all the wild roses (很快就聚集了许多鹿，啃光了所有的野玫瑰)</li><li>He has so little time that he can’t go to the cinema with you (他几乎没时间跟你们去电影院)</li></ul></blockquote></li><li><p>so…that…句型的否定形式可用简单句too…to…或not…enough to代替</p><blockquote><ul><li>He is so young that he can’t go to school = He is too young to go to school</li></ul></blockquote></li><li><p>当so/such…that结构中的so或such放在句首时，主句用倒装语序</p><blockquote><ul><li>So proud was he that he never listened to any advice (他太骄傲了以致于从来听不进任何建议)</li></ul></blockquote></li></ol><p>(六) <strong>让步状语从句</strong></p><table><thead><tr><th align="left">项目</th><th align="left">位置</th><th align="left">注意事项</th></tr></thead><tbody><tr><td align="left">though</td><td align="left">句首,或句末</td><td align="left">放在句末，做副词，意为“可是，不过” ,不可与but连用，可与yet,still连用</td></tr><tr><td align="left">even though</td><td align="left">通常放在句中链接主从句</td><td align="left"></td></tr><tr><td align="left">even if</td><td align="left">通常放在句中链接主从句</td><td align="left"></td></tr><tr><td align="left">although</td><td align="left">句首或句中</td><td align="left">在句首需要有逗号，在句中不需要逗号，不可与but连用，可与yet,still连用</td></tr></tbody></table><ol><li><p>引导让步状语从句的从属连词主要有although, though, even though，even if（即使）</p><blockquote><ul><li>Though we are poor, we are still happy. 我们虽然穷，但是很快活。</li><li>He went out even though it was raining. 尽管下着雨，他还是出去了。</li><li>It’s hard work, I enjoy it though. 工作很辛苦，可我乐意干</li><li>The speech is good, it could be better though. 这次演讲不错，虽然还可以再好一点</li><li>Although Princeton has a world famous university, it is still a small quiet town. 普林斯顿虽然有一所闻名世界的大学，但仍然是个安静的小镇。</li><li>He often helps me with my English although he is pretty busy. 尽管他相当忙，但还是常常帮助我学英语。</li><li>Although the book was old , we decided to buy it . 尽管这本书很旧，我们还是决定买。</li><li><em>Though she was busy with her work, yet she managed to find time to stay with her family 虽然她忙于工作,但她还是挤出时间与家人在一起.</em></li><li><em>She was busy with her work ,and yet she managed to find time to stay with her family (这里是副词and yet ==but )</em></li><li><em>She was busy with her work , yet she managed to find time to stay with her family （这里是连接词,解释为：虽然,但是=but ）</em></li></ul></blockquote></li><li><p>连词while有时也可表示“尽管”、“虽然”，引导让步状语从句</p><blockquote><p>While we don’t agree with each other, we continue to be friends. 尽管我们意见不同，我们还是朋友</p></blockquote></li><li><p>whatever, whoever, however, whenever, wherever等引导让步状语从句, 歌词中多见</p><blockquote><ul><li>Don’t lose heart whatever you do. 不管你做什么，都不要灰心。</li><li>Whoever you are, you can’t pass this way. 不管你是谁，你都不能从这里通过</li></ul></blockquote></li><li><p>as也可引导让步状语从句，但要将名词、形容词或副词等提到as前，若提前的是单数可数名词，要省略a或an，引导让步状语从句</p><blockquote><p>Teacher as he is, he can’t know everything. 虽然是老师，他也不可能什么都懂。</p></blockquote></li><li><p>Though引导的让步状语从句可用部分倒装，倒装后位于句首的名词之前不用冠词a或an</p><blockquote><p>Poor though I am ,I can afford it. 我虽穷，但这东西还是买得起的。</p></blockquote></li><li><p>习语 as though (好像，仿佛)，even though (即使，纵然)， 有一种虚拟在里面, 不确定是否是某种情况</p><blockquote><p>She closed her eyes as though she were tired. 她闭上眼，仿佛很疲劳似的。<br>He is an honest man, I must say, even though I has opposed him. 尽管我反对他，我还得说他是个诚实的人。</p></blockquote></li></ol><p>(七) 地点状语从句<br><strong>注意区分where引导的定语从句与状语从句</strong></p><blockquote><ol><li>You’d better make a mark where you have any questions. (状语从句)你最好在有疑问的地方做个记号。</li><li>You’d better make a mark at the place where you have any questions. (定语从句) 你最好在有疑问的地方做个记号。</li></ol></blockquote><ol><li>Where引导状语从句—副词性从句</li></ol><p><strong>当Where引导状语从句时，Where前没有表示地点的先行词，Where是从属连词，Where引导的从句修饰主句的谓语动词</strong></p><blockquote><ul><li>The famous scientist grew up where he was born and in 1930 he came to Shanghai. (这位知名的科学家就在出生地成长，1930年来到上海。)<br>评析：句中“the famous scientist grew up “这一部分是该句的主句，Where到句子最后是地点状语从句，where前没有表示地点的先行词.</li><li>She found her passport where she lost it . (她在她丢护照的地方找到了护照。)<br>评析：”passport”是主句 found 后的宾语，它并不是从句中lost的地点，因此 where 引导的是地点状语从句，从属连词where引导的从句修饰主句的谓语动词 found 。</li></ul></blockquote><ol start="2"><li>Where引导定语从句—形容词性从句</li></ol><p><strong>当where 引导定语从句时，Where前有表示地点的先行词，where 引导的从句修饰先行词，Where是关系副词，在从句中作地点状语</strong></p><blockquote><ul><li>He’s got himself into a dangerous situation where is likely to lose control over the plane . (他在飞机上失去控制，处于极其危险的境地。)<br>评析：situation 是先行词，其后是Where引导的定语从句。</li><li>This is the place where Luxun once lived . (这是鲁迅曾经生活过的地方。)<br>评析： the place 是先行词，其后是 where引导的定语从句 ，where 在从句中作地点状语。</li></ul></blockquote><ol start="3"><li><p>在有些情况下,where引导的定语从句可转换为where引导的地点状语从句.</p><blockquote><p>A tall building was put up at the place where there used to be a desert.＝A tall building was put up where there used to be a desert. (在以前曾是沙漠的地方盖起了一幢高楼.)</p></blockquote></li><li><p>where引导宾语从句、表语从句、主语从句———名词性从句</p><blockquote><ul><li>This is where Luxun once lived.   这是鲁迅曾经住的地方(where 引导表语从句)</li><li>I don’t know where Luxun once lived .我不清楚鲁迅曾经住在哪里。(where 引导宾语从句)</li><li>She was free to go to where she liked . 她可以去任何她喜欢的地方。(where 引导宾语从句)</li><li>Where Mary was born is Beijing .  玛利出身的地方是北京。(where 引导主语从句)</li></ul></blockquote></li><li><p>学后感</p><blockquote><ul><li>先行词是地点类的名词 place situation case， 后面的where引导定语从句</li><li>where 出现在什么地方就是充当什么成分</li><li>主句动词后面除了宾语和表语，剩下的就是状语</li><li>状语用来修饰的是主句的动词</li></ul></blockquote></li><li><p>课后习题</p><blockquote><ul><li>有志者事竟成。 Where there is a will, there is a way.   </li><li>书在你原来放的地方。  The book is where you left it.   </li><li>她回到了她刚才坐的地方。  She is back to where she sat just now.</li><li>请呆在原处。  Please stay where you are.   </li><li>这就是他曾工作过的农场。  This is the farm where he once worked.</li></ul></blockquote></li></ol><p>（八） 比较状语从句<br><strong>常见的引导词有： as…as,not so (as)…as, than, the more…the more等</strong></p><ol><li><p><strong>the more + 主谓， the more + 名词 + 主谓</strong></p><blockquote><ul><li>The harder you work, the more progress you will make. 你越努力，取得的进步就越大。   </li><li>The more you study, the more knowledge you can get.  你学的知识越多，你的知识越丰富。</li></ul></blockquote></li><li><p><strong>not so/as … as 之间只能是形容词原级，不可以是比较级和最高级</strong></p><blockquote><ul><li>The work is not so difficult as you imagine. 这工作不像你想像的那么困难。</li><li>He doesn’t work as hard as she (does). 他工作不像她那样努力。</li></ul></blockquote></li><li><p><strong>表示倍数的三种句型</strong></p><blockquote><ul><li><strong>倍数＋as many +可数名词复数+as</strong></li><li><strong>倍数+as much+不可数名词+as</strong></li><li><strong>倍数+as+形容词原级+名词+as</strong></li><li>I have twice as many books as you do. 我拥有的书是你的两倍。</li><li>It is reported that the United States uses twice as much energy as the whole of Europe. 据报道美国人使用的能源是整个欧洲的两倍。</li><li>I can rent three times as big a room as yours in my city using that money. 用那些钱我能在我们的城市租一个三倍大的房间。</li><li><strong>注意：</strong> adj + a/an + 名词</li></ul></blockquote></li></ol><p>（九） 方式状语从句<br><strong>常见的引导词有：as ,as if ，as though</strong></p><ol><li><p>** as if 从句用陈述语气的情况,当说话者认为句子所述的是真实的或极有可能发生或存在的事实时 **</p><blockquote><ul><li>It sounds as if it is raining．听起来像是在下雨。</li><li>He talks as if he is drunk．从他谈话的样子来看他是醉了。</li></ul></blockquote></li><li><p><strong>as if 从句用虚拟语气的情况,当说话人认为句子所述的是不真实的或极少有可能发生或存在的情况时。从句虚拟语气动词时态的形式如下</strong></p><blockquote><p><strong>如果从句表示与现在事实相反，谓语动词用一般过去时</strong></p><ul><li>You look as if you didn’t care． 你看上去好像并不在乎。</li><li>He talks as if he knew where she was． 他说话的样子，好像他知道她在哪里似的。</li></ul><p><strong>从句表示与过去事实相反，谓语动词用“had＋过去分词”</strong></p><ul><li>He talks about Rome as if he had been there before． 他说起罗马来好像他以前去过罗马似的。</li><li>The girllistened as if she had been turned to stone． 那女孩倾听着，一动也不动，像已经变成了石头似的。</li></ul><p><strong>从句表示与将来事实相反，谓语动词用“would／could／might＋动词原形”</strong></p><ul><li>He opened his mouth as if he would say something．  他张开嘴好像要说什么。</li><li>It looks as if it might snow．看来好像要下雪了。</li></ul><p><strong>注意：</strong> as if /though引导的从句常用虚拟语气，表示非真实情况，但如果从句中陈述的情况很可能实现，也可用陈述语气</p></blockquote></li></ol><p>（十） 状语从句的省略<br><strong>当时间、条件、让步、方式和比较状语从句的主语与主句一致或为it 或 there且谓语动词含be动词时，从句中的主语和谓语可以一起省去</strong></p><ol><li>Don’t speak until spoken to.( 省略了you are) 你不要讲话，除非让你讲话。</li><li>I have no money. If any, I will lend yousome. 我手里没有钱，有的话，我会借给你的。( 省略了there is)</li><li>Though cold, he still wore a shirt. 尽管很冷，他却只穿一件短袖。 ( 省略了it was)</li></ol><h4 id="强调句"><a href="#强调句" class="headerlink" title="强调句"></a>强调句</h4><p>（一） 区分强调句与其他类型从句（主、定、状）</p><ol><li><p>强调句与主语从句的区别</p><blockquote><ul><li>It is true that he is honest. (主语从句) 他真的很诚实。</li><li>True he is honest (去掉It is … that 之后不成句子，所以是主语从句，强调句去掉仍然成句子如： It is Mr Fu that is honest)</li><li>It is known to all that China is a country with a long history. (主语从句) 众所周知，中国是一个历史悠久的国家。<br>It was here that he fell off his bicycle.(强调句) 这正是他从自行车上摔下来的地方。</li></ul><p><strong>总结：</strong> “It is / was + 形容词 / 分词 /  + that从句”是主语从句，它译成中文时<strong>不</strong>可加上“正是……”“就是……”之类字眼，</p></blockquote></li><li><p>含有定语从句的强调句型 (在被强调的名词后再设计一个以该名词为先行词的定语从句，这时不要把定语从句当作强调句)。</p><blockquote><ul><li>It was this school where (in which) he once studied that gave him a chance of teaching.正是这所他曾经学习过的学校给了他教学的机会。</li></ul><p><strong>总结：</strong> 这种句子先写主干： It was this school…. that gave him a chance of teaching</p></blockquote></li><li><p>强调句型与状语从句的区别</p><blockquote><ul><li>It was at 7:00 that I arrived.(强调句型，强调时间状语at 7:00)正是在7:00时， 我到了。</li><li>It was 7:00 when I arrived.(时间状语从句，在7:00前无介词at) 当我到达时， 时间是7:00。</li><li>It was two years ago that I began to learn drawing.(强调句型，前后时态一致) 正是在两年前我开始学习绘画。</li><li>It is(has been) two years since I began to learn drawing.(since引导的时间状语从句，前后时态不一致) 自从我学习绘画以来已经有两年了。</li><li>It was two years before they came to see us.(时间状语从句) 过了两年后他们才来看我们。</li><li>It was two years later that they came to see us.(强调句型) 正是两年后他们才来看我们的。</li><li>It won’t be long before we graduate from the school. (时间状语从句) 不久我就将毕业了。</li><li>It will be two years before we graduate from this university. (时间状语从句) 再过两年我们就将大学毕业了。</li></ul><p><strong>总结：</strong> 可以看先行词，如果是引导时间的词since before after 就是时间状语从句， that是强调句</p></blockquote></li></ol><p>（二） 强调三关</p><p><img src="http://7xkyc7.com1.z0.glb.clouddn.com/xmind_mind1.png" alt="mind1"></p><h3 id="常用句式"><a href="#常用句式" class="headerlink" title="常用句式"></a>常用句式</h3><ol><li><p><strong>sb1 cut sb1 off</strong>  sb1截断了sb2的来源（多只经济来源）</p><blockquote><p>My daddy cut me off  我老爸断了我的经济来源<br><strong>sth cut sb off</strong> (sth断了)<br>Machine cut me off (电话断了)</p></blockquote></li><li><p><strong>sb is dumb blonde that has no common sense</strong>   某人是没有常识的金发女郎（世界观及价值观与常人不同）</p></li><li><p><strong>I knew it was stupid and I <em>shouldn’t have done</em> it</strong>   我知道这事情很蠢我也不该这么做</p><blockquote><p>shouldn’t have done, 本来不该做的事情做了，同理，should have done,本该做的事情没做，口语中使用频率很高.<br>You shouldn’t have said that.</p></blockquote></li><li><p><strong>sb is at rock bottom</strong> 某人在很惨/低谷的时候</p></li><li><p><strong>I think it is the best thing that could’ve ever happened to you</strong></p></li><li><p><strong>get out on one’s way</strong>  自力更生</p><blockquote><p>We should get out on our way.</p></blockquote></li><li><p><strong>How does he expect me to do sth</strong>   责备的语气，怎么可以这样？太过分了</p><blockquote><p>How does my boss expect me to work overtime</p></blockquote></li><li><p><strong>tune (曲调，调整，使一致)</strong></p><blockquote><p>tune in(收听) America tuned in to watch six very attractive singles navigate relationships and life in New York City<br>stay tuned (不要换台，不要走开， DJ常用语)</p></blockquote></li><li><p><strong>clip</strong> 小段音频或视频， next clip， clip section 2</p></li><li><p><strong>wind(wound) up doing == end up doing</strong> 最终..</p></li><li><p><strong>Right in the very beginning</strong> 就在一开始</p></li><li><p>*<em>we really just fell in love and adored（倾慕） each other instantly *</em></p></li><li><p><strong>sitcom = situation comedy</strong> （情景喜剧）</p></li><li><p><strong>Who have the best chemistry of the group?</strong></p><blockquote><p>chemistry: 化学反应，相互吸引，并非配合的默契</p></blockquote></li><li><p><strong>take sb under one’s …</strong>  </p><blockquote><p>he graciously took me under his wings.</p></blockquote></li><li><p><strong>be filthy rich</strong>  </p><blockquote><p>filthy /‘fɪlθi/ 肮脏的，污秽的，猥亵的， 是指有铜臭的那种感觉  Tom is filthy rich.    </p></blockquote></li><li><p><strong>I don’t want to go into sth</strong>   我不想详细的解释/讲这件事， 因为懒/麻烦不愿意说</p></li><li><p><strong>It won’t work out</strong>  …行不通</p></li><li><p><strong>have words</strong> 达成一致</p></li><li><p><strong>His mind is blown/ sb blew his mind</strong>  脑袋爆炸，指信息量很大，一时接受不了</p></li><li><p><strong>But not yet</strong>  …还没怎样，但是要快了</p></li><li><p><strong>I expect(预测)/look forward to(期盼) it will rain today</strong></p></li><li><p><strong>What if I …</strong> 如果我….  通常接过去时/过去完成时</p><blockquote><p>What if I was still fat  （过去时）<br>What if I had had the guts(勇气) to quit my job （过去完成时）<br>What if…? 主要有三种用法，此处表示假设，意思是“要是……将会怎么样”。此外，它还可以表示邀请或建议，意思是“如果……如何？”What if…? 还可以表示某事不重要，常常与so连用，意为“就算……那又怎样？<br>What if you join us for lunch? 同我们一起吃晚饭怎么样  （表示邀请/建议）<br>So what if we’re a little late? 就算我们迟到一小会又怎样  （表示某事不重要）</p></blockquote></li><li><p><strong>golden years</strong> 黄金年代  <strong>prime time</strong> 黄金时间</p></li><li><p><strong>That’s for sure</strong> 那毋庸置疑， 可以在自己说的句子末尾加上这句话， 也可以在别人说过话之后说这句话表示肯定和认可</p></li><li><p><strong>Don’t dwell</strong> (不要沉溺于过去)</p><blockquote><p>dwell /dwɛl/ (vi. 居住；存在于；细想某事)<br>move on / look forward  是其反义词 表示向前看</p></blockquote></li><li><p><strong>casual Friday</strong>  通常所说的happy Friday, 指工作族不用在星期五穿西装打领带那么不自由</p></li><li><p><strong>only if/if only</strong></p><blockquote><p>only if 的only 是重点，”只有如果(当…)”,if only 的if是重点”如果…就好了(既然假设就虚拟)”</p></blockquote></li><li><p><strong>You guys really think that I’m that shallow</strong>  (你们真的那么认为我那么肤浅/浅薄吗？)</p></li><li><p><strong>wear a tie</strong> (戴领带)</p></li><li><p><strong>sb have a knack for sth</strong> 某人有… 天分</p><blockquote><p>knack /næk/ n. 诀窍；本领；熟练技术；巧妙手法   I have a knack for stocks 我有炒股票的天分/潜质</p></blockquote></li><li><p><strong>quit my job</strong> 放弃我的工作，表示辞职</p></li><li><p><strong>I have to admit, *the horoscope stuff really caught my attention.</strong> 我不得不承认，星座运势这东西引起了我的兴趣</p></li><li><p><strong>Virgos have a strong attention to detail, they are known to take good care of people</strong> 处女座及其关注细节，他们是公认的擅长照顾别人</p></li><li><p><strong>Do you have some studying(homework) to do?</strong></p></li><li><p><strong>Do you not wanna be seen with me?  和 Don’t you wanna be seen with me?</strong>  (两者表达的意思不一样， 前者在当时的对话情景猜测到对方的意思)</p></li><li><p><strong>I’m about to leave</strong> (我马上要离开， 指下一秒将要做某事)</p></li><li><p>*<em>you may frown upon that. *</em> （你可能心里头不舒服，表示表情上，内心里（暗暗）不满，不同意， 而disapprove,disagree 表示言语上的不同意）</p></li><li><p><strong>You are so fired. ！</strong> 你铁定被解雇了 有点你会被解雇的很惨的意思</p><blockquote><p>you are so dead 你死定了</p></blockquote></li><li><p><strong>what are you [doing]</strong> 句型扩展</p><blockquote><ul><li>what are you trying to say. (你想说什么)<br>情景应用： A: 说了半天也说不明白，或者在纠结该不该说  B: what are you trying to say?   你现在正在尝试要说什么？</li><li>what do you want to say? (你想说什么)<br>情景应用： A: 跑到B面前说“Can I talk to you?” B: what do you want to say? 你想要说什么？</li><li>what are you doing saying this  （你说这个干什么，带有责备语气）<br>情景应用： 一般情况下，句型 what are you doing [doing] 带有责备的情感在里面   what are you doing talking to her about that? 你和她谈论那个干什么？</li></ul></blockquote></li><li><p><strong>Please bear in mind</strong> 请记住</p><blockquote><p>Please bear in mind that I love you forever.</p></blockquote></li><li><p><strong>Twist the knife</strong> 往伤口上撒盐，揭伤疤</p><blockquote><p>They’re all twisting the knife.</p></blockquote></li><li><p><strong>Split the cost</strong> 分摊成本，类似于中国的AA制</p></li><li><p><strong>you can’t be too careful in your work</strong>  </p><blockquote><p>A：你出门还带刀自我保护，太夸张了吧 B：You can’t be too careful.（现在世道这么乱，再怎么小心也不为过, 小心使得万年船）</p></blockquote></li><li><p><strong>Do you mind if we switch places？ （becasue I get off next 可说可不说） 类似于在电梯中请求互换位置</strong></p></li><li><p><strong>mean to do sth</strong> 有意做某事 故意做某事 // <strong>run into sb</strong> 不小心撞到别人，偶遇别人=bump into</p><blockquote><p>Oops, I did not mean to run into you like that, sir  哎呀！我没成想要这么碰到你的，对不起，先生。</p></blockquote></li><li><p><strong>school night/work night</strong></p><blockquote><p>school night 明早还要上学<br>work night 明天要上班<br>以上两种句型的理解：上班(上学)期间，不是放假期间，晚上不要玩疯，要做准备，为了第二天工作、学习<br> Is it a school night and she has a lot of homework to do?</p></blockquote></li><li><p><strong>Bring ’em on</strong>  放马过来  还想说什么就说吧</p></li><li><p><strong>girl/boy scouts</strong> 美国12岁以下孩子的一个real life的锻炼活动， 猜测类似夏令营， 为了筹办活动买girl/boy scouts cookies</p></li><li><p><strong>Tell sb good luck with sth.</strong>  表示“祝某人在某事上有好运”，口语中经常使用。</p><blockquote><p>A: Tom will have an exam tomorrow. 汤姆明天有个考试。  B: Tell him good luck with that. 帮我祝他好运。</p></blockquote></li><li><p><strong>I can let it go for eight.</strong> (结合上下文是8000元成交的意思， 其中let it go， 可以想象养了好久的宠物要走了，舍不得，此处理解为“勉强成交，非常不情愿的让价”)</p></li><li><p><strong>We stand firm at $10</strong> (我们坚决付十块， stand firm at … 坚定..立场)</p></li><li><p><strong>I’m over it</strong> (不在乎，无所谓了)</p></li><li><p><strong>hold out sth</strong> （伸出手里的东西，直直的拿着…）</p></li><li><p><strong>Engagement ring</strong> 结婚戒指</p></li><li><p><strong>poker face</strong> （ 一本正经的面容, 面无表情的人）</p></li><li><p><strong>a man-to-man talk</strong> (一对一的，坦率的,直言不讳的; 畅所欲言的)</p></li><li><p><strong>count on sb</strong> (依赖/指望某人)</p><blockquote><p>Don’t count on me (别指望我)<br>You can count on us (你可以指望/依赖我们)</p></blockquote></li><li><p><strong>toe the line</strong> (脚靠着线，不要越界，循规蹈矩，遵守规则)</p></li><li><p><strong>thread the needle</strong> (有balance的意思  也有讽刺这个东西很难， “线穿针眼”)</p><blockquote><p>it’s like thread the needle. (这个东西很难)</p></blockquote></li><li><p><strong>think outside the box</strong> (创新思维，摆脱思维定式)</p></li><li><p><strong>I have bigger fish to fry</strong> (有更大、重要的事情要处理)</p><blockquote><p>通常会说 I have bigger fish</p></blockquote></li><li><p>*<em>sb is heartless *</em> ( 某人无情无义)</p></li><li><p><strong>she/he gets on one knee</strong>  （单膝跪地求婚）</p><blockquote><p>take a knee (教练：围起来听教练讲话)</p></blockquote></li><li><p><strong>We’re engaged</strong>  我们订婚了  <strong>engagement ring</strong> 订婚戒指</p></li><li><p><strong>We’re dying out here!</strong>  ( 我们等得快急死了！)</p></li><li><p><strong>be likely to do sth.</strong> (表示“很有可能做某事”，强调可能性)</p><blockquote><p>It is likely to rain. 好像快要下雨了。<br>be unlikely to (不大可能，不再发生)<br>These tactics are unlikely to be helpful to you (这种方法对你未必有用)<br>He is very ill and unlikely to recover (他病得很重，不大可能恢复健康了)</p></blockquote></li><li><p><strong>lose one’s temper</strong> （失态）</p></li><li><p><strong>the box that it came in</strong>  （包装的箱子）</p></li><li><p><strong>shake hand</strong> (握手)</p></li><li><p><strong>Parents shouldn’t play favorites</strong>  （父母不应偏心）</p><blockquote><p>I’m the favorite (我是父母喜欢的那一个)</p></blockquote></li><li><p><strong>I’m kind/sort of （kina）tired</strong> （我有点累，比I’m a little bit tired更地道）</p></li><li><p><strong>clever/smart/resourceful/competent</strong></p><blockquote><p>在美国clever带有“小聪明”的意思，也有指动物的聪明， 在英国clever可以指人的聪明， 所以夸人聪明还是用smart比较合适<br>resourceful 形容人比较足智多谋，资源分丰富<br>competent/incompetent 有能力的和没有能力的 形容人</p></blockquote></li><li><p>*<em>get the hell out of here *</em> （滚出去  也有强调的意思， 要读的快和地道才有感觉）</p></li><li><p><strong>check clear/bounce</strong> (形容支票是可以支出钱或不能支出钱)</p></li><li><p><strong>I can’t wait to see everything again!</strong> （ 我都等不及要再次看到它们了！）</p><blockquote><p>can’t wait to do sth.表示“迫不及待要做某事”，口语中的使用频率很高。</p></blockquote></li><li><p><strong>can’t/couldn’t help doing sth.</strong> (情不自禁做某事)</p><blockquote><p>I can’t help laughing. (我忍不住大笑)</p></blockquote></li><li><p><strong>hit 常用短语总结：</strong></p><blockquote><ol><li>hit on sb (撩妹，泡妞) —— Cindy never realizes when boys  are hitting on her(Cindy 总是浑然不知有男生在追她)</li><li>hit on sth (灵机一动想到sth) —— He hit on an idea that would be a perfect surprise (他灵机一动，想到了完美的生日趴体惊喜)</li><li>hit smw (上路去哪) —— Let’s hit the road after staying here for a night (我们在这呆一晚就上路吧)</li><li>hit the sack/hay (就寝、睡觉) —— Tina was so tired that she hit the sack soon after long hours works （Tina 实在是太累了，长时间工作以后早早睡觉去了）</li><li>hit the nail[指甲、钉子] (说话中肯，一针见血) —— He always hit the nail on the head so all people found him extremly reliable （他说话总是一针见血，所有人都觉得他很靠谱）</li><li>hit the jackpot (中头彩) —— Jocelin is the perfect girl for me, I’ve hit the jackpot in life being with her (Jocelin是我的真命天女，能和她在一起真是我这辈子最大的福分)</li><li>hit it off well (一拍即合) —— We all thought the two of you would hit it off well （我们大家都认为你们会相处愉快）</li><li>hit the bottle (酗酒) —— He started to hit the bottle to relieve stress. (他开始用酗酒来释放压力)</li><li>hit the light (开灯) —— Would you please hit the light for me? （请问你可以帮我开一下灯么？）</li><li>hit the big (做到，成功) —— We hit the big (我们成功了)</li><li>hit the book (啃书，用工读书) —— I got an exam tomorrow. so I got to hit the books tonight. （我明天有个考试，今晚我要念书呢）</li><li>hit the roof (暴跳如雷，大怒) —— My parents would hit the roof if he knew that I wrecked his car （如果我爸发现我毁了他的车，一定会暴跳如雷的）</li><li>hit me (场景： 对酒吧调酒师说hit me, 指再来一杯)</li></ol></blockquote></li><li><p>*<em>ground rules = basic rule *</em> (基本规则)</p><blockquote><p>Are there ground rules (有什么基本的规则吗？ 如在玩游戏前做好规则)</p></blockquote></li><li><p><strong>I’m just saying</strong> (A: you’re so handsome, I’m just saying. 为了避免尴尬的局面，可以说I’m just saying.)</p></li><li><p><strong>He really told her off</strong> (他臭骂了她一顿)</p></li><li><p><strong>shave a head</strong> (理发)</p></li><li><p>*<em>on top of *</em> (并且 另外)</p></li><li><p>*<em>reduce anxiety *</em> (减少、降低焦虑，注意动词的使用)</p></li><li><p><strong>fixate on sth</strong> (提起sth)</p><blockquote><p>Why does everyone keep fixating on that? (为什么大家都绕着这个话题打转？ )</p></blockquote></li><li><p>*<em>of course it was a line *</em> (显然这是骗你的)</p></li><li><p><strong>live off</strong> (以…为食料；靠…生活；住在…之外)</p><blockquote><p>You can’t live off your parents all the time (你不能一直靠你父母生活)</p></blockquote></li><li><p><strong>是（is）, 有（there be）, 时（when）</strong>  (万能转换)</p></li><li><p><strong>loudly 和 loud 的区别</strong></p><blockquote><p>loudly 有吵闹的声音大的感觉<br>speak loud and clear</p></blockquote></li><li><p><strong>为某人支付费用</strong></p><blockquote><p>cover for you (暂时帮你付，回头你需要归还) I forgot my wallet, can you cover me?  (我忘记带钱包了，能先临时帮我付一下吗？)<br>pay for you (帮你付，不需要你还)</p></blockquote></li><li><p><strong>She gives him a withering look</strong>  （她用一个绝望或失望的眼神看了他一眼）</p></li><li><p><strong>You had one job</strong> (就让你干了一件事还干不好的意思)</p></li><li><p>*<em>beyond one’s grasp, beyond one’s capatibility , out of reach, out of control 区别 *</em></p><blockquote><p>beyond one’s grasp (鞭长莫及，有能力，但是远水解不了近渴的感觉) I can’t help him because it’s beyond my grasp<br>beyond one’s capatibility (超出某人的能力范围) The work is difficult and beyond my capatibility (工作太难超出了我的能力范围，也可以直接说 it’s beyond me)<br>out of reach (指空间距离的不能及) I’m in BJ， teaching in SH is out of reach<br>out of control (某物不可控) The fire is out of control (大火失去了控制)</p></blockquote></li><li><p><strong>a family of three</strong> (三口之家)</p></li><li><p>*<em>have yet to do sth *</em> (used for saying that something has not happened or been done up to the present time, especially when you think it should have happened or been done)</p><blockquote><p>As for accommodation, the resort has yet to announce the price of a stay in its hotel rooms. (至于膳宿，度假胜地还没有公布酒店的费用)</p></blockquote></li><li><p><strong>trial run/flight/version</strong> (试运行/试飞/试用版本)</p></li><li><p><strong>turn over in one’s mind</strong> (Think about something thoroughly)</p><blockquote><p>My father gave me some advice that I’ve been turning over in my mind ever since (我父亲教导过我一句话，我至今还念念不忘)</p></blockquote></li><li><p><strong>web celebrity</strong> (网红， celebrity也可以指名声名气)</p></li><li><p>*<em>You have got to do sth *</em>  (强烈建议做某事， got 要加重音)</p><blockquote><p>You’ve got to try this.</p></blockquote></li><li><p><strong>I’m not that much of …</strong> (我还没那么…,还没到..程度，也算是一种谦虚的说法)</p><blockquote><p>I’m not that much of an artist<br>I’m not that much of a sweet tooth (我不那么喜欢吃甜食)</p></blockquote></li><li><p><strong>This is the best sth/sb I have ever done</strong></p><blockquote><p>This is the best radio show I have ever listened to.<br>This is the best movie I have ever seen</p></blockquote></li><li><p><em>Sth is addressed to you*</em> (sth是邮寄给你的)</p><blockquote><p>This is not addressed to you (这不是邮寄给你的)<br>注意名词动词的读音区分 vt. 演说；从事；忙于；写姓名地址；向…致辞；与…说话；提出；处理   n. 地址；演讲；致辞；说话的技巧；称呼</p></blockquote></li><li><p><strong>send away</strong></p><blockquote><p>send away for sth (request another sth) 想象“让快递小哥送过来sth”</p></blockquote></li><li><p>** I’ll be right with you.** (等等，我马上就来)</p><blockquote><p>Wait a few minutes and I’ll be right with you. (请等一下，我马上就来)</p></blockquote></li><li><p><strong>sink one’s teeth into sth/sb</strong></p><blockquote><ul><li><strong>bite to sth/sb</strong><br>I can’t wait to sink my teeth into that delicious-looking dessert(餐后甜点) you made<br>The dog sunk his teeth into the little boy’s arm.</li><li><strong>get a chance to do something energetically or productively</strong><br>I want to give the students a project they can really sink their teeth into.<br>I’m so bored at work. I would like something I can sink my teeth into.</li></ul></blockquote></li><li><p><strong>first-tier city</strong> (一线城市)</p></li><li><p><strong>take sb/sth for granted</strong> (把…当成理所当然)</p><blockquote><p>So many of us take clean water for granted.<br>Children often take their parents for granted.</p></blockquote></li><li><p><strong>slow motion hair shake</strong> (慢动作甩头发)</p></li><li><p><strong>It’s a running gag</strong> （不停出现的笑点）</p><blockquote><p>gag me (short for gag me with a spoon)</p><ul><li>Shit i have so much homework. Gag meee! (杀了我吧，恶心死我吧)</li></ul></blockquote></li><li><p><strong>stare at sb</strong> ( 盯着某人看，  不是很礼貌的行为)</p><blockquote><p>Don’t stare</p></blockquote></li><li><p><strong>wafer thin ice</strong>  (很危险了)</p><blockquote><p>you’re standing on thin ice  （你很危险了，“别嘚瑟了，再触碰底线就死定了”）</p></blockquote></li><li><p><strong>sth rules</strong> (sth很给力，指很过瘾)</p><blockquote><p>movie rules / water rules</p></blockquote></li><li><p>*<em>leg warms *</em> (秋裤)</p></li><li><p><strong>You shush</strong> （你闭嘴吧）</p><blockquote><p>口语中，You shush或者Shush的使用频率很高，说话者用来让对方“闭嘴”或者“安静一下<br>Shush! I want to hear the weather. (安静！我要听天气预报)<br>Shush! Here he comes. I’ll talk to you later. (嘘！他来了。我一会儿再跟你说)<br>Don’t shush me. (让对方安静的意思)<br><strong>注意：</strong> Shush与Shut up所表达的含义相同，但Shush的语气比较委婉和客气，而Shut up则比较粗鲁，一般是急了的情况下用这种表达来让对方“住口”</p></blockquote></li><li><p>*<em>one hit wonder *</em> (one hit wonder，指代一个歌手或者组合只有一首成功的单曲)</p><blockquote><p>There are lots of singers are one hit wonder</p></blockquote></li><li><p><strong>tell each other secrets</strong> (互相揭穿秘密)</p></li><li><p><strong>freshman sophomore junior senior</strong> (大一大二大三大四)</p></li><li><p>*<em>valley girl *</em> （说话声音比较大，比较兴奋的女孩，会让周围的人觉得很吵 ）</p></li><li><p><strong>英语中没有学哥小妹，只需要说来自同一个学校就可以了， he was my friend from college 或者 alumni /ə’lʌmnaɪ/ 校友</strong></p></li><li><p><strong>to make matters worse</strong> (更糟糕的是)</p></li><li><p><strong>tough cookie = a difficult people</strong> (难相处的人)</p></li><li><p><strong>wedding vows</strong> （very serious promise， 现在多数在结婚时候用了）  婚姻誓词</p></li><li><p><strong>flash back episode</strong> (回顾片段  电影中的回忆片段)</p></li><li><p>*<em>steal one’s thunder *</em> (抢了谁的风头)</p></li><li><p><strong>Your roof, your rules</strong> (你的地盘你做主)</p></li><li><p><strong>a blessing in disguise</strong> (塞翁失马，因祸得福)</p></li><li><p><strong>word on the street</strong> (小道消息)</p></li><li><p>*<em>second mother tongue *</em> （第二母语）</p></li><li><p><strong>serve for sth</strong> （服务../用来做..）</p></li><li><p><strong>show off</strong> (炫耀，显摆)</p></li><li><p><strong>Reading makes a full man; conference a ready man;and writing an exact man</strong> (读书使人充实；交谈使人机敏；笔记使人精确)</p></li><li><p><strong>learn from the past</strong> (从历史/过去中学习)</p></li><li><p><strong>Those are way too expensive</strong> (way too + adj 太…)</p></li><li><p><strong>He’s a pushover</strong> (他是一个容易被掌控使唤的人)</p></li><li><p><strong>He’s a buzzkill</strong> (他是一个扫兴的人)</p></li><li><p><strong>i’m not doing it/sth</strong> (正在否认不做什么)</p></li><li><p><strong>I’m not returning them, you’ll see</strong> (you’ll see 等着看吧，尾语)</p></li></ol><h3 id="成语短语总结"><a href="#成语短语总结" class="headerlink" title="成语短语总结"></a>成语短语总结</h3><ol><li><p><strong>不管三七二十一</strong> &lt;——&gt; <strong>瞻前顾后</strong></p><blockquote><p><strong>rain or shine</strong> &lt;——&gt; <strong>take a look around</strong></p><ul><li>You have to carry out(贯彻，执行) your plan, rain or shine.</li><li>Buddy, just keep going， I’ll be along with you, rain or shine.</li><li>If you take a look around, you will miss a lot of oppotunities that were supposed to belong to you.</li></ul></blockquote></li><li><p><strong>不寒而栗</strong></p><blockquote><p><strong>Make one’ s teeth chatter(使卡嗒卡嗒作声). Make one’s flesh(肉体) creep</strong></p><ul><li>The mysterious /mɪ’stɪrɪəs/ sound in the dark made Lily’s teeth chatter.</li><li>The news that fake vaccines were being sold to different provinces in China made my teeth chatter.</li></ul></blockquote></li><li><p><strong>不可救药</strong> &lt;——&gt; <strong>微感不适</strong></p><blockquote><p><strong>beyond remedy(补救，治疗，赔偿)</strong> &lt;——&gt; <strong>To feel off color</strong></p><ul><li>Robert’s laziness is beyond remedy.</li><li>Tom feels off color</li></ul></blockquote></li><li><p><strong>不可同日而语</strong> &lt;——&gt; <strong>相提并论</strong></p><blockquote><p><strong>can’t be mentioned on the same day</strong> &lt;——&gt; <strong>place on par</strong></p><ul><li>John’s idea is different from Jean’s, they can’t be mentioned on the same day.</li><li>Both of things can not be placed on par.</li></ul></blockquote></li></ol><h3 id="生词表"><a href="#生词表" class="headerlink" title="生词表"></a>生词表</h3><table><thead><tr><th align="left">序号</th><th align="left">单词</th><th align="left">音标</th><th align="left">词性和解释</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">ditch</td><td align="left">/dɪtʃ/</td><td align="left">vt. 在…上掘沟；把…开入沟里；丢弃 n. 沟渠；壕沟</td></tr><tr><td align="left">2</td><td align="left">custod</td><td align="left">/‘kʌstədi/</td><td align="left">n. 保管；监护；拘留；抚养权</td></tr><tr><td align="left">3</td><td align="left">alcoholic</td><td align="left">/,ælkə’hɔlɪk/</td><td align="left">adj. 酒精的，含酒精的 n. 酒鬼，酗酒者</td></tr><tr><td align="left">4</td><td align="left">revelation</td><td align="left">/‘rɛvə’leʃən/</td><td align="left">n. 启示；揭露；出乎意料的事；被揭露的真相</td></tr><tr><td align="left">5</td><td align="left">massage</td><td align="left">/mə’sɑːʒ</td><td align="left">n. 按摩；揉 vt. 按摩；揉</td></tr><tr><td align="left">6</td><td align="left">horoscope</td><td align="left">/‘hɔrəskop</td><td align="left">n. 占星术；星象；十二宫图</td></tr><tr><td align="left">7</td><td align="left">nonsense</td><td align="left">/‘nɑnsɛn/</td><td align="left">n. 胡说；废话</td></tr><tr><td align="left">8</td><td align="left">charming</td><td align="left">/‘tʃɑrmɪŋ/</td><td align="left">adj. 迷人的；可爱的</td></tr><tr><td align="left">9</td><td align="left">arrogant</td><td align="left">/‘ærəɡən/</td><td align="left">adj. 自大的，傲慢的</td></tr><tr><td align="left">10</td><td align="left">oops</td><td align="left">/uːps/</td><td align="left">（表示惊讶或后悔）哎哟…</td></tr><tr><td align="left">11</td><td align="left">taboo</td><td align="left">/təˈbuː/</td><td align="left">禁忌</td></tr><tr><td align="left">12</td><td align="left">dash</td><td align="left">/dæʃ/</td><td align="left">连字符”-“</td></tr><tr><td align="left">13</td><td align="left">underscore</td><td align="left">/ˌʌn.dɚˈskɔːr/</td><td align="left">下划线”_”</td></tr><tr><td align="left">14</td><td align="left">money-oriented</td><td align="left">/ -ɔːr.i.en.t̬ɪd/</td><td align="left">导向钱的, 注意连字符的使用</td></tr><tr><td align="left">15</td><td align="left">detail-oriented</td><td align="left">/ -ɔːr.i.en.t̬ɪd/</td><td align="left">导向细节的， 注意连字符的使用，可能几百年后就是一个单词，中间没有连字符</td></tr><tr><td align="left">16</td><td align="left">alley</td><td align="left">/ ˈæl.i/</td><td align="left">小街, 小巷，胡同, （尤指两边有树或灌木的）小径…</td></tr><tr><td align="left">17</td><td align="left">stove</td><td align="left">/ stoʊv/</td><td align="left">（用于取暖的）炉，火炉, 炉灶…</td></tr><tr><td align="left">18</td><td align="left">ramen</td><td align="left">/ˈrɑː.men/</td><td align="left">日式拉面 方便面</td></tr><tr><td align="left">19</td><td align="left">drip-&gt;dribble</td><td align="left">/drɪp/ /ˈdrɪb.əl/</td><td align="left">滴嗒-&gt;滴滴答答 frequentative form 反复动词</td></tr><tr><td align="left">20</td><td align="left">murmur</td><td align="left">/ˈmɝː.mɚ/</td><td align="left">轻声说, 低声说 ,喃喃自语  frequentative form 反复动词</td></tr><tr><td align="left">21</td><td align="left">jerk</td><td align="left">/dʒɜːk/</td><td align="left">（美俚) foolish person 蠢人.阿呆,笨瓜,不懂世故 （适合好朋友之间用，有点幼稚，可爱的感觉）</td></tr><tr><td align="left">22</td><td align="left">seminar</td><td align="left">/ˈsem.ə.nɑːr/</td><td align="left">专题讨论会, 研讨会…</td></tr><tr><td align="left">23</td><td align="left">bluff</td><td align="left">/blʌf/</td><td align="left">以假象欺骗，蒙，唬</td></tr><tr><td align="left">24</td><td align="left">bury</td><td align="left">/ˈber.i/</td><td align="left">埋, 埋葬，安葬, 掩埋</td></tr><tr><td align="left">25</td><td align="left">hatchet</td><td align="left">/ˈhætʃ.ɪt/</td><td align="left">小斧头</td></tr><tr><td align="left">26</td><td align="left">cosmetic</td><td align="left">/kɑːzˈmet̬.ɪk/</td><td align="left">adj. 美容的；化妆用的 n. 化妆品；装饰品</td></tr><tr><td align="left">27</td><td align="left">sentimental</td><td align="left">/‘sɛntə’mɛntl/</td><td align="left">adj. 伤感的；多愁善感的；感情用事的；寓有情感的</td></tr><tr><td align="left">28</td><td align="left">bend（过去时bent”弯曲的”）</td><td align="left">/bɛnd/</td><td align="left">vt. 使弯曲；使屈服；使致力；使朝向 vi. 弯曲，转弯；屈服；倾向；专心于 n. 弯曲</td></tr><tr><td align="left">29</td><td align="left">daisy</td><td align="left">/‘deɪzɪ/</td><td align="left">n. 雏菊；菊科植物；极好的东西 adj. 极好的；上等的</td></tr><tr><td align="left">30</td><td align="left">tassel</td><td align="left">/‘tæsl/</td><td align="left">n. 流苏；缨；穗 vt. 用流苏装饰；摘下…穗</td></tr><tr><td align="left">31</td><td align="left">step-dad, step-mom, step-brother, step-sister</td><td align="left"></td><td align="left">继父,继母,继兄,继女</td></tr><tr><td align="left">32</td><td align="left">asbestos</td><td align="left">/æz’bestɒs    /</td><td align="left">n.石棉</td></tr><tr><td align="left">33</td><td align="left">ceiling</td><td align="left">/‘siːlɪŋ/</td><td align="left">天花板</td></tr><tr><td align="left">34</td><td align="left">oven</td><td align="left">/‘ʌvən/</td><td align="left">n. 烤箱</td></tr><tr><td align="left">35</td><td align="left">bulb</td><td align="left">/bʌlb/</td><td align="left">n. 电灯泡</td></tr><tr><td align="left">36</td><td align="left">bittersweet</td><td align="left">/‘bɪtɚ,swit/</td><td align="left">adj. 苦乐参半的；又苦又甜的  n. 又苦又甜的东西；蜀羊泉</td></tr><tr><td align="left">37</td><td align="left">narcissist</td><td align="left">/nɑr’sɪsɪst/</td><td align="left">n. 自我陶醉者 自恋的人</td></tr><tr><td align="left">38</td><td align="left">narcissism</td><td align="left">/‘nɑrsɪ’sɪzə/</td><td align="left">n. [心理] 自恋，自我陶醉</td></tr><tr><td align="left">39</td><td align="left">downhill</td><td align="left">/,daʊn’hɪl/</td><td align="left">adv. 下坡；向下；每况愈下 adj. 下坡的；容易的 n. 下坡；滑降</td></tr><tr><td align="left">40</td><td align="left">punchline</td><td align="left">/‘pʌntʃlaɪn/</td><td align="left">n. 笑点；结尾警语；妙语如珠</td></tr><tr><td align="left">41</td><td align="left">bald</td><td align="left">/bɔld/</td><td align="left">adj. 秃顶的；光秃的；单调的；无装饰的 vi. 变秃</td></tr><tr><td align="left">42</td><td align="left">therapy</td><td align="left">/‘θɛrəpi/</td><td align="left">n. 治疗，疗法</td></tr><tr><td align="left">43</td><td align="left">tuition</td><td align="left">/tʊ’ɪʃən/</td><td align="left">n. 学费；讲授</td></tr><tr><td align="left">44</td><td align="left">tutor</td><td align="left">/‘tʊtɚ/</td><td align="left">vt. 辅导；约束 n. 导师；家庭教师；助教 vi. 当家庭教师；（美）在家庭教师指导下学习</td></tr><tr><td align="left">45</td><td align="left">scooter</td><td align="left">/ˈskuː.t̬ɚ/</td><td align="left">n. 单脚滑行车</td></tr><tr><td align="left">46</td><td align="left">ambidextrous</td><td align="left">/‘æmbə’dɛkstrəs/</td><td align="left">n. 旁观者</td></tr><tr><td align="left">47</td><td align="left">onlooker = spectator</td><td align="left">/‘ɑnlʊkɚ/</td><td align="left">adj. 双手灵巧的；怀有二心的</td></tr><tr><td align="left">48</td><td align="left">vague</td><td align="left">/veɡ/</td><td align="left">adj. 模糊的；含糊的；不明确的；暧昧的</td></tr><tr><td align="left">49</td><td align="left">genetics</td><td align="left">/dʒə’nɛtɪks/</td><td align="left">n. 遗传学</td></tr><tr><td align="left">50</td><td align="left">clumsy</td><td align="left">/‘klʌmzi/</td><td align="left">adj. 笨拙的</td></tr><tr><td align="left">51</td><td align="left">stigma</td><td align="left">/‘stɪɡmə/</td><td align="left">n. [植] 柱头；耻辱；污名；烙印；特征</td></tr><tr><td align="left">52</td><td align="left">gasp</td><td align="left">/ɡæsp/</td><td align="left">vi. 喘气；喘息；渴望 vt. 气喘吁吁地说；喘着气说话 n. 喘气 (很惊讶的场景，倒吸一口气)</td></tr><tr><td align="left">53</td><td align="left">creamy</td><td align="left">/‘krimi/</td><td align="left">adj. 奶油色的；乳脂状的；含乳脂的</td></tr><tr><td align="left">54</td><td align="left">hypocrite</td><td align="left">/‘hɪpə’krɪ/</td><td align="left">n. 伪君子；伪善者</td></tr><tr><td align="left">55</td><td align="left">foreshadow</td><td align="left">/fɔrˈʃæd·oʊ/</td><td align="left">vt. 预示；成为…的前兆，做铺垫 n. 预兆，铺垫</td></tr><tr><td align="left">56</td><td align="left">cliche</td><td align="left">/kliːˈʃeɪ/</td><td align="left">n. 陈词滥调；[印刷] 铅版；陈腐思想 adj. 陈腐的 a saying or remark that is very often made and is therefore not original and not interesting ,想象剧情中的甩头发太普遍了，烂大街了</td></tr><tr><td align="left">57</td><td align="left">conversationalist</td><td align="left">/ˌkɑːn.vɚˈseɪ.ʃən.əl.ɪst/</td><td align="left">n. 健谈的人 someone who enjoys or is good at talking with people</td></tr><tr><td align="left">58</td><td align="left">intently</td><td align="left">/ɪnˈtent·li/</td><td align="left">adv. 专心地；一心一意地；心无旁骛地 in a way that shows great attention to something</td></tr><tr><td align="left">59</td><td align="left">pathetic</td><td align="left">/pəˈθet̬.ɪk/</td><td align="left">adj. 可怜的，悲哀的；感伤的；乏味的</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Life </category>
          
          <category> English </category>
          
      </categories>
      
      
        <tags>
            
            <tag> English </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo在github上搭建自己的博客</title>
      <link href="//p/build-github-pages-blog.html"/>
      <url>//p/build-github-pages-blog.html</url>
      
        <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>长时间在某平台上写博客记录些什么，但是近期该平台陆陆续续出现一些小问题，让写博客这么愉快的事情总是充斥着各种插曲，稍稍不爽，于是乎开始准备搭建自己的的博客，通过查阅资料用了两天时间初步搭建起来，收获颇丰，所以趁热打铁记录整个过程，搭建过程参考了非常多前辈们的blog，先真诚的道一声<strong>“感谢”</strong>，文章末尾会给出相关的参考链接。可搭建博客的框架很多，参考<a href="http://www.chinaz.com/special/static-blog/index.html?qq-pf-to=pcqq.c2c" target="_blank" rel="noopener">静态博客框架对比</a>，选择你看上眼的，本文选择<a href="https://hexo.io/docs/" target="_blank" rel="noopener">Hexo</a>，为什么选择它，我只能说对比之后喜欢.</p><h2 id="为什么选择github平台？"><a href="#为什么选择github平台？" class="headerlink" title="为什么选择github平台？"></a>为什么选择github平台？</h2><p>为什么选择<strong>github</strong>平台，我们通过下面的两组问题就可以得到答案了.</p><blockquote><p>博友们是否在编写博客的时候遇到过以下问题：</p></blockquote><blockquote><ol><li>博客平台升级维护</li><li>没有网络（比博客升级和维护还惨）</li><li>不够定制化</li></ol></blockquote><hr><blockquote><p>github上搭建自己的博客当然是有很多好处的：</p></blockquote><blockquote><ol><li>学着用github，享受github的便利，上面有很多大牛，眼界会开阔很多</li><li>顺便看看github工作原理，最好的团队协作流程</li><li>自我认为开源是一种趋势，github上有良好的开源氛围与精神</li><li>定制化的博客，可以按照自己的喜好来做更改</li><li>即便离线我也可以按照Markdown语法来编写博客，有网络时上传即可</li><li>一份使用 Markdown 格式撰写的文件应该可以直接以纯文本发布，并且看起来不会像是由许多标签或是格式指令所构成，可读性强</li></ol></blockquote><h2 id="搭建过程"><a href="#搭建过程" class="headerlink" title="搭建过程"></a>搭建过程</h2><p>按照下面的过程逐步进行，细心理解领会，你会发现搭建过程很简单, 下文都是在Windows 环境进行搭建。</p><h3 id="前期准备工作"><a href="#前期准备工作" class="headerlink" title="前期准备工作"></a>前期准备工作</h3><p>安装Hexo很简单，但是需要下面两样东东的支持：</p><ul><li>Node.js</li><li>Git</li></ul><p>在Windows 环境安装真的是太简单了，基本上是无脑<strong>下一步</strong></p><a id="more"></a><h3 id="Hexo安装"><a href="#Hexo安装" class="headerlink" title="Hexo安装"></a>Hexo安装</h3><p>在某个磁盘目录下新建一个文件夹，然后鼠标右键单击<strong>【Git Bash】</strong>, 进入下图：<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_1_%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%8B%E5%8D%95%E5%87%BBgit_bash.png" alt="单击Git Bash"></p><p>执行下面命令安装Hexo：</p><blockquote><p>$ npm install -g hexo-cli</p></blockquote><p>查看一下安装的Hexo版本（本人安装的是3.1.1）<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_1_%E6%9F%A5%E7%9C%8Bhexo%E7%89%88%E6%9C%AC.png" alt="查看hexo版本"></p><p>hexo的命令要怎么用？必须help命令来帮忙<br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_1_hexo%20help%E5%91%BD%E4%BB%A4.png" alt="hexo help命令"></p><p>安装好后就需要初始化Hexo来创建项目了</p><blockquote><p>$ hexo init</p></blockquote><p>该文件夹下会生成以下文件：</p><blockquote><ul><li>scaffolds 脚手架，也就是一个工具模板</li><li>scripts 写文件的js，扩展hexo的功能</li><li>source 存放博客正文内容</li><li>source/_drafts 草稿箱</li><li>source/_posts 文件箱</li><li>themes 存放皮肤的目录</li><li>themes/landscape 默认的皮肤</li><li>_config.yml 全局的配置文件</li><li>db.json 静态常量</li></ul></blockquote><p>项目创建完毕，就要启动了</p><blockquote><p>$ hexo server</p></blockquote><p>这个地方可能会遇到错误， 因为server在Hexo 3的版本被分离出来，需要<a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">单独安装</a>：</p><blockquote><p>$ npm install hexo-server –save</p></blockquote><p>这样重新启动就好了.</p><p>这时端口4000被打开了，我们能过浏览器打址，<a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a><br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_1_hexo%E9%BB%98%E8%AE%A4%E4%B8%BB%E9%A2%98.png" alt="hexo默认主题"></p><p>我们可以使用下面命令来创建新page来写博客了</p><blockquote><p>$ hexo new myNewPage</p></blockquote><p>创建好myNewPage.md文件会自动放在<strong>source/_posts</strong>目录下，生成的md后缀的文件需要采用<a href="http://www.appinn.com/markdown/#philosophy" target="_blank" rel="noopener">Markdown</a>进行编写，然后刷新页面，你就会发现你的新文章了，是不是有点小激动，还有更好的，往下看。</p><h3 id="更改Hexo主题"><a href="#更改Hexo主题" class="headerlink" title="更改Hexo主题"></a>更改Hexo主题</h3><p>安装好的Hexo我们都是一样的在<strong>source/themes</strong>默认主题<strong>landscape</strong>, 是不是觉得不够爽， 那就<a href="https://github.com/hexojs/hexo/wiki/Themes" target="_blank" rel="noopener">选择主题</a>, 这里面应该有你想要的那一款吧。</p><p>执行下面命令将选好的主题clone到自己的hexo空间</p><blockquote><p>$ git clone <a href="https://github.com/A-limon/pacman.git" target="_blank" rel="noopener">https://github.com/A-limon/pacman.git</a> themes/pacman</p></blockquote><p>这样你会发现pacman这个主题就在你的themes文件下了，想让自己博客指定主题，只需要修改hexo的主题文件_config.yml 中的theme属性即可</p><blockquote><p>theme: pacman</p></blockquote><p>重新启动，刷新你的页面，主题变了吧。</p><h3 id="配置和使用Github"><a href="#配置和使用Github" class="headerlink" title="配置和使用Github"></a>配置和使用Github</h3><p>我们如何让本地git项目与远程的github建立联系呢？用<strong>SSH keys</strong><br>开始菜单处单击【Git Bash】**</p><p>首先我们需要检查你电脑上现有的ssh key：</p><blockquote><p>$ cd ~/.ssh</p></blockquote><p>如果提示：No such file or directory 说明你是第一次使用git， 接下来需要生成<strong>SSH keys</strong></p><blockquote><p>$ ssh-keygen -t rsa -C “邮件地址@youremail.com”<br>Generating public/private rsa key pair.<br>Enter file in which to save the key (/Users/your_user_directory/.ssh/id_rsa):&lt;回车就好&gt;</p></blockquote><p><strong>注意:</strong> 此处的邮箱地址，你可以输入自己的邮箱地址；注意2: 此处的「-C」的是大写的「C」</p><p>系统要求输入密码和确认密码：</p><blockquote><p>$ Enter passphrase (empty for no passphrase):&lt;输入加密串&gt;<br>$ Enter same passphrase again:&lt;再次输入加密串&gt;</p></blockquote><p>最后看到下面界面就生成了<strong>SSH keys</strong><br><img src="http://7xkyc7.com1.z0.glb.clouddn.com/blog_1_%E7%94%9F%E6%88%90sshkey.png" alt="生成sshkey"></p><p>按照log提示找到id_rsa.pub文件，复制里面的内容，然后将<strong>SSH keys</strong>添加到github上，登陆github系统。点击右上角的 Account Settings—-&gt;SSH Public keys —-&gt; add another public keys</p><p>可以通过下面命令来进行测试是否成功</p><blockquote><p>$ ssh -T <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a></p></blockquote><p>现在你已经可以通过SSH链接到GitHub了，还有一些个人信息需要完善的。</p><p>Git会根据用户的名字和邮箱来记录提交。GitHub也是用这些信息来做权限的处理，输入下面的代码进行个人信息的设置，把名称和邮箱替换成你自己的，名字必须是你的真名，而不是GitHub的昵称。</p><blockquote><p>$ git config –global user.name “your name”<br>$ git config –global user.email  “<a href="mailto:username@gmail.com" target="_blank" rel="noopener">username@gmail.com</a>“</p></blockquote><p>至此<strong>SSH keys</strong>设置成功</p><h3 id="发布博客到Github"><a href="#发布博客到Github" class="headerlink" title="发布博客到Github"></a>发布博客到Github</h3><p>我们的终极目标是将博客发布到github上，我们还是需要有一些准备工作要做。在github上新建username.github.io的repository，至于为什么请参考<a href="https://pages.github.com/" target="_blank" rel="noopener">github pages</a></p><p>本地新建一个文件夹，该文件夹下右键单击<strong>【Git Bash】</strong> 执行命令</p><blockquote><p>$ git clone <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:username/username.github.io.git</p></blockquote><p>这样就在本地生成了自己的repository</p><p>怎样发布到github上去，我们同样要修改hexo下的_config.yml文件，在最后deployment处增加这样两行</p><blockquote><p>deploy:<br>type: github<br>repo: <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:username/username.github.io.git</p></blockquote><p>然后执行命令进行静态化，将所有文件静态化到public文件夹下</p><blockquote><p>$ hexo generate</p></blockquote><p>然后进行部署</p><blockquote><p>$ hexo deploy</p></blockquote><p>这个地方可能又遇到问题了，提示【hexo ERROR Deployer not found: github】，同样是3以上版本的问题，按照下面操作即可：</p><blockquote><p>$ npm install hexo-deployer-git –save</p></blockquote><p>然后将上面说到的部署文件的type由<strong>github</strong>改为<strong>git</strong></p><blockquote><p>deploy:<br>type: git<br>repo: <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:username/username.github.io.git</p></blockquote><p>重新生成静态文件，然后发布，这样在浏览器中输入username.github.io就可以到你在github上的博客了， 有没有小激动？ 最后小伙伴们哪里看不懂或哪里有问题欢迎留言，我进行补充或回答, 更多问题可以参考官网文档<a href="https://hexo.io/docs/" target="_blank" rel="noopener">Docs</a> .</p><p>最后真的感激前辈们的博文指点，下面提供我参考过的一些链接：</p><ol><li><a href="http://cnfeat.com/2014/05/10/2014-05-11-how-to-build-a-blog/" target="_blank" rel="noopener">如何搭建一个独立博客——简明GithubPages与Hexo教程</a></li><li><a href="http://blog.fens.me/hexo-blog-github/" target="_blank" rel="noopener">Hexo在github上构建免费的Web应用</a></li><li><a href="http://www.ruanyifeng.com/blog/2012/08/blogging_with_jekyll.html" target="_blank" rel="noopener">搭建一个免费的，无限流量的Blog—-github Pages和Jekyll入门</a></li><li><a href="http://www.cnblogs.com/fstang/p/3308964.html" target="_blank" rel="noopener">用Jekyll在github上写博客——《搭建一个免费的，无限流量的Blog》的注脚</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub Pages </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

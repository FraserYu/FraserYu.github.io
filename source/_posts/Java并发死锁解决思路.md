---
title: Javaå¹¶å‘æ­»é”è§£å†³æ€è·¯
categories: [Coding, Java-Concurrency]
tags:
  - æ­»é”
  - é”ç²’åº¦
id: java-concurrency-dead-lock
date: 2019-10-18 14:01:20
thumbnail: https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-imgconcurrency.png
description: é¿å…æ­»é”ï¼Œåªéœ€è¦æ‰“ç ´Coffmanæ‰€è¯´çš„ä¸‰ä¸ªæ¡ä»¶å³å¯
keywords: Javaå¹¶å‘,æ­»é”,é¿å…æ­»é”,Coffman,å¹¶å‘

---

## å†™åœ¨å‰é¢
ä¸Šä¸€ç¯‡æ–‡ç« [å…±äº«èµ„æºé‚£ä¹ˆå¤šï¼Œå¦‚ä½•ç”¨ä¸€æŠŠé”ä¿æŠ¤å¤šä¸ªèµ„æºï¼Ÿ](https://dayarch.top/p/33b9e35c.html) æ–‡ç« æˆ‘ä»¬è°ˆåˆ°äº†é“¶è¡Œè½¬è´¦ç»å…¸æ¡ˆä¾‹ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªé—®é¢˜:
1. å•çº¯çš„ç”¨ synchronized æ–¹æ³•èµ·ä¸åˆ°ä¿æŠ¤ä½œç”¨(ä¸èƒ½ä¿æŠ¤ target)
2. ç”¨ Account.class é”æ–¹æ¡ˆï¼Œé”çš„ç²’åº¦åˆè¿‡å¤§ï¼Œå¯¼è‡´æ¶‰åŠåˆ°è´¦æˆ·çš„æ‰€æœ‰æ“ä½œ(å–æ¬¾ï¼Œè½¬è´¦ï¼Œä¿®æ”¹å¯†ç ç­‰)éƒ½ä¼šå˜æˆä¸²è¡Œæ“ä½œ


å¦‚ä½•è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜å‘¢ï¼Ÿå’±ä»¬å…ˆæ¢å¥½è¡£æœç©¿è¶Šå›åˆ°è¿‡å»å¯»æ‰¾ä¸€ä¸‹é’±åº„ï¼Œä¸€èµ·é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œdengdeng deng.......

![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/2019-10-17-16-08-25.png)


æ¥åˆ°é’±åº„ï¼Œå‘Šè¯‰æŸœå‘˜ä½ è¦ç»™é“è›‹å„¿è½¬ 100 é“œé’±ï¼Œè¿™æ—¶æŸœå‘˜è½¬èº«åœ¨å¢™ä¸Šå¯»æ‰¾ä½ å’Œé“è›‹å„¿çš„è´¦æœ¬ï¼Œæ­¤æ—¶æŸœå‘˜å¯èƒ½é¢ä¸´ä¸‰ç§æƒ…å†µ:
1. ç†æƒ³çŠ¶æ€: ä½ å’Œé“è›‹å„¿çš„è´¦æœ¬éƒ½æ˜¯ç©ºé—²çŠ¶æ€ï¼Œä¸€èµ·æ‹¿å›æ¥ï¼Œåœ¨ä½ çš„è´¦æœ¬ä¸Šå‡ 100 é“œé’±ï¼Œåœ¨é“è›‹å„¿è´¦æœ¬ä¸ŠåŠ  100 é“œé’±ï¼ŒæŸœå‘˜è½¬èº«å°†è´¦æœ¬æŒ‚å›åˆ°å¢™ä¸Šï¼Œå®Œæˆä½ çš„ä¸šåŠ¡
2. å°´å°¬çŠ¶æ€: ä½ çš„è´¦æœ¬åœ¨ï¼Œé“è›‹å„¿çš„è´¦æœ¬è¢«å…¶ä»–æŸœå‘˜æ‹¿å‡ºå»ç»™åˆ«äººè½¬è´¦ï¼Œä½ è¦ç­‰å¾…å…¶ä»–æŸœå‘˜æŠŠé“è›‹å„¿çš„è´¦æœ¬å½’è¿˜
3. æŠ“ç‹‚çŠ¶æ€: ä½ çš„è´¦æœ¬ä¸åœ¨ï¼Œé“è›‹å„¿çš„è´¦æœ¬ä¹Ÿä¸åœ¨ï¼Œä½ åªèƒ½ç­‰å¾…ä¸¤ä¸ªè´¦æœ¬éƒ½å½’è¿˜

æ”¾æ…¢æŸœå‘˜çš„å–è´¦æœ¬æ“ä½œï¼Œä»–ä¸€å®šæ˜¯å…ˆæ‹¿åˆ°ä½ çš„è´¦æœ¬ï¼Œç„¶åå†å»æ‹¿é“è›‹å„¿çš„è´¦æœ¬ï¼Œä¸¤ä¸ªè´¦æœ¬éƒ½æ‹¿åˆ°(ç†æƒ³çŠ¶æ€)ä¹‹åæ‰èƒ½å®Œæˆè½¬è´¦ï¼Œç”¨ç¨‹åºæ¨¡å‹æ¥æè¿°ä¸€ä¸‹è¿™ä¸ªæ‹¿å–è´¦æœ¬çš„è¿‡ç¨‹:

![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E6%AD%BB%E9%94%81%20%281%29.png)


æˆ‘ä»¬ç»§ç»­ç”¨ç¨‹åºä»£ç æè¿°ä¸€ä¸‹ä¸Šé¢è¿™ä¸ªæ¨¡å‹:

```java
class Account {
  private int balance;
  // è½¬è´¦
  void transfer(Account target, int amt){
    // é”å®šè½¬å‡ºè´¦æˆ·
    synchronized(this) {              
      // é”å®šè½¬å…¥è´¦æˆ·
      synchronized(target) {           
        if (this.balance > amt) {
          this.balance -= amt;
          target.balance += amt;
        }
      }
    }
  } 
}
```

è¿™ä¸ªè§£å†³æ–¹æ¡ˆçœ‹èµ·æ¥å¾ˆå®Œç¾ï¼Œè§£å†³äº†æ–‡ç« å¼€å¤´è¯´çš„ä¸¤ä¸ªé—®é¢˜ï¼Œä½†çœŸæ˜¯è¿™æ ·å—ï¼Ÿ

- - - - - - - 

æˆ‘ä»¬åˆšåˆšè¯´è¿‡çš„ç†æƒ³çŠ¶æ€æ˜¯é’±åº„åªæœ‰ä¸€ä¸ªæŸœå‘˜(æ—¢å•çº¿ç¨‹)ã€‚éšç€é’±åº„è§„æ¨¡å˜å¤§ï¼Œå¢™ä¸Šæ—©å·²æŒ‚äº†éå¸¸å¤šä¸ªè´¦æœ¬ï¼Œé’±åº„ä¸ºäº†åº”å¯¹ç¹å¿™çš„ä¸šåŠ¡ï¼Œå¼€é€šäº†å¤šä¸ªçª—å£ï¼Œæ­¤æ—¶æœ‰å¤šä¸ªæŸœå‘˜(å¤šçº¿ç¨‹)å¤„ç†é’±åº„ä¸šåŠ¡ã€‚


![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/2019-10-17-18-42-42.png)


æŸœå‘˜ 1 æ­£åœ¨åŠç†ç»™é“è›‹å„¿è½¬è´¦çš„ä¸šåŠ¡ï¼Œä½†åªæ‹¿åˆ°äº†ä½ çš„è´¦æœ¬ï¼›æŸœå‘˜ 2 æ­£åœ¨åŠç†é“è›‹å„¿ç»™ä½ è½¬è´¦çš„ä¸šåŠ¡ï¼Œä½†åªæ‹¿åˆ°äº†é“è›‹å„¿çš„è´¦æœ¬ï¼Œæ­¤æ—¶åŒæ–¹å‡ºç°äº†å°´å°¬çŠ¶æ€ï¼Œä¸¤ä½æŸœå‘˜éƒ½åœ¨ç­‰å¾…å¯¹æ–¹å½’è¿˜è´¦æœ¬ä¸ºå½“å‰å®¢æˆ·åŠç†è½¬è´¦ä¸šåŠ¡ã€‚

![](https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-imgbank.png)



ç°å®ä¸­æŸœå‘˜ä¼šæ²Ÿé€šï¼Œå–Šå‡ºä¸€å—“å­ ***è€é“ï¼Œé“è›‹å„¿çš„è´¦æœ¬å…ˆç»™æˆ‘ç”¨ä¸€ä¸‹ï¼Œç”¨å®Œè¿˜ç»™ä½ ***ï¼Œä½†ç¨‹åºå´æ²¡è¿™ä¹ˆæ™ºèƒ½ï¼Œsynchronized å†…ç½®é”éå¸¸æ‰§ç€ï¼Œå®ƒä¼šå‘Šè¯‰ä½ ã€Œæ­»ç­‰ã€çš„é“ç†ï¼Œæœ€ç»ˆå‡ºç°æ­»é”
>  Java æœ‰äº† synchronized å†…ç½®é”ï¼Œè¿˜å‘æ˜äº†æ˜¾ç¤ºé” Lockï¼Œæ˜¯ä¸æ˜¯å°±ä¸ºäº†æ²»ä¸€æ²» synchronized ã€Œæ­»ç­‰ã€çš„æ‰§ç€å‘¢ï¼ŸğŸ˜

### è§£å†³æ–¹æ¡ˆ
å¦‚ä½•è§£å†³ä¸Šé¢çš„é—®é¢˜å‘¢ï¼Ÿæ­£æ‰€è°“çŸ¥å·±çŸ¥å½¼æ–¹èƒ½ç™¾æˆ˜ä¸æ®†ï¼Œæˆ‘ä»¬è¦å…ˆäº†è§£ä»€ä¹ˆæƒ…å†µä¼šå‘ç”Ÿæ­»é”ï¼Œæ‰èƒ½çŸ¥é“å¦‚ä½•é¿å…æ­»é”ï¼Œå¾ˆå¹¸è¿æˆ‘ä»¬å¯ä»¥ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šçœ‹å¾…é—®é¢˜

`Coffman` æ€»ç»“å‡ºäº†å››ä¸ªæ¡ä»¶è¯´æ˜å¯ä»¥å‘ç”Ÿæ­»é”çš„æƒ…å½¢:
#### Coffman æ¡ä»¶
**äº’æ–¥æ¡ä»¶ï¼š**æŒ‡è¿›ç¨‹å¯¹æ‰€åˆ†é…åˆ°çš„èµ„æºè¿›è¡Œæ’å®ƒæ€§ä½¿ç”¨ï¼Œå³åœ¨ä¸€æ®µæ—¶é—´å†…æŸèµ„æºåªç”±ä¸€ä¸ªè¿›ç¨‹å ç”¨ã€‚å¦‚æœæ­¤æ—¶è¿˜æœ‰å…¶å®ƒè¿›ç¨‹è¯·æ±‚èµ„æºï¼Œåˆ™è¯·æ±‚è€…åªèƒ½ç­‰å¾…ï¼Œç›´è‡³å æœ‰èµ„æºçš„è¿›ç¨‹ç”¨æ¯•é‡Šæ”¾ã€‚

**è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼š**æŒ‡è¿›ç¨‹å·²ç»ä¿æŒè‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œè¯¥èµ„æºå·²è¢«å…¶å®ƒè¿›ç¨‹å æœ‰ï¼Œæ­¤æ—¶è¯·æ±‚è¿›ç¨‹é˜»å¡ï¼Œä½†åˆå¯¹è‡ªå·±å·²è·å¾—çš„å…¶å®ƒèµ„æºä¿æŒä¸æ”¾ã€‚

**ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼š**æŒ‡è¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å‰¥å¤ºï¼Œåªèƒ½åœ¨ä½¿ç”¨å®Œæ—¶ç”±è‡ªå·±é‡Šæ”¾ã€‚

**ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼š**æŒ‡åœ¨å‘ç”Ÿæ­»é”æ—¶ï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹â€”â€”èµ„æºçš„ç¯å½¢é“¾ï¼Œå³è¿›ç¨‹é›†åˆ{P1ï¼ŒP2ï¼ŒÂ·Â·Â·ï¼ŒPn}ä¸­çš„ P1 æ­£åœ¨ç­‰å¾…ä¸€ä¸ª P2 å ç”¨çš„èµ„æºï¼›P2 æ­£åœ¨ç­‰å¾… P3 å ç”¨çš„èµ„æºï¼Œâ€¦â€¦ï¼ŒPn æ­£åœ¨ç­‰å¾…å·²è¢« P0 å ç”¨çš„èµ„æºã€‚


![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E7%8E%AF%E5%BD%A2.png)


è¿™å‡ ä¸ªæ¡ä»¶å¾ˆå¥½ç†è§£ï¼Œå…¶ä¸­ã€Œäº’æ–¥æ¡ä»¶ã€æ˜¯å¹¶å‘ç¼–ç¨‹çš„æ ¹åŸºï¼Œè¿™ä¸ªæ¡ä»¶æ²¡åŠæ³•æ”¹å˜ã€‚ä½†å…¶ä»–ä¸‰ä¸ªæ¡ä»¶éƒ½æœ‰æ”¹å˜çš„å¯èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ç ´åå¦å¤–ä¸‰ä¸ªæ¡ä»¶å°±ä¸ä¼šå‡ºç°ä¸Šé¢è¯´åˆ°çš„æ­»é”é—®é¢˜

#### ç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶
æ¯ä¸ªæŸœå‘˜éƒ½å¯ä»¥å–æ”¾è´¦æœ¬ï¼Œå¾ˆå®¹æ˜“å‡ºç°äº’ç›¸ç­‰å¾…çš„æƒ…å†µã€‚è¦æƒ³ç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼Œå°±è¦ä¸€æ¬¡æ€§æ‹¿åˆ°æ‰€æœ‰èµ„æºã€‚

ä½œä¸ºç¨‹åºçŒ¿ä½ ä¸€å®šå¬è¿‡è¿™å¥è¯:
>  ä»»ä½•è½¯ä»¶å·¥ç¨‹é‡åˆ°çš„é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªä¸­é—´å±‚æ¥è§£å†³

æˆ‘ä»¬ä¸å…è®¸æŸœå‘˜éƒ½å¯ä»¥å–æ”¾è´¦æœ¬ï¼Œè´¦æœ¬è¦ç”±å•ç‹¬çš„è´¦æœ¬ç®¡ç†å‘˜æ¥ç®¡ç†



![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E8%B4%A6%E6%9C%AC%E7%AE%A1%E7%90%86%E5%91%98.png)



ä¹Ÿå°±æ˜¯è¯´è´¦æœ¬ç®¡ç†å‘˜æ‹¿å–è´¦æœ¬æ˜¯ä¸´ç•ŒåŒºï¼Œå¦‚æœåªæ‹¿åˆ°å…¶ä¸­ä¹‹ä¸€çš„è´¦æœ¬ï¼Œé‚£ä¹ˆä¸ä¼šç»™æŸœå‘˜ï¼Œè€Œæ˜¯ç­‰å¾…æŸœå‘˜ä¸‹ä¸€æ¬¡è¯¢é—®æ˜¯å¦ä¸¤ä¸ªè´¦æœ¬éƒ½åœ¨
```java
public class Account {
	//å•ä¾‹çš„è´¦æœ¬ç®¡ç†å‘˜
	private AccountBookManager accountBookManager;

	private int balance;

	public void transfer(Account target, int amt){
		// ä¸€æ¬¡æ€§ç”³è¯·è½¬å‡ºè´¦æˆ·å’Œè½¬å…¥è´¦æˆ·ï¼Œç›´åˆ°æˆåŠŸ
		while(accountBookManager.getAllRequiredAccountBook(this, target));

		try{
			// é”å®šè½¬å‡ºè´¦æˆ·
			synchronized(this){
				// é”å®šè½¬å…¥è´¦æˆ·
				synchronized(target){
					if (this.balance > amt){
						this.balance -= amt;
						target.balance += amt;
					}
				}
			}
		} finally {
			accountBookManager.releaseObtainedAccountBook(this, target);
		}
		
	}
}

public class AccountBookManager {

	List<Object> accounts = new ArrayList<>(2);

	synchronized boolean getAllRequiredAccountBook( Object from, Object to){
		if(accounts.contains(from) || accounts.contains(to)){
			return false;
		} else{
			accounts.add(from);
			accounts.add(to);

			return true;
		}
	}
	// å½’è¿˜èµ„æº
	synchronized void releaseObtainedAccountBook(Object from, Object to){
		accounts.remove(from);
		accounts.remove(to);
	}
}
```

#### ç ´åä¸å¯å‰¥å¤ºæ¡ä»¶
ä¸Šé¢å·²ç»ç»™äº†ä½ å°å°çš„æç¤ºï¼Œä¸ºäº†è§£å†³å†…ç½®é”çš„æ‰§ç€ï¼ŒJava æ˜¾ç¤ºé”æ”¯æŒé€šçŸ¥(notify/notifyall)å’Œç­‰å¾…(wait)ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥åŠŸèƒ½å¯ä»¥å®ç°å–Šä¸€å—“å­ ***è€é“ï¼Œé“è›‹å„¿çš„è´¦æœ¬å…ˆç»™æˆ‘ç”¨ä¸€ä¸‹ï¼Œç”¨å®Œè¿˜ç»™ä½ *** çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåç»­å°†åˆ° Java SDK ç›¸å…³å†…å®¹æ—¶ä¼šåšè¯´æ˜

#### ç ´åç¯è·¯ç­‰å¾…æ¡ä»¶
ç ´åç¯è·¯ç­‰å¾…æ¡ä»¶ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å°†èµ„æºåºå·å¤§å°æ’åºè·å–å°±ä¼šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†ç¯è·¯æ‹†é™¤



![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-10-17/%E9%93%B6%E8%A1%8C%E8%BD%AC%E5%B8%90%E6%8E%92%E5%BA%8F.png)


ç»§ç»­ç”¨ä»£ç æ¥è¯´æ˜:
```java
class Account {
  private int id;
  private int balance;
  // è½¬è´¦
  void transfer(Account target, int amt){
    Account smaller = this        
    Account larger = target;    
    // æ’åº
    if (this.id > target.id) { 
      smaller = target;           
      larger = this;            
    }                          
    // é”å®šåºå·å°çš„è´¦æˆ·
    synchronized(smaller){
      // é”å®šåºå·å¤§çš„è´¦æˆ·
      synchronized(larger){ 
        if (this.balance > amt){
          this.balance -= amt;
          target.balance += amt;
        }
      }
    }
  } 
}
```
å½“ smaller è¢«å ç”¨æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œä¹Ÿå°±ä¸ä¼šå­˜åœ¨æ­»é”äº†. 

## é™„åŠ è¯´æ˜
åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œå…³äº Account éƒ½ä¼šæ˜¯æ•°æ®åº“å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äº‹åŠ¡æˆ–æ•°æ®åº“çš„ä¹è§‚é”æ¥è§£å†³çš„ã€‚å¦å¤–åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè´¦æœ¬ç®¡ç†å‘˜è¿™ä¸ªè§’è‰²çš„å¤„ç†ä¹Ÿå¯èƒ½ä¼šç”¨ redis åˆ†å¸ƒå¼é”æ¥è§£å†³. 

åœ¨å¤„ç†ç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ while å¾ªç¯æ–¹å¼æ¥ä¸æ–­è¯·æ±‚é”çš„æ—¶å€™ï¼Œåœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬ä¼šæœ‰ timeout çš„è®¾ç½®ï¼Œé˜²æ­¢æ— ä¼‘æ­¢çš„æµªè´¹ CPU ä½¿ç”¨ç‡

å¦å¤–å¤§å®¶å¯ä»¥å°è¯•ä½¿ç”¨é˜¿é‡Œå¼€æºå·¥å…· Arthas æ¥æŸ¥çœ‹ CPU ä½¿ç”¨ç‡ï¼Œçº¿ç¨‹ç­‰ç›¸å…³é—®é¢˜ï¼Œgithub ä¸Šæœ‰æ˜ç¡®çš„è¯´æ˜

## æ€»ç»“
è®¡ç®—æœºçš„è®¡ç®—èƒ½åŠ›è¿œè¿œè¶…è¿‡äººç±»ï¼Œä½†æ˜¯ä»–çš„æ™ºæ…§è¿˜éœ€è¦æœ‰å¸¦æé«˜ï¼Œå½“çœ‹å¾…å¹¶å‘é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€è®¤ä¸ºäººç±»çš„æœ€åŸºæœ¬æ²Ÿé€šè®¡ç®—æœºä¹Ÿå¯ä»¥åšåˆ°ï¼Œå…¶å®ä¸ç„¶ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œç¼–å†™å¹¶å‘ç¨‹åºï¼Œè¦ç«™åœ¨è®¡ç®—æœºçš„è§’åº¦æ¥çœ‹å¾…é—®é¢˜

ç²—ç²’åº¦é”æˆ‘ä»¬ä¸æå€¡ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨ç»†ç²’åº¦é”ï¼Œä½†ä½¿ç”¨ç»†ç²’åº¦é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦ä¸¥æ ¼æŒ‰ç…§ Coffman çš„å››å¤§æ¡ä»¶æ¥é€æ¡åˆ¤æ–­ï¼Œè¿™æ ·å†åº”ç”¨æˆ‘ä»¬è¿™å‡ ä¸ªè§£å†³æ–¹æ¡ˆæ¥è§£å†³å°±å¥½äº†


## çµé­‚è¿½é—®
1. ç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶æ—¶ï¼Œå¤„ç†èƒ½åŠ›çš„ç“¶é¢ˆåœ¨è´¦æœ¬ç®¡ç†å‘˜é‚£é‡Œï¼Œé‚£ä½ è§‰å¾—è¿™ç§å¤„ç†æ–¹å¼ä¼šæé«˜å¹¶å‘é‡å—ï¼Ÿ
2. ç ´åè¯·æ±‚ä¿æŒæ¡ä»¶çš„æ–¹æ³•å’Œç ´åç¯è·¯ç­‰å¾…çš„æ–¹æ³•ï¼Œä½ è§‰å¾—é‚£ç§æ–¹å¼æ›´å¥½
3. ç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶æ—¶ï¼Œå¦‚æœä»£ç æ¢æˆä¸‹é¢çš„æ ·å­ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```java
public void transfer(Account target, int amt){
    // ä¸€æ¬¡æ€§ç”³è¯·è½¬å‡ºè´¦æˆ·å’Œè½¬å…¥è´¦æˆ·ï¼Œç›´åˆ°æˆåŠŸ
    while(accountBookManager.getAllRequiredAccountBook(this, target)){}
        try{
            // é”å®šè½¬å‡ºè´¦æˆ·
            synchronized(this){
                // é”å®šè½¬å…¥è´¦æˆ·
                synchronized(target){
                    if (this.balance > amt){
                        this.balance -= amt;
                        target.balance += amt;
                    }
                }
            }
        } finally {
            accountBookManager.releaseObtainedAccountBook(this, target);
        }
    }
}
```

## æé«˜æ•ˆç‡å·¥å…·

![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png) 

--------

## æ¨èé˜…è¯»
1. [è¿™æ¬¡èµ°è¿›å¹¶å‘çš„ä¸–ç•Œï¼Œè¯·ä¸è¦é”™è¿‡](https://dayarch.top/p/d7e125a1.html)
2. [å­¦å¹¶å‘ç¼–ç¨‹ï¼Œé€å½»ç†è§£è¿™ä¸‰ä¸ªæ ¸å¿ƒæ˜¯å…³é”®](https://dayarch.top/p/86243a5b.html)
3. [å¹¶å‘Bugä¹‹æºæœ‰ä¸‰ï¼Œè¯·çå¤§çœ¼ç›çœ‹æ¸…å®ƒä»¬](https://dayarch.top/p/6d12b8cf.html)
4. [å¯è§æ€§æœ‰åºæ€§ï¼ŒHappens-beforeæ¥æå®š](https://dayarch.top/p/815d7647.html)
5. [è§£å†³åŸå­æ€§é—®é¢˜ï¼Ÿä½ é¦–å…ˆéœ€è¦çš„æ˜¯å®è§‚ç†è§£](https://dayarch.top/p/32b8e26a.html)
6. [é¢è¯•å¹¶å‘volatileå…³é”®å­—æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å…·å¤‡å“ªäº›è°ˆèµ„ï¼Ÿ](https://dayarch.top/p/fb3c7eeb.html)

--------

> ### æ¬¢è¿æŒç»­å…³æ³¨å…¬ä¼—å·ï¼šã€Œæ—¥æ‹±ä¸€å…µã€
> - å‰æ²¿ Java æŠ€æœ¯å¹²è´§åˆ†äº« 
> - é«˜æ•ˆå·¥å…·æ±‡æ€» | å›å¤ã€Œå·¥å…·ã€
> - é¢è¯•é—®é¢˜åˆ†æä¸è§£ç­” 
> - æŠ€æœ¯èµ„æ–™é¢†å– | å›å¤ã€Œèµ„æ–™ã€

> ä»¥è¯»ä¾¦æ¢å°è¯´æ€ç»´è½»æ¾è¶£å‘³å­¦ä¹  Java æŠ€æœ¯æ ˆç›¸å…³çŸ¥è¯†ï¼Œæœ¬ç€å°†å¤æ‚é—®é¢˜ç®€å•åŒ–ï¼ŒæŠ½è±¡é—®é¢˜å…·ä½“åŒ–å’Œå›¾å½¢åŒ–åŸåˆ™é€æ­¥åˆ†è§£æŠ€æœ¯é—®é¢˜ï¼ŒæŠ€æœ¯æŒç»­æ›´æ–°ï¼Œè¯·æŒç»­å…³æ³¨......

![](http://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png)

---
title: 并发编程三大核心
tags:
  - 分工
  - 同步
  - 互斥
category: [Coding, Java-Concurrency]
id: java-concurrency-core
date: 2019-08-28 20:29:07
thumbnail: https://cdn.jsdelivr.net/gh/FraserYu/img-host/blog-imgconcurrency.png
description: 了解分工，同步与互斥，才能真正了解并发, 学习并发上来就研究SDK源码，就好比没学会走就要跑一样，结果可想而知
keywords: Java并发,分工,同步,互斥,并发基础

---


## 写在前面
上一篇文章[这次走进并发的世界，请不要错过](https://mp.weixin.qq.com/s/I53l5W_Wl-lMc-_FAeJ6WQ) 给大家带了并发编程的开胃菜，接下来我们逐步上正餐，在吃正餐之前，我还要引用那首诗词: 「横看成岭侧成峰，远近高低各不同」，远看看轮廓，近看看细节，不断切换思维或视角来学习

![](https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-27/team-3393037.jpg)


远看并发，**并发编程可以抽象成三个核心问题: 分工、同步/协作、互斥**

如果你已经工作了，那么你一定听说过或者正在应用敏捷开发模式来交付日常的工作任务，我们就用你熟悉的流程来解释这三个核心问题

## 分工
> 将当前 Sprint 的 Story 拆分成「合适」大小的 Task，并且安排给「合适」的 Team Member 去完成

这里面用了两个「合适」，将 Story 拆分成大小适中，可完成的 Task 是非常重要的。拆分的粒度太粗，导致这个任务完成难度变高，耗时长，不易与其他人配合；拆分的粒度太细，又导致任务太多，不好管理与追踪，浪费精力和资源。(**合适的线程才能更好的完成整块工作，当然一个线程可以轻松搞定的就没必要多线程**)；安排给合适的人员去完成同样重要，UX-UE 问题交给后端人员处理，很显然是有问题的 (**主线程应该做的事交给子线程显然是解决不了问题的，每个线程做正确的事才能发挥作用**)

关于分工，常见的 Executor，生产者-消费者模式，Fork/Join 等，这都是分工思想的体现

## 同步/协作
任务拆分完毕，我要等张三的任务，张三要等李四的任务，也就是说任务之间存在依赖关系，前面的任务执行完毕，后面的任务才可以执行，人高级在可以通过沟通反复确认，确保自己的任务可以开始执行。**但面对程序，我们需要了解程序的沟通方式，一个线程执行完任务，如何通知后续线程执行**

所有的同步/协作关系我们都可以用你最熟悉的 If-then-else 来表示:

```java
if(前序任务完成){
    execute();
}else{
    wait();
}
```
上面的代码就是说:**当某个条件不满足时，线程需要等待；当某个条件满足时，线程需要被唤醒执行**，线程之间的协作可能是主线程与子线程的协作，可能是子线程与子线程的合作， Java SDK 中 CountDownLatch 和 CyclicBarrier 就是用来解决线程协作问题的

## 互斥
**分工和同步强调的是性能，但是互斥是强调正确性**，就是我们常常提到的「线程安全」，当多个线程**同时**访问一个共享变量/成员变量时，就可能发生不确定性，造成不确定性主要是有`可见性`、`原子性`、`有序性`这三大问题，而解决这些问题的核心就是互斥
> ### 互斥
>  同一时刻，只允许一个线程访问共享变量

来看下图，主干路就是共享变量，进入主干路一次只能有一辆车，这样你是否理解了呢？「**天下大事，分久必合**」

![](https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-27/42f62cfa83224f5b8735bc03df7deb39.gif)


同样 Java SDK 也有很多互斥的解决方案，比如你马上就能想到 synchronized 关键字，Lock，ThreadLocal 等就是互斥的解决方案

## 总结
资本家疯狂榨取劳动工人的剩余价值，获得最大收益。当你面对 CPU，内存，IO 这些劳动工人时，你就是那个资本家，你要思考如何`充分榨取`它们的价值
>  当一个工人能干的活，绝不让两个人来干(单线程能满足就没必要为了多线程)
> 当多个工人干活时，就要让他们分工明确，合作顺畅，没矛盾

当任务很大时，由于 IO 干活慢，CPU 干活快，就没必要让 CPU 死等当前的 IO，转而去执行其他指令，这就是`榨取剩余价值`，如何最大限度的榨取其价值，这就涉及到后续的调优问题，比如多少线程合适等

**分工是设计，同步和互斥是实现**，没有好的设计也就没有好的实现，所以在分工阶段，强烈建议大家勾划草图，了解瓶颈所在，这样才会有更好的实现，后续章节的内容，我也会带领大家画草图，分析问题，逐步养成这个习惯

本章内容可以用下面的图来简单概括，叶子结点的内容我们会逐步点亮，现阶段不用过分关注(如果你上来就啃 JDK 源码，也许你会痛苦的迷失，并最终放弃你的进阶之路的)

![](https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E5%A4%9A%E7%BA%BF%E7%A8%8B/_image/2019-08-27/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83.png)


**理解三大核心问题，你要充分结合生活中的实际，程序中的并发问题，基本上都能在实际生活中找得到原型**

下一篇文章的内容，我们就要聊聊，引起线程安全的三个问题:「可见性，原子性，有序性」，这涉及到 JMM 的一点内容，可以提前了解一下的，这样我们才能更好的碰撞

## 灵魂追问
1. 工作中多线程编程的场景多吗？
2. 想到多线程，只会想到 synchronized 吗？
3. Java 并发包各个类，你有了解底层实现和设计理念吗？

## 提高效率工具

![](https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/b.png)

--------

## 推荐阅读
+ [每天用SpringBoot，还不懂RESTful API返回统一数据格式是怎么实现的？ ](https://mp.weixin.qq.com/s/q5cyK14WGiMm-R6NIFBcTg)
+ [双亲委派模型：大厂高频面试题，轻松搞定](https://mp.weixin.qq.com/s/Dnr1jLebvBUHnziZzSfcrA)
+ [面试还不知道BeanFactory和ApplicationContext的区别？](https://mp.weixin.qq.com/s/YBQB086ADBjHUmwrFQrWew)
+ [如何设计好的RESTful API](https://mp.weixin.qq.com/s/hR1TqkVzwZ_T8fuMnsM4hQ)
+ [红黑树，超强动静图详解，简单易懂](https://mp.weixin.qq.com/s/ilND8u_8HGSTSrJiMB4X8g)

--------
> ### 欢迎持续关注公众号：「日拱一兵」
> - 前沿 Java 技术干货分享
> - 高效工具汇总 | 回复「工具」
> - 面试问题分析与解答
> - 技术资料领取 | 回复「资料」

> 以读侦探小说思维轻松趣味学习 Java 技术栈相关知识，本着将复杂问题简单化，抽象问题具体化和图形化原则逐步分解技术问题，技术持续更新，请持续关注......

![](https://rgyb.sunluomeng.top/%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E6%96%87%E7%AB%A0/%E6%84%9F%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BB%93/_image/2019-06-18/a%20%281%29.png)
